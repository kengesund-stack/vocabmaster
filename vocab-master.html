<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>VocabMaster</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
:root {
  --bg:#0a0a0f; --sf:#12121a; --sf2:#1a1a26; --sf3:#22222f;
  --ac:#7c5cfc; --ac2:#fc5c7d; --ac3:#5cf8fc;
  --tx:#f0f0f8; --tx2:#9090aa;
  --gn:#4cff91; --rd:#ff4c6a; --or:#ff9c4c; --gd:#ffd700;
  --r:14px;
  --st:env(safe-area-inset-top,0px); --sb:env(safe-area-inset-bottom,0px);
}
html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--tx); font-family:-apple-system,Helvetica,Arial,sans-serif; -webkit-user-select:none; user-select:none; }
#app { width:100%; height:100%; overflow:hidden; position:relative; }

.scr { display:none; position:absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; background:var(--bg); }
.scr.on { display:flex; }

.scroll { flex:1; overflow-y:scroll; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:14px 18px; }

.tabbar { display:flex; background:var(--sf); border-top:1px solid rgba(255,255,255,.07); padding-bottom:var(--sb); flex-shrink:0; }
.tab { flex:1; display:flex; flex-direction:column; align-items:center; padding:8px 0; background:none; border:none; color:var(--tx2); cursor:pointer; font-family:inherit; }
.tab.on { color:var(--ac); }
.tab-ic { font-size:20px; }
.tab-lb { font-size:10px; margin-top:2px; }

.hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:10px; background:var(--bg); border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0; }
.hdr-title { font-size:16px; font-weight:600; flex:1; }

#s-home { background:radial-gradient(ellipse at 20% 10%,rgba(124,92,252,.15) 0%,transparent 55%),radial-gradient(ellipse at 80% 90%,rgba(252,92,125,.1) 0%,transparent 55%),var(--bg); }
.home-top { display:flex; justify-content:space-between; align-items:center; padding:12px 18px 0; padding-top:calc(var(--st) + 12px); flex-shrink:0; }
.logo { font-size:24px; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg,var(--ac),var(--ac2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

.btn { display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.btn-ic { width:38px; height:38px; border-radius:10px; background:var(--sf2); font-size:17px; color:var(--tx2); }
.btn-back { width:34px; height:34px; border-radius:9px; background:var(--sf2); font-size:17px; color:var(--tx); flex-shrink:0; }
.btn-primary { width:100%; padding:14px; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); color:#fff; font-size:15px; font-weight:600; -webkit-appearance:none; border:none; cursor:pointer; font-family:inherit; }
.btn-primary:active { opacity:.8; }
.btn-sec { width:100%; padding:13px; background:var(--sf2); border:1px solid rgba(255,255,255,.1); border-radius:var(--r); color:var(--tx); font-size:14px; font-weight:500; margin-top:8px; -webkit-appearance:none; border-radius:var(--r); cursor:pointer; font-family:inherit; }
.btn-sec:active { background:var(--sf3); }
.btn-text { background:none; border:none; color:var(--ac); font-size:13px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }

.stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
.stat { background:var(--sf); border-radius:var(--r); padding:11px; text-align:center; }
.stat-n { font-size:22px; font-weight:700; }
.stat-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.due-btn { width:100%; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); padding:15px 17px; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; border:none; cursor:pointer; -webkit-appearance:none; text-align:left; font-family:inherit; }
.due-btn:active { opacity:.85; }
.due-txt h3 { font-size:16px; font-weight:600; color:#fff; }
.due-txt p { font-size:11px; color:rgba(255,255,255,.75); margin-top:2px; }
.due-n { font-size:36px; font-weight:700; color:#fff; line-height:1; }

.act-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:18px; }
.act-card { background:var(--sf); border-radius:var(--r); padding:14px; border:none; cursor:pointer; text-align:left; width:100%; -webkit-appearance:none; font-family:inherit; }
.act-card:active { background:var(--sf2); }
.act-ic { font-size:24px; margin-bottom:5px; display:block; }
.act-title { font-size:13px; font-weight:600; color:var(--tx); }
.act-sub { font-size:11px; color:var(--tx2); margin-top:2px; }

.sec-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.sec-title { font-size:12px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }

.list-card { background:var(--sf); border-radius:var(--r); padding:13px; margin-bottom:7px; display:flex; align-items:center; gap:11px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.list-card:active { background:var(--sf2); }
.lc-prog-wrap { padding:0 13px 10px; }
.lc-prog-bar { height:4px; background:rgba(255,255,255,.1); border-radius:2px; overflow:hidden; }
.lc-prog-fill { height:100%; border-radius:2px; transition:width .4s ease; }
.lc-prog-txt { font-size:10px; color:var(--tx2); margin-top:4px; display:flex; justify-content:space-between; }

/* ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ */
.swipe-wrap { position:relative; overflow:hidden; border-radius:var(--r); margin-bottom:7px; }
.swipe-del-bg { position:absolute; right:0; top:0; bottom:0; width:90px; background:var(--rd); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:2px; color:#fff; font-size:11px; font-weight:700; border-radius:var(--r); }
.swipe-del-bg span { font-size:20px; }
.swipe-inner { position:relative; transition:transform .2s ease; touch-action:pan-y; will-change:transform; }
.swipe-inner.swiped { transform:translateX(-90px); }
.swipe-inner .list-card { margin-bottom:0; border-radius:var(--r); }
.list-ic { width:40px; height:40px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.list-inf { flex:1; min-width:0; }
.list-name { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.list-meta { font-size:11px; color:var(--tx2); margin-top:2px; }
.list-badge { background:var(--ac); color:#fff; font-size:11px; font-weight:600; padding:2px 8px; border-radius:20px; }

/* è¨€èªãƒãƒƒã‚¸ */
.lang-badge { display:inline-block; font-size:10px; font-weight:700; padding:1px 6px; border-radius:5px; margin-left:5px; vertical-align:middle; }
.lang-en { background:rgba(76,255,145,.15); color:var(--gn); }
.lang-de { background:rgba(255,215,0,.15); color:var(--gd); }
.lang-fr { background:rgba(92,248,252,.15); color:var(--ac3); }
.lang-es { background:rgba(255,156,76,.15); color:var(--or); }
.lang-it { background:rgba(252,92,125,.15); color:var(--ac2); }

.seg { display:flex; background:var(--sf); border-radius:11px; padding:3px; margin-bottom:16px; }
.seg-btn { flex:1; padding:8px 3px; border:none; border-radius:8px; background:transparent; color:var(--tx2); font-size:12px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }
.seg-btn.on { background:var(--sf3); color:var(--tx); }

.lbl { font-size:12px; color:var(--tx2); margin-bottom:5px; font-weight:500; }
.inp { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:var(--r); color:var(--tx); font-family:inherit; font-size:15px; padding:12px 14px; outline:none; -webkit-appearance:none; margin-bottom:12px; -webkit-user-select:text; user-select:text; }
.inp:focus { border-color:var(--ac); }
.ta { height:140px; resize:none; line-height:1.6; }
.hint { font-size:11px; color:var(--tx2); margin-bottom:12px; line-height:1.5; }

/* è¨€èªé¸æŠ */
.lang-sel-wrap { margin-bottom:14px; }
.lang-sel-title { font-size:12px; color:var(--tx2); margin-bottom:7px; font-weight:500; }
.lang-sel-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.lang-sel-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.lang-sel-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }
.opt-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.opt-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }

.upload { border:2px dashed rgba(124,92,252,.3); border-radius:var(--r); padding:26px; text-align:center; cursor:pointer; margin-bottom:12px; background:rgba(124,92,252,.03); }
.upload:active { border-color:var(--ac); background:rgba(124,92,252,.08); }
.upload-ic { font-size:30px; margin-bottom:5px; }
.upload-tx { font-size:14px; font-weight:500; }
.upload-sub { font-size:11px; color:var(--tx2); margin-top:3px; }

.prev-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.prev-title { font-size:13px; font-weight:600; color:var(--tx2); }
.prev-cnt { background:var(--ac); color:#fff; font-size:11px; padding:2px 8px; border-radius:10px; }
.prev-list { display:flex; flex-direction:column; gap:5px; max-height:220px; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.prev-item { background:var(--sf); border-radius:9px; padding:9px 11px; display:flex; align-items:center; gap:9px; }
.pi-n { font-size:11px; color:var(--tx2); width:20px; flex-shrink:0; }
.pi-en { font-size:14px; font-weight:500; flex:1; }
.pi-ja { font-size:12px; color:var(--ac3); }

.srch-wrap { padding:9px 16px 0; flex-shrink:0; }
.srch { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:11px; padding:9px 13px; color:var(--tx); font-family:inherit; font-size:14px; outline:none; -webkit-appearance:none; -webkit-user-select:text; user-select:text; }

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ */
.filter-bar { display:flex; gap:7px; padding:9px 16px 0; overflow-x:scroll; -webkit-overflow-scrolling:touch; flex-shrink:0; }
.filter-bar::-webkit-scrollbar { display:none; }
.flt-btn { padding:5px 12px; border-radius:20px; border:1px solid rgba(255,255,255,.1); background:var(--sf); color:var(--tx2); font-size:12px; font-weight:500; white-space:nowrap; cursor:pointer; -webkit-appearance:none; font-family:inherit; flex-shrink:0; }
.flt-btn.on { background:var(--ac); border-color:var(--ac); color:#fff; }

.word-item { background:var(--sf); border-radius:var(--r); padding:11px 13px; margin-bottom:6px; display:flex; align-items:center; gap:9px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.word-item:active { background:var(--sf2); }
.wi-inf { flex:1; min-width:0; }
.wi-en { font-size:14px; font-weight:500; }
.wi-ja { font-size:11px; color:var(--tx2); margin-top:2px; }
.wi-lvl { width:28px; height:28px; border-radius:7px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; flex-shrink:0; }
.l0{background:rgba(255,76,106,.15);color:var(--rd);} .l1{background:rgba(255,156,76,.15);color:var(--or);} .l2{background:rgba(255,215,0,.15);color:var(--gd);} .l3{background:rgba(76,255,145,.15);color:var(--gn);} .l4{background:rgba(124,92,252,.15);color:var(--ac);} .l5{background:rgba(92,248,252,.15);color:var(--ac3);}

#s-quiz { background:radial-gradient(ellipse at 50% 0%,rgba(124,92,252,.12) 0%,transparent 55%),var(--bg); }
.qz-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.qz-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.qz-fill { height:100%; background:linear-gradient(90deg,var(--ac),var(--ac2)); border-radius:3px; transition:width .35s ease; }
.qz-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.qz-body { flex:1; display:flex; flex-direction:column; padding:13px 16px; overflow:hidden; gap:10px; }
.qz-card { background:var(--sf); border-radius:18px; padding:22px 18px; text-align:center; flex-shrink:0; }
.qz-badge { display:inline-block; background:rgba(124,92,252,.15); color:var(--ac); font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; margin-bottom:12px; text-transform:uppercase; letter-spacing:.06em; }
.qz-word { font-size:28px; font-weight:700; line-height:1.2; word-break:break-word; }
.choices { display:flex; flex-direction:column; gap:7px; flex:1; justify-content:center; }
.ch-btn { width:100%; padding:13px 14px; background:var(--sf); border:2px solid rgba(255,255,255,.08); border-radius:13px; color:var(--tx); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; text-align:left; display:flex; align-items:center; gap:9px; -webkit-appearance:none; min-height:50px; }
.ch-btn:active:not(.done) { border-color:var(--ac); background:rgba(124,92,252,.08); }
.ch-btn.ok { border-color:var(--gn)!important; background:rgba(76,255,145,.08)!important; }
.ch-btn.ok .ch-lt { background:rgba(76,255,145,.2); color:var(--gn); }
.ch-btn.ok .ch-tx { color:var(--gn); }
.ch-btn.ng { border-color:var(--rd)!important; background:rgba(255,76,106,.08)!important; }
.ch-btn.ng .ch-lt { background:rgba(255,76,106,.2); color:var(--rd); }
.ch-btn.ng .ch-tx { color:var(--rd); }
.ch-lt { width:25px; height:25px; border-radius:6px; background:rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--tx2); flex-shrink:0; }
.ch-tx { flex:1; line-height:1.3; }
.ch-ic { font-size:15px; margin-left:auto; flex-shrink:0; min-width:18px; text-align:center; }
.ch-dk { width:100%; padding:11px 14px; background:transparent; border:2px dashed rgba(255,255,255,.15); border-radius:13px; color:var(--tx2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; text-align:center; margin-top:2px; -webkit-appearance:none; }
.ch-dk:active:not(.done) { border-color:rgba(255,255,255,.35); color:var(--tx); }
.ch-dk.done { opacity:.5; pointer-events:none; }

.fb { position:absolute; bottom:calc(var(--sb) + 7px); left:14px; right:14px; background:var(--sf2); border:1px solid rgba(255,255,255,.08); border-radius:13px; padding:11px 14px; display:flex; align-items:center; justify-content:space-between; gap:9px; opacity:0; transform:translateY(28px); transition:opacity .25s ease,transform .25s ease; pointer-events:none; z-index:10; }
.fb.on { opacity:1; transform:translateY(0); pointer-events:auto; }
.fb-tx { font-size:13px; font-weight:600; }
.fb-dt { font-size:11px; color:var(--tx2); margin-top:2px; }
.fb-next { background:var(--ac); color:#fff; border:none; border-radius:9px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; font-family:inherit; -webkit-appearance:none; }
.fb-next:active { opacity:.8; }

#s-result { background:radial-gradient(ellipse at 50% 30%,rgba(124,92,252,.2) 0%,transparent 55%),var(--bg); align-items:center; justify-content:center; padding:36px 22px; }
.res-em { font-size:64px; margin-bottom:12px; }
.res-tl { font-size:26px; font-weight:700; margin-bottom:5px; text-align:center; }
.res-sub { font-size:13px; color:var(--tx2); margin-bottom:24px; text-align:center; }
.res-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:9px; width:100%; margin-bottom:24px; }
.res-stat { background:var(--sf); border-radius:13px; padding:13px; text-align:center; }
.rs-n { font-size:24px; font-weight:700; }
.rs-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.set-group { background:var(--sf); border-radius:var(--r); margin-bottom:16px; overflow:hidden; }
.set-row { display:flex; align-items:center; padding:13px 14px; gap:9px; border-bottom:1px solid rgba(255,255,255,.05); cursor:pointer; }
.set-row:last-child { border-bottom:none; }
.set-lbl { flex:1; font-size:14px; }
.set-val { font-size:13px; color:var(--tx2); }
.set-sec { font-size:11px; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; font-weight:600; margin-bottom:6px; padding-left:2px; }
.set-inp { background:transparent; border:none; color:var(--tx); font-family:inherit; font-size:13px; outline:none; flex:1; text-align:right; -webkit-user-select:text; user-select:text; -webkit-appearance:none; }
.toggle { width:40px; height:24px; border-radius:12px; background:var(--sf3); position:relative; cursor:pointer; transition:background .3s; flex-shrink:0; border:none; -webkit-appearance:none; }
.toggle.on { background:var(--ac); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:transform .3s; box-shadow:0 1px 3px rgba(0,0,0,.4); }
.toggle.on::after { transform:translateX(16px); }
.sel { background:transparent; border:none; color:var(--tx2); font-size:13px; outline:none; font-family:inherit; -webkit-appearance:none; padding:4px 0; }

.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:50; display:none; align-items:flex-end; }
.modal-bg.on { display:flex; }
.modal-sh { background:var(--sf); border-radius:20px 20px 0 0; padding:18px 16px calc(var(--sb) + 16px); width:100%; max-height:80%; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.modal-hd { width:32px; height:4px; background:rgba(255,255,255,.15); border-radius:2px; margin:0 auto 16px; }
.modal-tl { font-size:17px; font-weight:700; margin-bottom:13px; }
.del-btn { background:rgba(255,76,106,.1); color:var(--rd); border:1px solid rgba(255,76,106,.2); border-radius:11px; padding:12px; font-size:14px; font-weight:600; cursor:pointer; width:100%; font-family:inherit; margin-top:5px; -webkit-appearance:none; }
.del-btn:active { background:rgba(255,76,106,.2); }

.empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:44px 20px; text-align:center; gap:9px; }
.empty-ic { font-size:42px; }
.empty-tl { font-size:16px; font-weight:600; }
.empty-sub { font-size:12px; color:var(--tx2); line-height:1.5; }

.ai-tag { display:inline-block; background:linear-gradient(135deg,var(--ac),var(--ac2)); color:#fff; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; vertical-align:middle; margin-left:3px; }

.ld-bg { position:fixed; inset:0; background:rgba(10,10,15,.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
.ld-bg.on { display:flex; }
.spin { width:42px; height:42px; border:3px solid rgba(124,92,252,.2); border-top-color:var(--ac); border-radius:50%; animation:sp .8s linear infinite; margin-bottom:12px; }
@keyframes sp { to { transform:rotate(360deg); } }
.ld-tx { font-size:13px; color:var(--tx2); }

.toast { position:fixed; top:calc(var(--st) + 12px); left:16px; right:16px; background:var(--sf3); border:1px solid rgba(255,255,255,.1); border-radius:11px; padding:10px 14px; font-size:13px; font-weight:500; text-align:center; z-index:200; transform:translateY(-70px); opacity:0; transition:all .25s ease; pointer-events:none; }
.toast.on { transform:translateY(0); opacity:1; }

/* ---- FLASHCARD ---- */
#s-flash { background:radial-gradient(ellipse at 50% 0%,rgba(92,248,252,.08) 0%,transparent 55%),var(--bg); }
.fl-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.fl-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.fl-fill { height:100%; background:linear-gradient(90deg,var(--ac3),var(--ac)); border-radius:3px; transition:width .35s ease; }
.fl-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.fl-body { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; gap:16px; }
.fl-card { width:100%; max-width:360px; background:var(--sf); border-radius:22px; padding:36px 24px; text-align:center; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; box-shadow:0 4px 32px rgba(0,0,0,.4); transition:transform .2s ease,opacity .2s ease; }
.fl-card.flip { transform:scale(.93); opacity:.4; }
.fl-lang { font-size:11px; font-weight:700; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }
.fl-word { font-size:32px; font-weight:700; line-height:1.2; word-break:break-word; }
.fl-meaning { font-size:22px; color:var(--ac3); font-weight:600; }
.fl-spk { background:rgba(92,248,252,.12); border:none; border-radius:20px; padding:6px 18px; color:var(--ac3); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.fl-controls { display:flex; align-items:center; gap:18px; flex-shrink:0; padding-bottom:calc(var(--sb) + 16px); }
.fl-ctrl-btn { width:52px; height:52px; border-radius:50%; background:var(--sf2); border:none; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--tx); -webkit-appearance:none; }
.fl-ctrl-btn:active { background:var(--sf3); }
.fl-play-btn { width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--ac3),var(--ac)); border:none; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; -webkit-appearance:none; box-shadow:0 4px 16px rgba(124,92,252,.4); }
.fl-play-btn:active { opacity:.85; }

::-webkit-scrollbar { display:none; }
</style>
</head>
<body>
<script id="embedded-data" type="application/json">null</script>
<div id="app">

<div class="ld-bg" id="ld"><div class="spin"></div><div class="ld-tx" id="ld-tx">å‡¦ç†ä¸­...</div></div>
<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal-bg"><div class="modal-sh"><div class="modal-hd"></div><div id="modal-ct"></div></div></div>

<!-- HOME -->
<div class="scr on" id="s-home">
  <div class="home-top">
    <div class="logo">VocabMaster</div>
    <button class="btn btn-ic" id="B-go-settings">âš™ï¸</button>
  </div>
  <div class="scroll">
    <div style="height:14px"></div>
    <div class="stats">
      <div class="stat"><div class="stat-n" id="H-total">0</div><div class="stat-l">ç·å˜èªæ•°</div></div>
      <div class="stat"><div class="stat-n" id="H-mastered">0</div><div class="stat-l">ç¿’å¾—æ¸ˆã¿</div></div>
      <div class="stat"><div class="stat-n" id="H-streak">0</div><div class="stat-l">é€£ç¶šæ—¥æ•°</div></div>
    </div>
    <button class="due-btn" id="B-quiz-due">
      <div class="due-txt"><h3>ä»Šæ—¥ã®å¾©ç¿’</h3><p>å¿˜å´æ›²ç·šã«åŸºã¥ãæœ€é©ã‚¿ã‚¤ãƒŸãƒ³ã‚°</p></div>
      <div class="due-n" id="H-due">0</div>
    </button>
    <div class="act-grid">
      <button class="act-card" id="B-go-add"><span class="act-ic">â•</span><div class="act-title">å˜èªã‚’è¿½åŠ </div><div class="act-sub">ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»AI</div></button>
      <button class="act-card" id="B-quiz-all"><span class="act-ic">âš¡</span><div class="act-title">å…¨å˜èªã‚¯ã‚¤ã‚º</div><div class="act-sub">4æŠå½¢å¼ã§ç·´ç¿’</div></button>
      <button class="act-card" id="B-go-list"><span class="act-ic">ğŸ“š</span><div class="act-title">å˜èªä¸€è¦§</div><div class="act-sub">ç®¡ç†ãƒ»ç·¨é›†</div></button>
      <button class="act-card" id="B-quiz-weak"><span class="act-ic">ğŸ¯</span><div class="act-title">è‹¦æ‰‹å˜èª</div><div class="act-sub">é–“é•ãˆãŸå˜èªã‚’ç‰¹è¨“</div></button>
      <button class="act-card" id="B-study-list" style="border:1.5px solid rgba(124,92,252,.4)"><span class="act-ic">ğŸ“–</span><div class="act-title">äºˆç¿’â†’ã‚¯ã‚¤ã‚º</div><div class="act-sub">ãƒªã‚¹ãƒˆã‚’é¸ã‚“ã§äºˆç¿’ã‹ã‚‰</div></button>
      <button class="act-card" id="B-test-list" style="border:1.5px solid rgba(252,92,125,.4)"><span class="act-ic">ğŸ“</span><div class="act-title">ãƒ†ã‚¹ãƒˆå½¢å¼</div><div class="act-sub">äºˆç¿’ãªã—ãƒ»æ¡ç‚¹ã®ã¿</div></button>
    </div>
    <div class="sec-hdr">
      <div class="sec-title">å˜èªãƒªã‚¹ãƒˆ</div>
      <button class="btn-text" id="B-new-list">ï¼‹ æ–°è¦</button>
    </div>
    <div id="H-lists"></div>
    <div style="margin:18px 0 8px">
      <button id="B-report" style="width:100%;padding:13px;background:var(--sf);border:1.5px solid rgba(92,248,252,.3);border-radius:var(--r);color:var(--ac3);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px">
        <span>ğŸ“Š</span><span>å­¦ç¿’å ±å‘Šæ›¸ã‚’ä½œæˆ</span>
      </button>
    </div>
    <div style="height:14px"></div>
  </div>
  <div class="tabbar">
    <button class="tab on" id="T-home"><div class="tab-ic">ğŸ </div><div class="tab-lb">ãƒ›ãƒ¼ãƒ </div></button>
    <button class="tab" id="T-add"><div class="tab-ic">â•</div><div class="tab-lb">è¿½åŠ </div></button>
    <button class="tab" id="T-list"><div class="tab-ic">ğŸ“š</div><div class="tab-lb">å˜èªå¸³</div></button>
    <button class="tab" id="T-settings"><div class="tab-ic">âš™ï¸</div><div class="tab-lb">è¨­å®š</div></button>
  </div>
</div>

<!-- ADD -->
<div class="scr" id="s-add">
  <div class="hdr">
    <button class="btn btn-back" id="B-add-back">â†</button>
    <div class="hdr-title">å˜èªã‚’è¿½åŠ </div>
  </div>
  <div class="scroll">
    <div class="seg">
      <button class="seg-btn on" id="SG-paste">è²¼ã‚Šä»˜ã‘</button>
      <button class="seg-btn" id="SG-file">ãƒ•ã‚¡ã‚¤ãƒ«</button>
      <button class="seg-btn" id="SG-ai">AIæŠ½å‡º<span class="ai-tag">AI</span></button>
    </div>

    <!-- è¨€èªé¸æŠï¼ˆå…±é€šï¼‰ -->
    <div class="lang-sel-wrap">
      <div class="lang-sel-title">å­¦ç¿’è¨€èªã‚’é¸æŠ</div>
      <div class="lang-sel-grid">
        <button class="lang-sel-btn on" data-lang="en" id="LS-en">ğŸ‡¬ğŸ‡§<br>è‹±èª</button>
        <button class="lang-sel-btn" data-lang="de" id="LS-de">ğŸ‡©ğŸ‡ª<br>ç‹¬èª</button>
        <button class="lang-sel-btn" data-lang="fr" id="LS-fr">ğŸ‡«ğŸ‡·<br>ä»èª</button>
        <button class="lang-sel-btn" data-lang="es" id="LS-es">ğŸ‡ªğŸ‡¸<br>è¥¿èª</button>
        <button class="lang-sel-btn" data-lang="it" id="LS-it">ğŸ‡®ğŸ‡¹<br>ä¼Šèª</button>
      </div>
    </div>

    <!-- PASTE -->
    <div id="TP-paste">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-paste-name" type="text" placeholder="ä¾‹: ãƒ‰ã‚¤ãƒ„èªåŸºç¤å˜èª">
      <div class="lbl">å˜èªãƒªã‚¹ãƒˆï¼ˆ1è¡Œ1å˜èª /ã€Œå˜èª,è¨³ã€å½¢å¼ / JSONãƒ†ã‚­ã‚¹ãƒˆã‚‚å¯ï¼‰</div>
      <textarea class="inp ta" id="IN-paste-text" placeholder="ä¾‹:&#10;Haus&#10;Schule,å­¦æ ¡&#10;arbeiten&#10;schÃ¶n,ç¾ã—ã„"></textarea>
      <div class="hint">JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•èªè­˜ã—ã¾ã™ã€‚è¨³ãªã—ã®å˜èªã¯APIã‚­ãƒ¼è¨­å®šã§AIè‡ªå‹•ç¿»è¨³ã§ãã¾ã™</div>
      <button class="btn-primary" id="B-parse">ğŸ” è§£æã™ã‚‹</button>
    </div>

    <!-- FILE -->
    <div id="TP-file" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-file-name" type="text" placeholder="ä¾‹: Deutsch A1">
      <div class="lbl">å‡¦ç†ãƒ¢ãƒ¼ãƒ‰</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-fmode="vocab" id="FM-vocab" style="flex:1;padding:8px">ğŸ“‹<br>å˜èªãƒªã‚¹ãƒˆ<br><span style="font-size:9px;opacity:.7">CSV/Excel</span></button>
        <button class="opt-btn" data-fmode="json" id="FM-json" style="flex:1;padding:8px">ğŸ“—<br>JSONèª­è¾¼<br><span style="font-size:9px;opacity:.7">å¤–éƒ¨JSON</span></button>
        <button class="opt-btn" data-fmode="extract" id="FM-extract" style="flex:1;padding:8px">âœ¨<br>AIã§æŠ½å‡º<br><span style="font-size:9px;opacity:.7">Word/PDF/TXT</span></button>
      </div>
      <div class="upload" id="B-upload">
        <div class="upload-ic" id="UP-ic">ğŸ“</div>
        <div class="upload-tx">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="upload-sub" id="UP-sub">CSV / Excel (.xlsx)</div>
      </div>
      <input type="file" id="IN-file" accept=".csv,.xlsx,.xls,.txt,.json" style="display:none">
      <div class="hint" id="UP-hint">CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰</div>
      <!-- AIæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰ -->
      <div id="FILE-ai-opts" style="display:none">
        <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
        <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
          <button class="opt-btn on" data-level="all" id="FLV-all">ğŸ”€<br>åŒºåˆ¥ãªã—</button>
          <button class="opt-btn" data-level="beginner" id="FLV-beginner">ğŸŒ±<br>åˆç´š</button>
          <button class="opt-btn" data-level="intermediate" id="FLV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
          <button class="opt-btn" data-level="advanced" id="FLV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
        </div>
        <div class="lbl" style="margin-top:8px">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
        <div style="display:flex;gap:7px;margin-bottom:4px">
          <button class="opt-btn on" data-type="words" id="FTY-words" style="flex:1;padding:7px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-type="phrases" id="FTY-phrases" style="flex:1;padding:7px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
          <button class="opt-btn" data-type="both" id="FTY-both" style="flex:1;padding:7px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
        </div>
      </div>
      <!-- JSONãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div id="FILE-json-opts" style="display:none">
        <div style="background:var(--sf);border-radius:var(--r);padding:11px 13px;margin-bottom:10px;font-size:11px;color:var(--tx2);line-height:1.7">
          ğŸ“— å¯¾å¿œå½¢å¼ï¼š<br>
          <b style="color:var(--tx)">ãƒ‘ã‚¿ãƒ¼ãƒ³C</b>ï¼ˆãƒã‚¹ãƒˆå‹ï¼‰:<br>
          <code style="color:var(--ac3);font-size:10px">{"book_title":"...", "content":{"vocabulary":[...],"phrases":[...]}}</code><br>
          <b style="color:var(--tx)">ã‚·ãƒ³ãƒ—ãƒ«å‹</b>:<br>
          <code style="color:var(--ac3);font-size:10px">{"words":[...]} / [{"word":"...","meaning":"..."}]</code><br>
          å„è¦ç´ ã®ã‚­ãƒ¼åã¯è‡ªå‹•æ¤œå‡ºã—ã¾ã™ï¼ˆword/term/front + meaning/translation/back/definitionï¼‰
        </div>
        <div class="lbl">å–ã‚Šè¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <button class="opt-btn on" data-jsec="all" id="JSEC-all" style="flex:1;padding:7px;font-size:11px">ğŸ“¦<br>ã™ã¹ã¦</button>
          <button class="opt-btn" data-jsec="vocabulary" id="JSEC-vocab" style="flex:1;padding:7px;font-size:11px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-jsec="phrases" id="JSEC-phrase" style="flex:1;padding:7px;font-size:11px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        </div>
      </div>
    </div>

    <!-- AI -->
    <div id="TP-ai" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-ai-name" type="text" placeholder="ä¾‹: å°èª¬ã‹ã‚‰æŠ½å‡º">
      <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
      <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
        <button class="opt-btn on" data-level="all" id="LV-all">ğŸ”€<br>åŒºåˆ¥<br>ãªã—</button>
        <button class="opt-btn" data-level="beginner" id="LV-beginner">ğŸŒ±<br>åˆç´š</button>
        <button class="opt-btn" data-level="intermediate" id="LV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
        <button class="opt-btn" data-level="advanced" id="LV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
      </div>
      <div id="LV-hint" style="font-size:10px;color:var(--tx2);margin-bottom:12px;line-height:1.6;padding:7px 10px;background:var(--sf);border-radius:9px"></div>
      <div class="lbl">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-type="words" id="TY-words" style="flex:1;padding:8px">ğŸ“<br>å˜èªã®ã¿</button>
        <button class="opt-btn" data-type="phrases" id="TY-phrases" style="flex:1;padding:8px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        <button class="opt-btn" data-type="both" id="TY-both" style="flex:1;padding:8px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
      </div>
      <div class="lbl">ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</div>
      <textarea class="inp ta" id="IN-ai-text" style="height:140px" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºãƒ»ç¿»è¨³ã—ã¾ã™ã€‚&#10;&#10;ä¾‹ (ç‹¬): Das Haus ist sehr schÃ¶n und die Schule liegt in der NÃ¤he...&#10;ä¾‹ (è‹±): The enigmatic professor was known for his perspicacious observations..."></textarea>
      <div class="hint">âœ¨ AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚APIã‚­ãƒ¼ãªã—ã§ã‚‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚</div>
      <button class="btn-primary" id="B-ai-extract">âœ¨ AI ã§å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡º</button>
    </div>

    <!-- PREVIEW -->
    <div id="PRV" style="display:none;margin-top:16px">
      <div class="prev-hdr">
        <div class="prev-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="prev-cnt" id="PRV-cnt">0 å˜èª</div>
      </div>
      <div class="prev-list" id="PRV-list"></div>
      <button class="btn-primary" style="margin-top:13px" id="B-save">ğŸ’¾ å˜èªå¸³ã«ä¿å­˜</button>
      <button class="btn-sec" id="B-clr-prv">âœ• ã‚¯ãƒªã‚¢</button>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<!-- LIST -->
<div class="scr" id="s-list">
  <div class="hdr">
    <button class="btn btn-back" id="B-list-back">â†</button>
    <div class="hdr-title">å˜èªä¸€è¦§</div>
    <div style="display:flex;align-items:center;gap:4px">
      <button class="btn" id="B-dup-check" title="é‡è¤‡ãƒã‚§ãƒƒã‚¯" style="font-size:18px;padding:4px 6px">âŠœ</button>
      <button class="btn" id="B-sel-mode" title="é¸æŠãƒ¢ãƒ¼ãƒ‰" style="font-size:17px;padding:4px 6px;color:var(--tx2)">â˜‘</button>
      <select class="sel" id="SEL-list"><option value="all">ã™ã¹ã¦</option></select>
    </div>
  </div>
  <div id="SEL-toolbar" style="display:none;padding:8px 14px;background:var(--sf);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn" id="SEL-all-btn" style="font-size:12px;color:var(--ac);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">å…¨é¸æŠ</button>
      <span id="SEL-count" style="font-size:12px;color:var(--tx2);flex:1;text-align:center">0ä»¶é¸æŠä¸­</span>
      <button class="btn" id="SEL-move-btn" style="font-size:12px;color:var(--ac3);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">âœ¦ ç§»å‹•</button>
      <button class="btn" id="SEL-del-btn" style="font-size:12px;color:var(--rd);font-weight:600;padding:5px 10px;background:rgba(255,76,106,.1);border-radius:8px">ğŸ—‘ å‰Šé™¤</button>
    </div>
  </div>
  <div class="srch-wrap">
    <input class="srch" id="IN-search" type="search" placeholder="å˜èªã‚’æ¤œç´¢...">
  </div>
  <div class="filter-bar" id="LANG-filter">
    <button class="flt-btn on" data-lang="all">ã™ã¹ã¦</button>
    <button class="flt-btn" data-lang="en">ğŸ‡¬ğŸ‡§ è‹±èª</button>
    <button class="flt-btn" data-lang="de">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª</button>
    <button class="flt-btn" data-lang="fr">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª</button>
    <button class="flt-btn" data-lang="es">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª</button>
    <button class="flt-btn" data-lang="it">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª</button>
  </div>
  <div class="filter-bar" id="STATUS-filter" style="padding-top:6px">
    <button class="flt-btn on" data-status="all">ğŸ“‹ ã™ã¹ã¦</button>
    <button class="flt-btn" data-status="studied">âœ… å­¦ç¿’æ¸ˆã¿</button>
    <button class="flt-btn" data-status="missed">âŒ é–“é•ã„</button>
    <button class="flt-btn" data-status="dontknow">â“ ä¸æ˜</button>
    <button class="flt-btn" data-status="new">ğŸ†• æœªå­¦ç¿’</button>
  </div>
  <div style="display:flex;align-items:center;gap:7px;padding:6px 16px 0;flex-shrink:0">
    <span style="font-size:11px;color:var(--tx2);white-space:nowrap">ä¸¦ã³æ›¿ãˆ:</span>
    <div class="filter-bar" id="SORT-filter" style="padding:0;flex:1;overflow-x:scroll">
      <button class="flt-btn on" data-sort="default">ç™»éŒ²é †</button>
      <button class="flt-btn" data-sort="missed">é–“é•ã„å¤š</button>
      <button class="flt-btn" data-sort="slow">æ™‚é–“ãŒã‹ã‹ã‚‹</button>
      <button class="flt-btn" data-sort="level-asc">ãƒ¬ãƒ™ãƒ«ä½â†‘</button>
      <button class="flt-btn" data-sort="level-desc">ãƒ¬ãƒ™ãƒ«é«˜â†‘</button>
    </div>
  </div>
  <div class="scroll" style="padding-top:10px">
    <div id="L-words"></div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- FLASHCARD -->
<div class="scr" id="s-flash">
  <div class="fl-hdr">
    <button class="btn btn-back" id="B-flash-exit">âœ•</button>
    <div class="fl-prog"><div class="fl-fill" id="FL-fill" style="width:0%"></div></div>
    <div class="fl-cnt" id="FL-cnt">1/0</div>
  </div>
  <div class="fl-body">
    <div class="fl-card" id="FL-card">
      <div class="fl-lang" id="FL-lang">è‹±èª</div>
      <div class="fl-word" id="FL-word">word</div>
      <div class="fl-meaning" id="FL-meaning"></div>
      <button class="fl-spk" id="FL-spk">ğŸ”Š ç™ºéŸ³</button>
    </div>
  </div>
  <div class="fl-controls">
    <button class="fl-ctrl-btn" id="FL-prev">â€¹â€¹</button>
    <button class="fl-play-btn" id="FL-play">â–¶</button>
    <button class="fl-ctrl-btn" id="FL-next">â€ºâ€º</button>
  </div>
  <button class="btn-primary" id="FL-to-quiz" style="margin:0 16px calc(var(--sb) + 16px);flex-shrink:0">âš¡ ã“ã®ã¾ã¾ã‚¯ã‚¤ã‚ºã¸</button>
  <div id="FL-auto-quiz-overlay" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.75);z-index:100;flex-direction:column;align-items:center;justify-content:center;gap:16px">
    <div style="font-size:20px;font-weight:700;color:#fff">ğŸ‰ äºˆç¿’å®Œäº†ï¼</div>
    <div style="font-size:15px;color:rgba(255,255,255,.8)" id="FL-aq-msg">3ç§’å¾Œã«ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¾ã™</div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button id="FL-aq-now" style="padding:11px 24px;background:linear-gradient(135deg,var(--ac),var(--ac2));border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">ä»Šã™ãé–‹å§‹</button>
      <button id="FL-aq-cancel" style="padding:11px 20px;background:var(--sf2);border:1px solid rgba(255,255,255,.15);border-radius:12px;color:var(--tx2);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="scr" id="s-quiz">
  <div class="qz-hdr">
    <button class="btn btn-back" id="B-quiz-exit">âœ•</button>
    <div class="qz-prog"><div class="qz-fill" id="QZ-fill" style="width:0%"></div></div>
    <div style="display:flex;align-items:center;gap:7px">
      <div id="QZ-mode-badge" style="display:none;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(252,92,125,.2);color:var(--ac2)">ğŸ“ ãƒ†ã‚¹ãƒˆ</div>
      <div class="qz-cnt" id="QZ-cnt">0/0</div>
    </div>
  </div>
  <div class="qz-body">
    <div class="qz-card">
      <div class="qz-badge" id="QZ-badge">æ—¥æœ¬èªã‚’é¸ã¹</div>
      <div class="qz-word" id="QZ-word">word</div>
      <button id="B-speak" style="margin-top:10px;background:rgba(124,92,252,.15);border:none;border-radius:20px;padding:6px 16px;color:var(--ac);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:none">ğŸ”Š ç™ºéŸ³</button>
    </div>
    <div class="choices" id="QZ-choices"></div>
  </div>
  <div class="fb" id="FB">
    <div><div class="fb-tx" id="FB-tx"></div><div class="fb-dt" id="FB-dt"></div></div>
    <button class="fb-next" id="B-next">æ¬¡ã¸ â†’</button>
  </div>
</div>

<!-- RESULT -->
<div class="scr" id="s-result">
  <div class="res-em" id="R-em">ğŸ‰</div>
  <div class="res-tl" id="R-tl">ã‚ˆãã§ãã¾ã—ãŸï¼</div>
  <div class="res-sub" id="R-sub">å­¦ç¿’å®Œäº†</div>
  <div class="res-stats">
    <div class="res-stat"><div class="rs-n" id="R-ok" style="color:var(--gn)">0</div><div class="rs-l">æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ng" style="color:var(--rd)">0</div><div class="rs-l">ä¸æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ac" style="color:var(--ac)">0%</div><div class="rs-l">æ­£è§£ç‡</div></div>
  </div>
  <button class="btn-primary" id="B-res-home" style="width:260px">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <button class="btn-sec" id="B-res-weak" style="width:260px">ğŸ¯ é–“é•ã„ã‚’å¾©ç¿’</button>
</div>

<!-- SETTINGS -->
<div class="scr" id="s-settings">
  <div class="hdr">
    <button class="btn btn-back" id="B-set-back">â†</button>
    <div class="hdr-title">è¨­å®š</div>
  </div>
  <div class="scroll">
    <div class="set-sec">AI è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <span class="set-lbl">ğŸ”‘ Anthropic APIã‚­ãƒ¼</span>
        <input type="password" class="inp" id="IN-apikey" placeholder="sk-ant-..." style="margin-bottom:0;font-size:13px;padding:10px 12px">
        <button class="btn-primary" id="B-save-key" style="padding:10px;font-size:13px">ğŸ’¾ APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
        <div id="KEY-status" style="font-size:11px;text-align:center;padding:2px 0"></div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨AIç¿»è¨³ãƒ»å˜èªæŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚ã‚­ãƒ¼ã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</span>
      </div>
    </div>
    <div class="set-sec">å­¦ç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ“Š 1ã‚»ãƒƒã‚·ãƒ§ãƒ³å•é¡Œæ•°</span>
        <input type="number" id="SEL-size" min="1" max="200" value="20"
          style="width:64px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
        <span style="font-size:13px;color:var(--tx2)">å•</span>
      </div>
      <div class="set-row" id="ROW-random">
        <span class="set-lbl">ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆæœªå‡ºé¡Œã‹ã‚‰ï¼‰</span>
        <button class="toggle" id="TG-random"></button>
      </div>
      <div class="set-row" id="ROW-rev">
        <span class="set-lbl">ğŸ”„ é€†ã‚¯ã‚¤ã‚ºï¼ˆæ—¥â†’å¤–å›½èªï¼‰æ··åœ¨</span>
        <button class="toggle" id="TG-rev"></button>
      </div>
      <div class="set-row" id="ROW-speak">
        <span class="set-lbl">ğŸ”Š ã‚¯ã‚¤ã‚ºæ™‚ã«è‡ªå‹•èª­ã¿ä¸Šã’</span>
        <button class="toggle" id="TG-speak"></button>
      </div>
      <div class="set-row" id="ROW-autonext">
        <span class="set-lbl">â­ï¸ ã‚¯ã‚¤ã‚ºæ­£è§£æ™‚ã«è‡ªå‹•ã§æ¬¡ã¸</span>
        <button class="toggle" id="TG-autonext"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ” ä¸æ­£è§£æ™‚ã®å†å‡ºé¡Œå›æ•°</span>
        <div style="display:flex;gap:5px">
          <button class="opt-btn" data-rq="0" id="RQ-0" style="padding:5px 10px;font-size:12px">ãªã—</button>
          <button class="opt-btn" data-rq="1" id="RQ-1" style="padding:5px 10px;font-size:12px">1å›</button>
          <button class="opt-btn" data-rq="2" id="RQ-2" style="padding:5px 10px;font-size:12px">2å›</button>
          <button class="opt-btn" data-rq="3" id="RQ-3" style="padding:5px 10px;font-size:12px">3å›</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">â±ï¸ è‡ªå‹•é€²è¡Œã®å¾…æ©Ÿæ™‚é–“</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-autonext-sec" min="0.5" max="10" step="0.5" value="1.5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">âš ï¸ å¾…æ©Ÿæ™‚é–“ã¯äºˆç¿’ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã«ã‚‚ä½¿ã‚ã‚Œã¾ã™ï¼ˆå˜èª+è¨³ã®èª­ã¿ä¸Šã’å¾Œã«æ¬¡ã¸ï¼‰</span>
      </div>
    </div>
    <div class="set-sec">äºˆç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" id="ROW-flashauto">
        <span class="set-lbl">â–¶ï¸ äºˆç¿’ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•å†ç”Ÿ</span>
        <button class="toggle" id="TG-flashauto"></button>
      </div>
      <div class="set-row" id="ROW-autoQuiz">
        <span class="set-lbl">âš¡ äºˆç¿’å®Œäº†å¾Œã«è‡ªå‹•ã§ã‚¯ã‚¤ã‚ºã¸</span>
        <button class="toggle" id="TG-autoQuiz"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ”Š èª­ã¿ä¸Šã’ã‚‹è¨€èª</span>
        <div style="display:flex;gap:6px">
          <button class="opt-btn on" id="SPK-both" style="padding:5px 10px;font-size:12px">ä¸¡æ–¹</button>
          <button class="opt-btn" id="SPK-foreign" style="padding:5px 10px;font-size:12px">å¤–å›½èªã®ã¿</button>
          <button class="opt-btn" id="SPK-ja" style="padding:5px 10px;font-size:12px">æ—¥æœ¬èªã®ã¿</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">â±ï¸ ã‚«ãƒ¼ãƒ‰åˆ‡æ›¿é–“éš”</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-flash-sec" min="1" max="15" step="0.5" value="2"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸµ èª­ã¿ä¸Šã’ä¸­ã®éŸ³æ¥½éŸ³é‡</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-duck-vol" min="0" max="80" step="5" value="15"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">%</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">èª­ã¿ä¸Šã’ä¸­ã®éŸ³æ¥½ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä¸‹ã’ã¾ã™ã€‚0%ã§ç„¡éŸ³ã€100%ã§å¤‰åŒ–ãªã—ã€‚</span>
      </div>
    </div>
    <div class="set-sec">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>
    <div class="set-group">
      <div class="set-row" id="ROW-cloudauto">
        <span class="set-lbl">ğŸ”„ ã‚¯ãƒ©ã‚¦ãƒ‰è‡ªå‹•ä¿å­˜ï¼ˆ5åˆ†ã”ã¨ï¼‰</span>
        <button class="toggle" id="TG-cloudauto"></button>
      </div>
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <div style="font-size:11px;color:var(--tx2);line-height:1.6;padding:2px 0">åŒã˜Claudeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸåˆ¥ãƒ‡ãƒã‚¤ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•åŒæœŸã§ãã¾ã™ã€‚</div>
        <button class="btn-primary" id="B-cloud-save" style="padding:10px;font-size:13px">â˜ï¸ ä»Šã™ãä¿å­˜</button>
        <button class="btn-sec" id="B-cloud-load" style="padding:10px;font-size:13px;margin-top:0">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
        <div id="CLOUD-status" style="font-size:11px;text-align:center;color:var(--tx2);padding:2px 0;min-height:16px"></div>
      </div>
    </div>
    <div class="set-sec">ãƒ‡ãƒ¼ã‚¿</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;padding:10px 16px">
        <button class="btn-primary" id="B-save-file" style="width:100%;padding:12px;font-size:14px;font-weight:700">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆiCloudç”¨ï¼‰</button>
      </div>
      <div class="set-row" style="cursor:default;padding:0 16px 10px">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚“ã HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚iCloudã«ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„ã€‚</span>
      </div>
      <div class="set-row" id="B-export"><span class="set-lbl">ğŸ“¤ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-export-select"><span class="set-lbl">ğŸ“‹ ãƒªã‚¹ãƒˆã‚’é¸ã‚“ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-export-csv"><span class="set-lbl">ğŸ“Š CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-qr"><span class="set-lbl">ğŸ“± QRã‚³ãƒ¼ãƒ‰ã§è»¢é€</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-import-row"><span class="set-lbl">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¿½åŠ çµ±åˆï¼‰</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-reset"><span class="set-lbl" style="color:var(--rd)">ğŸ—‘ï¸ ã™ã¹ã¦å‰Šé™¤</span><span class="set-val">â†’</span></div>
    </div>
    <div style="text-align:center;padding:16px;color:var(--tx2);font-size:11px">VocabMaster v2.0 â€” å¤šè¨€èªå¯¾å¿œç‰ˆ</div>
    <div style="height:20px"></div>
  </div>
</div>

</div>
<input type="file" id="IN-import" accept=".json" style="display:none">

<script>
var MEM=null, DBKEY='vm3';
function sGet(){
  /* ã¾ãšHTMLã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª */
  try{var ed=document.getElementById('embedded-data');if(ed&&ed.textContent&&ed.textContent!=='null'){var v=JSON.parse(ed.textContent);if(v)return v;}}catch(e){}
  /* æ¬¡ã«localStorageã‚’ç¢ºèª */
  try{var v=localStorage.getItem(DBKEY);return v?JSON.parse(v):null;}catch(e){return MEM;}
}
function sSet(v){
  try{localStorage.setItem(DBKEY,JSON.stringify(v));}catch(e){}
  MEM=v;
}

/* â”€â”€ Claudeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŒæœŸ â”€â”€ */
var CLOUD_KEY='vocabmaster-sync-v1';
function cloudStatus(msg,clr){var el=document.getElementById('CLOUD-status');if(el){el.textContent=msg;el.style.color=clr||'var(--tx2)';}}

/* â”€â”€ è‡ªå‹•ä¿å­˜ï¼šãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆæœ€å¾Œã®save()ã‹ã‚‰5åˆ†å¾Œã«å®Ÿè¡Œã€é‡è¤‡ã—ãªã„ï¼‰ â”€â”€ */
var _autoSaveTimer=null;
var AUTO_SAVE_DELAY=5*60*1000; /* 5åˆ† */

function scheduleAutoCloudSave(){
  if(!G.cfg.cloudAuto) return;       /* è‡ªå‹•ä¿å­˜OFFãªã‚‰ä½•ã‚‚ã—ãªã„ */
  if(!window.storage) return;        /* ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒä½¿ãˆãªã„ç’°å¢ƒ */
  if(_autoSaveTimer) clearTimeout(_autoSaveTimer);
  _autoSaveTimer=setTimeout(function(){
    _autoSaveTimer=null;
    cloudSaveAuto();
  }, AUTO_SAVE_DELAY);
}

async function cloudSaveAuto(){
  /* ã‚µã‚¤ãƒ¬ãƒ³ãƒˆä¿å­˜ï¼ˆãƒœã‚¿ãƒ³UIæ“ä½œãªã—ãƒ»ãƒˆãƒ¼ã‚¹ãƒˆæœ€å°é™ï¼‰ */
  if(!window.storage||!G.cfg.cloudAuto) return;
  try{
    var payload=JSON.stringify(G);
    if(payload.length>4*1024*1024) return; /* å¤§ãã™ãã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— */
    var result=await window.storage.set(CLOUD_KEY, payload);
    if(result){
      var now=new Date();
      var ts=now.getFullYear()+'/'+(now.getMonth()+1)+'/'+now.getDate()+' '+now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
      cloudStatus('ğŸ”„ è‡ªå‹•ä¿å­˜å®Œäº† â€” '+ts,'var(--gn)');
      /* ãƒ›ãƒ¼ãƒ ç”»é¢ã«ã„ã‚‹å ´åˆã®ã¿ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‡ºã™ï¼ˆã‚¯ã‚¤ã‚ºä¸­ã¯é‚ªé­”ã—ãªã„ï¼‰ */
      if(document.getElementById('s-home').classList.contains('on')){
        toast('â˜ï¸ è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
      }
    }
  }catch(e){ /* è‡ªå‹•ä¿å­˜å¤±æ•—ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«ç„¡è¦– */ }
}

async function cloudSave(){
  if(!window.storage){cloudStatus('âš ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“','var(--rd)');return;}
  var btn=document.getElementById('B-cloud-save');
  if(btn){btn.disabled=true;btn.textContent='ä¿å­˜ä¸­...';}
  cloudStatus('','');
  try{
    var payload=JSON.stringify(G);
    if(payload.length>4*1024*1024){cloudStatus('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ï¼ˆ4MBè¶…ï¼‰','var(--rd)');return;}
    var result=await window.storage.set(CLOUD_KEY, payload);
    if(result){
      var now=new Date();
      var ts=now.getFullYear()+'/'+(now.getMonth()+1)+'/'+now.getDate()+' '+now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
      cloudStatus('âœ… ä¿å­˜å®Œäº† â€” '+ts,'var(--gn)');
      toast('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ');
    }else{
      cloudStatus('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','var(--rd)');
    }
  }catch(e){
    cloudStatus('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+e.message,'var(--rd)');
  }finally{
    if(btn){btn.disabled=false;btn.textContent='â˜ï¸ ä»Šã™ãä¿å­˜';}
  }
}

/* èµ·å‹•æ™‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚ˆã‚Šæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°é€šçŸ¥ */
async function cloudCheckOnStartup(){
  if(!window.storage) return;
  try{
    var result=await window.storage.get(CLOUD_KEY);
    if(!result||!result.value) return;
    var remote=JSON.parse(result.value);
    var remoteWords=(remote.words||[]).length;
    var localWords=G.words.length;
    /* ã‚¯ãƒ©ã‚¦ãƒ‰ã®å˜èªæ•°ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‚ˆã‚Šå¤šã„å ´åˆã®ã¿ææ¡ˆ */
    if(remoteWords>localWords){
      setTimeout(function(){
        var msg='â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™\n\nã‚¯ãƒ©ã‚¦ãƒ‰: '+remoteWords+'å˜èª / ãƒ­ãƒ¼ã‚«ãƒ«: '+localWords+'å˜èª\n\nã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰';
        if(confirm(msg)){
          var savedKey=(G.cfg&&G.cfg.key)||'';
          G=remote;
          if(savedKey&&(!G.cfg||!G.cfg.key)){if(!G.cfg)G.cfg={};G.cfg.key=savedKey;}
          sSet(G);
          homeRefresh();
          toast('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ'+remoteWords+'å˜èªï¼‰');
        }
      }, 800);
    }
  }catch(e){ /* èµ·å‹•æ™‚ãƒã‚§ãƒƒã‚¯å¤±æ•—ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«ç„¡è¦– */ }
}

async function cloudLoad(){
  if(!window.storage){cloudStatus('âš ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“','var(--rd)');return;}
  var btn=document.getElementById('B-cloud-load');
  if(btn){btn.disabled=true;btn.textContent='èª­ã¿è¾¼ã¿ä¸­...';}
  cloudStatus('','');
  try{
    var result=await window.storage.get(CLOUD_KEY);
    if(!result||!result.value){cloudStatus('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“','var(--tx2)');toast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');return;}
    var remote=JSON.parse(result.value);
    /* ä»¶æ•°è¡¨ç¤ºã—ã¦ç¢ºèª */
    var lists=(remote.lists||[]).length;
    var words=(remote.words||[]).length;
    var msg='ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿:\nãƒªã‚¹ãƒˆ '+lists+' ä»¶ / å˜èª '+words+' ä»¶\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¨ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ\nï¼ˆç½®ãæ›ãˆå‰ã«ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼‰';
    if(!confirm(msg))return;
    var savedKey=(G.cfg&&G.cfg.key)||'';
    G=remote;
    /* ç¾åœ¨ãƒ‡ãƒã‚¤ã‚¹ã®APIã‚­ãƒ¼ã‚’å„ªå…ˆã—ã¦ä¿æŒ */
    if(savedKey&&!G.cfg.key){if(!G.cfg)G.cfg={};G.cfg.key=savedKey;}
    sSet(G);
    homeRefresh();listFilterRebuild();listRender();
    cloudStatus('âœ… èª­ã¿è¾¼ã¿å®Œäº† â€” ãƒªã‚¹ãƒˆ'+lists+'ä»¶ / å˜èª'+words+'ä»¶','var(--gn)');
    toast('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  }catch(e){
    cloudStatus('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+e.message,'var(--rd)');
  }finally{
    if(btn){btn.disabled=false;btn.textContent='ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€';}
  }
}

var EASE0=2.5, EMIN=1.3;

/* è¨€èªå®šç¾© */
var LANGS={
  en:{name:'è‹±èª',flag:'ğŸ‡¬ğŸ‡§',cls:'lang-en'},
  de:{name:'ãƒ‰ã‚¤ãƒ„èª',flag:'ğŸ‡©ğŸ‡ª',cls:'lang-de'},
  fr:{name:'ãƒ•ãƒ©ãƒ³ã‚¹èª',flag:'ğŸ‡«ğŸ‡·',cls:'lang-fr'},
  es:{name:'ã‚¹ãƒšã‚¤ãƒ³èª',flag:'ğŸ‡ªğŸ‡¸',cls:'lang-es'},
  it:{name:'ã‚¤ã‚¿ãƒªã‚¢èª',flag:'ğŸ‡®ğŸ‡¹',cls:'lang-it'}
};

function mkDB(){return{words:[],lists:[],logs:[],cfg:{size:20,random:true,rev:false,speak:true,autonext:false,autonextSec:1.5,flashSec:2,flashAuto:false,spkMode:'both',duckVol:15,key:'',requeueMax:1},stats:{streak:0,lastDay:''}};}
var G=sGet()||mkDB();
function save(){sSet(G);clearWordLogCache();scheduleAutoCloudSave();}

/* â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆHTMLã«ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ï¼‰ â”€â”€ */
function saveAsFile(){
  var data=JSON.stringify(G);
  var current=document.documentElement.outerHTML;
  var marker='embedded-data" type="application/json">';
  var si=current.indexOf(marker);
  if(si<0){toast('ä¿å­˜ã‚¨ãƒ©ãƒ¼');return;}
  si+=marker.length;
  var ei=current.indexOf('</',si);
  var updated=current.slice(0,si)+data+current.slice(ei);
  var blob=new Blob([updated],{type:'text/html;charset=utf-8'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='vocab-master.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}


/* SRS */
function lvl(w){var s=w.s;if(!s)return 0;if(s.i>=60)return 5;if(s.i>=30)return 4;if(s.i>=14)return 3;if(s.i>=7)return 2;if(s.i>=3)return 1;return 0;}
function due(w){if(!w.s||!w.s.d)return true;return new Date(w.s.d)<=new Date();}
function answer(w,ok){
  if(Q.testMode)return; /* ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯SRSæ›´æ–°ã—ãªã„ */
  if(!w.s)w.s={i:1,e:EASE0,d:null,k:0,l:0};
  var s=w.s;
  if(ok){s.k=(s.k||0)+1;if(s.k<=1)s.i=1;else if(s.k===2)s.i=3;else s.i=Math.round(s.i*s.e);s.e=Math.min(3.0,s.e+0.1);}
  else{s.l=(s.l||0)+1;s.k=0;s.i=1;s.e=Math.max(EMIN,s.e-0.2);}
  s.i=Math.max(1,Math.min(s.i,365));
  var dt=new Date();dt.setDate(dt.getDate()+s.i);s.d=dt.toISOString();w.lr=new Date().toISOString();save();
}
function getDue(){return G.words.filter(due);}
function getWeak(){return G.words.filter(function(w){return w.s&&(w.s.l||0)>0;}).sort(function(a,b){return(b.s.l||0)-(a.s.l||0);});}

/* NAV */
var SCREENS=['s-home','s-add','s-list','s-flash','s-quiz','s-result','s-settings'];
var TABMAP={'s-home':'T-home','s-add':'T-add','s-list':'T-list','s-settings':'T-settings'};
function go(id){
  /* é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ */
  if(selModeOn&&id!=='s-list'){selModeOn=false;selSet={};var tb=document.getElementById('SEL-toolbar');if(tb)tb.style.display='none';var sb=document.getElementById('B-sel-mode');if(sb)sb.style.color='var(--tx2)';}
  SCREENS.forEach(function(s){el(s).classList.remove('on');});
  el(id).classList.add('on');
  ['T-home','T-add','T-list','T-settings'].forEach(function(t){el(t).classList.remove('on');});
  if(TABMAP[id])el(TABMAP[id]).classList.add('on');
  if(id==='s-home')homeRefresh();
  if(id==='s-list'){if(selModeOn)toggleSelMode();listFilterRebuild();listRender();}
  if(id==='s-settings')settingsLoad();
}

/* HELPERS */
function el(id){return document.getElementById(id);}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
var _tt=null;
function toast(msg){var t=el('toast');t.textContent=msg;t.classList.add('on');if(_tt)clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('on');},2800);}
function loading(msg){el('ld-tx').textContent=msg||'å‡¦ç†ä¸­...';el('ld').classList.add('on');}
function loaded(){el('ld').classList.remove('on');}
function shuffle(a){var b=a.slice();for(var i=b.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=b[i];b[i]=b[j];b[j]=t;}return b;}
function uid(){return '_'+(Date.now()%1e9)+'_'+(Math.random()*1e6|0);}
function langBadge(lang){var l=LANGS[lang||'en'];if(!l)return'';return'<span class="lang-badge '+l.cls+'">'+l.flag+' '+l.name+'</span>';}

/* HOME */
function homeRefresh(){
  el('H-total').textContent=G.words.length;
  el('H-mastered').textContent=G.words.filter(function(w){return w.s&&w.s.i>=14;}).length;
  el('H-streak').textContent=G.stats.streak||0;
  el('H-due').textContent=getDue().length;
  homeListsRender();
}
function homeListsRender(){
  var c=el('H-lists');
  if(!G.lists.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“–</div><div class="empty-tl">å˜èªãƒªã‚¹ãƒˆãªã—</div><div class="empty-sub">ã€Œå˜èªã‚’è¿½åŠ ã€ã‹ã‚‰<br>æ–°ã—ã„å˜èªã‚’ç™»éŒ²ã—ã‚ˆã†</div></div>';return;}
  var h='';
  G.lists.forEach(function(lst){
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var d=ws.filter(due).length;
    var l=LANGS[lst.lang||'en'];
    var cursor=lst.cursor||0;
    var total=ws.length;
    var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
    var progClr=pct>=100?'var(--gn)':pct>=60?'var(--ac3)':pct>=30?'var(--ac)':'var(--ac2)';
    var nextN=Math.min(parseInt(G.cfg.size)||20, total-cursor);
    var progLabel=pct>=100?'âœ… å…¨å˜èªå®Œäº†ï¼':'æ¬¡å›: '+cursor+'ã€œ'+(cursor+nextN)+'ç•ªç›® ('+pct+'%)';
    h+='<div class="swipe-wrap" data-lid="'+esc(lst.id)+'">'+
      '<div class="swipe-del-bg"><span>ğŸ—‘ï¸</span>å‰Šé™¤</div>'+
      '<div class="swipe-inner">'+
        '<button class="list-card" data-lid="'+esc(lst.id)+'" style="padding-bottom:8px">'+
          '<div class="list-ic" style="background:'+lst.clr+'20">'+(l?l.flag:'ğŸ“—')+'</div>'+
          '<div class="list-inf">'+
            '<div class="list-name">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
            '<div class="list-meta">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div>'+
            '<div style="margin-top:7px">'+
              '<div class="lc-prog-bar"><div class="lc-prog-fill" style="width:'+pct+'%;background:'+progClr+'"></div></div>'+
              '<div class="lc-prog-txt"><span>'+progLabel+'</span><span style="font-weight:600;color:'+progClr+'">'+pct+'%</span></div>'+
            '</div>'+
          '</div>'+
          (d?'<div class="list-badge" style="align-self:flex-start">'+d+'</div>':'')+'</button>'+
      '</div>'+
    '</div>';
  });
  c.innerHTML=h;

  /* ã‚¿ãƒƒãƒ—ã§listMenu */
  c.querySelectorAll('.list-card').forEach(function(b){
    b.addEventListener('click',function(){
      var inner=this.closest('.swipe-inner');
      if(inner&&inner.classList.contains('swiped')){
        /* ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã¯ã‚¿ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒªã‚»ãƒƒãƒˆ */
        inner.classList.remove('swiped');return;
      }
      listMenu(this.getAttribute('data-lid'));
    });
  });

  /* ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ */
  c.querySelectorAll('.swipe-wrap').forEach(function(wrap){
    var inner=wrap.querySelector('.swipe-inner');
    var startX,startY,dx,isDragging=false,isSwipe=false;

    inner.addEventListener('touchstart',function(e){
      startX=e.touches[0].clientX;
      startY=e.touches[0].clientY;
      dx=0; isDragging=true; isSwipe=false;
      inner.style.transition='none';
    },{passive:true});

    inner.addEventListener('touchmove',function(e){
      if(!isDragging)return;
      dx=e.touches[0].clientX-startX;
      var dy=e.touches[0].clientY-startY;
      if(!isSwipe&&Math.abs(dy)>Math.abs(dx)){isDragging=false;return;}
      if(Math.abs(dx)>8)isSwipe=true;
      if(!isSwipe)return;
      var already=inner.classList.contains('swiped')?-90:0;
      var tx=Math.min(0,Math.max(-90,already+dx));
      inner.style.transform='translateX('+tx+'px)';
    },{passive:true});

    inner.addEventListener('touchend',function(){
      if(!isDragging){inner.style.transition='';return;}
      isDragging=false;
      inner.style.transition='transform .2s ease';
      var already=inner.classList.contains('swiped')?-90:0;
      var total=already+dx;
      if(total<-40){
        /* å‰Šé™¤ã‚¾ãƒ¼ãƒ³è¡¨ç¤º */
        inner.style.transform='translateX(-90px)';
        inner.classList.add('swiped');
      } else {
        inner.style.transform='';
        inner.classList.remove('swiped');
      }
    });
  });

  /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèµ¤ã„ã‚¾ãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒ—ï¼‰ */
  c.querySelectorAll('.swipe-del-bg').forEach(function(btn){
    btn.addEventListener('click',function(){
      var lid=this.closest('.swipe-wrap').getAttribute('data-lid');
      deleteList(lid);
    });
  });
}

function deleteList(lid){
  var lst=G.lists.find(function(l){return l.id===lid;});
  if(!lst)return;
  var cnt=G.words.filter(function(w){return w.lid===lid;}).length;
  if(!confirm('ã€Œ'+lst.name+'ã€ï¼ˆ'+cnt+'å˜èªï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;
  G.lists=G.lists.filter(function(l){return l.id!==lid;});
  G.words=G.words.filter(function(w){return w.lid!==lid;});
  save();homeRefresh();toast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* ADD */
var addMode='paste', prevWords=[], selLang='en', selLevel='all', selType='words';

function segSwitch(mode){
  addMode=mode;
  ['paste','file','ai'].forEach(function(m){el('TP-'+m).style.display=m===mode?'block':'none';el('SG-'+m).classList.toggle('on',m===mode);});
  prvHide();
}

function setLang(lang){
  selLang=lang;
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-lang')===lang);});
  updateLevelHint();
  /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–° */
  var ph={en:'ä¾‹:\nabandon\nabsolute,çµ¶å¯¾çš„ãª',de:'ä¾‹:\nHaus\nSchule,å­¦æ ¡\narbeiten\nschÃ¶n,ç¾ã—ã„',fr:'ä¾‹:\nmaison\nÃ©cole,å­¦æ ¡\ntravail,ä»•äº‹',es:'ä¾‹:\ncasa\nescuela,å­¦æ ¡\ntrabajo,ä»•äº‹',it:'ä¾‹:\ncasa\nscuola,å­¦æ ¡\nlavoro,ä»•äº‹'};
  var ta=el('IN-paste-text');if(ta)ta.placeholder=ph[lang]||ph.en;
}

function parsePaste(){
  var txt=el('IN-paste-text').value.trim();
  if(!txt){toast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  /* JSONãƒ†ã‚­ã‚¹ãƒˆã‚’è‡ªå‹•æ¤œå‡º */
  if(txt.charAt(0)==='{' || txt.charAt(0)==='['){
    try{
      JSON.parse(txt);
      var ni=el('IN-paste-name');
      jsonImport(txt, (ni&&ni.value.trim())||'è²¼ã‚Šä»˜ã‘ãƒªã‚¹ãƒˆ');
      return;
    }catch(e){}
  }
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim();var m=(p[1]||'').trim();
    if(w)words.push({word:w,meaning:m});
  });
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function needTranslate(words){return G.cfg.key&&words.some(function(w){return !w.meaning;});}

/* ---- FILE MODE ---- */
var fileMode='vocab'; /* vocab | extract */
var fileSelLevel='all', fileSelType='words';

function setFileMode(mode){
  fileMode=mode;
  document.querySelectorAll('[data-fmode]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-fmode')===mode);});
  var isExtract=(mode==='extract');
  var isJson=(mode==='json');
  el('FILE-ai-opts').style.display=isExtract?'block':'none';
  el('FILE-json-opts').style.display=isJson?'block':'none';
  if(isJson){
    el('UP-ic').textContent='ğŸ“—';
    el('UP-sub').textContent='JSON ãƒ•ã‚¡ã‚¤ãƒ« (.json)';
    el('UP-hint').textContent='book_title / content / vocabulary / phrases ãªã©ã‚’è‡ªå‹•èªè­˜ã—ã¾ã™';
    el('IN-file').accept='.json';
  } else if(isExtract){
    el('UP-ic').textContent='ğŸ“„';
    el('UP-sub').textContent='Word (.docx) / PDF / TXT / CSV';
    el('UP-hint').textContent='âœ¨ AIãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‹ã‚‰å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™';
    el('IN-file').accept='.txt,.csv,.docx,.pdf';
  } else {
    el('UP-ic').textContent='ğŸ“';
    el('UP-sub').textContent='CSV / Excel (.xlsx)';
    el('UP-hint').textContent='CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰';
    el('IN-file').accept='.csv,.xlsx,.xls,.txt';
  }
}

function setFileLevel(level){
  fileSelLevel=level;
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
}

function setFileType(type){
  fileSelType=type;
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function handleFile(evt){
  var f=evt.target.files[0];if(!f)return;evt.target.value='';
  var ext=f.name.split('.').pop().toLowerCase();
  var ni=el('IN-file-name');
  if(ni&&!ni.value)ni.value=f.name.replace(/\.[^.]+$/,'');

  if(fileMode==='json'||ext==='json'){
    var fr=new FileReader();
    fr.onload=function(e){jsonImport(e.target.result, f.name);};
    fr.readAsText(f,'UTF-8');
    return;
  }

  if(fileMode==='extract'){
    /* AIæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰: ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šå‡ºã—ã¦AIã¸ */
    if(ext==='txt'||ext==='csv'){
      var fr=new FileReader();
      fr.onload=function(e){fileAiExtract(e.target.result, f.name);};
      fr.readAsText(f,'UTF-8');
    } else if(ext==='docx'){
      extractDocx(f);
    } else if(ext==='pdf'){
      extractPdf(f);
    } else {
      toast('AIæŠ½å‡ºå¯¾å¿œ: TXT / CSV / Word(.docx) / PDF');
    }
  } else {
    /* å˜èªãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥é€šã‚Šï¼‰ */
    if(ext==='csv'||ext==='txt'){var fr=new FileReader();fr.onload=function(e){csvParse(e.target.result,f.name);};fr.readAsText(f,'UTF-8');}
    else if(ext==='xlsx'||ext==='xls'){xlsxRead(f);}
    else toast('å¯¾å¿œå½¢å¼: CSV, TXT, XLSX');
  }
}

function extractDocx(file){
  loading('Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      try{
        mammoth.extractRawText({arrayBuffer:e.target.result}).then(function(result){
          loaded();
          if(!result.value||result.value.trim().length<10){toast('ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸ');return;}
          fileAiExtract(result.value, file.name);
        }).catch(function(){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
      }catch(e){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof mammoth!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
  s.onload=function(){loaded();doExtract();};
  s.onerror=function(){loaded();toast('Wordãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function extractPdf(file){
  loading('PDFã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      var typedArray=new Uint8Array(e.target.result);
      pdfjsLib.getDocument({data:typedArray}).promise.then(function(pdf){
        var totalPages=pdf.numPages, texts=[], done=0;
        for(var i=1;i<=totalPages;i++){
          (function(pageNum){
            pdf.getPage(pageNum).then(function(page){
              page.getTextContent().then(function(tc){
                texts[pageNum-1]=tc.items.map(function(s){return s.str;}).join(' ');
                done++;
                if(done===totalPages){
                  loaded();
                  var fullText=texts.join('\n');
                  if(!fullText.trim()){toast('PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸï¼ˆç”»åƒPDFã¯éå¯¾å¿œï¼‰');return;}
                  fileAiExtract(fullText, file.name);
                }
              });
            });
          })(i);
        }
      }).catch(function(){loaded();toast('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof pdfjsLib!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=function(){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    loaded();doExtract();
  };
  s.onerror=function(){loaded();toast('PDFãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function fileAiExtract(text, fname){
  var savedLevel=selLevel, savedType=selType;
  selLevel=fileSelLevel; selType=fileSelType;
  if(!G.cfg.key){toast('AIã§ã®æŠ½å‡ºã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ï¼ˆè¨­å®šç”»é¢ã§å…¥åŠ›ï¼‰');selLevel=savedLevel;selType=savedType;return;}
  var ln=langName(selLang);
  var def=getLevelDef(selLang,fileSelLevel);
  var typeCond={words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'};
  var articleRule={en:'',de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',fr:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maisonï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'};
  var articleInstr=articleRule[selLang]||'';
  function makePrompt(chunk){
    return 'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[fileSelType]+'ã‚’ã§ãã‚‹ã ã‘å¤šãæŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      (articleInstr?articleInstr+'\n':'')+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
      '{"words":[{"word":"primate","meaning":"éœŠé•·é¡"},{"word":"be put upon","meaning":"åˆ©ç”¨ã•ã‚Œã‚‹"}]}\n\n'+
      'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+chunk;
  }
  var chunks=splitChunks(text, 80000);
  loading('AIãŒæŠ½å‡ºä¸­... (1/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();selLevel=savedLevel;selType=savedType;
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false; seen[k]=true; return true;
      });
      if(!words.length){toast('âŒ å˜èªãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');return;}
      toast('âœ… '+words.length+'èªã‚’æŠ½å‡ºã—ã¾ã—ãŸ'+(chunks.length>1?' ('+chunks.length+'ãƒ‘ãƒ¼ãƒˆå‡¦ç†)':''));
      prvShow(words);
      var ni2=el('IN-file-name');var ni3=el('IN-ai-name');
      if(ni2&&ni2.value&&ni3&&!ni3.value)ni3.value=ni2.value;
    },
    function(e){
      loaded();selLevel=savedLevel;selType=savedType;
      var msg=e.message||'';
      toast(msg.indexOf('401')>=0?'âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™':'âŒ ã‚¨ãƒ©ãƒ¼: '+msg.slice(0,50));
    }
  );
}

function csvParse(txt,fname){
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim().replace(/^["']|["']$/g,'');
    var m=(p[1]||'').trim().replace(/^["']|["']$/g,'');
    if(w)words.push({word:w,meaning:m});
  });
  var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=fname.replace(/\.[^.]+$/,'');
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function xlsxRead(file){
  loading('Excelã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doRead(){
    var fr=new FileReader();
    fr.onload=function(e){
      loaded();
      try{
        var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        var rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
        var words=[];
        rows.forEach(function(r){var w=(r[0]||'').toString().trim(),m=(r[1]||'').toString().trim();if(w)words.push({word:w,meaning:m});});
        var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=file.name.replace(/\.[^.]+$/,'');
        if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
        needTranslate(words)?doTranslate(words,selLang):prvShow(words);
      }catch(e){toast('Excelã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof XLSX!=='undefined'){loaded();doRead();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload=function(){loaded();doRead();};
  s.onerror=function(){loaded();toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã¯Exceléå¯¾å¿œã€‚CSVã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚');};
  document.head.appendChild(s);
}

/* ---- JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---- */
var jsonSection='all'; /* all | vocabulary | phrases */

function setJsonSection(sec){
  jsonSection=sec;
  document.querySelectorAll('[data-jsec]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-jsec')===sec);});
}

function jsonImport(text, fname){
  try{
    var d=JSON.parse(text);
  }catch(e){toast('âŒ JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');return;}

  /* book_title ã‹ã‚‰ãƒªã‚¹ãƒˆåã‚’è‡ªå‹•è¨­å®š */
  var ni=el('IN-file-name');
  if(ni){
    var autoName=d.book_title||d.title||d.name||fname.replace(/\.[^.]+$/,'');
    if(autoName&&!ni.value)ni.value=autoName;
  }

  /* å˜èªé…åˆ—ã‚’å–ã‚Šå‡ºã™æ±ç”¨é–¢æ•° */
  function extractWords(arr){
    if(!Array.isArray(arr))return[];
    return arr.map(function(item){
      var w=item.word||item.term||item.front||item.expression||item.vocab||item.german||item.deutsch||item.french||item.franÃ§ais||item.spanish||item.espaÃ±ol||item.italian||item.italiano||item.english||'';
      var m=item.meaning||item.translation||item.back||item.definition||item.japanese||item.ja||'';
      return w?{word:String(w).trim(),meaning:String(m).trim()}:null;
    }).filter(Boolean);
  }

  var words=[];

  /* ãƒ‘ã‚¿ãƒ¼ãƒ³C: {"content":{"vocabulary":[...],"phrases":[...]}} */
  if(d.content&&typeof d.content==='object'){
    var vocab=extractWords(d.content.vocabulary||d.content.words||[]);
    var phrases=extractWords(d.content.phrases||d.content.expressions||[]);
    if(jsonSection==='vocabulary'){words=vocab;}
    else if(jsonSection==='phrases'){words=phrases;}
    else{words=vocab.concat(phrases);}
  }
  /* {"words":[...]} ã¾ãŸã¯ {"vocabulary":[...]} */
  else if(Array.isArray(d.words)){words=extractWords(d.words);}
  else if(Array.isArray(d.vocabulary)){words=extractWords(d.vocabulary);}
  else if(Array.isArray(d.phrases)){words=extractWords(d.phrases);}
  /* ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«é…åˆ— */
  else if(Array.isArray(d)){words=extractWords(d);}

  if(!words.length){toast('âŒ å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚JSONã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');return;}

  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã«ãƒªã‚¹ãƒˆåã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ã‘ã‚‹ */
  if(ni&&ni.value&&d.content){
    if(jsonSection==='vocabulary')ni.value=ni.value+' [å˜èª]';
    else if(jsonSection==='phrases')ni.value=ni.value+' [ç†Ÿèª]';
  }

  toast('âœ… '+words.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

/* è¨€èªÃ—ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ¤œå®šåŸºæº– */
var LEVEL_DEF={
  en:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»beå‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” è‹±æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ï¼ˆä¸­å­¦è‹±èªç›¸å½“ï¼‰ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ï¼ˆé«˜æ ¡è‹±èªç›¸å½“ï¼‰ã®å˜èªã€‚æ—¥å¸¸ãƒ»ç¤¾ä¼šçš„ãªè©±é¡Œã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»é›£è§£ãªèªå½™'}
  },
  de:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»åŠ©å‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ç‹¬æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ‰ã‚¤ãƒ„èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã®ãƒ†ãƒ¼ãƒã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  fr:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»Ãªtre/avoirãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ä»æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»æ™‚äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚å­¦è¡“ãƒ»æ–‡å­¦ãƒ»å°‚é–€çš„ãªèªå½™'}
  },
  es:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»ser/estarãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š6ç´šãƒ»5ç´šãƒ»4ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š4ã€œ6ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š3ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š2ã€œ3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  it:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»essere/avereãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®šï¼ˆä¼Šæ¤œï¼‰5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  }
};

function getLevelDef(lang,level){
  var ld=LEVEL_DEF[lang]||LEVEL_DEF.en;
  return ld[level]||ld.all;
}

function setLevel(level){
  selLevel=level;
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
  updateLevelHint();
}

function updateLevelHint(){
  var h=el('LV-hint');
  if(!h)return;
  var def=getLevelDef(selLang,selLevel);
  h.textContent=def.hint;
}

function setType(type){
  selType=type;
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function aiExtract(){
  var txt=el('IN-ai-text').value.trim();
  if(!txt||txt.length<20){toast('ã‚‚ã†å°‘ã—é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  /* APIã‚­ãƒ¼ã‚’ãã®å ´ã§å…¥åŠ›æ¬„ã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆä¿å­˜æ¸ˆã¿ã§ãªãã¦ã‚‚å‹•ãï¼‰ */
  var keyFromInput=(el('IN-apikey')||{}).value||'';
  if(keyFromInput&&!G.cfg.key){G.cfg.key=keyFromInput;save();}
  if(G.cfg.key){
    aiExtractAPI(txt);
  } else {
    if(confirm('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨AIç¿»è¨³ãŒä½¿ãˆã¾ã™ã€‚\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºï¼ˆè¨³ãªã—ï¼‰ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿ')){
      offlineExtract(txt);
    }
  }
}

function apiCall(body,ok,ng){
  var xhr=new XMLHttpRequest();
  xhr.open('POST','https://api.anthropic.com/v1/messages',true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.setRequestHeader('x-api-key',G.cfg.key);
  xhr.setRequestHeader('anthropic-version','2023-06-01');
  xhr.setRequestHeader('anthropic-dangerous-direct-browser-access','true');
  xhr.onload=function(){try{var d=JSON.parse(xhr.responseText);xhr.status===200?ok(d):ng(new Error((d.error&&d.error.message)||'APIã‚¨ãƒ©ãƒ¼ '+xhr.status));}catch(e){ng(e);}};
  xhr.onerror=function(){ng(new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼'));};
  xhr.send(JSON.stringify(body));
}

/* ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ‡å®šæ–‡å­—æ•°ã§ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ï¼ˆå˜èªåŒºåˆ‡ã‚Šã‚’å°Šé‡ï¼‰ */
function splitChunks(text, chunkSize){
  var chunks=[];
  var pos=0;
  while(pos<text.length){
    var end=Math.min(pos+chunkSize, text.length);
    /* è¡Œæœ«ã‹ç©ºç™½ã§åˆ‡ã‚‹ */
    if(end<text.length){
      var nl=text.lastIndexOf('\n',end);
      var sp=text.lastIndexOf(' ',end);
      var cut=nl>pos+chunkSize/2?nl:sp>pos+chunkSize/2?sp:end;
      end=cut>pos?cut:end;
    }
    chunks.push(text.slice(pos,end).trim());
    pos=end;
  }
  return chunks.filter(function(c){return c.length>0;});
}

/* è¤‡æ•°ãƒãƒ£ãƒ³ã‚¯ã‚’é †æ¬¡APIã«é€ã‚Šã€çµæœã‚’ãƒãƒ¼ã‚¸ã—ã¦è¿”ã™ */
function apiCallChunked(chunks, makePrompt, model, okAll, ngAll){
  var allWords=[];
  var idx=0;
  function next(){
    if(idx>=chunks.length){okAll(allWords);return;}
    var chunk=chunks[idx];
    idx++;
    loading('AIãŒæŠ½å‡ºä¸­... ('+idx+'/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
    var body={
      model:model,
      max_tokens:16000,
      messages:[{role:'user',content:makePrompt(chunk)}]
    };
    apiCall(body,function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var words=(JSON.parse(m[0]).words||[]).filter(function(w){return w.word&&w.word.trim();});
          allWords=allWords.concat(words);
        }
      }catch(e){/* ãƒ‘ãƒ¼ãƒˆã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ */}
      next();
    },function(e){ngAll(e);});
  }
  next();
}

function langName(lang){return LANGS[lang]?LANGS[lang].name:'è‹±èª';}

function aiExtractAPI(txt){
  /* â”€â”€ ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã®å˜èªãƒªã‚¹ãƒˆå½¢å¼ã‚’æ¤œå‡º â”€â”€ */
  var slashCount=(txt.match(/ \/ /g)||[]).length;
  var lineCount=txt.split('\n').filter(function(l){return l.trim();}).length;
  var isWordList= slashCount > 20 && slashCount > lineCount * 0.5;

  if(isWordList){
    loading('å˜èªãƒªã‚¹ãƒˆã‚’è§£æä¸­...');
    var rawWords=[];
    txt.split('\n').forEach(function(line){
      line=line.trim();
      if(!line) return;
      if(/[\u3000-\u9fff]/.test(line)) return;
      line.split('/').forEach(function(w){
        w=w.trim().replace(/^\(|\)$/g,'');
        if(w && w.length>0 && w.length<60) rawWords.push(w);
      });
    });
    var seen={};
    var words=rawWords.filter(function(w){
      var k=w.toLowerCase();
      if(seen[k])return false; seen[k]=true; return true;
    }).map(function(w){return{word:w, meaning:''};});

    if(!words.length){loaded();toast('\u274c å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
    loaded();

    if(G.cfg.key){
      translateInChunks(words, selLang, function(translated){
        var ni=el('IN-ai-name');
        if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_AIæŠ½å‡º';
        toast('\u2705 '+translated.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        prvShow(translated);
      });
    } else {
      var ni=el('IN-ai-name');
      if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_æŠ½å‡º';
      toast('\u2705 '+words.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆç¿»è¨³ã¯APIã‚­ãƒ¼ãŒå¿…è¦ï¼‰');
      prvShow(words);
    }
    return;
  }

  /* â”€â”€ é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã®AIæŠ½å‡º â”€â”€ */
  var ln=langName(selLang);
  var def=getLevelDef(selLang,selLevel);
  var levelLabel={all:'',beginner:'åˆç´š_',intermediate:'ä¸­ç´š_',advanced:'ä¸Šç´š_'};
  var typeLabel={words:'å˜èª_',phrases:'ç†Ÿèª_',both:'å˜èªç†Ÿèª_'};
  var typeCond={
    words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',
    phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',
    both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'
  };
  var articleRule={
    en:'',
    de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: gehen, habenï¼‰ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    fr:"åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maison, l\'Ã©coleï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: aller, avoirï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚",
    es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: ir, tenerï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casa, lo studenteï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: andare, avereï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'
  };
  var articleInstr=articleRule[selLang]||'';
  var ni=el('IN-ai-name');
  if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_'+(levelLabel[selLevel]||'')+(typeLabel[selType]||'')+'AIæŠ½å‡º';

  function makePrompt(chunk){
    return 'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€'+
      'ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[selType]+'ã‚’ã§ãã‚‹ã ã‘å¤šãæŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      (articleInstr?articleInstr+'\n':'')+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
      '{"words":[{"word":"primate","meaning":"éœŠé•·é¡"},{"word":"be put upon","meaning":"åˆ©ç”¨ã•ã‚Œã‚‹ã€ã“ãä½¿ã‚ã‚Œã‚‹"}]}\n\n'+
      'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+chunk;
  }

  var chunks=splitChunks(txt, 80000);
  loading('AIãŒæŠ½å‡ºä¸­... (1/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false;
        seen[k]=true;return true;
      });
      if(!words.length){toast('\u274c å˜èªãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');return;}
      toast('\u2705 '+words.length+'èªã‚’æŠ½å‡ºã—ã¾ã—ãŸ'+(chunks.length>1?' ('+chunks.length+'ãƒ‘ãƒ¼ãƒˆå‡¦ç†)':''));
      prvShow(words);
    },
    function(e){
      loaded();
      var msg=e.message||'';
      if(msg.indexOf('401')>=0||msg.indexOf('authentication')>=0||msg.toLowerCase().indexOf('invalid')>=0){
        toast('\u274c APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„');
      } else if(msg.indexOf('\u901a\u4fe1')>=0){
        toast('\u274c é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      } else {
        toast('\u274c AIã‚¨ãƒ©ãƒ¼: '+msg.slice(0,60));
      }
    }
  );
}

/* å˜èªãƒªã‚¹ãƒˆã‚’150èªãšã¤åˆ†å‰²ã—ã¦AIç¿»è¨³ */
function translateInChunks(words, lang, callback){
  var ln=langName(lang);
  var chunkSize=150;
  var total=words.length;
  var idx=0;
  var result=words.slice();

  function nextChunk(){
    if(idx>=total){callback(result);return;}
    var chunk=result.slice(idx, idx+chunkSize);
    var noMeaning=chunk.filter(function(w){return !w.meaning;});
    if(!noMeaning.length){idx+=chunkSize;nextChunk();return;}

    loading('ç¿»è¨³ä¸­... ('+Math.min(idx+chunkSize,total)+'/'+total+'èª)');
    var wordList=noMeaning.map(function(w){return w.word;}).join(' / ');
    var prompt=
      'ä»¥ä¸‹ã®'+ln+'ã®å˜èªãƒ»ç†Ÿèªã™ã¹ã¦ã«æ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã‚’å«ã‚ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'JSONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆ```ä¸è¦ï¼‰: {"translations":{"abandon":"æ¨ã¦ã‚‹","be put upon":"ã“ãä½¿ã‚ã‚Œã‚‹"}}\n\n'+
      'å˜èªãƒªã‚¹ãƒˆ: '+wordList;

    apiCall({
      model:'claude-haiku-4-5-20251001',
      max_tokens:16000,
      messages:[{role:'user',content:prompt}]
    },function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var tr=JSON.parse(m[0]).translations||{};
          for(var i=idx;i<Math.min(idx+chunkSize,total);i++){
            var w=result[i];
            if(!w.meaning){
              var meaning=tr[w.word]||tr[w.word.toLowerCase()]||'';
              if(!meaning){
                var wn=w.word.replace(/\s+/g,' ').trim();
                Object.keys(tr).forEach(function(k){
                  if(!meaning&&k.replace(/\s+/g,' ').trim().toLowerCase()===wn.toLowerCase())meaning=tr[k];
                });
              }
              if(meaning)w.meaning=meaning;
            }
          }
        }
      }catch(e){}
      idx+=chunkSize;
      nextChunk();
    },function(){
      idx+=chunkSize;
      nextChunk();
    });
  }
  nextChunk();
}
function offlineExtract(txt){
  var common={the:1,be:1,is:1,are:1,was:1,were:1,have:1,has:1,had:1,do:1,does:1,did:1,will:1,would:1,shall:1,should:1,may:1,might:1,must:1,can:1,could:1,a:1,an:1,in:1,on:1,at:1,to:1,for:1,of:1,and:1,or:1,but:1,not:1,this:1,that:1,with:1,from:1,by:1,as:1,up:1,out:1,if:1,about:1,who:1,what:1,which:1,all:1,when:1,so:1,no:1,just:1,into:1,over:1,after:1,also:1,than:1,only:1,they:1,their:1,you:1,we:1,he:1,she:1,me:1,my:1,us:1,him:1,it:1,i:1,
    der:1,die:1,das:1,ein:1,eine:1,und:1,oder:1,aber:1,nicht:1,ist:1,sind:1,war:1,hat:1,haben:1,mit:1,von:1,aus:1,bei:1,nach:1,zum:1,zur:1,dem:1,den:1,des:1,
    le:1,la:1,les:1,un:1,une:1,des:1,et:1,ou:1,est:1,sont:1,pas:1,que:1,qui:1,dans:1,sur:1,avec:1,par:1,
    el:1,los:1,las:1,es:1,son:1,una:1,con:1,por:1,para:1,
    il:1,lo:1,gli:1,del:1,della:1,nella:1,con:1,per:1,una:1,sono:1};
  var f={},m,re=/\b([\wÃ„Ã¤Ã–Ã¶ÃœÃ¼ÃŸÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÃ‘Ã±Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹]{3,})\b/g;
  while((m=re.exec(txt))!==null){var w=m[1];if(!common[w.toLowerCase()]&&!common[w])f[w]=(f[w]||0)+1;}
  var s=Object.keys(f).sort(function(a,b){return f[b]-f[a];}).slice(0,30);
  toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºå®Œäº†ï¼ˆè¨³ãªã—ï¼‰APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨è¨³ã‚‚ä»˜ä¸ã§ãã¾ã™');
  prvShow(s.map(function(w){return{word:w,meaning:''};}));
}

function doTranslate(words,lang){
  var nm=words.filter(function(w){return !w.meaning;});
  if(!nm.length){prvShow(words);return;}
  var ln=langName(lang);
  loading(nm.length+'å˜èªã‚’ç¿»è¨³ä¸­...');
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:2048,
    messages:[{role:'user',content:'ä»¥ä¸‹ã®'+ln+'ã®å˜èªã«æ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚JSONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„: {"translations":{"Haus":"å®¶",...}}\\n\\nå˜èª: '+nm.map(function(w){return w.word;}).join(', ')}]
  },function(d){
    try{var m=d.content[0].text.match(/\{[\s\S]*\}/);if(m){var tr=JSON.parse(m[0]).translations||{};words.forEach(function(w){if(!w.meaning&&tr[w.word])w.meaning=tr[w.word];});}}catch(e){}
    loaded();prvShow(words);
  },function(){loaded();prvShow(words);});
}

function prvShow(words){
  prevWords=words.filter(function(w){return w.word&&w.word.trim();});
  el('PRV').style.display='block';
  el('PRV-cnt').textContent=prevWords.length+' å˜èª';
  var h='';
  prevWords.forEach(function(w,i){
    h+='<div class="prev-item"><div class="pi-n">'+(i+1)+'</div><div class="pi-en">'+esc(w.word)+'</div><div class="pi-ja">'+(w.meaning?esc(w.meaning):'<span style="color:var(--tx2);font-size:11px">è¨³ãªã—</span>')+'</div></div>';
  });
  el('PRV-list').innerHTML=h;
  var sc=el('s-add').querySelector('.scroll');if(sc)sc.scrollTop=9999;
}
function prvHide(){prevWords=[];el('PRV').style.display='none';el('PRV-list').innerHTML='';}

function saveList(){
  if(!prevWords.length)return;
  var nameMap={paste:'IN-paste-name',file:'IN-file-name',ai:'IN-ai-name'};
  var ni=el(nameMap[addMode]||'IN-paste-name');
  var listName=(ni&&ni.value.trim())||((LANGS[selLang]?LANGS[selLang].name:'')+'ãƒªã‚¹ãƒˆ '+(G.lists.length+1));
  var lst=null;
  for(var i=0;i<G.lists.length;i++){if(G.lists[i].name===listName){lst=G.lists[i];break;}}
  if(!lst){
    var clrs=['#7c5cfc','#fc5c7d','#5cf8fc','#ffd700','#4cff91','#ff9c4c'];
    var langClr={en:'#4cff91',de:'#ffd700',fr:'#5cf8fc',es:'#ff9c4c',it:'#fc5c7d'};
    lst={id:uid(),name:listName,ic:LANGS[selLang]?LANGS[selLang].flag:'ğŸ“—',clr:langClr[selLang]||clrs[G.lists.length%clrs.length],lang:selLang,cr:new Date().toISOString()};
    G.lists.push(lst);
  }
  var added=0;
  prevWords.forEach(function(pw){
    var ex=G.words.some(function(w){return w.word===pw.word&&w.lid===lst.id;});
    if(!ex){G.words.push({id:uid(),word:pw.word,meaning:pw.meaning||'',lid:lst.id,lang:selLang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});added++;}
  });
  save();prvHide();
  if(ni)ni.value='';
  var ta=el(addMode==='paste'?'IN-paste-text':addMode==='ai'?'IN-ai-text':'IN-paste-text');if(ta)ta.value='';
  toast('âœ… '+added+'å˜èªã‚’ã€Œ'+listName+'ã€ã«è¿½åŠ ã—ã¾ã—ãŸ');
  setTimeout(function(){go('s-home');},500);
}

/* WORD LIST */
var listLangFilter='all';
var listStatusFilter='all';
var listSort='default';

/* å˜èªã”ã¨ã®ãƒ­ã‚°é›†è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ */
var _wordLogCache=null;
function getWordLogCache(){
  if(_wordLogCache)return _wordLogCache;
  var c={};
  (G.logs||[]).forEach(function(log){
    (log.miss||[]).forEach(function(m){
      if(!c[m.id])c[m.id]={miss:0,slowMs:0,slowCnt:0};
      c[m.id].miss++;
    });
    (log.slow||[]).forEach(function(m){
      if(!c[m.id])c[m.id]={miss:0,slowMs:0,slowCnt:0};
      c[m.id].slowMs+=(m.answerMs||0);
      c[m.id].slowCnt++;
    });
  });
  _wordLogCache=c;
  return c;
}
function clearWordLogCache(){_wordLogCache=null;}

function wordStatus(w){
  if(!w.lr)return 'new';
  var s=w.s||{};
  if((s.l||0)>0&&(s.k||0)===0)return 'dontknow';
  if((s.l||0)>0)return 'missed';
  return 'studied';
}

function listFilterRebuild(){
  var sel=el('SEL-list'),cur=sel.value;
  sel.innerHTML='<option value="all">ã™ã¹ã¦</option>';
  G.lists.forEach(function(l){var o=document.createElement('option');o.value=l.id;o.textContent=(LANGS[l.lang]?LANGS[l.lang].flag+' ':'')+l.name;sel.appendChild(o);});
  sel.value=cur||'all';
}
function listRender(){
  /* é¸æŠãƒ¢ãƒ¼ãƒ‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¡¨ç¤ºã‚’åŒæœŸ */
  var _tb=document.getElementById('SEL-toolbar');
  if(_tb)_tb.style.display=selModeOn?'block':'none';
  var flt=(el('SEL-list')||{}).value||'all';
  var srch=((el('IN-search')||{}).value||'').toLowerCase();
  var c=el('L-words');
  var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
  if(listLangFilter!=='all')words=words.filter(function(w){return(w.lang||'en')===listLangFilter;});
  if(srch)words=words.filter(function(w){return w.word.toLowerCase().indexOf(srch)>=0||w.meaning.toLowerCase().indexOf(srch)>=0;});
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  if(listStatusFilter!=='all'){
    words=words.filter(function(w){return wordStatus(w)===listStatusFilter;});
  }
  /* ã‚½ãƒ¼ãƒˆ */
  var cache=getWordLogCache();
  if(listSort==='missed'){
    words=words.slice().sort(function(a,b){return ((b.s&&b.s.l)||0)-((a.s&&a.s.l)||0);});
  } else if(listSort==='slow'){
    words=words.slice().sort(function(a,b){
      var ca=cache[a.id], cb=cache[b.id];
      var aa=ca&&ca.slowCnt?ca.slowMs/ca.slowCnt:0;
      var ba=cb&&cb.slowCnt?cb.slowMs/cb.slowCnt:0;
      return ba-aa;
    });
  } else if(listSort==='level-asc'){
    words=words.slice().sort(function(a,b){return lvl(a)-lvl(b);});
  } else if(listSort==='level-desc'){
    words=words.slice().sort(function(a,b){return lvl(b)-lvl(a);});
  }
  if(!words.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ”</div><div class="empty-tl">å˜èªãªã—</div></div>';return;}
  var lb=['åˆ','å…¥','ä¸­','ä¸­ä¸Š','ä¸Š','ç¿’å¾—'],h='';
  words.forEach(function(w){
    var v=lvl(w);
    var l=LANGS[w.lang||'en'];
    var st=wordStatus(w);
    var stIcon='';
    if(st==='studied')stIcon='<span title="å­¦ç¿’æ¸ˆã¿" style="font-size:13px;margin-left:4px">âœ…</span>';
    else if(st==='missed'){var mc=(w.s&&w.s.l)||0;stIcon='<span title="é–“é•ã„'+mc+'å›" style="font-size:13px;margin-left:4px">âŒ</span><span style="font-size:10px;color:var(--rd);margin-left:2px">Ã—'+mc+'</span>';}
    else if(st==='dontknow')stIcon='<span title="ã‚ã‹ã‚‰ãªã„" style="font-size:13px;margin-left:4px">â“</span>';
    else stIcon='<span title="æœªå­¦ç¿’" style="font-size:13px;margin-left:4px;opacity:.3">ğŸ†•</span>';
    var chk=selModeOn?'<input type="checkbox" class="word-sel-chk" data-wid="'+esc(w.id)+'"'+(selSet[w.id]?' checked':'')+' style="width:18px;height:18px;flex-shrink:0;margin-right:4px;accent-color:var(--ac)">':'';
    h+='<button class="word-item" data-wid="'+esc(w.id)+'" style="'+(selModeOn&&selSet[w.id]?'background:rgba(124,92,252,.18);border-color:var(--ac);':'')+'">'+
      chk+
      '<div class="wi-inf"><div class="wi-en">'+(l?'<span style="font-size:11px;margin-right:4px">'+l.flag+'</span>':'')+esc(w.word)+stIcon+'</div>'+
      '<div class="wi-ja">'+(w.meaning?esc(w.meaning):'è¨³ãªã—')+'</div></div>'+
      '<div class="wi-lvl l'+v+'">'+lb[v]+'</div></button>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.word-item').forEach(function(b){
    b.addEventListener('click',function(e){
      var wid=this.getAttribute('data-wid');
      if(selModeOn){selWordToggle(wid);this.style.background=selSet[wid]?'rgba(124,92,252,.18)':'';this.style.borderColor=selSet[wid]?'var(--ac)':'';}
      else{wordDetail(wid);}
    });
  });
  c.querySelectorAll('.word-sel-chk').forEach(function(chk){
    chk.addEventListener('click',function(e){e.stopPropagation();selWordToggle(this.getAttribute('data-wid'));var btn=this.closest('.word-item');if(btn){btn.style.background=selSet[this.getAttribute('data-wid')]?'rgba(124,92,252,.18)':'';btn.style.borderColor=selSet[this.getAttribute('data-wid')]?'var(--ac)':'';}});
  });
}

function listMenu(lid){
  var lst=G.lists.find(function(x){return x.id===lid;}); if(!lst)return;
  var ws=G.words.filter(function(w){return w.lid===lid;});
  var d=ws.filter(due).length;
  var l=LANGS[lst.lang||'en'];
  var cursor=lst.cursor||0;
  var total=ws.length;
  if(cursor>=total)cursor=0; /* å…¨å®Œäº†ã—ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆæ¸ˆã¿æ‰±ã„ */
  var size=Math.min(parseInt(G.cfg.size)||20, total);
  var nextEnd=Math.min(cursor+size, total);
  var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
  var progressInfo=total>0?'é€²æ— '+pct+'% ('+cursor+'/'+total+'å˜èªå®Œäº†)':'';
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(lst.name)+'</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:8px">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div>'+
    (total>0?'<div style="margin-bottom:14px"><div style="height:5px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-bottom:5px"><div style="height:100%;width:'+pct+'%;background:'+(pct>=100?'var(--gn)':pct>=60?'var(--ac3)':'var(--ac)')+';border-radius:3px;transition:width .3s"></div></div><div style="font-size:11px;color:var(--tx2)">'+progressInfo+(cursor<total?' Â· æ¬¡å›: '+cursor+'ã€œ'+nextEnd+'ç•ªç›®':' Â· å…¨å˜èªå®Œäº†ï¼')+'</div></div>':'')+
    '<button class="btn-primary" id="LM-flash" style="margin-bottom:8px">ğŸ“– äºˆç¿’ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-quiz" style="margin-top:0;margin-bottom:8px">âš¡ ã™ãã‚¯ã‚¤ã‚ºï¼ˆç¶šãã‹ã‚‰ï¼‰</button>'+
    '<button class="btn-sec" id="LM-quiz-reset" style="margin-top:0;margin-bottom:8px">ğŸ” æœ€åˆã‹ã‚‰ã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-due" style="margin-top:0;margin-bottom:8px'+(d?'':';opacity:.4;pointer-events:none')+'">ğŸ“… å¾©ç¿’å˜èªã®ã¿ï¼ˆ'+d+'ä»¶ï¼‰</button>'+
    '<button class="btn-sec" id="LM-list" style="margin-top:0;margin-bottom:8px">ğŸ“š å˜èªä¸€è¦§ã‚’è¦‹ã‚‹</button>'+
    '<button class="btn-sec" id="LM-edit" style="margin-top:0">âœï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†</button>';
  el('modal-bg').classList.add('on');

  /* ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ä»¥é™ã®å…¨æœªç¿’å˜èªã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡ºã™ã‚‹å…±é€šé–¢æ•° */
  function makePool(fromStart){
    var cur=fromStart?0:(lst.cursor||0);
    if(cur>=total)cur=0;
    /* cursorä»¥é™ã®å…¨å˜èªã‚’å¯¾è±¡ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦sizeä»¶å–ã‚‹ */
    var remaining=ws.slice(cur);
    var pool=G.cfg.random ? shuffle(remaining).slice(0,size) : remaining.slice(0,size);
    if(pool.length<2&&total>=2){
      /* æ®‹ã‚ŠãŒå°‘ãªã™ãã‚‹å ´åˆã¯å…ˆé ­ã‹ã‚‰ */
      cur=0;
      var all=G.cfg.random ? shuffle(ws.slice()) : ws.slice();
      pool=all.slice(0,size);
    }
    /* nextCursorã¯ã€Œå–ã‚Šå‡ºã—ãŸä»¶æ•°åˆ†ã€ã ã‘é€²ã‚ã‚‹ï¼ˆç™»éŒ²é †ã§ã®ä½ç½®ï¼‰ */
    var nextCursor=Math.min(cur+size, total);
    return {pool:pool, nextCursor:nextCursor};
  }

  el('LM-flash').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’flashStartã«æ¸¡ã—ã€ã‚¯ã‚¤ã‚ºå®Œäº†æ™‚ã«é€²ã‚ã‚‹ */
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    flashStart(r.pool,'list',lid);
  });
  el('LM-quiz').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    if(r.pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-quiz-reset').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(true);
    if(r.pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-due').addEventListener('click',function(){
    if(!d)return;
    el('modal-bg').classList.remove('on');
    var pool=ws.filter(due);
    if(pool.length<2){toast('å¾©ç¿’å˜èªãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½2å˜èªï¼‰');return;}
    var qs=(G.cfg.random ? shuffle(pool) : pool).slice(0,size);
    Q={words:qs,q:qs.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'due',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    go('s-quiz');qRender();
  });
  el('LM-list').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    go('s-list');
    var sel=el('SEL-list');
    listFilterRebuild();
    sel.value=lid;
    listRender();
  });
  el('LM-edit').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editList(lid);
  });
}

function wordDetail(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var lst=G.lists.find(function(x){return x.id===w.lid;});
  var dStr=w.s&&w.s.d?new Date(w.s.d).toLocaleDateString('ja-JP'):'ã™ã';
  var lbn=['åˆç´š','å…¥é–€','ä¸­ç´š','ä¸­ä¸Šç´š','ä¸Šç´š','ç¿’å¾—æ¸ˆã¿'],v=lvl(w);
  var l=LANGS[w.lang||'en'];
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(w.word)+'</div>'+
    '<div style="font-size:20px;color:var(--ac3);margin-bottom:13px">'+esc(w.meaning||'è¨³ãªã—')+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px">'+
    mkCard('SRSãƒ¬ãƒ™ãƒ«',lbn[v])+mkCard('æ¬¡å›å¾©ç¿’',dStr)+
    mkCard('é€£ç¶šæ­£è§£',(w.s&&w.s.k||0))+mkCard('é–“é•ã„å›æ•°','<span style="color:var(--rd)">'+(w.s&&w.s.l||0)+'</span>')+
    '</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">è¨€èª: '+(l?l.flag+' '+l.name:'ä¸æ˜')+' ï¼ ãƒªã‚¹ãƒˆ: '+esc(lst?lst.name:'ä¸æ˜')+'</div>'+
    '<button class="btn-sec" id="EDIT-word-btn" style="margin-bottom:8px">âœï¸ å˜èªã‚’ç·¨é›†</button>'+
    '<button class="del-btn" id="DEL-btn">ğŸ—‘ï¸ ã“ã®å˜èªã‚’å‰Šé™¤</button>';
  el('modal-bg').classList.add('on');
  el('EDIT-word-btn').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editWord(wid);
  });
  el('DEL-btn').addEventListener('click',function(){
    if(!confirm('ã€Œ'+w.word+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
    G.words=G.words.filter(function(x){return x.id!==wid;});
    save();el('modal-bg').classList.remove('on');listRender();toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  });
}
function mkCard(l,v){return'<div style="background:var(--sf2);border-radius:9px;padding:10px"><div style="font-size:10px;color:var(--tx2);margin-bottom:3px">'+l+'</div><div style="font-size:14px;font-weight:600">'+v+'</div></div>';}
/* ========== EDIT FUNCTIONS ========== */

/* â”€â”€ ãƒªã‚¹ãƒˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
function editList(lid){
  var lst=G.lists.find(function(x){return x.id===lid;});if(!lst)return;
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+(lst.lang===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">ãƒªã‚¹ãƒˆå</div>'+
    '<input class="inp" id="EL-name" type="text" value="'+escHtml(lst.name)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">è¨€èª</div>'+
    '<select class="inp" id="EL-lang" style="margin-bottom:16px">'+langOpts+'</select>'+
    '<button class="btn-primary" id="EL-save" style="margin-bottom:8px">ğŸ’¾ ä¿å­˜</button>'+
    '<button class="btn-sec" id="EL-cancel" style="margin-top:0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EL-name');if(n){n.focus();n.select();}},100);
  el('EL-save').addEventListener('click',function(){
    var name=(el('EL-name').value||'').trim();
    if(!name){toast('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    lst.name=name;
    lst.lang=el('EL-lang').value;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listFilterRebuild();listRender();
    toast('âœ… ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });
  el('EL-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* â”€â”€ å˜èªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€ */
function editWord(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+((w.lang||'en')===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  var listOpts=G.lists.map(function(l){
    return '<option value="'+l.id+'"'+(w.lid===l.id?' selected':'')+'>'+escHtml(l.name)+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœï¸ å˜èªã‚’ç·¨é›†</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">å˜èªï¼ˆå¤–å›½èªï¼‰</div>'+
    '<input class="inp" id="EW-word" type="text" value="'+escHtml(w.word)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">æ„å‘³ï¼ˆæ—¥æœ¬èªï¼‰</div>'+
    '<input class="inp" id="EW-meaning" type="text" value="'+escHtml(w.meaning||'')+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">è¨€èª</div>'+
    '<select class="inp" id="EW-lang" style="margin-bottom:12px">'+langOpts+'</select>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">æ‰€å±ãƒªã‚¹ãƒˆ</div>'+
    '<select class="inp" id="EW-list" style="margin-bottom:16px">'+listOpts+'</select>'+
    '<button class="btn-primary" id="EW-save" style="margin-bottom:8px">ğŸ’¾ ä¿å­˜</button>'+
    '<button class="btn-sec" id="EW-cancel" style="margin-top:0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EW-word');if(n){n.focus();n.select();}},100);
  el('EW-save').addEventListener('click',function(){
    var word=(el('EW-word').value||'').trim();
    var meaning=(el('EW-meaning').value||'').trim();
    if(!word){toast('å˜èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    w.word=word; w.meaning=meaning;
    w.lang=el('EW-lang').value;
    w.lid=el('EW-list').value;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('âœ… å˜èªã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });
  el('EW-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* â”€â”€ é‡è¤‡ãƒã‚§ãƒƒã‚¯ â”€â”€ */
function checkDuplicates(){
  var seen={}, dups=[];
  G.words.forEach(function(w){
    var key=(w.word||'').toLowerCase().trim()+'|'+(w.lang||'en');
    if(seen[key]){
      /* åŒä¸€ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ  */
      var grp=dups.find(function(g){return g.key===key;});
      if(grp)grp.words.push(w);
      else dups.push({key:key,words:[seen[key],w]});
    } else {
      seen[key]=w;
    }
  });
  if(!dups.length){toast('é‡è¤‡å˜èªã¯ã‚ã‚Šã¾ã›ã‚“ âœ…');return;}

  var rows=dups.map(function(g){
    var wds=g.words;
    var lists=wds.map(function(w){var l=G.lists.find(function(x){return x.id===w.lid;});return l?l.name:'ä¸æ˜';});
    return '<div style="background:var(--sf2);border-radius:9px;padding:10px;margin-bottom:8px">'+
      '<div style="font-weight:700;margin-bottom:5px;color:var(--ac3)">'+escHtml(wds[0].word)+'</div>'+
      wds.map(function(w,i){
        return '<div style="display:flex;align-items:center;gap:7px;margin-bottom:4px">'+
          '<input type="checkbox" class="dup-chk" data-wid="'+w.id+'" style="width:16px;height:16px;flex-shrink:0">'+
          '<span style="font-size:11px;color:var(--tx2);flex:1">'+escHtml(w.meaning||'è¨³ãªã—')+' <span style="opacity:.6">ï¼ '+escHtml(lists[i])+'</span></span>'+
        '</div>';
      }).join('')+
    '</div>';
  }).join('');

  el('modal-ct').innerHTML=
    '<div class="modal-tl">âŠœ é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆ'+dups.length+'ä»¶ï¼‰</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">å‰Šé™¤ã™ã‚‹å˜èªã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</div>'+
    '<div id="DUP-list">'+rows+'</div>'+
    '<button class="del-btn" id="DUP-del" style="margin-top:8px">ğŸ—‘ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸå˜èªã‚’å‰Šé™¤</button>'+
    '<button class="btn-sec" id="DUP-cancel" style="margin-top:8px">é–‰ã˜ã‚‹</button>';
  el('modal-bg').classList.add('on');

  el('DUP-del').addEventListener('click',function(){
    var checked=Array.from(el('DUP-list').querySelectorAll('.dup-chk:checked')).map(function(c){return c.getAttribute('data-wid');});
    if(!checked.length){toast('å‰Šé™¤ã™ã‚‹å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
    G.words=G.words.filter(function(w){return checked.indexOf(w.id)<0;});
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('ğŸ—‘ï¸ '+checked.length+'ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
  });
  el('DUP-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* â”€â”€ é¸æŠãƒ¢ãƒ¼ãƒ‰ â”€â”€ */
var selModeOn=false, selSet={};
function toggleSelMode(){
  selModeOn=!selModeOn; selSet={};
  el('SEL-toolbar').style.display=selModeOn?'block':'none';
  el('B-sel-mode').style.color=selModeOn?'var(--ac)':'var(--tx2)';
  listRender();
  updateSelCount();
}
function updateSelCount(){
  var n=Object.keys(selSet).length;
  el('SEL-count').textContent=n+'ä»¶é¸æŠä¸­';
}
function selWordToggle(wid){
  if(selSet[wid])delete selSet[wid]; else selSet[wid]=true;
  var chk=document.querySelector('.word-sel-chk[data-wid="'+wid+'"]');
  if(chk)chk.checked=!!selSet[wid];
  updateSelCount();
}
function selDeleteAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(!confirm(ids.length+'ä»¶ã®å˜èªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  G.words=G.words.filter(function(w){return!selSet[w.id];});
  selSet={};save();homeRefresh();listRender();updateSelCount();toast('ğŸ—‘ï¸ '+ids.length+'ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
}
function selMoveAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(G.lists.length<2){toast('ç§»å‹•å…ˆãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var opts=G.lists.map(function(l){return '<button class="btn-sec sel-mv-btn" data-lid="'+l.id+'" style="margin-bottom:6px;margin-top:0">'+escHtml(l.name)+'</button>';}).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœ¦ ç§»å‹•å…ˆãƒªã‚¹ãƒˆã‚’é¸æŠ</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">'+ids.length+'ä»¶ã‚’ç§»å‹•ã—ã¾ã™</div>'+
    opts+
    '<button class="btn-sec" id="MV-cancel" style="margin-top:8px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.sel-mv-btn').forEach(function(b){
    b.addEventListener('click',function(){
      var toLid=this.getAttribute('data-lid');
      G.words.forEach(function(w){if(selSet[w.id])w.lid=toLid;});
      selSet={};save();el('modal-bg').classList.remove('on');
      listRender();updateSelCount();toast('âœ… ç§»å‹•ã—ã¾ã—ãŸ');
    });
  });
  el('MV-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}
/* ========== END EDIT FUNCTIONS ========== */


/* ---------- SPEECH ---------- */
var LANG_VOICE={en:'en-US',de:'de-DE',fr:'fr-FR',es:'es-ES',it:'it-IT'};

/* ---- éŸ³æ¥½ãƒ€ãƒƒã‚­ãƒ³ã‚° ---- */
var DUCK_VOL=0.15; /* èª­ã¿ä¸Šã’ä¸­ã®éŸ³æ¥½éŸ³é‡ */
var _duckActive=0; /* ãƒã‚¹ãƒˆå¯¾å¿œã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
function duckStart(){
  _duckActive++;
  if(_duckActive>1)return;
  document.querySelectorAll('audio,video').forEach(function(m){
    if(!m.paused&&!m._preVol){m._preVol=m.volume;m.volume=Math.min(m.volume,DUCK_VOL);}
  });
}
function duckEnd(){
  _duckActive=Math.max(0,_duckActive-1);
  if(_duckActive>0)return;
  setTimeout(function(){ /* å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆ»ã™ï¼ˆæ¬¡ã®èª­ã¿ä¸Šã’ãŒæ¥ãŸå ´åˆå¯¾ç­–ï¼‰ */
    if(_duckActive>0)return;
    document.querySelectorAll('audio,video').forEach(function(m){
      if(m._preVol!=null){m.volume=m._preVol;delete m._preVol;}
    });
  },300);
}

function speak(text, lang){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);
  u.lang=LANG_VOICE[lang||'en']||'en-US';
  u.rate=0.9;
  u.pitch=1.0;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();};
  u.onerror=function(){duckEnd();};
  setTimeout(function(){window.speechSynthesis.speak(u);},100);
}

/* ---------- FLASHCARD ---------- */
var FL={words:[],i:0,playing:false,timer:null,quizPool:null,quizMode:null,quizLid:null,token:0};

/* ---- èª­ã¿ä¸Šã’ã‚­ãƒ¥ãƒ¼ï¼ˆiOSå¯¾å¿œï¼‰ ---- */
var SQ={queue:[],busy:false};
function sqClear(){
  SQ.queue=[];SQ.busy=false;
  try{window.speechSynthesis.cancel();}catch(e){}
}
function sqSpeak(text,lang,cb){
  cb=cb||function(){};
  if(!text||!text.trim()){cb();return;} /* ç©ºæ–‡å­—ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦cbã ã‘å‘¼ã¶ */
  SQ.queue.push({text:text,lang:lang,cb:cb});
  if(!SQ.busy)sqNext();
}
function sqNext(){
  if(!SQ.queue.length){SQ.busy=false;return;}
  SQ.busy=true;
  var item=SQ.queue.shift();
  if(!window.speechSynthesis){item.cb();SQ.busy=false;sqNext();return;}
  var u=new SpeechSynthesisUtterance(item.text);
  u.lang=LANG_VOICE[item.lang||'en']||'en-US';
  u.rate=0.9;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  u.onerror=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  setTimeout(function(){
    window.speechSynthesis.speak(u);
    setTimeout(function(){if(window.speechSynthesis.paused)window.speechSynthesis.resume();},200);
  },80);
}

function speakWithCb(text,lang,cb){sqSpeak(text,lang,cb);}
function speakJa(text){sqSpeak(text,'ja',function(){});}

function flRender(){
  var token=++FL.token;
  var w=FL.words[FL.i];
  if(!w)return;
  var tot=FL.words.length,cur=FL.i+1;
  el('FL-fill').style.width=(cur/tot*100)+'%';
  el('FL-cnt').textContent=cur+'/'+tot;
  var l=LANGS[w.lang||'en'];
  el('FL-lang').textContent=l?l.flag+' '+l.name:'';
  var card=el('FL-card');
  card.classList.add('flip');

  setTimeout(function(){
    if(FL.token!==token)return;
    el('FL-word').textContent=w.word;
    el('FL-meaning').textContent='';
    card.classList.remove('flip');

    var mode=G.cfg.spkMode||'both';
    var doForeign=(mode==='both'||mode==='foreign');
    var doJa=(mode==='both'||mode==='ja');

    /* èª­ã¿ä¸Šã’å®Œäº†å¾Œã«æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸é€²ã‚€æ±ç”¨é–¢æ•° */
    function sayThen(text, lang, next){
      if(!text||!text.trim()||!window.speechSynthesis){
        setTimeout(next,50);return;
      }
      var u=new SpeechSynthesisUtterance(text);
      u.lang=lang; u.rate=0.9;
      u.onstart=function(){duckStart();};
      u.onend=function(){duckEnd();if(FL.token===token)next();};
      u.onerror=function(){duckEnd();if(FL.token===token)next();};
      window.speechSynthesis.speak(u);
    }

    /* â‘¢ ä¸¡æ–¹å®Œäº†å¾Œã«è¨­å®šç§’æ•°å¾…ã£ã¦æ¬¡ã¸ */
    function afterAll(){
      if(!FL.playing||FL.token!==token)return;
      FL.timer=setTimeout(function(){
        if(!FL.playing||FL.token!==token)return;
        if(FL.i<FL.words.length-1){FL.i++;flRender();}
        else{
          flStopAuto();
          if(G.cfg.autoQuiz){flStartAutoQuizCountdown();}
          else{toast('äºˆç¿’å®Œäº†ï¼ã‚¯ã‚¤ã‚ºã§ç¢ºèªã—ã‚ˆã†');}
        }
      },(G.cfg.flashSec||2)*1000);
    }

    /* â‘¡ å’Œè¨³ã‚’è¡¨ç¤ºã—ã¦æ—¥æœ¬èªèª­ã¿ä¸Šã’ â†’ afterAll */
    function showMeaning(){
      if(FL.token!==token)return;
      el('FL-meaning').textContent=w.meaning||'';
      if(doJa&&w.meaning&&w.meaning.trim()){
        sayThen(w.meaning,'ja-JP',afterAll);
      } else {
        afterAll();
      }
    }

    /* â‘  å¤–å›½èªèª­ã¿ä¸Šã’ â†’ 800mså¾Œã«showMeaning */
    if(doForeign&&w.word){
      sayThen(w.word, LANG_VOICE[w.lang||'en']||'en-US', function(){
        setTimeout(showMeaning, 800);
      });
    } else {
      setTimeout(showMeaning, 300);
    }

  },200);
}

function flNext(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i<FL.words.length-1){FL.i++;flRender();}
  else{toast('æœ€å¾Œã®å˜èªã§ã™');}
}
function flPrev(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i>0){FL.i--;flRender();}
  else{toast('æœ€åˆã®å˜èªã§ã™');}
}
function flToggleAuto(){
  if(FL.playing){flStopAuto();}
  else{
    FL.playing=true;
    el('FL-play').textContent='â¸';
    if(!SQ.busy&&!FL.timer){flRender();}
  }
}
function flStopAuto(){
  FL.playing=false;
  el('FL-play').textContent='â–¶';
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
}

/* äºˆç¿’å®Œäº†å¾Œã®è‡ªå‹•ã‚¯ã‚¤ã‚ºç§»è¡Œã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
var FL_AQ_timer=null;
function flStartAutoQuizCountdown(){
  var overlay=el('FL-auto-quiz-overlay');
  overlay.style.display='flex';
  var sec=3;
  function tick(){
    el('FL-aq-msg').textContent=sec+'ç§’å¾Œã«ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¾ã™';
    if(sec<=0){flLaunchAutoQuiz();return;}
    sec--;
    FL_AQ_timer=setTimeout(tick,1000);
  }
  tick();
}
function flCancelAutoQuiz(){
  if(FL_AQ_timer){clearTimeout(FL_AQ_timer);FL_AQ_timer=null;}
  el('FL-auto-quiz-overlay').style.display='none';
  toast('äºˆç¿’å®Œäº†ï¼ã‚¯ã‚¤ã‚ºã§ç¢ºèªã—ã‚ˆã†');
}
function flLaunchAutoQuiz(){
  if(FL_AQ_timer){clearTimeout(FL_AQ_timer);FL_AQ_timer=null;}
  el('FL-auto-quiz-overlay').style.display='none';
  if(window.speechSynthesis)window.speechSynthesis.cancel();
  var pool=FL.words.slice();
  if(pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
  var qpool=G.cfg.random ? shuffle(pool) : pool;
  var pending=Q._pendingCursor;
  Q={words:qpool,q:qpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
  if(pending)Q._pendingCursor=pending;
  go('s-quiz');qRender();
}

function flashStart(words, quizMode, quizLid){
  if(!words||!words.length){toast('å˜èªãŒã‚ã‚Šã¾ã›ã‚“');return;}
  sqClear();
  FL.words=words; FL.i=0; FL.playing=false; FL.timer=null; FL.token=0;
  FL.quizMode=quizMode; FL.quizLid=quizLid;
  go('s-flash');
  if(G.cfg.flashAuto){
    FL.playing=true;
    el('FL-play').textContent='â¸';
  }
  flRender();
}

function flBindButtons(){
  el('B-flash-exit').addEventListener('click',function(){
    flCancelAutoQuiz();
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    go('s-home');
  });
  el('FL-prev').addEventListener('click',flPrev);
  el('FL-next').addEventListener('click',flNext);
  el('FL-play').addEventListener('click',flToggleAuto);
  el('FL-spk').addEventListener('click',function(){
    var w=FL.words[FL.i];if(!w)return;
    speak(w.word,w.lang||'en');
    if(w.meaning)setTimeout(function(){speakJa(w.meaning);},1800);
  });
  el('FL-to-quiz').addEventListener('click',function(){
    flCancelAutoQuiz();
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    var pool=FL.words.slice();
    if(pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
    var qpool=G.cfg.random ? shuffle(pool) : pool;
    var pending=Q._pendingCursor;
    Q={words:qpool,q:qpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    if(pending)Q._pendingCursor=pending;
    go('s-quiz');qRender();
  });
  el('FL-aq-now').addEventListener('click',function(){flLaunchAutoQuiz();});
  el('FL-aq-cancel').addEventListener('click',function(){flCancelAutoQuiz();});
}

/* QUIZ */
var Q={words:[],q:[],i:0,ok:0,ng:0,done:false,miss:[],ci:0,ca:'',testMode:false,startMs:Date.now()};
/* ============================================================
   å­¦ç¿’å ±å‘Šæ›¸
   ============================================================ */
function showReportModal(){
  showReportStep1();
}

function showReportStep1(){
  var periods=[
    {id:'day',  label:'ğŸ“… æ—¥æ¬¡å ±å‘Šæ›¸', sub:'æœ¬æ—¥ã®å­¦ç¿’è¨˜éŒ²'},
    {id:'week', label:'ğŸ“† é€±æ¬¡å ±å‘Šæ›¸', sub:'éå»7æ—¥é–“ã®è¨˜éŒ²'},
    {id:'month',label:'ğŸ—“ï¸ æœˆæ¬¡å ±å‘Šæ›¸', sub:'éå»30æ—¥é–“ã®è¨˜éŒ²'}
  ];
  var html='<div class="modal-tl">ğŸ“Š å­¦ç¿’å ±å‘Šæ›¸ã‚’ä½œæˆ</div>';
  html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">â‘  æœŸé–“ã‚’é¸æŠ</div>';
  periods.forEach(function(p){
    html+='<button class="rpt-btn" data-period="'+p.id+'" style="display:flex;align-items:center;gap:12px;width:100%;background:var(--sf2);border:none;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;">'+
      '<div style="flex:1"><div style="font-size:14px;font-weight:600;color:var(--tx)">'+p.label+'</div>'+
      '<div style="font-size:11px;color:var(--tx2);margin-top:3px">'+p.sub+'</div></div>'+
      '<div style="font-size:18px;color:var(--tx2)">â€º</div></button>';
  });
  el('modal-ct').innerHTML=html;
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.rpt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      showReportStep2(this.getAttribute('data-period'));
    });
  });
}

function showReportStep2(period){
  var periodLabels={day:'æ—¥æ¬¡å ±å‘Šæ›¸',week:'é€±æ¬¡å ±å‘Šæ›¸',month:'æœˆæ¬¡å ±å‘Šæ›¸'};
  /* é¸æŠçŠ¶æ…‹ã‚’JSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ç®¡ç†ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä¸ä½¿ç”¨ï¼‰ */
  var selLids={all:true}; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå…¨ã¦é¸æŠ */

  function renderStep2(){
    var html='<div class="modal-tl">ğŸ“Š '+periodLabels[period]+'</div>';
    html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">â‘¡ å˜èªé›†ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>';

    function btnStyle(lid){
      var on=selLids[lid];
      return 'display:flex;align-items:center;gap:12px;width:100%;background:'+(on?'rgba(124,92,252,.15)':'var(--sf2)')+
        ';border:2px solid '+(on?'var(--ac)':'rgba(255,255,255,.1)')+
        ';border-radius:12px;padding:13px 14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;';
    }
    function chkMark(lid){
      return '<div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(selLids[lid]?'var(--ac)':'rgba(255,255,255,.2)')+
        ';background:'+(selLids[lid]?'var(--ac)':'transparent')+
        ';display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:#fff">'+
        (selLids[lid]?'âœ“':'')+
        '</div>';
    }

    html+='<button class="rpt-sel-btn" data-lid="all" style="'+btnStyle('all')+'">'+
      chkMark('all')+
      '<div style="flex:1"><div style="font-size:14px;font-weight:600;color:var(--tx)">ğŸ“š ã™ã¹ã¦ã®å˜èªé›†</div>'+
      '<div style="font-size:11px;color:var(--tx2);margin-top:2px">å…¨ãƒªã‚¹ãƒˆã‚’å¯¾è±¡ã«ã™ã‚‹</div></div></button>';

    G.lists.forEach(function(lst){
      var l=LANGS[lst.lang||'en'];
      var ws=G.words.filter(function(w){return w.lid===lst.id;});
      html+='<button class="rpt-sel-btn" data-lid="'+lst.id+'" style="'+btnStyle(lst.id)+'">'+
        chkMark(lst.id)+
        '<div style="font-size:22px;flex-shrink:0">'+(l?l.flag:'ğŸ“—')+'</div>'+
        '<div style="flex:1;min-width:0">'+
          '<div style="font-size:14px;font-weight:600;color:var(--tx);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(lst.name)+'</div>'+
          '<div style="font-size:11px;color:var(--tx2);margin-top:2px">'+ws.length+'å˜èª</div>'+
        '</div></button>';
    });

    html+='<button class="btn-primary" id="RPT-go" style="margin-top:4px">ğŸ“„ å ±å‘Šæ›¸ã‚’ä½œæˆ</button>';
    html+='<button class="btn-sec" id="RPT-back" style="margin-top:0;margin-top:8px">â† æˆ»ã‚‹</button>';
    el('modal-ct').innerHTML=html;

    el('modal-ct').querySelectorAll('.rpt-sel-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var lid=this.getAttribute('data-lid');
        if(lid==='all'){
          /* ã€Œå…¨ã¦ã€ã‚’ã‚¿ãƒƒãƒ— â†’ å…¨ã¦ONãƒ»å€‹åˆ¥OFF */
          selLids={all:true};
        } else {
          /* å€‹åˆ¥ã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå…¨ã¦ã€ã‚’OFFã€å€‹åˆ¥ãƒˆã‚°ãƒ« */
          delete selLids.all;
          if(selLids[lid]) delete selLids[lid];
          else selLids[lid]=true;
          /* ä½•ã‚‚é¸ã°ã‚Œãªã‘ã‚Œã°ã€Œå…¨ã¦ã€ã«æˆ»ã™ */
          if(!Object.keys(selLids).length) selLids={all:true};
        }
        renderStep2(); /* å†æç”» */
      });
    });

    el('RPT-go').addEventListener('click',function(){
      var lids=Object.keys(selLids);
      el('modal-bg').classList.remove('on');
      generateReport(period, lids);
    });
    el('RPT-back').addEventListener('click',function(){showReportStep1();});
  }

  renderStep2();
}

function generateReport(period, lids){
  if(!G.logs)G.logs=[];
  lids=lids||['all'];
  var now=new Date();
  var cutoff=new Date(now);
  var periodLabel='';
  if(period==='day'){cutoff.setHours(0,0,0,0);periodLabel='æ—¥æ¬¡å ±å‘Šæ›¸ï¼ˆ'+fmtDate(now)+'ï¼‰';}
  else if(period==='week'){cutoff.setDate(now.getDate()-6);cutoff.setHours(0,0,0,0);periodLabel='é€±æ¬¡å ±å‘Šæ›¸ï¼ˆ'+fmtDate(cutoff)+'ã€œ'+fmtDate(now)+'ï¼‰';}
  else{cutoff.setDate(now.getDate()-29);cutoff.setHours(0,0,0,0);periodLabel='æœˆæ¬¡å ±å‘Šæ›¸ï¼ˆ'+fmtDate(cutoff)+'ã€œ'+fmtDate(now)+'ï¼‰';}

  /* å˜èªé›†ãƒ•ã‚£ãƒ«ã‚¿ */
  var filterAll=(lids.indexOf('all')>=0||!lids.length);
  var listNames=[];
  if(!filterAll){
    lids.forEach(function(lid){
      var lst=G.lists.find(function(x){return x.id===lid;});
      if(lst)listNames.push(lst.name);
    });
  }

  /* ãƒ­ã‚°ã‚’æœŸé–“ï¼‹å˜èªé›†ã§ãƒ•ã‚£ãƒ«ã‚¿ */
  var logs=G.logs.filter(function(l){
    if(new Date(l.ts)<cutoff)return false;
    if(filterAll)return true;
    /* lidsã¨ãƒ­ã‚°ã®lidsãŒé‡ãªã‚‹ã‹ç¢ºèª */
    var logLids=l.lids||[];
    /* å¤ã„ãƒ­ã‚°ã¯wordsã‹ã‚‰æ¨å®š */
    if(!logLids.length&&l.words&&l.words.length){
      var lidSet={};
      l.words.forEach(function(wid){var w=G.words.find(function(x){return x.id===wid;});if(w&&w.lid)lidSet[w.lid]=true;});
      logLids=Object.keys(lidSet);
    }
    return lids.some(function(lid){return logLids.indexOf(lid)>=0;});
  });

  /* é›†è¨ˆ */
  var totalSessions=logs.length;
  var totalQ=logs.reduce(function(s,l){return s+l.total;},0);
  var totalOk=logs.reduce(function(s,l){return s+l.ok;},0);
  var totalNg=logs.reduce(function(s,l){return s+l.ng;},0);
  var avgAcc=totalQ?Math.round(totalOk/totalQ*100):0;
  /* dur(ç§’)ã¨durationMs(ãƒŸãƒªç§’)ã‚’ä¸¡å¯¾å¿œã§çµ±ä¸€ */
  var totalDurMs=logs.reduce(function(s,l){return s+(l.durationMs||((l.dur||0)*1000));},0);

  /* æ—¥åˆ¥é›†è¨ˆ */
  var dayMap={};
  logs.forEach(function(l){
    var d=l.ts.slice(0,10);
    if(!dayMap[d])dayMap[d]={ok:0,ng:0,total:0,sessions:0,durMs:0};
    dayMap[d].ok+=l.ok; dayMap[d].ng+=l.ng; dayMap[d].total+=l.total; dayMap[d].sessions++;
    dayMap[d].durMs+=(l.durationMs||((l.dur||0)*1000));
  });

  /* é–“é•ãˆãŸå˜èªã®é›†è¨ˆï¼ˆå›æ•°é †ï¼‰ */
  var missMap={};
  logs.forEach(function(l){
    (l.miss||[]).forEach(function(w){
      if(!missMap[w.id])missMap[w.id]={word:w.word,meaning:w.meaning,lang:w.lang,count:0};
      missMap[w.id].count++;
    });
  });
  var missArr=Object.values(missMap).sort(function(a,b){return b.count-a.count;});

  /* æº–è‹¦æ‰‹ï¼šæ­£è§£ã—ãŸãŒ5ç§’ä»¥ä¸Šã‹ã‹ã£ãŸå˜èª */
  var slowMap={};
  logs.forEach(function(l){
    (l.slow||[]).forEach(function(w){
      if(!slowMap[w.id])slowMap[w.id]={word:w.word,meaning:w.meaning||'',lang:w.lang||'en',count:0,totalMs:0};
      slowMap[w.id].count++;
      slowMap[w.id].totalMs+=(w.answerMs||0);
    });
  });
  var slowArr=Object.values(slowMap).map(function(w){w.avgMs=w.count?Math.round(w.totalMs/w.count):0;return w;})
    .sort(function(a,b){return b.count!==a.count?b.count-a.count:b.avgMs-a.avgMs;});

  /* æ­£ç­”ç‡æ¨ç§»ï¼ˆæ—¥åˆ¥ï¼‰ */
  var dayKeys=Object.keys(dayMap).sort();

  /* ãƒ¢ãƒ¼ãƒ‰åˆ¥å­¦ç¿’æ™‚é–“é›†è¨ˆ */
  var MODES=['due','study','all','weak','test'];
  var modeLabels={due:'ä»Šæ—¥ã®å¾©ç¿’',all:'å…¨å˜èªã‚¯ã‚¤ã‚º',weak:'è‹¦æ‰‹å˜èª',study:'äºˆç¿’â†’ã‚¯ã‚¤ã‚º',test:'ãƒ†ã‚¹ãƒˆå½¢å¼'};
  var modeColors={due:'#7c5cfc',all:'#4cff91',weak:'#fc5c7d',study:'#ffd700',test:'#5cf8fc'};
  var modeMs={due:0,all:0,weak:0,study:0,test:0};
  logs.forEach(function(l){
    var m=l.quizMode||(l.testMode?'test':'all');
    if(modeMs[m]===undefined)modeMs[m]=0;
    modeMs[m]+=(l.durationMs||((l.dur||0)*1000));
  });
  var modeData=MODES.filter(function(k){return modeMs[k]>0;}).map(function(k){
    return {key:k, label:modeLabels[k], ms:modeMs[k], color:modeColors[k]};
  });

  /* ãƒªã‚¹ãƒˆåˆ¥é›†è¨ˆ */
  var listMap={};
  logs.forEach(function(l){
    (l.lids||[]).forEach(function(lid){
      if(!listMap[lid])listMap[lid]={sessions:0,total:0,ok:0,durMs:0};
      listMap[lid].sessions++;
      listMap[lid].total+=l.total;
      listMap[lid].ok+=l.ok;
      listMap[lid].durMs+=(l.durationMs||((l.dur||0)*1000));
    });
    /* lidsãŒãªã„å¤ã„ãƒ­ã‚°ã¯wordsã‹ã‚‰æ¨å®š */
    if(!l.lids&&l.words&&l.words.length){
      var lidSet={};
      l.words.forEach(function(wid){
        var w=G.words.find(function(x){return x.id===wid;});
        if(w&&w.lid)lidSet[w.lid]=true;
      });
      Object.keys(lidSet).forEach(function(lid){
        if(!listMap[lid])listMap[lid]={sessions:0,total:0,ok:0,durMs:0};
        listMap[lid].sessions++;
        listMap[lid].total+=l.total;
        listMap[lid].ok+=l.ok;
        listMap[lid].durMs+=(l.durationMs||((l.dur||0)*1000));
      });
    }
  });
  var listData=Object.keys(listMap).map(function(lid){
    var lst=G.lists.find(function(x){return x.id===lid;});
    var r=listMap[lid];
    var acc2=r.total?Math.round(r.ok/r.total*100):0;
    return {lid:lid, name:lst?lst.name:'ï¼ˆå‰Šé™¤æ¸ˆã¿ãƒªã‚¹ãƒˆï¼‰', lang:lst?lst.lang:'', sessions:r.sessions, total:r.total, ok:r.ok, acc:acc2, durMs:r.durMs};
  }).sort(function(a,b){return b.durMs-a.durMs;});

  /* HTMLç”Ÿæˆï¼ˆ1ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ»ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆï¼‰ */
  var h=buildCombinedReportHTML(periodLabel, now,
    totalSessions, totalQ, totalOk, totalNg, avgAcc, totalDurMs,
    dayKeys, dayMap, logs, modeData, listData, period,
    filterAll?[]:listNames,
    missArr, slowArr);

  /* åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’1ã¤ã ã‘é–‹ã */
  var w=window.open('','_blank','width=900,height=700');
  if(!w){toast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');return;}
  w.document.write(h);
  w.document.close();
}

function fmtDate(d){
  return d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ'+d.getDate()+'æ—¥';
}
function fmtDateShort(s){
  var d=new Date(s);return (d.getMonth()+1)+'/'+d.getDate();
}

function buildCombinedReportHTML(title, now, sessions, totalQ, ok, ng, acc, totalDurMs, dayKeys, dayMap, logs, modeData, listData, period, targetListNames, missArr, slowArr){

  function fmtDur(ms){
    if(!ms||ms<1000)return '0åˆ†';
    var s=Math.round(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60);
    if(h>0)return h+'æ™‚é–“'+(m%60)+'åˆ†';
    if(m>0)return m+'åˆ†'+(s%60>0?s%60+'ç§’':'');
    return s+'ç§’';
  }

  /* â”€â”€ SVGï¼šè¤‡åˆã‚°ãƒ©ãƒ• â”€â”€ */
  function makeComboSVG(labels,durMins,accPcts){
    var n=labels.length;
    if(!n)return '<p style="color:#888;font-size:9pt;margin:8px 0">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    var GW=560,GH=120,PAD_L=36,PAD_R=36,PAD_B=22,PAD_T=14;
    var IW=GW-PAD_L-PAD_R,IH=GH-PAD_T-PAD_B;
    var bw=Math.min(36,Math.floor(IW/n)-3),step=IW/n;
    var maxDur=Math.max.apply(null,durMins.concat([1]));
    var grid='',yLbls='';
    [0,0.25,0.5,0.75,1].forEach(function(r){
      var y=PAD_T+IH-Math.round(r*IH);
      grid+='<line x1="'+PAD_L+'" y1="'+y+'" x2="'+(GW-PAD_R)+'" y2="'+y+'" stroke="'+(r===0||r===1?'#ccc':'#eee')+'" stroke-width="'+(r===0||r===1?'1':'0.5')+'" stroke-dasharray="'+(r>0&&r<1?'3,3':'0')+'"/>';
      yLbls+='<text x="'+(PAD_L-4)+'" y="'+(y+3)+'" text-anchor="end" font-size="7" fill="#888">'+Math.round(maxDur*r)+'</text>';
      yLbls+='<text x="'+(GW-PAD_R+4)+'" y="'+(y+3)+'" text-anchor="start" font-size="7" fill="#5c9cf8">'+(100*r|0)+'%</text>';
    });
    var bars='',barLbls='',xlbls='',lineP='',lineDots='';
    durMins.forEach(function(v,i){
      var bh=maxDur?Math.max(v>0?2:0,Math.round(v/maxDur*IH)):0;
      var cx=PAD_L+i*step+step/2,bx=cx-bw/2,by=PAD_T+IH-bh;
      bars+='<rect x="'+bx.toFixed(1)+'" y="'+by+'" width="'+bw+'" height="'+bh+'" fill="#7c5cfc" rx="2" opacity="0.75"/>';
      if(bh>13)barLbls+='<text x="'+cx.toFixed(1)+'" y="'+(by-2)+'" text-anchor="middle" font-size="6.5" fill="#7c5cfc">'+v+'åˆ†</text>';
      var show=(n<=14)||(i%Math.ceil(n/14)===0)||(i===n-1);
      if(show)xlbls+='<text x="'+cx.toFixed(1)+'" y="'+(GH-4)+'" text-anchor="middle" font-size="7" fill="#888">'+labels[i]+'</text>';
      var ap=accPcts[i],ly=PAD_T+IH-Math.round(ap/100*IH);
      lineDots+='<circle cx="'+cx.toFixed(1)+'" cy="'+ly+'" r="2.5" fill="'+(ap>=80?'#4cff91':ap>=60?'#ffd700':'#fc5c7d')+'" stroke="#fff" stroke-width="1"/>';
      if(i>0){var px=PAD_L+(i-1)*step+step/2,py=PAD_T+IH-Math.round(accPcts[i-1]/100*IH);lineP+='<line x1="'+px.toFixed(1)+'" y1="'+py+'" x2="'+cx.toFixed(1)+'" y2="'+ly+'" stroke="#5c9cf8" stroke-width="1.5" opacity="0.8"/>';}
    });
    var legend='<text x="'+(PAD_L+4)+'" y="'+(PAD_T-4)+'" font-size="7" fill="#7c5cfc">â–  å­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰</text><text x="'+(PAD_L+80)+'" y="'+(PAD_T-4)+'" font-size="7" fill="#5c9cf8">â€” æ­£ç­”ç‡</text>';
    return '<div style="overflow-x:auto"><svg viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:160px;display:block">'+grid+bars+barLbls+lineP+lineDots+xlbls+yLbls+legend+'</svg></div>';
  }

  function makeModeSVG(modeData){
    if(!modeData||!modeData.length)return '';
    var n=modeData.length,GW=560,GH=100,PAD_L=10,PAD_R=10,PAD_B=22,PAD_T=10;
    var IW=GW-PAD_L-PAD_R,IH=GH-PAD_T-PAD_B;
    var step=IW/n,bw=Math.min(60,step-12);
    var maxMs=Math.max.apply(null,modeData.map(function(m){return m.ms;}).concat([1]));
    var grid='',yLbls='';
    [0,0.5,1].forEach(function(r){
      var y=PAD_T+IH-Math.round(r*IH);
      grid+='<line x1="'+PAD_L+'" y1="'+y+'" x2="'+(GW-PAD_R)+'" y2="'+y+'" stroke="'+(r===0||r===1?'#ccc':'#eee')+'" stroke-width="1"/>';
      if(r>0)yLbls+='<text x="'+(PAD_L-2)+'" y="'+(y+3)+'" text-anchor="end" font-size="7" fill="#888">'+fmtDur(maxMs*r)+'</text>';
    });
    var bars='',barLbls='',xlbls='';
    modeData.forEach(function(m,i){
      var bh=maxMs?Math.max(m.ms>0?2:0,Math.round(m.ms/maxMs*IH)):0;
      var cx=PAD_L+i*step+step/2,bx=cx-bw/2,by=PAD_T+IH-bh;
      bars+='<rect x="'+bx.toFixed(1)+'" y="'+by+'" width="'+bw+'" height="'+bh+'" fill="'+m.color+'" rx="3" opacity="0.85"/>';
      if(bh>13)barLbls+='<text x="'+cx.toFixed(1)+'" y="'+(by-2)+'" text-anchor="middle" font-size="7" fill="'+m.color+'">'+fmtDur(m.ms)+'</text>';
      xlbls+='<text x="'+cx.toFixed(1)+'" y="'+(GH-4)+'" text-anchor="middle" font-size="7.5" fill="#555">'+m.label+'</text>';
    });
    return '<div style="overflow-x:auto"><svg viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:130px;display:block">'+grid+bars+barLbls+xlbls+yLbls+'</svg></div>';
  }

  /* ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ */
  var comboLabels=[],comboDurMins=[],comboAccPcts=[];
  if(period==='day'||period==='week'){
    comboLabels=dayKeys.map(function(d){return fmtDateShort(d);});
    comboDurMins=dayKeys.map(function(d){return Math.round((dayMap[d].durMs||0)/60000);});
    comboAccPcts=dayKeys.map(function(d){var r=dayMap[d];return r.total?Math.round(r.ok/r.total*100):0;});
  } else {
    var weekMap={};
    dayKeys.forEach(function(d){
      var dt=new Date(d),dow=dt.getDay()||7,mon=new Date(dt);
      mon.setDate(dt.getDate()-(dow-1));
      var wk=mon.toISOString().slice(0,10);
      if(!weekMap[wk])weekMap[wk]={durMs:0,ok:0,total:0};
      weekMap[wk].durMs+=(dayMap[d].durMs||0);
      weekMap[wk].ok+=dayMap[d].ok; weekMap[wk].total+=dayMap[d].total;
    });
    var wkKeys=Object.keys(weekMap).sort();
    comboLabels=wkKeys.map(function(k){var d=new Date(k);return(d.getMonth()+1)+'/'+(d.getDate())+'ã€œ';});
    comboDurMins=wkKeys.map(function(k){return Math.round(weekMap[k].durMs/60000);});
    comboAccPcts=wkKeys.map(function(k){var r=weekMap[k];return r.total?Math.round(r.ok/r.total*100):0;});
  }
  var comboSVG=makeComboSVG(comboLabels,comboDurMins,comboAccPcts);
  var modeSVG=makeModeSVG(modeData);
  var graphSection='';
  if(dayKeys.length>0){
    graphSection=
      '<h2>ğŸ“Š å­¦ç¿’çŠ¶æ³ã‚°ãƒ©ãƒ•</h2>'+
      '<div style="background:#f8f8ff;border:1px solid #e8e8f8;border-radius:8px;padding:12px;margin-bottom:14px">'+
        '<div style="font-size:9pt;font-weight:600;color:#555;margin-bottom:6px">â±ï¸ å­¦ç¿’æ™‚é–“ï¼ˆæ£’ï¼‰ï¼‹ ğŸ“ˆ æ­£ç­”ç‡ï¼ˆæŠ˜ã‚Œç·šï¼‰</div>'+comboSVG+
      '</div>'+
      (modeSVG?'<div style="background:#f8f8ff;border:1px solid #e8e8f8;border-radius:8px;padding:12px;margin-bottom:14px"><div style="font-size:9pt;font-weight:600;color:#555;margin-bottom:6px">ğŸ¯ ãƒ¢ãƒ¼ãƒ‰åˆ¥å­¦ç¿’æ™‚é–“</div>'+modeSVG+'</div>':'');
  }

  /* æ—¥åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ« */
  var langNames={en:'è‹±èª',de:'ãƒ‰ã‚¤ãƒ„èª',fr:'ãƒ•ãƒ©ãƒ³ã‚¹èª',es:'ã‚¹ãƒšã‚¤ãƒ³èª',it:'ã‚¤ã‚¿ãƒªã‚¢èª'};
  var dayRows='';
  dayKeys.forEach(function(d){
    var r=dayMap[d],a=r.total?Math.round(r.ok/r.total*100):0;
    var clr=a>=80?'#2e7d32':a>=60?'#f57c00':'#c62828';
    dayRows+='<tr><td>'+d.replace(/-/g,'/')+'</td><td>'+r.sessions+'</td><td>'+r.total+'</td><td>'+r.ok+'</td><td>'+r.ng+'</td>'+
      '<td><span style="color:'+clr+';font-weight:700">'+a+'%</span></td><td>'+fmtDur(r.durMs||0)+'</td></tr>';
  });
  if(!dayRows)dayRows='<tr><td colspan="7" style="text-align:center;color:#888;padding:14px">ã“ã®æœŸé–“ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';

  /* å˜èªé›†ãƒ†ãƒ¼ãƒ–ãƒ« */
  var listRows='';
  if(listData&&listData.length){
    listData.forEach(function(d){
      var l=LANGS[d.lang||'en'];
      var clr=d.acc>=80?'#2e7d32':d.acc>=60?'#f57c00':'#c62828';
      listRows+='<tr><td><strong>'+escHtml(d.name)+'</strong></td><td>'+(l?l.flag+' '+l.name:'â€”')+'</td>'+
        '<td style="text-align:center">'+d.sessions+'</td><td style="text-align:center">'+d.total+'</td>'+
        '<td style="text-align:center;color:'+clr+';font-weight:700">'+d.acc+'%</td><td>'+fmtDur(d.durMs)+'</td></tr>';
    });
  } else {
    listRows='<tr><td colspan="6" style="text-align:center;color:#888;padding:14px">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
  }

  /* è‹¦æ‰‹å˜èªãƒ†ãƒ¼ãƒ–ãƒ« */
  var missRows='';
  if(missArr&&missArr.length){
    missArr.forEach(function(w,i){
      missRows+='<tr><td style="text-align:center">'+(i+1)+'</td><td><strong>'+escHtml(w.word)+'</strong></td>'+
        '<td>'+escHtml(w.meaning)+'</td><td>'+(langNames[w.lang]||w.lang)+'</td>'+
        '<td style="color:#c62828;font-weight:700;text-align:center">'+w.count+'å›</td></tr>';
    });
  } else {
    missRows='<tr><td colspan="5" style="text-align:center;color:#888;padding:14px">é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ ğŸ‰</td></tr>';
  }

  /* æº–è‹¦æ‰‹ãƒ†ãƒ¼ãƒ–ãƒ« */
  var slowRows='';
  if(slowArr&&slowArr.length){
    slowArr.forEach(function(w,i){
      var avgSec=(w.avgMs/1000).toFixed(1);
      var secClr=w.avgMs>=15000?'#c62828':w.avgMs>=10000?'#f57c00':'#e65100';
      var medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
      slowRows+='<tr><td style="text-align:center">'+(medal||'<span style="color:#aaa">'+(i+1)+'</span>')+'</td>'+
        '<td><strong>'+escHtml(w.word)+'</strong></td><td>'+escHtml(w.meaning)+'</td>'+
        '<td>'+(langNames[w.lang]||w.lang)+'</td>'+
        '<td style="color:'+secClr+';font-weight:700;text-align:center">'+avgSec+'ç§’</td>'+
        '<td style="text-align:center;color:#888">'+w.count+'å›</td></tr>';
    });
  } else {
    slowRows='<tr><td colspan="6" style="text-align:center;color:#888;padding:14px">5ç§’ä»¥ä¸Šã‹ã‹ã£ãŸå˜èªã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‘</td></tr>';
  }

  var badges=(targetListNames&&targetListNames.length)?
    '<div style="margin-bottom:12px">'+targetListNames.map(function(n){return'<span style="display:inline-block;background:#7c5cfc22;color:#7c5cfc;border:1px solid #7c5cfc44;border-radius:6px;padding:2px 10px;font-size:9pt;font-weight:600;margin:0 3px 3px 0">'+escHtml(n)+'</span>';}).join('')+'</div>':'';

  /* â”€â”€ å­¦ç¿’å ±å‘Šæ›¸ãƒšãƒ¼ã‚¸ â”€â”€ */
  var page1=
    '<div id="tab-summary" class="tab-content" style="display:block">'+
    '<h1>ğŸ“Š VocabMaster å­¦ç¿’å ±å‘Šæ›¸</h1>'+
    '<div class="subtitle">'+escHtml(title)+' ï½œ ä½œæˆï¼š'+fmtDate(now)+' '+now.getHours()+'æ™‚'+String(now.getMinutes()).padStart(2,'0')+'åˆ†</div>'+
    badges+
    '<div class="summary-grid">'+
      '<div class="summary-box"><div class="summary-n">'+sessions+'</div><div class="summary-l">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div></div>'+
      '<div class="summary-box"><div class="summary-n">'+totalQ+'</div><div class="summary-l">ç·å‡ºé¡Œæ•°</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#2e7d32">'+ok+'</div><div class="summary-l">æ­£è§£æ•°</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#'+(acc>=80?'2e7d32':acc>=60?'f57c00':'c62828')+'">'+acc+'%</div><div class="summary-l">å¹³å‡æ­£ç­”ç‡</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#7c5cfc;font-size:14pt">'+fmtDur(totalDurMs)+'</div><div class="summary-l">ç·å­¦ç¿’æ™‚é–“</div></div>'+
    '</div>'+
    graphSection+
    '<h2>ğŸ“‹ æ—¥åˆ¥å­¦ç¿’è¨˜éŒ²</h2>'+
    '<table><tr><th>æ—¥ä»˜</th><th>ã‚»ãƒƒã‚·ãƒ§ãƒ³</th><th>å‡ºé¡Œæ•°</th><th>æ­£è§£</th><th>ä¸æ­£è§£</th><th>æ­£ç­”ç‡</th><th>å­¦ç¿’æ™‚é–“</th></tr>'+dayRows+'</table>'+
    '</div>';

  /* â”€â”€ å˜èªãƒ¬ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ â”€â”€ */
  var page2=
    '<div id="tab-words" class="tab-content" style="display:none">'+
    '<h1>ğŸ“ å˜èªãƒ¬ãƒãƒ¼ãƒˆ</h1>'+
    '<div class="subtitle">'+escHtml(title)+' ï½œ ä½œæˆï¼š'+fmtDate(now)+' '+now.getHours()+'æ™‚'+String(now.getMinutes()).padStart(2,'0')+'åˆ†</div>'+
    badges+
    '<h2 style="border-left-color:#7c5cfc">ğŸ“š ä½¿ç”¨ã—ãŸå˜èªé›†</h2>'+
    '<table><tr><th style="background:#7c5cfc">å˜èªé›†å</th><th style="background:#7c5cfc">è¨€èª</th><th style="background:#7c5cfc">ã‚»ãƒƒã‚·ãƒ§ãƒ³</th><th style="background:#7c5cfc">å‡ºé¡Œæ•°</th><th style="background:#7c5cfc">æ­£ç­”ç‡</th><th style="background:#7c5cfc">å­¦ç¿’æ™‚é–“</th></tr>'+listRows+'</table>'+
    '<h2 style="border-left-color:#c62828">âŒ è‹¦æ‰‹å˜èªï¼ˆä¸æ­£è§£ãŒå¤šã„é †ï¼‰</h2>'+
    '<table><tr><th style="background:#c62828">#</th><th style="background:#c62828">å˜èª</th><th style="background:#c62828">æ„å‘³</th><th style="background:#c62828">è¨€èª</th><th style="background:#c62828">é–“é•ã„å›æ•°</th></tr>'+missRows+'</table>'+
    '<h2 style="border-left-color:#e65100">â±ï¸ æº–è‹¦æ‰‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå›ç­”ã«æ™‚é–“ãŒã‹ã‹ã£ãŸå˜èªï¼‰</h2>'+
    '<div style="font-size:9pt;color:#888;margin:-8px 0 10px">æ­£è§£ã—ãŸãŒ5ç§’ä»¥ä¸Šã‹ã‹ã£ãŸå˜èª ï¼ å¹³å‡å›ç­”æ™‚é–“ã®é•·ã„é †</div>'+
    '<table><tr><th style="background:#e65100">#</th><th style="background:#e65100">å˜èª</th><th style="background:#e65100">æ„å‘³</th><th style="background:#e65100">è¨€èª</th><th style="background:#e65100">å¹³å‡å›ç­”æ™‚é–“</th><th style="background:#e65100">è¨ˆæ¸¬å›æ•°</th></tr>'+slowRows+'</table>'+
    '</div>';

  return '<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
    '<title>'+escHtml(title)+'</title>'+
    '<style>'+
    '@page{size:A4;margin:12mm 12mm 18mm 12mm}'+
    'body{font-family:"Hiragino Sans","Yu Gothic","Meiryo",Arial,sans-serif;font-size:10.5pt;color:#1a1a2e;background:#fff;margin:0;padding:0}'+
    '.topbar{display:flex;gap:8px;align-items:center;padding:12px 20px;background:#1a1a2e;position:sticky;top:0;z-index:10}'+
    '.tab-btn{padding:8px 20px;border:none;border-radius:8px;font-size:11pt;font-weight:600;cursor:pointer;font-family:inherit;background:rgba(255,255,255,.15);color:#fff}'+
    '.tab-btn.active{background:#7c5cfc;color:#fff}'+
    '.btn-print{padding:8px 18px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:11pt;font-weight:600;cursor:pointer;font-family:inherit;margin-left:auto}'+
    '.btn-close{padding:8px 14px;background:#888;color:#fff;border:none;border-radius:8px;font-size:11pt;cursor:pointer;font-family:inherit}'+
    '.tab-content{max-width:800px;margin:0 auto;padding:20px 20px 40px}'+
    'h1{font-size:18pt;color:#1a1a2e;border-bottom:3px solid #7c5cfc;padding-bottom:8px;margin-bottom:6px}'+
    'h2{font-size:12pt;color:#1a1a2e;border-left:4px solid #7c5cfc;padding-left:10px;margin:22px 0 10px}'+
    '.subtitle{color:#666;font-size:9.5pt;margin-bottom:14px}'+
    '.summary-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px}'+
    '.summary-box{background:#f8f8ff;border:1px solid #e0e0f0;border-radius:8px;padding:10px;text-align:center}'+
    '.summary-n{font-size:17pt;font-weight:700;color:#7c5cfc}'+
    '.summary-l{font-size:8pt;color:#666;margin-top:4px}'+
    'table{width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px}'+
    'th{background:#1a1a2e;color:#fff;padding:7px 8px;text-align:left;font-weight:600}'+
    'td{padding:6px 8px;border-bottom:1px solid #eee}'+
    'tr:nth-child(even) td{background:#f8f8ff}'+
    '.footer{margin-top:20px;padding-top:10px;border-top:1px solid #ddd;font-size:8pt;color:#aaa;text-align:center}'+
    '@media print{.topbar{display:none!important}.tab-content{display:block!important}h1{page-break-before:always}h1:first-child{page-break-before:avoid}th{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'+
    '</style>'+
    '<script>'+
    'function showTab(id){'+
      'document.querySelectorAll(".tab-content").forEach(function(el){el.style.display="none";});'+
      'document.getElementById(id).style.display="block";'+
      'document.querySelectorAll(".tab-btn").forEach(function(b){b.classList.remove("active");});'+
      'document.querySelector("[data-tab="+id+"]").classList.add("active");'+
    '}'+
    '<\/script>'+
    '</head><body>'+
    '<div class="topbar no-print">'+
      '<button class="tab-btn active" data-tab="tab-summary" onclick="showTab(\'tab-summary\')">ğŸ“Š å­¦ç¿’å ±å‘Šæ›¸</button>'+
      '<button class="tab-btn" data-tab="tab-words" onclick="showTab(\'tab-words\')">ğŸ“ å˜èªãƒ¬ãƒãƒ¼ãƒˆ</button>'+
      '<button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>'+
      '<button class="btn-close" onclick="window.close()">âœ•</button>'+
    '</div>'+
    page1+page2+
    '</body></html>';
}


function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ãƒªã‚¹ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆäºˆç¿’â†’ã‚¯ã‚¤ã‚º / ãƒ†ã‚¹ãƒˆå½¢å¼ï¼‰ */
function showListSelectModal(mode){
  if(!G.lists.length){toast('å˜èªãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var isStudy=(mode==='study');
  var title=isStudy?'ğŸ“– äºˆç¿’â†’ã‚¯ã‚¤ã‚ºï¼šãƒªã‚¹ãƒˆã‚’é¸æŠ':'ğŸ“ ãƒ†ã‚¹ãƒˆå½¢å¼ï¼šãƒªã‚¹ãƒˆã‚’é¸æŠ';
  var sub=isStudy?'äºˆç¿’ï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ï¼‰ã®å¾Œã«åŒã˜å˜èªã§ã‚¯ã‚¤ã‚º':'äºˆç¿’ãªã—ãƒ»SRSæ›´æ–°ãªã—ãƒ»æ¡ç‚¹ã®ã¿';
  var html='<div class="modal-tl">'+title+'</div>';
  html+='<div style="font-size:11px;color:var(--tx2);margin-bottom:12px">'+sub+'</div>';
  G.lists.forEach(function(lst){
    var l=LANGS[lst.lang||'en'];
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var cnt=ws.length;
    var cursor=lst.cursor||0; if(cursor>=cnt)cursor=0;
    var pct=cnt>0?Math.min(100,Math.round(cursor/cnt*100)):0;
    var progClr=pct>=100?'#4cff91':pct>=60?'#5cf8fc':'#7c5cfc';
    html+='<button class="list-sel-btn" data-lid="'+esc(lst.id)+'" style="display:flex;align-items:center;gap:10px;width:100%;background:var(--sf2);border:none;border-radius:12px;padding:12px 14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;">'+
      '<div style="width:36px;height:36px;border-radius:9px;background:'+lst.clr+'20;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">'+(l?l.flag:'ğŸ“—')+'</div>'+
      '<div style="flex:1;min-width:0">'+
        '<div style="font-size:14px;font-weight:600;color:var(--tx)">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
        '<div style="font-size:11px;color:var(--tx2);margin-top:2px">'+cnt+'å˜èª Â· é€²æ— '+pct+'%</div>'+
        '<div style="height:3px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:5px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+progClr+';border-radius:2px"></div></div>'+
      '</div>'+
      '<div style="font-size:18px;color:var(--tx2)">â€º</div></button>';
  });
  el('modal-ct').innerHTML=html;
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.list-sel-btn').forEach(function(b){
    b.addEventListener('click',function(){
      var lid=this.getAttribute('data-lid');
      var lst=G.lists.find(function(l){return l.id===lid;});
      var ws=G.words.filter(function(w){return w.lid===lid;});
      if(ws.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
      el('modal-bg').classList.remove('on');
      var size=Math.min(parseInt(G.cfg.size)||20, ws.length);
      var cursor=lst.cursor||0; if(cursor>=ws.length)cursor=0;
      var remaining=ws.slice(cursor);
      var pool;
      if(G.cfg.random){
        pool=shuffle(remaining).slice(0,size);
      } else {
        pool=remaining.slice(0,size);
      }
      if(pool.length<2){
        pool=G.cfg.random ? shuffle(ws.slice()).slice(0,size) : ws.slice(0,size);
      }
      var nextCursor=Math.min(cursor+size, ws.length);
      if(isStudy){
        Q._pendingCursor={lid:lid, next:nextCursor};
        flashStart((G.cfg.random ? shuffle(pool.slice()) : pool.slice()),'list',lid);
      } else {
        var tpool=G.cfg.random ? shuffle(pool.slice()) : pool.slice();
        Q={words:tpool,q:tpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:true,quizMode:'test',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
        go('s-quiz');qRender();
      }
    });
  });
}

function quizStart(mode,lid){
  var pool=[];
  if(mode==='due')pool=getDue();
  else if(mode==='all')pool=G.words.slice();
  else if(mode==='weak'){pool=getWeak();if(!pool.length){toast('é–“é•ãˆãŸå˜èªãŒã‚ã‚Šã¾ã›ã‚“');return;}}
  else if(mode==='list')pool=G.words.filter(function(w){return w.lid===lid;});
  if(pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
  var size=Math.min(pool.length,parseInt(G.cfg.size)||20);
  var ws=(G.cfg.random ? shuffle(pool) : pool).slice(0,size);
  Q={words:ws,q:ws.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:mode,sessionStart:Date.now(),
     consec:{},mastered:0,masteredIds:{}}; /* consec: wordIdâ†’é€£ç¶šæ­£è§£æ•° */
  go('s-quiz');qRender();
}

function qRender(){
  var q=Q.q[Q.i];if(!q){qResult();return;}
  if(Q.i===0&&!Q.sessionStart)Q.sessionStart=Date.now();

  var totalWords=Q.words.length;
  var mastered=Q.mastered||0;
  el('QZ-fill').style.width=(mastered/totalWords*100)+'%';
  el('QZ-cnt').textContent=mastered+'/'+totalWords;
  el('QZ-mode-badge').style.display=Q.testMode?'inline-block':'none';
  var rev=G.cfg.rev&&Math.random()<0.3;Q.rev=rev;
  var l=LANGS[q.lang||'en'];
  el('QZ-badge').textContent=rev?(l?l.name:'å¤–å›½èª')+'ã‚’é¸ã¹':'æ—¥æœ¬èªã‚’é¸ã¹';
  var displayWord=rev?(q.meaning||q.word):q.word;
  el('QZ-word').textContent=displayWord;
  Q.done=false;

  /* ç™ºéŸ³ãƒœã‚¿ãƒ³ â€” å¤–å›½èªãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘è¡¨ç¤º */
  var spk=el('B-speak');
  var isForLang=!rev;
  if(isForLang&&window.speechSynthesis){
    spk.style.display='inline-block';
    spk.onclick=function(){speak(q.word, q.lang||'en');};
    /* è‡ªå‹•èª­ã¿ä¸Šã’ãŒã‚ªãƒ³ã®ã¨ã */
    if(G.cfg.speak!==false){speak(q.word, q.lang||'en');}
  } else {
    spk.style.display='none';
    if(window.speechSynthesis)window.speechSynthesis.cancel();
  }

  var ca=rev?q.word:(q.meaning||'ï¼ˆè¨³ãªã—ï¼‰');
  var sameLang=G.words.filter(function(w){return w.id!==q.id&&(w.lang||'en')===(q.lang||'en');});
  var others=sameLang.length>=3?sameLang:G.words.filter(function(w){return w.id!==q.id;});
  var dist=shuffle(others).slice(0,3).map(function(w){return rev?w.word:(w.meaning||w.word);});
  var choices=shuffle([ca].concat(dist).slice(0,4));
  while(choices.length<4)choices.push('---');
  Q.ca=ca;Q.ci=choices.indexOf(ca);
  var L=['A','B','C','D'],h='';
  choices.forEach(function(c,i){
    h+='<button class="ch-btn" data-i="'+i+'"><div class="ch-lt">'+L[i]+'</div><div class="ch-tx">'+esc(c)+'</div><div class="ch-ic"></div></button>';
  });
  h+='<button class="ch-dk" id="QZ-dontknow">â“ åˆ†ã‹ã‚‰ãªã„</button>';
  el('QZ-choices').innerHTML=h;
  el('QZ-choices').querySelectorAll('.ch-btn').forEach(function(b){b.addEventListener('click',function(){qSelect(parseInt(this.getAttribute('data-i')));});});
  el('QZ-choices').querySelector('#QZ-dontknow').addEventListener('click',function(){qDontKnow();});
  el('FB').classList.remove('on');
  Q.qStartTime=Date.now();
}

function qDontKnow(){
  if(Q.done)return;Q.done=true;
  var answerMs=Q.qStartTime?Date.now()-Q.qStartTime:0;
  /* å…¨ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ– */
  el('QZ-choices').querySelectorAll('.ch-btn,.ch-dk').forEach(function(b){b.classList.add('done');});
  /* æ­£è§£ã‚’ç·‘ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  var btns=el('QZ-choices').querySelectorAll('.ch-btn');
  btns[Q.ci].classList.add('ok');
  btns[Q.ci].querySelector('.ch-ic').textContent='âœ“';
  var q=Q.q[Q.i];
  q._answerMs=answerMs;
  /* ä¸æ­£è§£ã¨åŒã˜æ‰±ã„ï¼ˆSRSæ›´æ–°ãƒ»missè¿½åŠ ï¼‰ */
  answer(q,false);
  Q.ng++;
  Q.miss.push(q);
  /* hadMissãƒ•ãƒ©ã‚° â†’ 2å›é€£ç¶šæ­£è§£ãŒå¿…è¦ã«ãªã‚‹ */
  if(!Q.consec)Q.consec={};
  q._hadMiss=true;
  Q.consec[q.id]=0;
  /* ç¿’å¾—ã‚«ã‚¦ãƒ³ãƒˆã¯å¢—ã‚„ã•ãªã„ */
  el('FB-tx').innerHTML='<span style="color:var(--ac3)">â“ åˆ†ã‹ã‚‰ãªã„</span> â†’ <span style="color:var(--gn)">'+esc(Q.ca)+'</span>';
  el('FB-dt').textContent=Q.testMode?'':'1æ—¥å¾Œã«å†å¾©ç¿’';
  el('FB').classList.add('on');
}

function qSelect(i){
  if(Q.done)return;Q.done=true;
  var answerMs=Q.qStartTime?Date.now()-Q.qStartTime:0;
  var btns=el('QZ-choices').querySelectorAll('.ch-btn');
  btns.forEach(function(b){b.classList.add('done');});
  var ok=(i===Q.ci);
  btns[i].classList.add(ok?'ok':'ng');
  btns[i].querySelector('.ch-ic').textContent=ok?'âœ“':'âœ—';
  if(!ok){btns[Q.ci].classList.add('ok');btns[Q.ci].querySelector('.ch-ic').textContent='âœ“';}
  var q=Q.q[Q.i];
  q._answerMs=answerMs;
  answer(q,ok);
  ok?Q.ok++:(Q.ng++,Q.miss.push(q));
  if(ok&&answerMs>=5000){
    if(!Q.slow)Q.slow=[];
    Q.slow.push({id:q.id,word:q.word,meaning:q.meaning||'',lang:q.lang||'en',lid:q.lid,answerMs:answerMs});
  }
  /* ç¿’å¾—åˆ¤å®šï¼šåˆå›æ­£è§£ã§å³ç¿’å¾—ã€‚ä¸æ­£è§£å¾Œã¯2å›é€£ç¶šæ­£è§£ã§ç¿’å¾— */
  if(!Q.consec)Q.consec={};
  if(!Q.masteredIds)Q.masteredIds={};
  var hadMiss=!!q._hadMiss;
  if(!ok){ q._hadMiss=true; Q.consec[q.id]=0; }
  else { Q.consec[q.id]=(Q.consec[q.id]||0)+1; }
  var justMastered=ok&&(!hadMiss||Q.consec[q.id]>=2)&&!Q.masteredIds[q.id];
  if(justMastered){Q.masteredIds[q.id]=true;Q.mastered=(Q.mastered||0)+1;}

  el('FB-tx').innerHTML=ok
    ?(justMastered?'<span style="color:var(--gn)">âœ“ æ­£è§£ï¼</span>':'<span style="color:var(--gn)">âœ“ æ­£è§£ï¼ ã‚‚ã†1å›ï¼</span>')
    :'<span style="color:var(--rd)">âœ— ä¸æ­£è§£</span> â†’ '+esc(Q.ca);
  el('FB-dt').textContent=Q.testMode?'':(ok?'æ¬¡å›: '+(q.s&&q.s.i||1)+'æ—¥å¾Œ':'1æ—¥å¾Œã«å†å¾©ç¿’');
  el('FB').classList.add('on');
  /* è‡ªå‹•é€²è¡Œ â€” æ­£è§£æ™‚ã®ã¿ï¼ˆä¸æ­£è§£ã¯æ‰‹å‹•ã§ç¢ºèªã•ã›ã‚‹ï¼‰ */
  if(ok&&G.cfg.autonext){
    var delay=Math.round((G.cfg.autonextSec||1.5)*1000);
    var remaining=Math.ceil(G.cfg.autonextSec||1.5);
    el('B-next').textContent='æ¬¡ã¸ ('+remaining+'ç§’)';
    var countdown=setInterval(function(){
      remaining--;
      if(remaining>0){el('B-next').textContent='æ¬¡ã¸ ('+remaining+'ç§’)';}
      else{clearInterval(countdown);}
    },1000);
    Q._autoTimer=setTimeout(function(){
      clearInterval(countdown);
      el('B-next').textContent='æ¬¡ã¸ â†’';
      if(Q.done)qNext();
    },delay);
  }
}

function qNext(){
  if(Q._autoTimer){clearTimeout(Q._autoTimer);Q._autoTimer=null;}
  el('B-next').textContent='æ¬¡ã¸ â†’';

  var q=Q.q[Q.i];
  /* ä¸æ­£è§£çµŒé¨“ã‚ã‚Š ã‹ã¤ å†å‡ºé¡Œå›æ•°ãŒä¸Šé™æœªæº€ã®å ´åˆã®ã¿å†å‡ºé¡Œ */
  var requeueMax=G.cfg.requeueMax!=null?G.cfg.requeueMax:1;
  if(!Q.requeued)Q.requeued={};
  var remaining=Q.q.length-(Q.i+1);
  if(q && q._hadMiss && (Q.requeued[q.id]||0)<requeueMax && remaining>0){
    Q.requeued[q.id]=(Q.requeued[q.id]||0)+1;
    /* æ®‹ã‚Šå•é¡Œã®ã†ã¡1ã€œ3å•å¾Œã®ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«æŒ¿å…¥ */
    var insertOffset=1+Math.floor(Math.random()*Math.min(remaining,3));
    Q.q.splice(Q.i+1+insertOffset,0,q);
  }

  Q.i++;
  Q.i>=Q.q.length?qResult():qRender();
}

function qResult(){
  el('FB').classList.remove('on');
  var tot=Q.ok+Q.ng,acc=tot?Math.round(Q.ok/tot*100):0;
  el('R-ok').textContent=Q.ok;el('R-ng').textContent=Q.ng;el('R-ac').textContent=acc+'%';
  var em='ğŸ“š',tl='ã‚‚ã†å°‘ã—ã§ã™ï¼';
  if(acc>=90){em='ğŸ†';tl='å®Œç’§ã§ã™ï¼';}else if(acc>=70){em='ğŸ‰';tl='ã‚ˆãã§ãã¾ã—ãŸï¼';}else if(acc>=50){em='ğŸ“š';tl='ã‚‚ã†å°‘ã—ã§ã™ï¼';}else{em='ğŸ’ª';tl='ç·´ç¿’ã‚ã‚‹ã®ã¿ï¼';}
  el('R-em').textContent=em;el('R-tl').textContent=tl;
  el('R-sub').textContent=tot+'å•ä¸­'+Q.ok+'å•æ­£è§£ Â· æ­£è§£ç‡'+acc+'%';

  /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’é€²ã‚ã‚‹ï¼ˆãƒªã‚¹ãƒˆã‚¯ã‚¤ã‚ºã®ã¿ï¼‰ */
  if(Q._pendingCursor&&!Q.testMode){
    var pc=Q._pendingCursor;
    var lst=G.lists.find(function(l){return l.id===pc.lid;});
    if(lst){
      var wsLen=G.words.filter(function(w){return w.lid===pc.lid;}).length;
      lst.cursor=pc.next>=wsLen?0:pc.next; /* æœ€å¾Œã¾ã§è¡Œã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ */
      var completed=(pc.next>=wsLen);
      if(completed){
        em='ğŸŠ';tl='ã“ã®ãƒªã‚¹ãƒˆå®Œäº†ï¼';
        el('R-em').textContent=em;el('R-tl').textContent=tl;
        el('R-sub').textContent='å…¨å˜èªã‚’å­¦ç¿’ã—ã¾ã—ãŸï¼æ¬¡å›ã¯æœ€åˆã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™';
      }
    }
  }

  /* ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’ä¿å­˜ */
  var _durMs=Q.sessionStart?Date.now()-Q.sessionStart:(Q.startMs?Date.now()-Q.startMs:0);
  if(!G.logs)G.logs=[];
  /* ä½¿ç”¨ãƒªã‚¹ãƒˆIDã‚’åé›†ï¼ˆé‡è¤‡æ’é™¤ï¼‰ */
  var _lidSet={};
  Q.words.forEach(function(w){if(w.lid)_lidSet[w.lid]=true;});
  var _lids=Object.keys(_lidSet);
  G.logs.push({
    ts: new Date().toISOString(),
    ok: Q.ok, ng: Q.ng, acc: acc, total: tot,
    durationMs: _durMs,
    quizMode: Q.quizMode||'all',
    testMode: !!Q.testMode,
    lids: _lids,
    miss: Q.miss.map(function(w){return{id:w.id,word:w.word,meaning:w.meaning||'',lang:w.lang||'en',lid:w.lid};}),
    slow: (Q.slow||[]).map(function(w){return{id:w.id,word:w.word,meaning:w.meaning||'',lang:w.lang||'en',lid:w.lid,answerMs:w.answerMs};}),
    words: Q.words.map(function(w){return w.id;})
  });
  if(G.logs.length>365)G.logs=G.logs.slice(-365);
  var today=new Date().toDateString();
  if(G.stats.lastDay!==today){var yest=new Date(Date.now()-86400000).toDateString();G.stats.streak=(G.stats.lastDay===yest)?(G.stats.streak||0)+1:1;G.stats.lastDay=today;}
  save();
  go('s-result');
}

/* SETTINGS */
function updateKeyStatus(){
  var s=el('KEY-status');if(!s)return;
  if(G.cfg.key){
    s.innerHTML='<span style="color:var(--gn)">âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ï¼ˆsk-ant-...'+G.cfg.key.slice(-4)+'ï¼‰</span>';
  } else {
    s.innerHTML='<span style="color:var(--or)">âš ï¸ APIã‚­ãƒ¼æœªè¨­å®š</span>';
  }
}
function settingsLoad(){
  el('IN-apikey').value=G.cfg.key||'';
  el('SEL-size').value=G.cfg.size||20;
  el('TG-rev').classList.toggle('on',!!G.cfg.rev);
  el('TG-random').classList.toggle('on',!!G.cfg.random);
  el('TG-speak').classList.toggle('on',G.cfg.speak!==false);
  el('TG-autonext').classList.toggle('on',!!G.cfg.autonext);
  el('IN-autonext-sec').value=G.cfg.autonextSec||1.5;
  el('TG-flashauto').classList.toggle('on',!!G.cfg.flashAuto);
  el('TG-autoQuiz').classList.toggle('on',!!G.cfg.autoQuiz);
  el('IN-flash-sec').value=G.cfg.flashSec||2;
  el('TG-cloudauto').classList.toggle('on',!!G.cfg.cloudAuto);
  var sm=G.cfg.spkMode||'both';
  ['both','foreign','ja'].forEach(function(m){el('SPK-'+m).classList.toggle('on',sm===m);});
  el('IN-duck-vol').value=G.cfg.duckVol!=null?G.cfg.duckVol:15;
  var rq=G.cfg.requeueMax!=null?G.cfg.requeueMax:1;
  [0,1,2,3].forEach(function(n){el('RQ-'+n).classList.toggle('on',rq===n);});
  updateKeyStatus();
}

/* BIND */
function bind(){
  flBindButtons();
  el('T-home').addEventListener('click',function(){go('s-home');});
  el('T-add').addEventListener('click',function(){go('s-add');});
  el('T-list').addEventListener('click',function(){go('s-list');});
  el('T-settings').addEventListener('click',function(){go('s-settings');});
  el('B-go-settings').addEventListener('click',function(){go('s-settings');});

  el('B-quiz-due').addEventListener('click',function(){quizStart('due');});
  el('B-go-add').addEventListener('click',function(){go('s-add');});
  el('B-quiz-all').addEventListener('click',function(){quizStart('all');});
  el('B-go-list').addEventListener('click',function(){go('s-list');});
  el('B-quiz-weak').addEventListener('click',function(){quizStart('weak');});
  el('B-study-list').addEventListener('click',function(){showListSelectModal('study');});
  el('B-test-list').addEventListener('click',function(){showListSelectModal('test');});
  el('B-report').addEventListener('click',function(){showReportModal();});
  el('B-new-list').addEventListener('click',function(){go('s-add');});

  el('B-add-back').addEventListener('click',function(){go('s-home');});
  el('SG-paste').addEventListener('click',function(){segSwitch('paste');});
  el('SG-file').addEventListener('click',function(){segSwitch('file');});
  el('SG-ai').addEventListener('click',function(){segSwitch('ai');});

  /* æŠ½å‡ºã‚¿ã‚¤ãƒ—ãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){
    b.addEventListener('click',function(){setType(this.getAttribute('data-type'));});
  });

  /* ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){
    b.addEventListener('click',function(){setLevel(this.getAttribute('data-level'));});
  });

  /* è¨€èªé¸æŠãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){
    b.addEventListener('click',function(){setLang(this.getAttribute('data-lang'));});
  });

  /* è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      listLangFilter=this.getAttribute('data-lang');
      el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(x){x.classList.remove('on');});
      this.classList.add('on');
      listRender();
    });
  });
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  el('STATUS-filter').querySelectorAll('.flt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      listStatusFilter=this.getAttribute('data-status');
      el('STATUS-filter').querySelectorAll('.flt-btn').forEach(function(x){x.classList.remove('on');});
      this.classList.add('on');
      listRender();
    });
  });
  /* ã‚½ãƒ¼ãƒˆ */
  el('SORT-filter').querySelectorAll('.flt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      listSort=this.getAttribute('data-sort');
      el('SORT-filter').querySelectorAll('.flt-btn').forEach(function(x){x.classList.remove('on');});
      this.classList.add('on');
      listRender();
    });
  });

  el('B-parse').addEventListener('click',parsePaste);
  el('B-upload').addEventListener('click',function(){el('IN-file').click();});
  el('IN-file').addEventListener('change',handleFile);

  /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã®ãƒ¢ãƒ¼ãƒ‰/ãƒ¬ãƒ™ãƒ«/ã‚¿ã‚¤ãƒ—åˆ‡æ›¿ */
  document.querySelectorAll('[data-fmode]').forEach(function(b){
    b.addEventListener('click',function(){setFileMode(this.getAttribute('data-fmode'));});
  });
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileLevel(this.getAttribute('data-level'));});
  });
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileType(this.getAttribute('data-type'));});
  });
  document.querySelectorAll('[data-jsec]').forEach(function(b){
    b.addEventListener('click',function(){setJsonSection(this.getAttribute('data-jsec'));});
  });
  el('B-ai-extract').addEventListener('click',aiExtract);
  el('B-save').addEventListener('click',saveList);
  el('B-clr-prv').addEventListener('click',prvHide);

  el('B-list-back').addEventListener('click',function(){
    if(selModeOn){toggleSelMode();}else{go('s-home');}
  });
  el('B-dup-check').addEventListener('click',function(){checkDuplicates();});
  el('B-sel-mode').addEventListener('click',function(){toggleSelMode();});
  el('SEL-all-btn').addEventListener('click',function(){
    var flt=el('SEL-list').value;
    var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
    var allSel=words.every(function(w){return selSet[w.id];});
    if(allSel){selSet={};}else{words.forEach(function(w){selSet[w.id]=true;});}
    listRender();updateSelCount();
  });
  el('SEL-del-btn').addEventListener('click',function(){selDeleteAll();});
  el('SEL-move-btn').addEventListener('click',function(){selMoveAll();});
  el('SEL-list').addEventListener('change',listRender);
  el('IN-search').addEventListener('input',listRender);

  el('B-quiz-exit').addEventListener('click',function(){
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    el('FB').classList.remove('on');go('s-home');
  });
  el('B-next').addEventListener('click',qNext);
  el('B-res-home').addEventListener('click',function(){go('s-home');});
  el('B-res-weak').addEventListener('click',function(){quizStart('weak');});

  el('B-set-back').addEventListener('click',function(){go('s-home');});
  el('B-save-file').addEventListener('click',function(){saveAsFile();});
  el('B-save-key').addEventListener('click',function(){
    var key=(el('IN-apikey').value||'').trim();
    if(!key){toast('âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    if(!key.startsWith('sk-ant-')){toast('âŒ APIã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆsk-ant-ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰');return;}
    G.cfg.key=key;save();
    updateKeyStatus();
    toast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });
  el('SEL-size').addEventListener('input',function(){
    var v=parseInt(this.value)||20;
    if(v<1)v=1;
    if(v>200)v=200;
    G.cfg.size=v;save();
  });
  el('TG-random').addEventListener('click',function(){G.cfg.random=!this.classList.contains('on');this.classList.toggle('on',G.cfg.random);save();});
  el('ROW-random').addEventListener('click',function(e){if(e.target!==el('TG-random'))el('TG-random').click();});
  el('TG-rev').addEventListener('click',function(){G.cfg.rev=!G.cfg.rev;this.classList.toggle('on',G.cfg.rev);save();});
  el('ROW-rev').addEventListener('click',function(e){if(e.target!==el('TG-rev'))el('TG-rev').click();});
  el('TG-speak').addEventListener('click',function(){G.cfg.speak=!this.classList.contains('on');this.classList.toggle('on',G.cfg.speak);save();});
  el('ROW-speak').addEventListener('click',function(e){if(e.target!==el('TG-speak'))el('TG-speak').click();});
  el('TG-autonext').addEventListener('click',function(){G.cfg.autonext=!this.classList.contains('on');this.classList.toggle('on',G.cfg.autonext);save();});
  el('ROW-autonext').addEventListener('click',function(e){if(e.target!==el('TG-autonext'))el('TG-autonext').click();});
  el('IN-autonext-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||1.5;
    if(v<0.5)v=0.5; if(v>10)v=10;
    G.cfg.autonextSec=v; save();
  });
  el('IN-flash-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||4;
    if(v<2)v=2; if(v>15)v=15;
    G.cfg.flashSec=v; save();
  });
  el('IN-duck-vol').addEventListener('input',function(){
    var v=parseInt(this.value);
    if(isNaN(v))v=15;
    if(v<0)v=0; if(v>100)v=100;
    G.cfg.duckVol=v; save();
    DUCK_VOL=v/100;
  });
  DUCK_VOL=(G.cfg.duckVol!=null?G.cfg.duckVol:15)/100;
  el('TG-flashauto').addEventListener('click',function(){G.cfg.flashAuto=!this.classList.contains('on');this.classList.toggle('on',G.cfg.flashAuto);save();});
  el('ROW-flashauto').addEventListener('click',function(e){if(e.target!==el('TG-flashauto'))el('TG-flashauto').click();});
  el('TG-autoQuiz').addEventListener('click',function(){G.cfg.autoQuiz=!this.classList.contains('on');this.classList.toggle('on',G.cfg.autoQuiz);save();});
  el('ROW-autoQuiz').addEventListener('click',function(e){if(e.target!==el('TG-autoQuiz'))el('TG-autoQuiz').click();});
  [0,1,2,3].forEach(function(n){
    el('RQ-'+n).addEventListener('click',function(){
      G.cfg.requeueMax=n; save();
      [0,1,2,3].forEach(function(x){el('RQ-'+x).classList.toggle('on',x===n);});
    });
  });
  ['both','foreign','ja'].forEach(function(m){
    el('SPK-'+m).addEventListener('click',function(){
      G.cfg.spkMode=m;save();
      ['both','foreign','ja'].forEach(function(x){el('SPK-'+x).classList.toggle('on',x===m);});
    });
  });

  /* ---- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ---- */

  /* å…¨ãƒ‡ãƒ¼ã‚¿JSON */
  el('B-export').addEventListener('click',function(){
    dlJson(G,'vocabmaster_backup.json');
    toast('âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
  });

  /* ãƒªã‚¹ãƒˆé¸æŠã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ */
  el('B-export-select').addEventListener('click',function(){
    if(!G.lists.length){toast('ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
    var html='<div class="modal-tl">ğŸ“‹ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒªã‚¹ãƒˆã‚’é¸æŠ</div>';
    html+='<div style="max-height:220px;overflow-y:auto;margin-bottom:12px">';
    G.lists.forEach(function(lst){
      var l=LANGS[lst.lang||'en'];
      var cnt=G.words.filter(function(w){return w.lid===lst.id;}).length;
      html+='<label style="display:flex;align-items:center;gap:10px;padding:10px 4px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer">'+
        '<input type="checkbox" data-lid="'+lst.id+'" style="width:18px;height:18px;accent-color:var(--ac)">'+
        '<span>'+(l?l.flag+' ':'')+esc(lst.name)+'</span>'+
        '<span style="margin-left:auto;font-size:12px;color:var(--tx2)">'+cnt+'å˜èª</span></label>';
    });
    html+='</div>';
    html+='<button class="btn-primary" id="EXP-json-sel" style="margin-bottom:8px">ğŸ“¤ JSON</button>';
    html+='<button class="btn-sec" id="EXP-csv-sel" style="margin-top:0">ğŸ“Š CSV</button>';
    el('modal-ct').innerHTML=html;
    el('modal-bg').classList.add('on');

    function getSelected(){
      return Array.from(el('modal-ct').querySelectorAll('input[data-lid]:checked')).map(function(c){return c.getAttribute('data-lid');});
    }
    el('EXP-json-sel').addEventListener('click',function(){
      var ids=getSelected();if(!ids.length){toast('ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
      var lists=G.lists.filter(function(l){return ids.indexOf(l.id)>=0;});
      var words=G.words.filter(function(w){return ids.indexOf(w.lid)>=0;});
      dlJson({words:words,lists:lists,cfg:G.cfg,stats:G.stats}, 'vocabmaster_lists.json');
      el('modal-bg').classList.remove('on');toast('âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    });
    el('EXP-csv-sel').addEventListener('click',function(){
      var ids=getSelected();if(!ids.length){toast('ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
      var words=G.words.filter(function(w){return ids.indexOf(w.lid)>=0;});
      exportCsv(words,'vocabmaster_lists.csv');
      el('modal-bg').classList.remove('on');toast('âœ… CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
    });
  });

  /* å…¨ãƒ‡ãƒ¼ã‚¿CSV */
  el('B-export-csv').addEventListener('click',function(){
    exportCsv(G.words,'vocabmaster_all.csv');
    toast('âœ… CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
  });

  /* QRã‚³ãƒ¼ãƒ‰è»¢é€ */
  el('B-qr').addEventListener('click',function(){
    if(!G.lists.length){toast('ãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
    var html='<div class="modal-tl">ğŸ“± QRã‚³ãƒ¼ãƒ‰ã§è»¢é€</div>';
    html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:10px">è»¢é€ã™ã‚‹ãƒªã‚¹ãƒˆã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ï¼ˆQRã‚³ãƒ¼ãƒ‰ã®ã‚µã‚¤ã‚ºåˆ¶é™ã®ãŸã‚1ãƒªã‚¹ãƒˆãšã¤ï¼‰</div>';
    html+='<select id="QR-sel" class="sel" style="width:100%;margin-bottom:12px">';
    G.lists.forEach(function(lst){
      var cnt=G.words.filter(function(w){return w.lid===lst.id;}).length;
      html+='<option value="'+lst.id+'">'+esc(lst.name)+' ('+cnt+'å˜èª)</option>';
    });
    html+='</select>';
    html+='<button class="btn-primary" id="QR-gen">QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>';
    html+='<div id="QR-area" style="margin-top:14px;text-align:center"></div>';
    el('modal-ct').innerHTML=html;
    el('modal-bg').classList.add('on');

    el('QR-gen').addEventListener('click',function(){
      var lid=el('QR-sel').value;
      var lst=G.lists.find(function(l){return l.id===lid;});
      var words=G.words.filter(function(w){return w.lid===lid;});
      if(!words.length){toast('å˜èªãŒã‚ã‚Šã¾ã›ã‚“');return;}
      /* ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã«åœ§ç¸®ã—ã¦URLã«åŸ‹ã‚è¾¼ã‚€ */
      var payload=JSON.stringify({lists:[lst],words:words});
      if(payload.length>2953){
        toast('å˜èªæ•°ãŒå¤šã™ãã¾ã™ï¼ˆç›®å®‰ï¼šå˜èª20å€‹ä»¥ä¸‹ï¼‰ã€‚ãƒªã‚¹ãƒˆã‚’åˆ†ã‘ã¦ãã ã•ã„');return;
      }
      var b64=btoa(unescape(encodeURIComponent(payload)));
      /* GitHub Pagesã®URLã«ãƒãƒƒã‚·ãƒ¥ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚€ */
      var baseUrl=location.href.split('#')[0];
      var qrUrl=baseUrl+'#import='+b64;
      genQr(qrUrl, 'QR-area');
    });
  });

  /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¿½åŠ çµ±åˆï¼‰ */
  el('B-import-row').addEventListener('click',function(){el('IN-import').click();});
  el('IN-import').addEventListener('change',function(e){
    var f=e.target.files[0];if(!f)return;
    var fr=new FileReader();
    fr.onload=function(ev){
      try{
        var d=JSON.parse(ev.target.result);
        if(!d.words||!d.lists)throw 0;
        /* è¿½åŠ çµ±åˆ: æ—¢å­˜IDã¨é‡è¤‡ã—ãªã„ã‚‚ã®ã ã‘è¿½åŠ  */
        var existListIds=G.lists.map(function(l){return l.id;});
        var existWordIds=G.words.map(function(w){return w.id;});
        var addedLists=0,addedWords=0;
        d.lists.forEach(function(lst){
          if(existListIds.indexOf(lst.id)<0){G.lists.push(lst);addedLists++;}
        });
        d.words.forEach(function(w){
          if(existWordIds.indexOf(w.id)<0){G.words.push(w);addedWords++;}
        });
        save();homeRefresh();
        toast('âœ… '+addedLists+'ãƒªã‚¹ãƒˆãƒ»'+addedWords+'å˜èªã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }
      catch(err){toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsText(f);e.target.value='';
  });

  el('B-reset').addEventListener('click',function(){
    if(confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')){G=mkDB();save();toast('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');homeRefresh();}
  });
  el('B-cloud-save').addEventListener('click',function(){cloudSave();});
  el('B-cloud-load').addEventListener('click',function(){cloudLoad();});
  el('TG-cloudauto').addEventListener('click',function(){
    G.cfg.cloudAuto=!this.classList.contains('on');
    this.classList.toggle('on',G.cfg.cloudAuto);
    save();
    if(G.cfg.cloudAuto){
      toast('ğŸ”„ è‡ªå‹•ä¿å­˜ã‚’ONã«ã—ã¾ã—ãŸ');
      cloudSaveAuto(); /* ONã«ã—ãŸç¬é–“ã«å³1å›ä¿å­˜ */
    } else {
      toast('è‡ªå‹•ä¿å­˜ã‚’OFFã«ã—ã¾ã—ãŸ');
      if(_autoSaveTimer){clearTimeout(_autoSaveTimer);_autoSaveTimer=null;}
    }
  });
  el('ROW-cloudauto').addEventListener('click',function(e){if(e.target!==el('TG-cloudauto'))el('TG-cloudauto').click();});
  el('modal-bg').addEventListener('click',function(e){if(e.target===this)this.classList.remove('on');});
}

/* ---- ãƒ‡ãƒ¼ã‚¿è»¢é€ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---- */
function dlJson(data, fname){
  var b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=fname;document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u);},1000);
}

function exportCsv(words, fname){
  var bom='\uFEFF'; /* BOM: Excelã§UTF-8ãŒæ–‡å­—åŒ–ã‘ã—ãªã„ã‚ˆã†ã« */
  var rows=[['word','meaning','lang','list']];
  words.forEach(function(w){
    var lst=G.lists.find(function(l){return l.id===w.lid;});
    rows.push([w.word, w.meaning||'', w.lang||'en', lst?lst.name:'']);
  });
  var csv=bom+rows.map(function(r){
    return r.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';}).join(',');
  }).join('\r\n');
  var b=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=fname;document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u);},1000);
}

function genQr(text, targetId){
  var area=el(targetId);
  area.innerHTML='<div style="color:var(--tx2);font-size:12px;margin-bottom:8px">ç”Ÿæˆä¸­...</div>';
  /* QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ */
  function doGen(){
    area.innerHTML='';
    var div=document.createElement('div');
    area.appendChild(div);
    new QRCode(div,{text:text,width:200,height:200,colorDark:'#ffffff',colorLight:'#12121a',correctLevel:QRCode.CorrectLevel.M});
    area.insertAdjacentHTML('beforeend','<div style="font-size:11px;color:var(--tx2);margin-top:8px">åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆURLã‚’é–‹ã„ã¦ãã ã•ã„</div>');
  }
  if(typeof QRCode!=='undefined'){doGen();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
  s.onload=doGen;
  s.onerror=function(){area.innerHTML='<span style="color:var(--rd)">QRãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';};
  document.head.appendChild(s);
}

/* SAMPLE */
function loadSample(){
  if(G.words.length>0)return;
  var samples=[
    {lang:'en',name:'è‹±èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡¬ğŸ‡§',clr:'#4cff91',words:[['abandon','æ¨ã¦ã‚‹ã€æ”¾æ£„ã™ã‚‹'],['accomplish','é”æˆã™ã‚‹'],['acquire','å–å¾—ã™ã‚‹'],['advocate','æå”±ã™ã‚‹'],['ambiguous','ã‚ã„ã¾ã„ãª']]},
    {lang:'de',name:'ãƒ‰ã‚¤ãƒ„èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡©ğŸ‡ª',clr:'#ffd700',words:[['Haus','å®¶'],['Schule','å­¦æ ¡'],['Arbeit','ä»•äº‹'],['schÃ¶n','ç¾ã—ã„'],['lernen','å­¦ã¶']]},
    {lang:'fr',name:'ãƒ•ãƒ©ãƒ³ã‚¹èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡«ğŸ‡·',clr:'#5cf8fc',words:[['maison','å®¶'],['Ã©cole','å­¦æ ¡'],['travail','ä»•äº‹'],['beau','ç¾ã—ã„'],['apprendre','å­¦ã¶']]},
  ];
  samples.forEach(function(s){
    var lst={id:uid(),name:s.name,ic:s.ic,clr:s.clr,lang:s.lang,cr:new Date().toISOString()};
    G.lists.push(lst);
    s.words.forEach(function(w){G.words.push({id:uid(),word:w[0],meaning:w[1],lid:lst.id,lang:s.lang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});});
  });
  save();
}

window.onload=function(){
  /* QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç† */
  var hash=location.hash;
  if(hash&&hash.indexOf('#import=')===0){
    try{
      var b64=hash.slice(8);
      var json=decodeURIComponent(escape(atob(b64)));
      var d=JSON.parse(json);
      if(d.words&&d.lists){
        var existListIds=G.lists.map(function(l){return l.id;});
        var existWordIds=G.words.map(function(w){return w.id;});
        var addedLists=0,addedWords=0;
        d.lists.forEach(function(lst){if(existListIds.indexOf(lst.id)<0){G.lists.push(lst);addedLists++;}});
        d.words.forEach(function(w){if(existWordIds.indexOf(w.id)<0){G.words.push(w);addedWords++;}});
        save();
        history.replaceState(null,'',location.pathname); /* ãƒãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™ */
        setTimeout(function(){toast('ğŸ“± QRã‹ã‚‰ '+addedLists+'ãƒªã‚¹ãƒˆãƒ»'+addedWords+'å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');},500);
      }
    }catch(e){/* ç„¡åŠ¹ãªãƒãƒƒã‚·ãƒ¥ã¯ç„¡è¦– */}
  }
  bind();loadSample();homeRefresh();updateLevelHint();
  /* èµ·å‹•æ™‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•ä¿å­˜ONã®å ´åˆã®ã¿ï¼‰ */
  if(G.cfg&&G.cfg.cloudAuto) cloudCheckOnStartup();
};
</script>
</body>
</html>
