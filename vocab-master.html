<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>VocabMaster</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
:root {
  --bg:#0a0a0f; --sf:#12121a; --sf2:#1a1a26; --sf3:#22222f;
  --ac:#7c5cfc; --ac2:#fc5c7d; --ac3:#5cf8fc;
  --tx:#f0f0f8; --tx2:#9090aa;
  --gn:#4cff91; --rd:#ff4c6a; --or:#ff9c4c; --gd:#ffd700;
  --r:14px;
  --st:env(safe-area-inset-top,0px); --sb:env(safe-area-inset-bottom,0px);
}
html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--tx); font-family:-apple-system,Helvetica,Arial,sans-serif; -webkit-user-select:none; user-select:none; }
#app { width:100%; height:100%; overflow:hidden; position:relative; }

.scr { display:none; position:absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; background:var(--bg); }
.scr.on { display:flex; }

.scroll { flex:1; overflow-y:scroll; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:14px 18px; }

.tabbar { display:flex; background:var(--sf); border-top:1px solid rgba(255,255,255,.07); padding-bottom:var(--sb); flex-shrink:0; }
.tab { flex:1; display:flex; flex-direction:column; align-items:center; padding:8px 0; background:none; border:none; color:var(--tx2); cursor:pointer; font-family:inherit; }
.tab.on { color:var(--ac); }
.tab-ic { font-size:20px; }
.tab-lb { font-size:10px; margin-top:2px; }

.hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:10px; background:var(--bg); border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0; }
.hdr-title { font-size:16px; font-weight:600; flex:1; }

#s-home { background:radial-gradient(ellipse at 20% 10%,rgba(124,92,252,.15) 0%,transparent 55%),radial-gradient(ellipse at 80% 90%,rgba(252,92,125,.1) 0%,transparent 55%),var(--bg); }
.home-top { display:flex; justify-content:space-between; align-items:center; padding:12px 18px 0; padding-top:calc(var(--st) + 12px); flex-shrink:0; }
.logo { font-size:24px; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg,var(--ac),var(--ac2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

.btn { display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.btn-ic { width:38px; height:38px; border-radius:10px; background:var(--sf2); font-size:17px; color:var(--tx2); }
.btn-back { width:34px; height:34px; border-radius:9px; background:var(--sf2); font-size:17px; color:var(--tx); flex-shrink:0; }
.btn-primary { width:100%; padding:14px; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); color:#fff; font-size:15px; font-weight:600; -webkit-appearance:none; border:none; cursor:pointer; font-family:inherit; }
.btn-primary:active { opacity:.8; }
.btn-sec { width:100%; padding:13px; background:var(--sf2); border:1px solid rgba(255,255,255,.1); border-radius:var(--r); color:var(--tx); font-size:14px; font-weight:500; margin-top:8px; -webkit-appearance:none; border-radius:var(--r); cursor:pointer; font-family:inherit; }
.btn-sec:active { background:var(--sf3); }
.btn-text { background:none; border:none; color:var(--ac); font-size:13px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }

.stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
.stat { background:var(--sf); border-radius:var(--r); padding:11px; text-align:center; }
.stat-n { font-size:22px; font-weight:700; }
.stat-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.due-btn { width:100%; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); padding:15px 17px; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; border:none; cursor:pointer; -webkit-appearance:none; text-align:left; font-family:inherit; }
.due-btn:active { opacity:.85; }
.due-txt h3 { font-size:16px; font-weight:600; color:#fff; }
.due-txt p { font-size:11px; color:rgba(255,255,255,.75); margin-top:2px; }
.due-n { font-size:36px; font-weight:700; color:#fff; line-height:1; }

.act-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:18px; }
.act-card { background:var(--sf); border-radius:var(--r); padding:14px; border:none; cursor:pointer; text-align:left; width:100%; -webkit-appearance:none; font-family:inherit; }
.act-card:active { background:var(--sf2); }
.act-ic { font-size:24px; margin-bottom:5px; display:block; }
.act-title { font-size:13px; font-weight:600; color:var(--tx); }
.act-sub { font-size:11px; color:var(--tx2); margin-top:2px; }

.sec-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.sec-title { font-size:12px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }

.list-card { background:var(--sf); border-radius:var(--r); padding:13px; margin-bottom:7px; display:flex; align-items:center; gap:11px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.list-card:active { background:var(--sf2); }
.list-ic { width:40px; height:40px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.list-inf { flex:1; min-width:0; }
.list-name { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.list-meta { font-size:11px; color:var(--tx2); margin-top:2px; }
.list-badge { background:var(--ac); color:#fff; font-size:11px; font-weight:600; padding:2px 8px; border-radius:20px; }

/* è¨€èªãƒãƒƒã‚¸ */
.lang-badge { display:inline-block; font-size:10px; font-weight:700; padding:1px 6px; border-radius:5px; margin-left:5px; vertical-align:middle; }
.lang-en { background:rgba(76,255,145,.15); color:var(--gn); }
.lang-de { background:rgba(255,215,0,.15); color:var(--gd); }
.lang-fr { background:rgba(92,248,252,.15); color:var(--ac3); }
.lang-es { background:rgba(255,156,76,.15); color:var(--or); }
.lang-it { background:rgba(252,92,125,.15); color:var(--ac2); }

.seg { display:flex; background:var(--sf); border-radius:11px; padding:3px; margin-bottom:16px; }
.seg-btn { flex:1; padding:8px 3px; border:none; border-radius:8px; background:transparent; color:var(--tx2); font-size:12px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }
.seg-btn.on { background:var(--sf3); color:var(--tx); }

.lbl { font-size:12px; color:var(--tx2); margin-bottom:5px; font-weight:500; }
.inp { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:var(--r); color:var(--tx); font-family:inherit; font-size:15px; padding:12px 14px; outline:none; -webkit-appearance:none; margin-bottom:12px; -webkit-user-select:text; user-select:text; }
.inp:focus { border-color:var(--ac); }
.ta { height:140px; resize:none; line-height:1.6; }
.hint { font-size:11px; color:var(--tx2); margin-bottom:12px; line-height:1.5; }

/* è¨€èªé¸æŠ */
.lang-sel-wrap { margin-bottom:14px; }
.lang-sel-title { font-size:12px; color:var(--tx2); margin-bottom:7px; font-weight:500; }
.lang-sel-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.lang-sel-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.lang-sel-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }
.opt-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.opt-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }

.upload { border:2px dashed rgba(124,92,252,.3); border-radius:var(--r); padding:26px; text-align:center; cursor:pointer; margin-bottom:12px; background:rgba(124,92,252,.03); }
.upload:active { border-color:var(--ac); background:rgba(124,92,252,.08); }
.upload-ic { font-size:30px; margin-bottom:5px; }
.upload-tx { font-size:14px; font-weight:500; }
.upload-sub { font-size:11px; color:var(--tx2); margin-top:3px; }

.prev-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.prev-title { font-size:13px; font-weight:600; color:var(--tx2); }
.prev-cnt { background:var(--ac); color:#fff; font-size:11px; padding:2px 8px; border-radius:10px; }
.prev-list { display:flex; flex-direction:column; gap:5px; max-height:220px; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.prev-item { background:var(--sf); border-radius:9px; padding:9px 11px; display:flex; align-items:center; gap:9px; }
.pi-n { font-size:11px; color:var(--tx2); width:20px; flex-shrink:0; }
.pi-en { font-size:14px; font-weight:500; flex:1; }
.pi-ja { font-size:12px; color:var(--ac3); }

.srch-wrap { padding:9px 16px 0; flex-shrink:0; }
.srch { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:11px; padding:9px 13px; color:var(--tx); font-family:inherit; font-size:14px; outline:none; -webkit-appearance:none; -webkit-user-select:text; user-select:text; }

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ */
.filter-bar { display:flex; gap:7px; padding:9px 16px 0; overflow-x:scroll; -webkit-overflow-scrolling:touch; flex-shrink:0; }
.filter-bar::-webkit-scrollbar { display:none; }
.flt-btn { padding:5px 12px; border-radius:20px; border:1px solid rgba(255,255,255,.1); background:var(--sf); color:var(--tx2); font-size:12px; font-weight:500; white-space:nowrap; cursor:pointer; -webkit-appearance:none; font-family:inherit; flex-shrink:0; }
.flt-btn.on { background:var(--ac); border-color:var(--ac); color:#fff; }

.word-item { background:var(--sf); border-radius:var(--r); padding:11px 13px; margin-bottom:6px; display:flex; align-items:center; gap:9px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.word-item:active { background:var(--sf2); }
.wi-inf { flex:1; min-width:0; }
.wi-en { font-size:14px; font-weight:500; }
.wi-ja { font-size:11px; color:var(--tx2); margin-top:2px; }
.wi-lvl { width:28px; height:28px; border-radius:7px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; flex-shrink:0; }
.l0{background:rgba(255,76,106,.15);color:var(--rd);} .l1{background:rgba(255,156,76,.15);color:var(--or);} .l2{background:rgba(255,215,0,.15);color:var(--gd);} .l3{background:rgba(76,255,145,.15);color:var(--gn);} .l4{background:rgba(124,92,252,.15);color:var(--ac);} .l5{background:rgba(92,248,252,.15);color:var(--ac3);}

#s-quiz { background:radial-gradient(ellipse at 50% 0%,rgba(124,92,252,.12) 0%,transparent 55%),var(--bg); }
.qz-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.qz-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.qz-fill { height:100%; background:linear-gradient(90deg,var(--ac),var(--ac2)); border-radius:3px; transition:width .35s ease; }
.qz-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.qz-body { flex:1; display:flex; flex-direction:column; padding:13px 16px; overflow:hidden; gap:10px; }
.qz-card { background:var(--sf); border-radius:18px; padding:22px 18px; text-align:center; flex-shrink:0; }
.qz-badge { display:inline-block; background:rgba(124,92,252,.15); color:var(--ac); font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; margin-bottom:12px; text-transform:uppercase; letter-spacing:.06em; }
.qz-word { font-size:28px; font-weight:700; line-height:1.2; word-break:break-word; }
.choices { display:flex; flex-direction:column; gap:7px; flex:1; justify-content:center; }
.ch-btn { width:100%; padding:13px 14px; background:var(--sf); border:2px solid rgba(255,255,255,.08); border-radius:13px; color:var(--tx); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; text-align:left; display:flex; align-items:center; gap:9px; -webkit-appearance:none; min-height:50px; }
.ch-btn:active:not(.done) { border-color:var(--ac); background:rgba(124,92,252,.08); }
.ch-btn.ok { border-color:var(--gn)!important; background:rgba(76,255,145,.08)!important; }
.ch-btn.ok .ch-lt { background:rgba(76,255,145,.2); color:var(--gn); }
.ch-btn.ok .ch-tx { color:var(--gn); }
.ch-btn.ng { border-color:var(--rd)!important; background:rgba(255,76,106,.08)!important; }
.ch-btn.ng .ch-lt { background:rgba(255,76,106,.2); color:var(--rd); }
.ch-btn.ng .ch-tx { color:var(--rd); }
.ch-lt { width:25px; height:25px; border-radius:6px; background:rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--tx2); flex-shrink:0; }
.ch-tx { flex:1; line-height:1.3; }
.ch-ic { font-size:15px; margin-left:auto; flex-shrink:0; min-width:18px; text-align:center; }

.fb { position:absolute; bottom:calc(var(--sb) + 7px); left:14px; right:14px; background:var(--sf2); border:1px solid rgba(255,255,255,.08); border-radius:13px; padding:11px 14px; display:flex; align-items:center; justify-content:space-between; gap:9px; opacity:0; transform:translateY(28px); transition:opacity .25s ease,transform .25s ease; pointer-events:none; z-index:10; }
.fb.on { opacity:1; transform:translateY(0); pointer-events:auto; }
.fb-tx { font-size:13px; font-weight:600; }
.fb-dt { font-size:11px; color:var(--tx2); margin-top:2px; }
.fb-next { background:var(--ac); color:#fff; border:none; border-radius:9px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; font-family:inherit; -webkit-appearance:none; }
.fb-next:active { opacity:.8; }

#s-result { background:radial-gradient(ellipse at 50% 30%,rgba(124,92,252,.2) 0%,transparent 55%),var(--bg); align-items:center; justify-content:center; padding:36px 22px; }
.res-em { font-size:64px; margin-bottom:12px; }
.res-tl { font-size:26px; font-weight:700; margin-bottom:5px; text-align:center; }
.res-sub { font-size:13px; color:var(--tx2); margin-bottom:24px; text-align:center; }
.res-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:9px; width:100%; margin-bottom:24px; }
.res-stat { background:var(--sf); border-radius:13px; padding:13px; text-align:center; }
.rs-n { font-size:24px; font-weight:700; }
.rs-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.set-group { background:var(--sf); border-radius:var(--r); margin-bottom:16px; overflow:hidden; }
.set-row { display:flex; align-items:center; padding:13px 14px; gap:9px; border-bottom:1px solid rgba(255,255,255,.05); cursor:pointer; }
.set-row:last-child { border-bottom:none; }
.set-lbl { flex:1; font-size:14px; }
.set-val { font-size:13px; color:var(--tx2); }
.set-sec { font-size:11px; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; font-weight:600; margin-bottom:6px; padding-left:2px; }
.set-inp { background:transparent; border:none; color:var(--tx); font-family:inherit; font-size:13px; outline:none; flex:1; text-align:right; -webkit-user-select:text; user-select:text; -webkit-appearance:none; }
.toggle { width:40px; height:24px; border-radius:12px; background:var(--sf3); position:relative; cursor:pointer; transition:background .3s; flex-shrink:0; border:none; -webkit-appearance:none; }
.toggle.on { background:var(--ac); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:transform .3s; box-shadow:0 1px 3px rgba(0,0,0,.4); }
.toggle.on::after { transform:translateX(16px); }
.sel { background:transparent; border:none; color:var(--tx2); font-size:13px; outline:none; font-family:inherit; -webkit-appearance:none; padding:4px 0; }

.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:50; display:none; align-items:flex-end; }
.modal-bg.on { display:flex; }
.modal-sh { background:var(--sf); border-radius:20px 20px 0 0; padding:18px 16px calc(var(--sb) + 16px); width:100%; max-height:80%; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.modal-hd { width:32px; height:4px; background:rgba(255,255,255,.15); border-radius:2px; margin:0 auto 16px; }
.modal-tl { font-size:17px; font-weight:700; margin-bottom:13px; }
.del-btn { background:rgba(255,76,106,.1); color:var(--rd); border:1px solid rgba(255,76,106,.2); border-radius:11px; padding:12px; font-size:14px; font-weight:600; cursor:pointer; width:100%; font-family:inherit; margin-top:5px; -webkit-appearance:none; }
.del-btn:active { background:rgba(255,76,106,.2); }

.empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:44px 20px; text-align:center; gap:9px; }
.empty-ic { font-size:42px; }
.empty-tl { font-size:16px; font-weight:600; }
.empty-sub { font-size:12px; color:var(--tx2); line-height:1.5; }

.ai-tag { display:inline-block; background:linear-gradient(135deg,var(--ac),var(--ac2)); color:#fff; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; vertical-align:middle; margin-left:3px; }

.ld-bg { position:fixed; inset:0; background:rgba(10,10,15,.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
.ld-bg.on { display:flex; }
.spin { width:42px; height:42px; border:3px solid rgba(124,92,252,.2); border-top-color:var(--ac); border-radius:50%; animation:sp .8s linear infinite; margin-bottom:12px; }
@keyframes sp { to { transform:rotate(360deg); } }
.ld-tx { font-size:13px; color:var(--tx2); }

.toast { position:fixed; top:calc(var(--st) + 12px); left:16px; right:16px; background:var(--sf3); border:1px solid rgba(255,255,255,.1); border-radius:11px; padding:10px 14px; font-size:13px; font-weight:500; text-align:center; z-index:200; transform:translateY(-70px); opacity:0; transition:all .25s ease; pointer-events:none; }
.toast.on { transform:translateY(0); opacity:1; }

/* ---- FLASHCARD ---- */
#s-flash { background:radial-gradient(ellipse at 50% 0%,rgba(92,248,252,.08) 0%,transparent 55%),var(--bg); }
.fl-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.fl-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.fl-fill { height:100%; background:linear-gradient(90deg,var(--ac3),var(--ac)); border-radius:3px; transition:width .35s ease; }
.fl-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.fl-body { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; gap:16px; }
.fl-card { width:100%; max-width:360px; background:var(--sf); border-radius:22px; padding:36px 24px; text-align:center; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; box-shadow:0 4px 32px rgba(0,0,0,.4); transition:transform .2s ease,opacity .2s ease; }
.fl-card.flip { transform:scale(.93); opacity:.4; }
.fl-lang { font-size:11px; font-weight:700; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }
.fl-word { font-size:32px; font-weight:700; line-height:1.2; word-break:break-word; }
.fl-meaning { font-size:22px; color:var(--ac3); font-weight:600; }
.fl-spk { background:rgba(92,248,252,.12); border:none; border-radius:20px; padding:6px 18px; color:var(--ac3); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.fl-controls { display:flex; align-items:center; gap:18px; flex-shrink:0; padding-bottom:calc(var(--sb) + 16px); }
.fl-ctrl-btn { width:52px; height:52px; border-radius:50%; background:var(--sf2); border:none; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--tx); -webkit-appearance:none; }
.fl-ctrl-btn:active { background:var(--sf3); }
.fl-play-btn { width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--ac3),var(--ac)); border:none; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; -webkit-appearance:none; box-shadow:0 4px 16px rgba(124,92,252,.4); }
.fl-play-btn:active { opacity:.85; }

::-webkit-scrollbar { display:none; }
</style>
</head>
<body>
<div id="app">

<div class="ld-bg" id="ld"><div class="spin"></div><div class="ld-tx" id="ld-tx">å‡¦ç†ä¸­...</div></div>
<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal-bg"><div class="modal-sh"><div class="modal-hd"></div><div id="modal-ct"></div></div></div>

<!-- HOME -->
<div class="scr on" id="s-home">
  <div class="home-top">
    <div class="logo">VocabMaster</div>
    <button class="btn btn-ic" id="B-go-settings">âš™ï¸</button>
  </div>
  <div class="scroll">
    <div style="height:14px"></div>
    <div class="stats">
      <div class="stat"><div class="stat-n" id="H-total">0</div><div class="stat-l">ç·å˜èªæ•°</div></div>
      <div class="stat"><div class="stat-n" id="H-mastered">0</div><div class="stat-l">ç¿’å¾—æ¸ˆã¿</div></div>
      <div class="stat"><div class="stat-n" id="H-streak">0</div><div class="stat-l">é€£ç¶šæ—¥æ•°</div></div>
    </div>
    <button class="due-btn" id="B-quiz-due">
      <div class="due-txt"><h3>ä»Šæ—¥ã®å¾©ç¿’</h3><p>å¿˜å´æ›²ç·šã«åŸºã¥ãæœ€é©ã‚¿ã‚¤ãƒŸãƒ³ã‚°</p></div>
      <div class="due-n" id="H-due">0</div>
    </button>
    <div class="act-grid">
      <button class="act-card" id="B-go-add"><span class="act-ic">â•</span><div class="act-title">å˜èªã‚’è¿½åŠ </div><div class="act-sub">ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»AI</div></button>
      <button class="act-card" id="B-quiz-all"><span class="act-ic">âš¡</span><div class="act-title">å…¨å˜èªã‚¯ã‚¤ã‚º</div><div class="act-sub">4æŠå½¢å¼ã§ç·´ç¿’</div></button>
      <button class="act-card" id="B-go-list"><span class="act-ic">ğŸ“š</span><div class="act-title">å˜èªä¸€è¦§</div><div class="act-sub">ç®¡ç†ãƒ»ç·¨é›†</div></button>
      <button class="act-card" id="B-quiz-weak"><span class="act-ic">ğŸ¯</span><div class="act-title">è‹¦æ‰‹å˜èª</div><div class="act-sub">é–“é•ãˆãŸå˜èªã‚’ç‰¹è¨“</div></button>
    </div>
    <div class="sec-hdr">
      <div class="sec-title">å˜èªãƒªã‚¹ãƒˆ</div>
      <button class="btn-text" id="B-new-list">ï¼‹ æ–°è¦</button>
    </div>
    <div id="H-lists"></div>
    <div style="height:14px"></div>
  </div>
  <div class="tabbar">
    <button class="tab on" id="T-home"><div class="tab-ic">ğŸ </div><div class="tab-lb">ãƒ›ãƒ¼ãƒ </div></button>
    <button class="tab" id="T-add"><div class="tab-ic">â•</div><div class="tab-lb">è¿½åŠ </div></button>
    <button class="tab" id="T-list"><div class="tab-ic">ğŸ“š</div><div class="tab-lb">å˜èªå¸³</div></button>
    <button class="tab" id="T-settings"><div class="tab-ic">âš™ï¸</div><div class="tab-lb">è¨­å®š</div></button>
  </div>
</div>

<!-- ADD -->
<div class="scr" id="s-add">
  <div class="hdr">
    <button class="btn btn-back" id="B-add-back">â†</button>
    <div class="hdr-title">å˜èªã‚’è¿½åŠ </div>
  </div>
  <div class="scroll">
    <div class="seg">
      <button class="seg-btn on" id="SG-paste">è²¼ã‚Šä»˜ã‘</button>
      <button class="seg-btn" id="SG-file">ãƒ•ã‚¡ã‚¤ãƒ«</button>
      <button class="seg-btn" id="SG-ai">AIæŠ½å‡º<span class="ai-tag">AI</span></button>
    </div>

    <!-- è¨€èªé¸æŠï¼ˆå…±é€šï¼‰ -->
    <div class="lang-sel-wrap">
      <div class="lang-sel-title">å­¦ç¿’è¨€èªã‚’é¸æŠ</div>
      <div class="lang-sel-grid">
        <button class="lang-sel-btn on" data-lang="en" id="LS-en">ğŸ‡¬ğŸ‡§<br>è‹±èª</button>
        <button class="lang-sel-btn" data-lang="de" id="LS-de">ğŸ‡©ğŸ‡ª<br>ç‹¬èª</button>
        <button class="lang-sel-btn" data-lang="fr" id="LS-fr">ğŸ‡«ğŸ‡·<br>ä»èª</button>
        <button class="lang-sel-btn" data-lang="es" id="LS-es">ğŸ‡ªğŸ‡¸<br>è¥¿èª</button>
        <button class="lang-sel-btn" data-lang="it" id="LS-it">ğŸ‡®ğŸ‡¹<br>ä¼Šèª</button>
      </div>
    </div>

    <!-- PASTE -->
    <div id="TP-paste">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-paste-name" type="text" placeholder="ä¾‹: ãƒ‰ã‚¤ãƒ„èªåŸºç¤å˜èª">
      <div class="lbl">å˜èªãƒªã‚¹ãƒˆï¼ˆ1è¡Œ1å˜èª ã¾ãŸã¯ã€Œå˜èª,è¨³ã€å½¢å¼ï¼‰</div>
      <textarea class="inp ta" id="IN-paste-text" placeholder="ä¾‹:&#10;Haus&#10;Schule,å­¦æ ¡&#10;arbeiten&#10;schÃ¶n,ç¾ã—ã„"></textarea>
      <div class="hint">è¨³ãªã—ã®å˜èªã¯APIã‚­ãƒ¼è¨­å®šã§AIè‡ªå‹•ç¿»è¨³ã§ãã¾ã™</div>
      <button class="btn-primary" id="B-parse">ğŸ” è§£æã™ã‚‹</button>
    </div>

    <!-- FILE -->
    <div id="TP-file" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-file-name" type="text" placeholder="ä¾‹: Deutsch A1">
      <div class="lbl">å‡¦ç†ãƒ¢ãƒ¼ãƒ‰</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-fmode="vocab" id="FM-vocab" style="flex:1;padding:8px">ğŸ“‹<br>å˜èªãƒªã‚¹ãƒˆ<br><span style="font-size:9px;opacity:.7">CSV/Excel</span></button>
        <button class="opt-btn" data-fmode="extract" id="FM-extract" style="flex:1;padding:8px">âœ¨<br>AIã§æŠ½å‡º<br><span style="font-size:9px;opacity:.7">Word/PDF/TXT</span></button>
      </div>
      <div class="upload" id="B-upload">
        <div class="upload-ic" id="UP-ic">ğŸ“</div>
        <div class="upload-tx">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="upload-sub" id="UP-sub">CSV / Excel (.xlsx)</div>
      </div>
      <input type="file" id="IN-file" accept=".csv,.xlsx,.xls,.txt" style="display:none">
      <div class="hint" id="UP-hint">CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰</div>
      <!-- AIæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰ -->
      <div id="FILE-ai-opts" style="display:none">
        <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
        <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
          <button class="opt-btn on" data-level="all" id="FLV-all">ğŸ”€<br>åŒºåˆ¥ãªã—</button>
          <button class="opt-btn" data-level="beginner" id="FLV-beginner">ğŸŒ±<br>åˆç´š</button>
          <button class="opt-btn" data-level="intermediate" id="FLV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
          <button class="opt-btn" data-level="advanced" id="FLV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
        </div>
        <div class="lbl" style="margin-top:8px">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
        <div style="display:flex;gap:7px;margin-bottom:4px">
          <button class="opt-btn on" data-type="words" id="FTY-words" style="flex:1;padding:7px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-type="phrases" id="FTY-phrases" style="flex:1;padding:7px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
          <button class="opt-btn" data-type="both" id="FTY-both" style="flex:1;padding:7px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
        </div>
      </div>
    </div>

    <!-- AI -->
    <div id="TP-ai" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-ai-name" type="text" placeholder="ä¾‹: å°èª¬ã‹ã‚‰æŠ½å‡º">
      <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
      <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
        <button class="opt-btn on" data-level="all" id="LV-all">ğŸ”€<br>åŒºåˆ¥<br>ãªã—</button>
        <button class="opt-btn" data-level="beginner" id="LV-beginner">ğŸŒ±<br>åˆç´š</button>
        <button class="opt-btn" data-level="intermediate" id="LV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
        <button class="opt-btn" data-level="advanced" id="LV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
      </div>
      <div id="LV-hint" style="font-size:10px;color:var(--tx2);margin-bottom:12px;line-height:1.6;padding:7px 10px;background:var(--sf);border-radius:9px"></div>
      <div class="lbl">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-type="words" id="TY-words" style="flex:1;padding:8px">ğŸ“<br>å˜èªã®ã¿</button>
        <button class="opt-btn" data-type="phrases" id="TY-phrases" style="flex:1;padding:8px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        <button class="opt-btn" data-type="both" id="TY-both" style="flex:1;padding:8px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
      </div>
      <div class="lbl">ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</div>
      <textarea class="inp ta" id="IN-ai-text" style="height:140px" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºãƒ»ç¿»è¨³ã—ã¾ã™ã€‚&#10;&#10;ä¾‹ (ç‹¬): Das Haus ist sehr schÃ¶n und die Schule liegt in der NÃ¤he...&#10;ä¾‹ (è‹±): The enigmatic professor was known for his perspicacious observations..."></textarea>
      <div class="hint">âœ¨ AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚APIã‚­ãƒ¼ãªã—ã§ã‚‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚</div>
      <button class="btn-primary" id="B-ai-extract">âœ¨ AI ã§å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡º</button>
    </div>

    <!-- PREVIEW -->
    <div id="PRV" style="display:none;margin-top:16px">
      <div class="prev-hdr">
        <div class="prev-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="prev-cnt" id="PRV-cnt">0 å˜èª</div>
      </div>
      <div class="prev-list" id="PRV-list"></div>
      <button class="btn-primary" style="margin-top:13px" id="B-save">ğŸ’¾ å˜èªå¸³ã«ä¿å­˜</button>
      <button class="btn-sec" id="B-clr-prv">âœ• ã‚¯ãƒªã‚¢</button>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<!-- LIST -->
<div class="scr" id="s-list">
  <div class="hdr">
    <button class="btn btn-back" id="B-list-back">â†</button>
    <div class="hdr-title">å˜èªä¸€è¦§</div>
    <select class="sel" id="SEL-list"><option value="all">ã™ã¹ã¦</option></select>
  </div>
  <div class="srch-wrap">
    <input class="srch" id="IN-search" type="search" placeholder="å˜èªã‚’æ¤œç´¢...">
  </div>
  <div class="filter-bar" id="LANG-filter">
    <button class="flt-btn on" data-lang="all">ã™ã¹ã¦</button>
    <button class="flt-btn" data-lang="en">ğŸ‡¬ğŸ‡§ è‹±èª</button>
    <button class="flt-btn" data-lang="de">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª</button>
    <button class="flt-btn" data-lang="fr">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª</button>
    <button class="flt-btn" data-lang="es">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª</button>
    <button class="flt-btn" data-lang="it">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª</button>
  </div>
  <div class="scroll" style="padding-top:10px">
    <div id="L-words"></div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- FLASHCARD -->
<div class="scr" id="s-flash">
  <div class="fl-hdr">
    <button class="btn btn-back" id="B-flash-exit">âœ•</button>
    <div class="fl-prog"><div class="fl-fill" id="FL-fill" style="width:0%"></div></div>
    <div class="fl-cnt" id="FL-cnt">1/0</div>
  </div>
  <div class="fl-body">
    <div class="fl-card" id="FL-card">
      <div class="fl-lang" id="FL-lang">è‹±èª</div>
      <div class="fl-word" id="FL-word">word</div>
      <div class="fl-meaning" id="FL-meaning"></div>
      <button class="fl-spk" id="FL-spk">ğŸ”Š ç™ºéŸ³</button>
    </div>
  </div>
  <div class="fl-controls">
    <button class="fl-ctrl-btn" id="FL-prev">â€¹â€¹</button>
    <button class="fl-play-btn" id="FL-play">â–¶</button>
    <button class="fl-ctrl-btn" id="FL-next">â€ºâ€º</button>
  </div>
  <button class="btn-primary" id="FL-to-quiz" style="margin:0 16px calc(var(--sb) + 16px);flex-shrink:0">âš¡ ã“ã®ã¾ã¾ã‚¯ã‚¤ã‚ºã¸</button>
</div>

<!-- QUIZ -->
<div class="scr" id="s-quiz">
  <div class="qz-hdr">
    <button class="btn btn-back" id="B-quiz-exit">âœ•</button>
    <div class="qz-prog"><div class="qz-fill" id="QZ-fill" style="width:0%"></div></div>
    <div class="qz-cnt" id="QZ-cnt">0/0</div>
  </div>
  <div class="qz-body">
    <div class="qz-card">
      <div class="qz-badge" id="QZ-badge">æ—¥æœ¬èªã‚’é¸ã¹</div>
      <div class="qz-word" id="QZ-word">word</div>
      <button id="B-speak" style="margin-top:10px;background:rgba(124,92,252,.15);border:none;border-radius:20px;padding:6px 16px;color:var(--ac);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:none">ğŸ”Š ç™ºéŸ³</button>
    </div>
    <div class="choices" id="QZ-choices"></div>
  </div>
  <div class="fb" id="FB">
    <div><div class="fb-tx" id="FB-tx"></div><div class="fb-dt" id="FB-dt"></div></div>
    <button class="fb-next" id="B-next">æ¬¡ã¸ â†’</button>
  </div>
</div>

<!-- RESULT -->
<div class="scr" id="s-result">
  <div class="res-em" id="R-em">ğŸ‰</div>
  <div class="res-tl" id="R-tl">ã‚ˆãã§ãã¾ã—ãŸï¼</div>
  <div class="res-sub" id="R-sub">å­¦ç¿’å®Œäº†</div>
  <div class="res-stats">
    <div class="res-stat"><div class="rs-n" id="R-ok" style="color:var(--gn)">0</div><div class="rs-l">æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ng" style="color:var(--rd)">0</div><div class="rs-l">ä¸æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ac" style="color:var(--ac)">0%</div><div class="rs-l">æ­£è§£ç‡</div></div>
  </div>
  <button class="btn-primary" id="B-res-home" style="width:260px">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <button class="btn-sec" id="B-res-weak" style="width:260px">ğŸ¯ é–“é•ã„ã‚’å¾©ç¿’</button>
</div>

<!-- SETTINGS -->
<div class="scr" id="s-settings">
  <div class="hdr">
    <button class="btn btn-back" id="B-set-back">â†</button>
    <div class="hdr-title">è¨­å®š</div>
  </div>
  <div class="scroll">
    <div class="set-sec">AI è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <span class="set-lbl">ğŸ”‘ Anthropic APIã‚­ãƒ¼</span>
        <input type="password" class="inp" id="IN-apikey" placeholder="sk-ant-..." style="margin-bottom:0;font-size:13px;padding:10px 12px">
        <button class="btn-primary" id="B-save-key" style="padding:10px;font-size:13px">ğŸ’¾ APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
        <div id="KEY-status" style="font-size:11px;text-align:center;padding:2px 0"></div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨AIç¿»è¨³ãƒ»å˜èªæŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚ã‚­ãƒ¼ã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</span>
      </div>
    </div>
    <div class="set-sec">å­¦ç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ“Š 1ã‚»ãƒƒã‚·ãƒ§ãƒ³å•é¡Œæ•°</span>
        <input type="number" id="SEL-size" min="1" max="200" value="20"
          style="width:64px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
        <span style="font-size:13px;color:var(--tx2)">å•</span>
      </div>
      <div class="set-row" id="ROW-rev">
        <span class="set-lbl">ğŸ”„ é€†ã‚¯ã‚¤ã‚ºï¼ˆæ—¥â†’å¤–å›½èªï¼‰æ··åœ¨</span>
        <button class="toggle" id="TG-rev"></button>
      </div>
      <div class="set-row" id="ROW-speak">
        <span class="set-lbl">ğŸ”Š ã‚¯ã‚¤ã‚ºæ™‚ã«è‡ªå‹•èª­ã¿ä¸Šã’</span>
        <button class="toggle" id="TG-speak"></button>
      </div>
      <div class="set-row" id="ROW-autonext">
        <span class="set-lbl">â­ï¸ ã‚¯ã‚¤ã‚ºæ­£è§£æ™‚ã«è‡ªå‹•ã§æ¬¡ã¸</span>
        <button class="toggle" id="TG-autonext"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">â±ï¸ è‡ªå‹•é€²è¡Œã®å¾…æ©Ÿæ™‚é–“</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-autonext-sec" min="0.5" max="10" step="0.5" value="1.5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">âš ï¸ å¾…æ©Ÿæ™‚é–“ã¯äºˆç¿’ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã«ã‚‚ä½¿ã‚ã‚Œã¾ã™ï¼ˆå˜èª+è¨³ã®èª­ã¿ä¸Šã’å¾Œã«æ¬¡ã¸ï¼‰</span>
      </div>
    </div>
    <div class="set-sec">äºˆç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ“– äºˆç¿’ã‚«ãƒ¼ãƒ‰è‡ªå‹•åˆ‡æ›¿é–“éš”</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-flash-sec" min="2" max="15" step="0.5" value="4"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">å¤–å›½èªèª­ã¿ä¸Šã’ â†’ 1.5ç§’å¾Œã«å’Œè¨³è¡¨ç¤ºãƒ»èª­ã¿ä¸Šã’ â†’ æ®‹ã‚Šæ™‚é–“å¾Œã«æ¬¡ã®ã‚«ãƒ¼ãƒ‰ã¸</span>
      </div>
    </div>
    <div class="set-sec">ãƒ‡ãƒ¼ã‚¿</div>
    <div class="set-group">
      <div class="set-row" id="B-export"><span class="set-lbl">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-import-row"><span class="set-lbl">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-reset"><span class="set-lbl" style="color:var(--rd)">ğŸ—‘ï¸ ã™ã¹ã¦å‰Šé™¤</span><span class="set-val">â†’</span></div>
    </div>
    <div style="text-align:center;padding:16px;color:var(--tx2);font-size:11px">VocabMaster v2.0 â€” å¤šè¨€èªå¯¾å¿œç‰ˆ</div>
    <div style="height:20px"></div>
  </div>
</div>

</div>
<input type="file" id="IN-import" accept=".json" style="display:none">

<script>
var MEM=null, DBKEY='vm3';
function sGet(){try{var v=localStorage.getItem(DBKEY);return v?JSON.parse(v):null;}catch(e){return MEM;}}
function sSet(v){try{localStorage.setItem(DBKEY,JSON.stringify(v));}catch(e){}MEM=v;}

var EASE0=2.5, EMIN=1.3;

/* è¨€èªå®šç¾© */
var LANGS={
  en:{name:'è‹±èª',flag:'ğŸ‡¬ğŸ‡§',cls:'lang-en'},
  de:{name:'ãƒ‰ã‚¤ãƒ„èª',flag:'ğŸ‡©ğŸ‡ª',cls:'lang-de'},
  fr:{name:'ãƒ•ãƒ©ãƒ³ã‚¹èª',flag:'ğŸ‡«ğŸ‡·',cls:'lang-fr'},
  es:{name:'ã‚¹ãƒšã‚¤ãƒ³èª',flag:'ğŸ‡ªğŸ‡¸',cls:'lang-es'},
  it:{name:'ã‚¤ã‚¿ãƒªã‚¢èª',flag:'ğŸ‡®ğŸ‡¹',cls:'lang-it'}
};

function mkDB(){return{words:[],lists:[],cfg:{size:20,rev:false,speak:true,autonext:false,autonextSec:1.5,flashSec:4,key:''},stats:{streak:0,lastDay:''}};}
var G=sGet()||mkDB();
function save(){sSet(G);}

/* SRS */
function lvl(w){var s=w.s;if(!s)return 0;if(s.i>=60)return 5;if(s.i>=30)return 4;if(s.i>=14)return 3;if(s.i>=7)return 2;if(s.i>=3)return 1;return 0;}
function due(w){if(!w.s||!w.s.d)return true;return new Date(w.s.d)<=new Date();}
function answer(w,ok){
  if(!w.s)w.s={i:1,e:EASE0,d:null,k:0,l:0};
  var s=w.s;
  if(ok){s.k=(s.k||0)+1;if(s.k<=1)s.i=1;else if(s.k===2)s.i=3;else s.i=Math.round(s.i*s.e);s.e=Math.min(3.0,s.e+0.1);}
  else{s.l=(s.l||0)+1;s.k=0;s.i=1;s.e=Math.max(EMIN,s.e-0.2);}
  s.i=Math.max(1,Math.min(s.i,365));
  var dt=new Date();dt.setDate(dt.getDate()+s.i);s.d=dt.toISOString();w.lr=new Date().toISOString();save();
}
function getDue(){return G.words.filter(due);}
function getWeak(){return G.words.filter(function(w){return w.s&&(w.s.l||0)>0;}).sort(function(a,b){return(b.s.l||0)-(a.s.l||0);});}

/* NAV */
var SCREENS=['s-home','s-add','s-list','s-flash','s-quiz','s-result','s-settings'];
var TABMAP={'s-home':'T-home','s-add':'T-add','s-list':'T-list','s-settings':'T-settings'};
function go(id){
  SCREENS.forEach(function(s){el(s).classList.remove('on');});
  el(id).classList.add('on');
  ['T-home','T-add','T-list','T-settings'].forEach(function(t){el(t).classList.remove('on');});
  if(TABMAP[id])el(TABMAP[id]).classList.add('on');
  if(id==='s-home')homeRefresh();
  if(id==='s-list'){listFilterRebuild();listRender();}
  if(id==='s-settings')settingsLoad();
}

/* HELPERS */
function el(id){return document.getElementById(id);}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
var _tt=null;
function toast(msg){var t=el('toast');t.textContent=msg;t.classList.add('on');if(_tt)clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('on');},2800);}
function loading(msg){el('ld-tx').textContent=msg||'å‡¦ç†ä¸­...';el('ld').classList.add('on');}
function loaded(){el('ld').classList.remove('on');}
function shuffle(a){var b=a.slice();for(var i=b.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=b[i];b[i]=b[j];b[j]=t;}return b;}
function uid(){return '_'+(Date.now()%1e9)+'_'+(Math.random()*1e6|0);}
function langBadge(lang){var l=LANGS[lang||'en'];if(!l)return'';return'<span class="lang-badge '+l.cls+'">'+l.flag+' '+l.name+'</span>';}

/* HOME */
function homeRefresh(){
  el('H-total').textContent=G.words.length;
  el('H-mastered').textContent=G.words.filter(function(w){return w.s&&w.s.i>=14;}).length;
  el('H-streak').textContent=G.stats.streak||0;
  el('H-due').textContent=getDue().length;
  homeListsRender();
}
function homeListsRender(){
  var c=el('H-lists');
  if(!G.lists.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“–</div><div class="empty-tl">å˜èªãƒªã‚¹ãƒˆãªã—</div><div class="empty-sub">ã€Œå˜èªã‚’è¿½åŠ ã€ã‹ã‚‰<br>æ–°ã—ã„å˜èªã‚’ç™»éŒ²ã—ã‚ˆã†</div></div>';return;}
  var h='';
  G.lists.forEach(function(lst){
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var d=ws.filter(due).length;
    var l=LANGS[lst.lang||'en'];
    h+='<button class="list-card" data-lid="'+esc(lst.id)+'">'+
      '<div class="list-ic" style="background:'+lst.clr+'20">'+(l?l.flag:'ğŸ“—')+'</div>'+
      '<div class="list-inf"><div class="list-name">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
      '<div class="list-meta">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div></div>'+
      (d?'<div class="list-badge">'+d+'</div>':'')+'</button>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.list-card').forEach(function(b){b.addEventListener('click',function(){listMenu(this.getAttribute('data-lid'));});});
}

/* ADD */
var addMode='paste', prevWords=[], selLang='en', selLevel='all', selType='words';

function segSwitch(mode){
  addMode=mode;
  ['paste','file','ai'].forEach(function(m){el('TP-'+m).style.display=m===mode?'block':'none';el('SG-'+m).classList.toggle('on',m===mode);});
  prvHide();
}

function setLang(lang){
  selLang=lang;
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-lang')===lang);});
  updateLevelHint();
  /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ›´æ–° */
  var ph={en:'ä¾‹:\nabandon\nabsolute,çµ¶å¯¾çš„ãª',de:'ä¾‹:\nHaus\nSchule,å­¦æ ¡\narbeiten\nschÃ¶n,ç¾ã—ã„',fr:'ä¾‹:\nmaison\nÃ©cole,å­¦æ ¡\ntravail,ä»•äº‹',es:'ä¾‹:\ncasa\nescuela,å­¦æ ¡\ntrabajo,ä»•äº‹',it:'ä¾‹:\ncasa\nscuola,å­¦æ ¡\nlavoro,ä»•äº‹'};
  var ta=el('IN-paste-text');if(ta)ta.placeholder=ph[lang]||ph.en;
}

function parsePaste(){
  var txt=el('IN-paste-text').value.trim();
  if(!txt){toast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim();var m=(p[1]||'').trim();
    if(w)words.push({word:w,meaning:m});
  });
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function needTranslate(words){return G.cfg.key&&words.some(function(w){return !w.meaning;});}

/* ---- FILE MODE ---- */
var fileMode='vocab'; /* vocab | extract */
var fileSelLevel='all', fileSelType='words';

function setFileMode(mode){
  fileMode=mode;
  document.querySelectorAll('[data-fmode]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-fmode')===mode);});
  var isExtract=(mode==='extract');
  el('FILE-ai-opts').style.display=isExtract?'block':'none';
  el('UP-ic').textContent=isExtract?'ğŸ“„':'ğŸ“';
  el('UP-sub').textContent=isExtract?'Word (.docx) / PDF / TXT / CSV':'CSV / Excel (.xlsx)';
  el('UP-hint').textContent=isExtract?'âœ¨ AIãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‹ã‚‰å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™':'CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰';
  el('IN-file').accept=isExtract?'.txt,.csv,.docx,.pdf':'.csv,.xlsx,.xls,.txt';
}

function setFileLevel(level){
  fileSelLevel=level;
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
}

function setFileType(type){
  fileSelType=type;
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function handleFile(evt){
  var f=evt.target.files[0];if(!f)return;evt.target.value='';
  var ext=f.name.split('.').pop().toLowerCase();
  var ni=el('IN-file-name');
  if(ni&&!ni.value)ni.value=f.name.replace(/\.[^.]+$/,'');

  if(fileMode==='extract'){
    /* AIæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰: ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šå‡ºã—ã¦AIã¸ */
    if(ext==='txt'||ext==='csv'){
      var fr=new FileReader();
      fr.onload=function(e){fileAiExtract(e.target.result, f.name);};
      fr.readAsText(f,'UTF-8');
    } else if(ext==='docx'){
      extractDocx(f);
    } else if(ext==='pdf'){
      extractPdf(f);
    } else {
      toast('AIæŠ½å‡ºå¯¾å¿œ: TXT / CSV / Word(.docx) / PDF');
    }
  } else {
    /* å˜èªãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥é€šã‚Šï¼‰ */
    if(ext==='csv'||ext==='txt'){var fr=new FileReader();fr.onload=function(e){csvParse(e.target.result,f.name);};fr.readAsText(f,'UTF-8');}
    else if(ext==='xlsx'||ext==='xls'){xlsxRead(f);}
    else toast('å¯¾å¿œå½¢å¼: CSV, TXT, XLSX');
  }
}

function extractDocx(file){
  loading('Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      try{
        mammoth.extractRawText({arrayBuffer:e.target.result}).then(function(result){
          loaded();
          if(!result.value||result.value.trim().length<10){toast('ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸ');return;}
          fileAiExtract(result.value, file.name);
        }).catch(function(){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
      }catch(e){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof mammoth!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
  s.onload=function(){loaded();doExtract();};
  s.onerror=function(){loaded();toast('Wordãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function extractPdf(file){
  loading('PDFã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      var typedArray=new Uint8Array(e.target.result);
      pdfjsLib.getDocument({data:typedArray}).promise.then(function(pdf){
        var totalPages=pdf.numPages, texts=[], done=0;
        for(var i=1;i<=totalPages;i++){
          (function(pageNum){
            pdf.getPage(pageNum).then(function(page){
              page.getTextContent().then(function(tc){
                texts[pageNum-1]=tc.items.map(function(s){return s.str;}).join(' ');
                done++;
                if(done===totalPages){
                  loaded();
                  var fullText=texts.join('\n');
                  if(!fullText.trim()){toast('PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸï¼ˆç”»åƒPDFã¯éå¯¾å¿œï¼‰');return;}
                  fileAiExtract(fullText, file.name);
                }
              });
            });
          })(i);
        }
      }).catch(function(){loaded();toast('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof pdfjsLib!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=function(){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    loaded();doExtract();
  };
  s.onerror=function(){loaded();toast('PDFãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function fileAiExtract(text, fname){
  /* AIæŠ½å‡ºã‚¿ãƒ–ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ã† â€” selLevel/selTypeã‚’fileã®ã‚‚ã®ã«ä¸€æ™‚å·®ã—æ›¿ãˆ */
  var savedLevel=selLevel, savedType=selType;
  selLevel=fileSelLevel; selType=fileSelType;
  var ni=el('IN-file-name');
  if(ni&&ni.value&&!el('IN-ai-name').value){/* ãƒ•ã‚¡ã‚¤ãƒ«åã‚’AIã‚¿ãƒ–ã«ã‚‚ã‚»ãƒƒãƒˆ */}
  /* AIæŠ½å‡ºã¸ */
  if(!G.cfg.key){toast('AIã§ã®æŠ½å‡ºã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ï¼ˆè¨­å®šç”»é¢ã§å…¥åŠ›ï¼‰');selLevel=savedLevel;selType=savedType;return;}
  var ln=langName(selLang);
  var def=getLevelDef(selLang,fileSelLevel);
  var typeCond={words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'};
  var articleRule={en:'',de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',fr:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maisonï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'};
  var articleInstr=articleRule[selLang]||'';
  loading('AIãŒæŠ½å‡ºä¸­...');
  var prompt=
    'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[fileSelType]+'ã‚’20ã€œ30å€‹æŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
    (articleInstr?articleInstr+'\n':'')+
    'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
    'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
    '{"words":[{"word":"der Mann","meaning":"ç”·æ€§ã€ç”·"},{"word":"gehen","meaning":"è¡Œã"}]}\n\n'+
    'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+text.slice(0,4000);
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:3000,
    messages:[{role:'user',content:prompt}]
  },function(d){
    loaded();selLevel=savedLevel;selType=savedType;
    try{
      var raw=d.content[0].text.replace(/```json|```/g,'').trim();
      var m=raw.match(/\{[\s\S]*\}/);if(!m)throw new Error('JSON not found');
      var words=(JSON.parse(m[0]).words||[]).filter(function(w){return w.word&&w.word.trim();});
      if(!words.length)throw new Error('empty');
      prvShow(words);
      /* ãƒªã‚¹ãƒˆåã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰è‡ªå‹•è¨­å®š */
      var ni2=el('IN-file-name');var ni3=el('IN-ai-name');
      if(ni2&&ni2.value&&ni3&&!ni3.value)ni3.value=ni2.value;
    }catch(e){toast('âŒ AIæŠ½å‡ºã‚¨ãƒ©ãƒ¼: '+e.message);}
  },function(e){
    loaded();selLevel=savedLevel;selType=savedType;
    var msg=e.message||'';
    toast(msg.indexOf('401')>=0?'âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™':'âŒ ã‚¨ãƒ©ãƒ¼: '+msg.slice(0,50));
  });
}

function csvParse(txt,fname){
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim().replace(/^["']|["']$/g,'');
    var m=(p[1]||'').trim().replace(/^["']|["']$/g,'');
    if(w)words.push({word:w,meaning:m});
  });
  var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=fname.replace(/\.[^.]+$/,'');
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function xlsxRead(file){
  loading('Excelã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doRead(){
    var fr=new FileReader();
    fr.onload=function(e){
      loaded();
      try{
        var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        var rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
        var words=[];
        rows.forEach(function(r){var w=(r[0]||'').toString().trim(),m=(r[1]||'').toString().trim();if(w)words.push({word:w,meaning:m});});
        var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=file.name.replace(/\.[^.]+$/,'');
        if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
        needTranslate(words)?doTranslate(words,selLang):prvShow(words);
      }catch(e){toast('Excelã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof XLSX!=='undefined'){loaded();doRead();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload=function(){loaded();doRead();};
  s.onerror=function(){loaded();toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã¯Exceléå¯¾å¿œã€‚CSVã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚');};
  document.head.appendChild(s);
}

/* è¨€èªÃ—ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ¤œå®šåŸºæº– */
var LEVEL_DEF={
  en:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»beå‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” è‹±æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ï¼ˆä¸­å­¦è‹±èªç›¸å½“ï¼‰ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ï¼ˆé«˜æ ¡è‹±èªç›¸å½“ï¼‰ã®å˜èªã€‚æ—¥å¸¸ãƒ»ç¤¾ä¼šçš„ãªè©±é¡Œã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»é›£è§£ãªèªå½™'}
  },
  de:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»åŠ©å‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ç‹¬æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ‰ã‚¤ãƒ„èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã®ãƒ†ãƒ¼ãƒã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  fr:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»Ãªtre/avoirãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ä»æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»æ™‚äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚å­¦è¡“ãƒ»æ–‡å­¦ãƒ»å°‚é–€çš„ãªèªå½™'}
  },
  es:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»ser/estarãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š6ç´šãƒ»5ç´šãƒ»4ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š4ã€œ6ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š3ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š2ã€œ3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  it:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»essere/avereãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®šï¼ˆä¼Šæ¤œï¼‰5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  }
};

function getLevelDef(lang,level){
  var ld=LEVEL_DEF[lang]||LEVEL_DEF.en;
  return ld[level]||ld.all;
}

function setLevel(level){
  selLevel=level;
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
  updateLevelHint();
}

function updateLevelHint(){
  var h=el('LV-hint');
  if(!h)return;
  var def=getLevelDef(selLang,selLevel);
  h.textContent=def.hint;
}

function setType(type){
  selType=type;
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function aiExtract(){
  var txt=el('IN-ai-text').value.trim();
  if(!txt||txt.length<20){toast('ã‚‚ã†å°‘ã—é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  /* APIã‚­ãƒ¼ã‚’ãã®å ´ã§å…¥åŠ›æ¬„ã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆä¿å­˜æ¸ˆã¿ã§ãªãã¦ã‚‚å‹•ãï¼‰ */
  var keyFromInput=(el('IN-apikey')||{}).value||'';
  if(keyFromInput&&!G.cfg.key){G.cfg.key=keyFromInput;save();}
  if(G.cfg.key){
    aiExtractAPI(txt);
  } else {
    if(confirm('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨AIç¿»è¨³ãŒä½¿ãˆã¾ã™ã€‚\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºï¼ˆè¨³ãªã—ï¼‰ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿ')){
      offlineExtract(txt);
    }
  }
}

function apiCall(body,ok,ng){
  var xhr=new XMLHttpRequest();
  xhr.open('POST','https://api.anthropic.com/v1/messages',true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.setRequestHeader('x-api-key',G.cfg.key);
  xhr.setRequestHeader('anthropic-version','2023-06-01');
  xhr.setRequestHeader('anthropic-dangerous-direct-browser-access','true');
  xhr.onload=function(){try{var d=JSON.parse(xhr.responseText);xhr.status===200?ok(d):ng(new Error((d.error&&d.error.message)||'APIã‚¨ãƒ©ãƒ¼ '+xhr.status));}catch(e){ng(e);}};
  xhr.onerror=function(){ng(new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼'));};
  xhr.send(JSON.stringify(body));
}

function langName(lang){return LANGS[lang]?LANGS[lang].name:'è‹±èª';}

function aiExtractAPI(txt){
  var ln=langName(selLang);
  var def=getLevelDef(selLang,selLevel);
  var levelLabel={all:'',beginner:'åˆç´š_',intermediate:'ä¸­ç´š_',advanced:'ä¸Šç´š_'};
  var typeLabel={words:'å˜èª_',phrases:'ç†Ÿèª_',both:'å˜èªç†Ÿèª_'};
  var typeCond={
    words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',
    phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',
    both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'
  };
  /* è¨€èªã”ã¨ã®å† è©ãƒ«ãƒ¼ãƒ« */
  var articleRule={
    en:'',
    de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: gehen, habenï¼‰ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    fr:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maison, l\'Ã©coleï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: aller, avoirï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: ir, tenerï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casa, lo studenteï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: andare, avereï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'
  };
  var articleInstr=articleRule[selLang]||'';
  var ni=el('IN-ai-name');
  if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_'+(levelLabel[selLevel]||'')+(typeLabel[selType]||'')+'AIæŠ½å‡º';
  loading('AIãŒæŠ½å‡ºä¸­...');
  var prompt=
    'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€'+
    'ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[selType]+'ã‚’20ã€œ30å€‹æŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
    (articleInstr?articleInstr+'\n':'')+
    'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
    'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
    '{"words":[{"word":"der Mann","meaning":"ç”·æ€§ã€ç”·"},{"word":"gehen","meaning":"è¡Œã"}]}\n\n'+
    'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+txt.slice(0,3000);
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:3000,
    messages:[{role:'user',content:prompt}]
  },function(d){
    loaded();
    try{
      var raw=d.content[0].text;
      raw=raw.replace(/```json|```/g,'').trim();
      var m=raw.match(/\{[\s\S]*\}/);
      if(!m)throw new Error('JSON not found');
      var parsed=JSON.parse(m[0]);
      var words=(parsed.words||[]).filter(function(w){return w.word&&w.word.trim();});
      if(!words.length)throw new Error('empty');
      prvShow(words);
    }catch(e){
      toast('âŒ AIæŠ½å‡ºã‚¨ãƒ©ãƒ¼: '+e.message);
    }
  },function(e){
    loaded();
    /* APIã‚­ãƒ¼ãŒé–“é•ã£ã¦ã„ã‚‹å¯èƒ½æ€§ */
    var msg=e.message||'';
    if(msg.indexOf('401')>=0||msg.indexOf('authentication')>=0||msg.toLowerCase().indexOf('invalid')>=0){
      toast('âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„');
    } else if(msg.indexOf('é€šä¿¡')>=0){
      toast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    } else {
      toast('âŒ ã‚¨ãƒ©ãƒ¼: '+msg.slice(0,50));
    }
  });
}

function offlineExtract(txt){
  var common={the:1,be:1,is:1,are:1,was:1,were:1,have:1,has:1,had:1,do:1,does:1,did:1,will:1,would:1,shall:1,should:1,may:1,might:1,must:1,can:1,could:1,a:1,an:1,in:1,on:1,at:1,to:1,for:1,of:1,and:1,or:1,but:1,not:1,this:1,that:1,with:1,from:1,by:1,as:1,up:1,out:1,if:1,about:1,who:1,what:1,which:1,all:1,when:1,so:1,no:1,just:1,into:1,over:1,after:1,also:1,than:1,only:1,they:1,their:1,you:1,we:1,he:1,she:1,me:1,my:1,us:1,him:1,it:1,i:1,
    der:1,die:1,das:1,ein:1,eine:1,und:1,oder:1,aber:1,nicht:1,ist:1,sind:1,war:1,hat:1,haben:1,mit:1,von:1,aus:1,bei:1,nach:1,zum:1,zur:1,dem:1,den:1,des:1,
    le:1,la:1,les:1,un:1,une:1,des:1,et:1,ou:1,est:1,sont:1,pas:1,que:1,qui:1,dans:1,sur:1,avec:1,par:1,
    el:1,los:1,las:1,es:1,son:1,una:1,con:1,por:1,para:1,
    il:1,lo:1,gli:1,del:1,della:1,nella:1,con:1,per:1,una:1,sono:1};
  var f={},m,re=/\b([\wÃ„Ã¤Ã–Ã¶ÃœÃ¼ÃŸÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÃ‘Ã±Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹]{3,})\b/g;
  while((m=re.exec(txt))!==null){var w=m[1];if(!common[w.toLowerCase()]&&!common[w])f[w]=(f[w]||0)+1;}
  var s=Object.keys(f).sort(function(a,b){return f[b]-f[a];}).slice(0,30);
  toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºå®Œäº†ï¼ˆè¨³ãªã—ï¼‰APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨è¨³ã‚‚ä»˜ä¸ã§ãã¾ã™');
  prvShow(s.map(function(w){return{word:w,meaning:''};}));
}

function doTranslate(words,lang){
  var nm=words.filter(function(w){return !w.meaning;});
  if(!nm.length){prvShow(words);return;}
  var ln=langName(lang);
  loading(nm.length+'å˜èªã‚’ç¿»è¨³ä¸­...');
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:2048,
    messages:[{role:'user',content:'ä»¥ä¸‹ã®'+ln+'ã®å˜èªã«æ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚JSONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„: {"translations":{"Haus":"å®¶",...}}\\n\\nå˜èª: '+nm.map(function(w){return w.word;}).join(', ')}]
  },function(d){
    try{var m=d.content[0].text.match(/\{[\s\S]*\}/);if(m){var tr=JSON.parse(m[0]).translations||{};words.forEach(function(w){if(!w.meaning&&tr[w.word])w.meaning=tr[w.word];});}}catch(e){}
    loaded();prvShow(words);
  },function(){loaded();prvShow(words);});
}

function prvShow(words){
  prevWords=words.filter(function(w){return w.word&&w.word.trim();});
  el('PRV').style.display='block';
  el('PRV-cnt').textContent=prevWords.length+' å˜èª';
  var h='';
  prevWords.forEach(function(w,i){
    h+='<div class="prev-item"><div class="pi-n">'+(i+1)+'</div><div class="pi-en">'+esc(w.word)+'</div><div class="pi-ja">'+(w.meaning?esc(w.meaning):'<span style="color:var(--tx2);font-size:11px">è¨³ãªã—</span>')+'</div></div>';
  });
  el('PRV-list').innerHTML=h;
  var sc=el('s-add').querySelector('.scroll');if(sc)sc.scrollTop=9999;
}
function prvHide(){prevWords=[];el('PRV').style.display='none';el('PRV-list').innerHTML='';}

function saveList(){
  if(!prevWords.length)return;
  var nameMap={paste:'IN-paste-name',file:'IN-file-name',ai:'IN-ai-name'};
  var ni=el(nameMap[addMode]||'IN-paste-name');
  var listName=(ni&&ni.value.trim())||((LANGS[selLang]?LANGS[selLang].name:'')+'ãƒªã‚¹ãƒˆ '+(G.lists.length+1));
  var lst=null;
  for(var i=0;i<G.lists.length;i++){if(G.lists[i].name===listName){lst=G.lists[i];break;}}
  if(!lst){
    var clrs=['#7c5cfc','#fc5c7d','#5cf8fc','#ffd700','#4cff91','#ff9c4c'];
    var langClr={en:'#4cff91',de:'#ffd700',fr:'#5cf8fc',es:'#ff9c4c',it:'#fc5c7d'};
    lst={id:uid(),name:listName,ic:LANGS[selLang]?LANGS[selLang].flag:'ğŸ“—',clr:langClr[selLang]||clrs[G.lists.length%clrs.length],lang:selLang,cr:new Date().toISOString()};
    G.lists.push(lst);
  }
  var added=0;
  prevWords.forEach(function(pw){
    var ex=G.words.some(function(w){return w.word===pw.word&&w.lid===lst.id;});
    if(!ex){G.words.push({id:uid(),word:pw.word,meaning:pw.meaning||'',lid:lst.id,lang:selLang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});added++;}
  });
  save();prvHide();
  if(ni)ni.value='';
  var ta=el(addMode==='paste'?'IN-paste-text':addMode==='ai'?'IN-ai-text':'IN-paste-text');if(ta)ta.value='';
  toast('âœ… '+added+'å˜èªã‚’ã€Œ'+listName+'ã€ã«è¿½åŠ ã—ã¾ã—ãŸ');
  setTimeout(function(){go('s-home');},500);
}

/* WORD LIST */
var listLangFilter='all';
function listFilterRebuild(){
  var sel=el('SEL-list'),cur=sel.value;
  sel.innerHTML='<option value="all">ã™ã¹ã¦</option>';
  G.lists.forEach(function(l){var o=document.createElement('option');o.value=l.id;o.textContent=(LANGS[l.lang]?LANGS[l.lang].flag+' ':'')+l.name;sel.appendChild(o);});
  sel.value=cur||'all';
}
function listRender(){
  var flt=(el('SEL-list')||{}).value||'all';
  var srch=((el('IN-search')||{}).value||'').toLowerCase();
  var c=el('L-words');
  var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
  if(listLangFilter!=='all')words=words.filter(function(w){return(w.lang||'en')===listLangFilter;});
  if(srch)words=words.filter(function(w){return w.word.toLowerCase().indexOf(srch)>=0||w.meaning.toLowerCase().indexOf(srch)>=0;});
  if(!words.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ”</div><div class="empty-tl">å˜èªãªã—</div></div>';return;}
  var lb=['åˆ','å…¥','ä¸­','ä¸­ä¸Š','ä¸Š','ç¿’å¾—'],h='';
  words.forEach(function(w){
    var v=lvl(w);
    var l=LANGS[w.lang||'en'];
    h+='<button class="word-item" data-wid="'+esc(w.id)+'">'+
      '<div class="wi-inf"><div class="wi-en">'+(l?'<span style="font-size:11px;margin-right:4px">'+l.flag+'</span>':'')+esc(w.word)+'</div>'+
      '<div class="wi-ja">'+(w.meaning?esc(w.meaning):'è¨³ãªã—')+'</div></div>'+
      '<div class="wi-lvl l'+v+'">'+lb[v]+'</div></button>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.word-item').forEach(function(b){b.addEventListener('click',function(){wordDetail(this.getAttribute('data-wid'));});});
}

function listMenu(lid){
  var lst=G.lists.find(function(x){return x.id===lid;}); if(!lst)return;
  var ws=G.words.filter(function(w){return w.lid===lid;});
  var d=ws.filter(due).length;
  var l=LANGS[lst.lang||'en'];
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(lst.name)+'</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:16px">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div>'+
    '<button class="btn-primary" id="LM-flash" style="margin-bottom:8px">ğŸ“– äºˆç¿’ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-quiz" style="margin-top:0;margin-bottom:8px">âš¡ ã™ãã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-due" style="margin-top:0;margin-bottom:8px'+(d?'':';opacity:.4;pointer-events:none')+'">ğŸ“… å¾©ç¿’å˜èªã®ã¿ï¼ˆ'+d+'ä»¶ï¼‰</button>'+
    '<button class="btn-sec" id="LM-list" style="margin-top:0">ğŸ“š å˜èªä¸€è¦§ã‚’è¦‹ã‚‹</button>';
  el('modal-bg').classList.add('on');
  el('LM-flash').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var pool=shuffle(ws.slice()).slice(0, Math.min(ws.length, parseInt(G.cfg.size)||20));
    flashStart(pool,'list',lid);
  });
  el('LM-quiz').addEventListener('click',function(){el('modal-bg').classList.remove('on');quizStart('list',lid);});
  el('LM-due').addEventListener('click',function(){
    if(!d)return;
    el('modal-bg').classList.remove('on');
    /* ã“ã®ãƒªã‚¹ãƒˆã®å¾©ç¿’å˜èªã®ã¿ */
    var pool=ws.filter(due);
    if(pool.length<2){toast('å¾©ç¿’å˜èªãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½2å˜èªï¼‰');return;}
    var size=Math.min(pool.length,parseInt(G.cfg.size)||20);
    var qs=shuffle(pool).slice(0,size);
    Q={words:qs,q:qs.slice(),i:0,ok:0,ng:0,done:false,miss:[],ci:0,ca:''};
    go('s-quiz');qRender();
  });
  el('LM-list').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    /* ãƒªã‚¹ãƒˆçµã‚Šè¾¼ã¿ã§ä¸€è¦§ã¸ */
    go('s-list');
    var sel=el('SEL-list');
    listFilterRebuild();
    sel.value=lid;
    listRender();
  });
}

function wordDetail(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var lst=G.lists.find(function(x){return x.id===w.lid;});
  var dStr=w.s&&w.s.d?new Date(w.s.d).toLocaleDateString('ja-JP'):'ã™ã';
  var lbn=['åˆç´š','å…¥é–€','ä¸­ç´š','ä¸­ä¸Šç´š','ä¸Šç´š','ç¿’å¾—æ¸ˆã¿'],v=lvl(w);
  var l=LANGS[w.lang||'en'];
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(w.word)+'</div>'+
    '<div style="font-size:20px;color:var(--ac3);margin-bottom:13px">'+esc(w.meaning||'è¨³ãªã—')+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px">'+
    mkCard('SRSãƒ¬ãƒ™ãƒ«',lbn[v])+mkCard('æ¬¡å›å¾©ç¿’',dStr)+
    mkCard('é€£ç¶šæ­£è§£',(w.s&&w.s.k||0))+mkCard('é–“é•ã„å›æ•°','<span style="color:var(--rd)">'+(w.s&&w.s.l||0)+'</span>')+
    '</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">è¨€èª: '+(l?l.flag+' '+l.name:'ä¸æ˜')+' ï¼ ãƒªã‚¹ãƒˆ: '+esc(lst?lst.name:'ä¸æ˜')+'</div>'+
    '<button class="del-btn" id="DEL-btn">ğŸ—‘ï¸ ã“ã®å˜èªã‚’å‰Šé™¤</button>';
  el('modal-bg').classList.add('on');
  el('DEL-btn').addEventListener('click',function(){
    G.words=G.words.filter(function(x){return x.id!==wid;});
    save();el('modal-bg').classList.remove('on');listRender();toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  });
}
function mkCard(l,v){return'<div style="background:var(--sf2);border-radius:9px;padding:10px"><div style="font-size:10px;color:var(--tx2);margin-bottom:3px">'+l+'</div><div style="font-size:14px;font-weight:600">'+v+'</div></div>';}

/* ---------- SPEECH ---------- */
var LANG_VOICE={en:'en-US',de:'de-DE',fr:'fr-FR',es:'es-ES',it:'it-IT'};
function speak(text, lang){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);
  u.lang=LANG_VOICE[lang||'en']||'en-US';
  u.rate=0.9;
  u.pitch=1.0;
  /* iOSã¯voicesã®ãƒ­ãƒ¼ãƒ‰ãŒé…ã‚Œã‚‹ãŸã‚å°‘ã—å¾…ã¤ */
  setTimeout(function(){window.speechSynthesis.speak(u);},100);
}

/* ---------- FLASHCARD ---------- */
var FL={words:[],i:0,playing:false,timer:null,quizPool:null,quizMode:null,quizLid:null};

function flashStart(words, quizMode, quizLid){
  if(!words||!words.length){toast('å˜èªãŒã‚ã‚Šã¾ã›ã‚“');return;}
  FL.words=words; FL.i=0; FL.playing=false; FL.timer=null;
  FL.quizMode=quizMode; FL.quizLid=quizLid;
  go('s-flash');
  flRender();
}

function flRender(){
  var w=FL.words[FL.i];
  if(!w)return;
  var tot=FL.words.length, cur=FL.i+1;
  el('FL-fill').style.width=(cur/tot*100)+'%';
  el('FL-cnt').textContent=cur+'/'+tot;
  var l=LANGS[w.lang||'en'];
  el('FL-lang').textContent=l?l.flag+' '+l.name:'';
  /* ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  var card=el('FL-card');
  card.classList.add('flip');
  setTimeout(function(){
    el('FL-word').textContent=w.word;
    el('FL-meaning').textContent='';
    card.classList.remove('flip');
    /* å¤–å›½èªã‚’èª­ã¿ä¸Šã’ */
    speak(w.word, w.lang||'en');
    /* 1.8ç§’å¾Œã«å’Œè¨³ã‚’è¡¨ç¤ºï¼‹èª­ã¿ä¸Šã’ */
    setTimeout(function(){
      el('FL-meaning').textContent=w.meaning||'';
      if(w.meaning) speakJa(w.meaning);
    }, 1800);
  }, 200);
}

function speakJa(text){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);
  u.lang='ja-JP'; u.rate=0.9;
  setTimeout(function(){window.speechSynthesis.speak(u);},100);
}

function flNext(){
  flStopAuto();
  if(FL.i<FL.words.length-1){FL.i++;flRender();}
  else{toast('æœ€å¾Œã®å˜èªã§ã™');}
}
function flPrev(){
  flStopAuto();
  if(FL.i>0){FL.i--;flRender();}
}
function flToggleAuto(){
  if(FL.playing){flStopAuto();}
  else{flStartAuto();}
}
function flStartAuto(){
  FL.playing=true;
  el('FL-play').textContent='â¸';
  var interval=(G.cfg.flashSec||4)*1000;
  FL.timer=setInterval(function(){
    if(FL.i<FL.words.length-1){FL.i++;flRender();}
    else{flStopAuto();toast('äºˆç¿’å®Œäº†ï¼ã‚¯ã‚¤ã‚ºã§ç¢ºèªã—ã‚ˆã†');}
  },interval);
}
function flStopAuto(){
  FL.playing=false;
  el('FL-play').textContent='â–¶';
  if(FL.timer){clearInterval(FL.timer);FL.timer=null;}
}

function flBindButtons(){
  el('B-flash-exit').addEventListener('click',function(){
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    go('s-home');
  });
  el('FL-prev').addEventListener('click',flPrev);
  el('FL-next').addEventListener('click',flNext);
  el('FL-play').addEventListener('click',flToggleAuto);
  el('FL-spk').addEventListener('click',function(){
    var w=FL.words[FL.i];if(!w)return;
    speak(w.word,w.lang||'en');
    if(w.meaning)setTimeout(function(){speakJa(w.meaning);},1800);
  });
  el('FL-to-quiz').addEventListener('click',function(){
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    quizStart(FL.quizMode, FL.quizLid);
  });
}

/* QUIZ */
var Q={words:[],q:[],i:0,ok:0,ng:0,done:false,miss:[],ci:0,ca:''};
function quizStart(mode,lid){
  var pool=[];
  if(mode==='due')pool=getDue();
  else if(mode==='all')pool=G.words.slice();
  else if(mode==='weak'){pool=getWeak();if(!pool.length){toast('é–“é•ãˆãŸå˜èªãŒã‚ã‚Šã¾ã›ã‚“');return;}}
  else if(mode==='list')pool=G.words.filter(function(w){return w.lid===lid;});
  if(pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
  var size=Math.min(pool.length,parseInt(G.cfg.size)||20);
  var ws=shuffle(pool).slice(0,size);
  Q={words:ws,q:ws.slice(),i:0,ok:0,ng:0,done:false,miss:[],ci:0,ca:''};
  go('s-quiz');qRender();
}

function qRender(){
  var q=Q.q[Q.i];if(!q){qResult();return;}
  var tot=Q.q.length,cur=Q.i+1;
  el('QZ-fill').style.width=(cur/tot*100)+'%';
  el('QZ-cnt').textContent=cur+'/'+tot;
  var rev=G.cfg.rev&&Math.random()<0.3;Q.rev=rev;
  var l=LANGS[q.lang||'en'];
  el('QZ-badge').textContent=rev?(l?l.name:'å¤–å›½èª')+'ã‚’é¸ã¹':'æ—¥æœ¬èªã‚’é¸ã¹';
  var displayWord=rev?(q.meaning||q.word):q.word;
  el('QZ-word').textContent=displayWord;
  Q.done=false;

  /* ç™ºéŸ³ãƒœã‚¿ãƒ³ â€” å¤–å›½èªãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘è¡¨ç¤º */
  var spk=el('B-speak');
  var isForLang=!rev;
  if(isForLang&&window.speechSynthesis){
    spk.style.display='inline-block';
    spk.onclick=function(){speak(q.word, q.lang||'en');};
    /* è‡ªå‹•èª­ã¿ä¸Šã’ãŒã‚ªãƒ³ã®ã¨ã */
    if(G.cfg.speak!==false){speak(q.word, q.lang||'en');}
  } else {
    spk.style.display='none';
    if(window.speechSynthesis)window.speechSynthesis.cancel();
  }

  var ca=rev?q.word:(q.meaning||'ï¼ˆè¨³ãªã—ï¼‰');
  var sameLang=G.words.filter(function(w){return w.id!==q.id&&(w.lang||'en')===(q.lang||'en');});
  var others=sameLang.length>=3?sameLang:G.words.filter(function(w){return w.id!==q.id;});
  var dist=shuffle(others).slice(0,3).map(function(w){return rev?w.word:(w.meaning||w.word);});
  var choices=shuffle([ca].concat(dist).slice(0,4));
  while(choices.length<4)choices.push('---');
  Q.ca=ca;Q.ci=choices.indexOf(ca);
  var L=['A','B','C','D'],h='';
  choices.forEach(function(c,i){
    h+='<button class="ch-btn" data-i="'+i+'"><div class="ch-lt">'+L[i]+'</div><div class="ch-tx">'+esc(c)+'</div><div class="ch-ic"></div></button>';
  });
  el('QZ-choices').innerHTML=h;
  el('QZ-choices').querySelectorAll('.ch-btn').forEach(function(b){b.addEventListener('click',function(){qSelect(parseInt(this.getAttribute('data-i')));});});
  el('FB').classList.remove('on');
}

function qSelect(i){
  if(Q.done)return;Q.done=true;
  var btns=el('QZ-choices').querySelectorAll('.ch-btn');
  btns.forEach(function(b){b.classList.add('done');});
  var ok=(i===Q.ci);
  btns[i].classList.add(ok?'ok':'ng');
  btns[i].querySelector('.ch-ic').textContent=ok?'âœ“':'âœ—';
  if(!ok){btns[Q.ci].classList.add('ok');btns[Q.ci].querySelector('.ch-ic').textContent='âœ“';}
  var q=Q.q[Q.i];answer(q,ok);
  ok?Q.ok++:(Q.ng++,Q.miss.push(q));
  el('FB-tx').innerHTML=ok?'<span style="color:var(--gn)">âœ“ æ­£è§£ï¼</span>':'<span style="color:var(--rd)">âœ— ä¸æ­£è§£</span> â†’ '+esc(Q.ca);
  el('FB-dt').textContent=ok?'æ¬¡å›: '+(q.s&&q.s.i||1)+'æ—¥å¾Œ':'1æ—¥å¾Œã«å†å¾©ç¿’';
  el('FB').classList.add('on');
  /* è‡ªå‹•é€²è¡Œ â€” æ­£è§£æ™‚ã®ã¿ï¼ˆä¸æ­£è§£ã¯æ‰‹å‹•ã§ç¢ºèªã•ã›ã‚‹ï¼‰ */
  if(ok&&G.cfg.autonext){
    var delay=Math.round((G.cfg.autonextSec||1.5)*1000);
    var remaining=Math.ceil(G.cfg.autonextSec||1.5);
    el('B-next').textContent='æ¬¡ã¸ ('+remaining+'ç§’)';
    var countdown=setInterval(function(){
      remaining--;
      if(remaining>0){el('B-next').textContent='æ¬¡ã¸ ('+remaining+'ç§’)';}
      else{clearInterval(countdown);}
    },1000);
    Q._autoTimer=setTimeout(function(){
      clearInterval(countdown);
      el('B-next').textContent='æ¬¡ã¸ â†’';
      if(Q.done)qNext();
    },delay);
  }
}

function qNext(){
  if(Q._autoTimer){clearTimeout(Q._autoTimer);Q._autoTimer=null;}
  el('B-next').textContent='æ¬¡ã¸ â†’';
  Q.i++;Q.i>=Q.q.length?qResult():qRender();
}

function qResult(){
  el('FB').classList.remove('on');
  var tot=Q.ok+Q.ng,acc=tot?Math.round(Q.ok/tot*100):0;
  el('R-ok').textContent=Q.ok;el('R-ng').textContent=Q.ng;el('R-ac').textContent=acc+'%';
  var em='ğŸ“š',tl='ã‚‚ã†å°‘ã—ã§ã™ï¼';
  if(acc>=90){em='ğŸ†';tl='å®Œç’§ã§ã™ï¼';}else if(acc>=70){em='ğŸ‰';tl='ã‚ˆãã§ãã¾ã—ãŸï¼';}else if(acc>=50){em='ğŸ“š';tl='ã‚‚ã†å°‘ã—ã§ã™ï¼';}else{em='ğŸ’ª';tl='ç·´ç¿’ã‚ã‚‹ã®ã¿ï¼';}
  el('R-em').textContent=em;el('R-tl').textContent=tl;
  el('R-sub').textContent=tot+'å•ä¸­'+Q.ok+'å•æ­£è§£ Â· æ­£è§£ç‡'+acc+'%';
  var today=new Date().toDateString();
  if(G.stats.lastDay!==today){var yest=new Date(Date.now()-86400000).toDateString();G.stats.streak=(G.stats.lastDay===yest)?(G.stats.streak||0)+1:1;G.stats.lastDay=today;save();}
  go('s-result');
}

/* SETTINGS */
function updateKeyStatus(){
  var s=el('KEY-status');if(!s)return;
  if(G.cfg.key){
    s.innerHTML='<span style="color:var(--gn)">âœ… APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿ï¼ˆsk-ant-...'+G.cfg.key.slice(-4)+'ï¼‰</span>';
  } else {
    s.innerHTML='<span style="color:var(--or)">âš ï¸ APIã‚­ãƒ¼æœªè¨­å®š</span>';
  }
}
function settingsLoad(){
  el('IN-apikey').value=G.cfg.key||'';
  el('SEL-size').value=G.cfg.size||20;
  el('TG-rev').classList.toggle('on',!!G.cfg.rev);
  el('TG-speak').classList.toggle('on',G.cfg.speak!==false);
  el('TG-autonext').classList.toggle('on',!!G.cfg.autonext);
  el('IN-autonext-sec').value=G.cfg.autonextSec||1.5;
  el('IN-flash-sec').value=G.cfg.flashSec||4;
  updateKeyStatus();
}

/* BIND */
function bind(){
  flBindButtons();
  el('T-home').addEventListener('click',function(){go('s-home');});
  el('T-add').addEventListener('click',function(){go('s-add');});
  el('T-list').addEventListener('click',function(){go('s-list');});
  el('T-settings').addEventListener('click',function(){go('s-settings');});
  el('B-go-settings').addEventListener('click',function(){go('s-settings');});

  el('B-quiz-due').addEventListener('click',function(){quizStart('due');});
  el('B-go-add').addEventListener('click',function(){go('s-add');});
  el('B-quiz-all').addEventListener('click',function(){quizStart('all');});
  el('B-go-list').addEventListener('click',function(){go('s-list');});
  el('B-quiz-weak').addEventListener('click',function(){quizStart('weak');});
  el('B-new-list').addEventListener('click',function(){go('s-add');});

  el('B-add-back').addEventListener('click',function(){go('s-home');});
  el('SG-paste').addEventListener('click',function(){segSwitch('paste');});
  el('SG-file').addEventListener('click',function(){segSwitch('file');});
  el('SG-ai').addEventListener('click',function(){segSwitch('ai');});

  /* æŠ½å‡ºã‚¿ã‚¤ãƒ—ãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){
    b.addEventListener('click',function(){setType(this.getAttribute('data-type'));});
  });

  /* ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){
    b.addEventListener('click',function(){setLevel(this.getAttribute('data-level'));});
  });

  /* è¨€èªé¸æŠãƒœã‚¿ãƒ³ */
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){
    b.addEventListener('click',function(){setLang(this.getAttribute('data-lang'));});
  });

  /* è¨€èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      listLangFilter=this.getAttribute('data-lang');
      el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(x){x.classList.remove('on');});
      this.classList.add('on');
      listRender();
    });
  });

  el('B-parse').addEventListener('click',parsePaste);
  el('B-upload').addEventListener('click',function(){el('IN-file').click();});
  el('IN-file').addEventListener('change',handleFile);

  /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ã®ãƒ¢ãƒ¼ãƒ‰/ãƒ¬ãƒ™ãƒ«/ã‚¿ã‚¤ãƒ—åˆ‡æ›¿ */
  document.querySelectorAll('[data-fmode]').forEach(function(b){
    b.addEventListener('click',function(){setFileMode(this.getAttribute('data-fmode'));});
  });
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileLevel(this.getAttribute('data-level'));});
  });
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileType(this.getAttribute('data-type'));});
  });
  el('B-ai-extract').addEventListener('click',aiExtract);
  el('B-save').addEventListener('click',saveList);
  el('B-clr-prv').addEventListener('click',prvHide);

  el('B-list-back').addEventListener('click',function(){go('s-home');});
  el('SEL-list').addEventListener('change',listRender);
  el('IN-search').addEventListener('input',listRender);

  el('B-quiz-exit').addEventListener('click',function(){
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    el('FB').classList.remove('on');go('s-home');
  });
  el('B-next').addEventListener('click',qNext);
  el('B-res-home').addEventListener('click',function(){go('s-home');});
  el('B-res-weak').addEventListener('click',function(){quizStart('weak');});

  el('B-set-back').addEventListener('click',function(){go('s-home');});
  el('B-save-key').addEventListener('click',function(){
    var key=(el('IN-apikey').value||'').trim();
    if(!key){toast('âŒ APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    if(!key.startsWith('sk-ant-')){toast('âŒ APIã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆsk-ant-ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰');return;}
    G.cfg.key=key;save();
    updateKeyStatus();
    toast('âœ… APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  });
  el('SEL-size').addEventListener('input',function(){
    var v=parseInt(this.value)||20;
    if(v<1)v=1;
    if(v>200)v=200;
    G.cfg.size=v;save();
  });
  el('TG-rev').addEventListener('click',function(){G.cfg.rev=!G.cfg.rev;this.classList.toggle('on',G.cfg.rev);save();});
  el('ROW-rev').addEventListener('click',function(e){if(e.target!==el('TG-rev'))el('TG-rev').click();});
  el('TG-speak').addEventListener('click',function(){G.cfg.speak=!this.classList.contains('on');this.classList.toggle('on',G.cfg.speak);save();});
  el('ROW-speak').addEventListener('click',function(e){if(e.target!==el('TG-speak'))el('TG-speak').click();});
  el('TG-autonext').addEventListener('click',function(){G.cfg.autonext=!this.classList.contains('on');this.classList.toggle('on',G.cfg.autonext);save();});
  el('ROW-autonext').addEventListener('click',function(e){if(e.target!==el('TG-autonext'))el('TG-autonext').click();});
  el('IN-autonext-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||1.5;
    if(v<0.5)v=0.5; if(v>10)v=10;
    G.cfg.autonextSec=v; save();
  });
  el('IN-flash-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||4;
    if(v<2)v=2; if(v>15)v=15;
    G.cfg.flashSec=v; save();
  });

  el('B-export').addEventListener('click',function(){
    var b=new Blob([JSON.stringify(G,null,2)],{type:'application/json'});
    var u=URL.createObjectURL(b),a=document.createElement('a');
    a.href=u;a.download='vocabmaster_backup.json';document.body.appendChild(a);a.click();
    setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u);},1000);
    toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†');
  });
  el('B-import-row').addEventListener('click',function(){el('IN-import').click();});
  el('IN-import').addEventListener('change',function(e){
    var f=e.target.files[0];if(!f)return;
    var fr=new FileReader();
    fr.onload=function(ev){
      try{var d=JSON.parse(ev.target.result);if(!d.words||!d.lists)throw 0;G=d;save();toast('âœ… '+G.words.length+'å˜èªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');homeRefresh();}
      catch(err){toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsText(f);e.target.value='';
  });
  el('B-reset').addEventListener('click',function(){
    if(confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')){G=mkDB();save();toast('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');homeRefresh();}
  });
  el('modal-bg').addEventListener('click',function(e){if(e.target===this)this.classList.remove('on');});
}

/* SAMPLE */
function loadSample(){
  if(G.words.length>0)return;
  var samples=[
    {lang:'en',name:'è‹±èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡¬ğŸ‡§',clr:'#4cff91',words:[['abandon','æ¨ã¦ã‚‹ã€æ”¾æ£„ã™ã‚‹'],['accomplish','é”æˆã™ã‚‹'],['acquire','å–å¾—ã™ã‚‹'],['advocate','æå”±ã™ã‚‹'],['ambiguous','ã‚ã„ã¾ã„ãª']]},
    {lang:'de',name:'ãƒ‰ã‚¤ãƒ„èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡©ğŸ‡ª',clr:'#ffd700',words:[['Haus','å®¶'],['Schule','å­¦æ ¡'],['Arbeit','ä»•äº‹'],['schÃ¶n','ç¾ã—ã„'],['lernen','å­¦ã¶']]},
    {lang:'fr',name:'ãƒ•ãƒ©ãƒ³ã‚¹èªã‚µãƒ³ãƒ—ãƒ«',ic:'ğŸ‡«ğŸ‡·',clr:'#5cf8fc',words:[['maison','å®¶'],['Ã©cole','å­¦æ ¡'],['travail','ä»•äº‹'],['beau','ç¾ã—ã„'],['apprendre','å­¦ã¶']]},
  ];
  samples.forEach(function(s){
    var lst={id:uid(),name:s.name,ic:s.ic,clr:s.clr,lang:s.lang,cr:new Date().toISOString()};
    G.lists.push(lst);
    s.words.forEach(function(w){G.words.push({id:uid(),word:w[0],meaning:w[1],lid:lst.id,lang:s.lang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});});
  });
  save();
}

window.onload=function(){bind();loadSample();homeRefresh();updateLevelHint();};
</script>
</body>
</html>
