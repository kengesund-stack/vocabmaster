<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>VocabMaster</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
:root {
  --bg:#0a0a0f; --sf:#12121a; --sf2:#1a1a26; --sf3:#22222f;
  --ac:#7c5cfc; --ac2:#fc5c7d; --ac3:#5cf8fc;
  --tx:#f0f0f8; --tx2:#9090aa;
  --gn:#4cff91; --rd:#ff4c6a; --or:#ff9c4c; --gd:#ffd700;
  --r:14px;
  --st:env(safe-area-inset-top,0px); --sb:env(safe-area-inset-bottom,0px);
}
html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--tx); font-family:-apple-system,Helvetica,Arial,sans-serif; -webkit-user-select:none; user-select:none; }
#app { width:100%; height:100%; overflow:hidden; position:relative; }

.scr { display:none; position:absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; background:var(--bg); }
.scr.on { display:flex; }

.scroll { flex:1; overflow-y:scroll; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:14px 18px; }

.tabbar { display:flex; background:var(--sf); border-top:1px solid rgba(255,255,255,.07); padding-bottom:var(--sb); flex-shrink:0; }
.tab { flex:1; display:flex; flex-direction:column; align-items:center; padding:8px 0; background:none; border:none; color:var(--tx2); cursor:pointer; font-family:inherit; }
.tab.on { color:var(--ac); }
.tab-ic { font-size:20px; }
.tab-lb { font-size:10px; margin-top:2px; }

.hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:10px; background:var(--bg); border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0; }
.hdr-title { font-size:16px; font-weight:600; flex:1; }

#s-home { background:radial-gradient(ellipse at 20% 10%,rgba(124,92,252,.15) 0%,transparent 55%),radial-gradient(ellipse at 80% 90%,rgba(252,92,125,.1) 0%,transparent 55%),var(--bg); }
.home-top { display:flex; justify-content:space-between; align-items:center; padding:12px 18px 0; padding-top:calc(var(--st) + 12px); flex-shrink:0; }
.logo { font-size:24px; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg,var(--ac),var(--ac2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

.btn { display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.btn-ic { width:38px; height:38px; border-radius:10px; background:var(--sf2); font-size:17px; color:var(--tx2); }
.btn-back { width:34px; height:34px; border-radius:9px; background:var(--sf2); font-size:17px; color:var(--tx); flex-shrink:0; }
.btn-primary { width:100%; padding:14px; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); color:#fff; font-size:15px; font-weight:600; -webkit-appearance:none; border:none; cursor:pointer; font-family:inherit; }
.btn-primary:active { opacity:.8; }
.btn-sec { width:100%; padding:13px; background:var(--sf2); border:1px solid rgba(255,255,255,.1); border-radius:var(--r); color:var(--tx); font-size:14px; font-weight:500; margin-top:8px; -webkit-appearance:none; border-radius:var(--r); cursor:pointer; font-family:inherit; }
.btn-sec:active { background:var(--sf3); }
.btn-text { background:none; border:none; color:var(--ac); font-size:13px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }

.stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
.stat { background:var(--sf); border-radius:var(--r); padding:11px; text-align:center; }
.stat-n { font-size:22px; font-weight:700; }
.stat-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.due-btn { width:100%; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); padding:15px 17px; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; border:none; cursor:pointer; -webkit-appearance:none; text-align:left; font-family:inherit; }
.due-btn:active { opacity:.85; }
.due-txt h3 { font-size:16px; font-weight:600; color:#fff; }
.due-txt p { font-size:11px; color:rgba(255,255,255,.75); margin-top:2px; }
.due-n { font-size:36px; font-weight:700; color:#fff; line-height:1; }

.act-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:18px; }
.act-card { background:var(--sf); border-radius:var(--r); padding:14px; border:none; cursor:pointer; text-align:left; width:100%; -webkit-appearance:none; font-family:inherit; }
.act-card:active { background:var(--sf2); }
.act-ic { font-size:24px; margin-bottom:5px; display:block; }
.act-title { font-size:13px; font-weight:600; color:var(--tx); }
.act-sub { font-size:11px; color:var(--tx2); margin-top:2px; }

.sec-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.sec-title { font-size:12px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }

.list-card { background:var(--sf); border-radius:var(--r); padding:13px; margin-bottom:7px; display:flex; align-items:center; gap:11px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.list-card:active { background:var(--sf2); }
.lc-prog-wrap { padding:0 13px 10px; }
.lc-prog-bar { height:4px; background:rgba(255,255,255,.1); border-radius:2px; overflow:hidden; }
.lc-prog-fill { height:100%; border-radius:2px; transition:width .4s ease; }
.lc-prog-txt { font-size:10px; color:var(--tx2); margin-top:4px; display:flex; justify-content:space-between; }

/* スワイプ削除 */
.swipe-wrap { position:relative; overflow:hidden; border-radius:var(--r); margin-bottom:7px; }
.swipe-del-bg { position:absolute; right:0; top:0; bottom:0; width:90px; background:var(--rd); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:2px; color:#fff; font-size:11px; font-weight:700; border-radius:var(--r); }
.swipe-del-bg span { font-size:20px; }
.swipe-inner { position:relative; transition:transform .2s ease; touch-action:pan-y; will-change:transform; }
.swipe-inner.swiped { transform:translateX(-90px); }
.swipe-inner .list-card { margin-bottom:0; border-radius:var(--r); }
.list-ic { width:40px; height:40px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.list-inf { flex:1; min-width:0; }
.list-name { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.list-meta { font-size:11px; color:var(--tx2); margin-top:2px; }
.list-badge { background:var(--ac); color:#fff; font-size:11px; font-weight:600; padding:2px 8px; border-radius:20px; }

/* 言語バッジ */
.lang-badge { display:inline-block; font-size:10px; font-weight:700; padding:1px 6px; border-radius:5px; margin-left:5px; vertical-align:middle; }
.lang-en { background:rgba(76,255,145,.15); color:var(--gn); }
.lang-de { background:rgba(255,215,0,.15); color:var(--gd); }
.lang-fr { background:rgba(92,248,252,.15); color:var(--ac3); }
.lang-es { background:rgba(255,156,76,.15); color:var(--or); }
.lang-it { background:rgba(252,92,125,.15); color:var(--ac2); }

.seg { display:flex; background:var(--sf); border-radius:11px; padding:3px; margin-bottom:16px; }
.seg-btn { flex:1; padding:8px 3px; border:none; border-radius:8px; background:transparent; color:var(--tx2); font-size:12px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }
.seg-btn.on { background:var(--sf3); color:var(--tx); }

.lbl { font-size:12px; color:var(--tx2); margin-bottom:5px; font-weight:500; }
.inp { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:var(--r); color:var(--tx); font-family:inherit; font-size:15px; padding:12px 14px; outline:none; -webkit-appearance:none; margin-bottom:12px; -webkit-user-select:text; user-select:text; }
.inp:focus { border-color:var(--ac); }
.ta { height:140px; resize:none; line-height:1.6; }
.hint { font-size:11px; color:var(--tx2); margin-bottom:12px; line-height:1.5; }

/* 言語選択 */
.lang-sel-wrap { margin-bottom:14px; }
.lang-sel-title { font-size:12px; color:var(--tx2); margin-bottom:7px; font-weight:500; }
.lang-sel-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.lang-sel-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.lang-sel-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }
.opt-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.opt-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }

.upload { border:2px dashed rgba(124,92,252,.3); border-radius:var(--r); padding:26px; text-align:center; cursor:pointer; margin-bottom:12px; background:rgba(124,92,252,.03); }
.upload:active { border-color:var(--ac); background:rgba(124,92,252,.08); }
.upload-ic { font-size:30px; margin-bottom:5px; }
.upload-tx { font-size:14px; font-weight:500; }
.upload-sub { font-size:11px; color:var(--tx2); margin-top:3px; }

.prev-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.prev-title { font-size:13px; font-weight:600; color:var(--tx2); }
.prev-cnt { background:var(--ac); color:#fff; font-size:11px; padding:2px 8px; border-radius:10px; }
.prev-list { display:flex; flex-direction:column; gap:5px; max-height:220px; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.prev-item { background:var(--sf); border-radius:9px; padding:9px 11px; display:flex; align-items:center; gap:9px; }
.pi-n { font-size:11px; color:var(--tx2); width:20px; flex-shrink:0; }
.pi-en { font-size:14px; font-weight:500; flex:1; }
.pi-ja { font-size:12px; color:var(--ac3); }

.srch-wrap { padding:9px 16px 0; flex-shrink:0; }
.srch { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:11px; padding:9px 13px; color:var(--tx); font-family:inherit; font-size:14px; outline:none; -webkit-appearance:none; -webkit-user-select:text; user-select:text; }

/* フィルタバー */
.filter-bar { display:flex; gap:7px; padding:9px 16px 0; overflow-x:scroll; -webkit-overflow-scrolling:touch; flex-shrink:0; }
.filter-bar::-webkit-scrollbar { display:none; }
.flt-btn { padding:5px 12px; border-radius:20px; border:1px solid rgba(255,255,255,.1); background:var(--sf); color:var(--tx2); font-size:12px; font-weight:500; white-space:nowrap; cursor:pointer; -webkit-appearance:none; font-family:inherit; flex-shrink:0; }
.flt-btn.on { background:var(--ac); border-color:var(--ac); color:#fff; }

.word-item { background:var(--sf); border-radius:var(--r); padding:11px 13px; margin-bottom:6px; display:flex; align-items:center; gap:9px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.word-item:active { background:var(--sf2); }
.wi-inf { flex:1; min-width:0; }
.wi-en { font-size:14px; font-weight:500; }
.wi-ja { font-size:11px; color:var(--tx2); margin-top:2px; }
.wi-lvl { width:28px; height:28px; border-radius:7px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; flex-shrink:0; }
.l0{background:rgba(255,76,106,.15);color:var(--rd);} .l1{background:rgba(255,156,76,.15);color:var(--or);} .l2{background:rgba(255,215,0,.15);color:var(--gd);} .l3{background:rgba(76,255,145,.15);color:var(--gn);} .l4{background:rgba(124,92,252,.15);color:var(--ac);} .l5{background:rgba(92,248,252,.15);color:var(--ac3);}

#s-quiz { background:radial-gradient(ellipse at 50% 0%,rgba(124,92,252,.12) 0%,transparent 55%),var(--bg); }
.qz-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.qz-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.qz-fill { height:100%; background:linear-gradient(90deg,var(--ac),var(--ac2)); border-radius:3px; transition:width .35s ease; }
.qz-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.qz-body { flex:1; display:flex; flex-direction:column; padding:13px 16px; overflow:hidden; gap:10px; }
.qz-card { background:var(--sf); border-radius:18px; padding:22px 18px; text-align:center; flex-shrink:0; }
.qz-badge { display:inline-block; background:rgba(124,92,252,.15); color:var(--ac); font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; margin-bottom:12px; text-transform:uppercase; letter-spacing:.06em; }
.qz-word { font-size:28px; font-weight:700; line-height:1.2; word-break:break-word; }
.choices { display:flex; flex-direction:column; gap:7px; flex:1; justify-content:center; }
.ch-btn { width:100%; padding:13px 14px; background:var(--sf); border:2px solid rgba(255,255,255,.08); border-radius:13px; color:var(--tx); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; text-align:left; display:flex; align-items:center; gap:9px; -webkit-appearance:none; min-height:50px; }
.ch-btn:active:not(.done) { border-color:var(--ac); background:rgba(124,92,252,.08); }
.ch-btn.ok { border-color:var(--gn)!important; background:rgba(76,255,145,.08)!important; }
.ch-btn.ok .ch-lt { background:rgba(76,255,145,.2); color:var(--gn); }
.ch-btn.ok .ch-tx { color:var(--gn); }
.ch-btn.ng { border-color:var(--rd)!important; background:rgba(255,76,106,.08)!important; }
.ch-btn.ng .ch-lt { background:rgba(255,76,106,.2); color:var(--rd); }
.ch-btn.ng .ch-tx { color:var(--rd); }
.ch-lt { width:25px; height:25px; border-radius:6px; background:rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--tx2); flex-shrink:0; }
.ch-tx { flex:1; line-height:1.3; }
.ch-ic { font-size:15px; margin-left:auto; flex-shrink:0; min-width:18px; text-align:center; }
.ch-dk { width:100%; padding:11px 14px; background:transparent; border:2px dashed rgba(255,255,255,.15); border-radius:13px; color:var(--tx2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; text-align:center; margin-top:2px; -webkit-appearance:none; }
.ch-dk:active:not(.done) { border-color:rgba(255,255,255,.35); color:var(--tx); }
.ch-dk.done { opacity:.5; pointer-events:none; }

.fb { position:absolute; bottom:calc(var(--sb) + 7px); left:14px; right:14px; background:var(--sf2); border:1px solid rgba(255,255,255,.08); border-radius:13px; padding:11px 14px; display:flex; align-items:center; justify-content:space-between; gap:9px; opacity:0; transform:translateY(28px); transition:opacity .25s ease,transform .25s ease; pointer-events:none; z-index:10; }
.fb.on { opacity:1; transform:translateY(0); pointer-events:auto; }
.fb-tx { font-size:13px; font-weight:600; }
.fb-dt { font-size:11px; color:var(--tx2); margin-top:2px; }
.fb-next { background:var(--ac); color:#fff; border:none; border-radius:9px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; font-family:inherit; -webkit-appearance:none; }
.fb-next:active { opacity:.8; }

#s-result { background:radial-gradient(ellipse at 50% 30%,rgba(124,92,252,.2) 0%,transparent 55%),var(--bg); align-items:center; justify-content:center; padding:36px 22px; }
.res-em { font-size:64px; margin-bottom:12px; }
.res-tl { font-size:26px; font-weight:700; margin-bottom:5px; text-align:center; }
.res-sub { font-size:13px; color:var(--tx2); margin-bottom:24px; text-align:center; }
.res-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:9px; width:100%; margin-bottom:24px; }
.res-stat { background:var(--sf); border-radius:13px; padding:13px; text-align:center; }
.rs-n { font-size:24px; font-weight:700; }
.rs-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.set-group { background:var(--sf); border-radius:var(--r); margin-bottom:16px; overflow:hidden; }
.set-row { display:flex; align-items:center; padding:13px 14px; gap:9px; border-bottom:1px solid rgba(255,255,255,.05); cursor:pointer; }
.set-row:last-child { border-bottom:none; }
.set-lbl { flex:1; font-size:14px; }
.set-val { font-size:13px; color:var(--tx2); }
.set-sec { font-size:11px; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; font-weight:600; margin-bottom:6px; padding-left:2px; }
.set-inp { background:transparent; border:none; color:var(--tx); font-family:inherit; font-size:13px; outline:none; flex:1; text-align:right; -webkit-user-select:text; user-select:text; -webkit-appearance:none; }
.toggle { width:40px; height:24px; border-radius:12px; background:var(--sf3); position:relative; cursor:pointer; transition:background .3s; flex-shrink:0; border:none; -webkit-appearance:none; }
.toggle.on { background:var(--ac); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:transform .3s; box-shadow:0 1px 3px rgba(0,0,0,.4); }
.toggle.on::after { transform:translateX(16px); }
.sel { background:transparent; border:none; color:var(--tx2); font-size:13px; outline:none; font-family:inherit; -webkit-appearance:none; padding:4px 0; }

.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:50; display:none; align-items:flex-end; }
.modal-bg.on { display:flex; }
.modal-sh { background:var(--sf); border-radius:20px 20px 0 0; padding:18px 16px calc(var(--sb) + 16px); width:100%; max-height:80%; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.modal-hd { width:32px; height:4px; background:rgba(255,255,255,.15); border-radius:2px; margin:0 auto 16px; }
.modal-tl { font-size:17px; font-weight:700; margin-bottom:13px; }
.del-btn { background:rgba(255,76,106,.1); color:var(--rd); border:1px solid rgba(255,76,106,.2); border-radius:11px; padding:12px; font-size:14px; font-weight:600; cursor:pointer; width:100%; font-family:inherit; margin-top:5px; -webkit-appearance:none; }
.del-btn:active { background:rgba(255,76,106,.2); }

.empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:44px 20px; text-align:center; gap:9px; }
.empty-ic { font-size:42px; }
.empty-tl { font-size:16px; font-weight:600; }
.empty-sub { font-size:12px; color:var(--tx2); line-height:1.5; }

.ai-tag { display:inline-block; background:linear-gradient(135deg,var(--ac),var(--ac2)); color:#fff; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; vertical-align:middle; margin-left:3px; }

.ld-bg { position:fixed; inset:0; background:rgba(10,10,15,.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
.ld-bg.on { display:flex; }
.spin { width:42px; height:42px; border:3px solid rgba(124,92,252,.2); border-top-color:var(--ac); border-radius:50%; animation:sp .8s linear infinite; margin-bottom:12px; }
@keyframes sp { to { transform:rotate(360deg); } }
.ld-tx { font-size:13px; color:var(--tx2); }

.toast { position:fixed; top:calc(var(--st) + 12px); left:16px; right:16px; background:var(--sf3); border:1px solid rgba(255,255,255,.1); border-radius:11px; padding:10px 14px; font-size:13px; font-weight:500; text-align:center; z-index:200; transform:translateY(-70px); opacity:0; transition:all .25s ease; pointer-events:none; }
.toast.on { transform:translateY(0); opacity:1; }

/* ---- FLASHCARD ---- */
#s-flash { background:radial-gradient(ellipse at 50% 0%,rgba(92,248,252,.08) 0%,transparent 55%),var(--bg); }
.fl-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.fl-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.fl-fill { height:100%; background:linear-gradient(90deg,var(--ac3),var(--ac)); border-radius:3px; transition:width .35s ease; }
.fl-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.fl-body { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; gap:16px; }
.fl-card { width:100%; max-width:360px; background:var(--sf); border-radius:22px; padding:36px 24px; text-align:center; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; box-shadow:0 4px 32px rgba(0,0,0,.4); transition:transform .2s ease,opacity .2s ease; }
.fl-card.flip { transform:scale(.93); opacity:.4; }
.fl-lang { font-size:11px; font-weight:700; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }
.fl-word { font-size:32px; font-weight:700; line-height:1.2; word-break:break-word; }
.fl-meaning { font-size:22px; color:var(--ac3); font-weight:600; }
.fl-spk { background:rgba(92,248,252,.12); border:none; border-radius:20px; padding:6px 18px; color:var(--ac3); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.fl-controls { display:flex; align-items:center; gap:18px; flex-shrink:0; padding-bottom:calc(var(--sb) + 16px); }
.fl-ctrl-btn { width:52px; height:52px; border-radius:50%; background:var(--sf2); border:none; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--tx); -webkit-appearance:none; }
.fl-ctrl-btn:active { background:var(--sf3); }
.fl-play-btn { width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--ac3),var(--ac)); border:none; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; -webkit-appearance:none; box-shadow:0 4px 16px rgba(124,92,252,.4); }
.fl-play-btn:active { opacity:.85; }

::-webkit-scrollbar { display:none; }

/* ---- FOLDER ---- */
.folder-block { margin-bottom:10px; }
.folder-hdr { display:flex; align-items:center; gap:8px; padding:8px 4px 6px; cursor:pointer; -webkit-tap-highlight-color:transparent; }
.folder-arrow { font-size:11px; color:var(--tx2); transition:transform .2s ease; flex-shrink:0; }
.folder-arrow.open { transform:rotate(90deg); }
.folder-ic { font-size:18px; flex-shrink:0; }
.folder-name { font-size:13px; font-weight:600; color:var(--tx); flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.folder-count { font-size:11px; color:var(--tx2); flex-shrink:0; }
.folder-edit-btn { background:none; border:none; font-size:15px; color:var(--tx2); cursor:pointer; padding:4px; flex-shrink:0; -webkit-appearance:none; }
.folder-body { overflow:hidden; transition:max-height .25s ease; }
.folder-body.collapsed { max-height:0 !important; }
.no-folder-hdr { font-size:11px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; padding:6px 4px 6px; }

/* ---- DRAG & DROP ---- */
.drag-ghost { position:fixed; pointer-events:none; z-index:500; opacity:.85; transform:scale(1.03); box-shadow:0 8px 32px rgba(0,0,0,.6); border-radius:var(--r); transition:transform .1s; left:0; top:0; }
.drag-ghost .swipe-del-bg { display:none; }
.drag-ghost .swipe-inner { transform:none !important; }
.list-card.dragging-src { opacity:.35; pointer-events:none; }
.folder-drop-target { outline:2px solid var(--ac); outline-offset:-2px; background:rgba(124,92,252,.12) !important; border-radius:var(--r); }
.nofolder-drop-target { outline:2px dashed var(--ac2); outline-offset:-2px; border-radius:8px; background:rgba(252,92,125,.08); }
.drag-hint { position:absolute; top:-22px; left:50%; transform:translateX(-50%); background:var(--ac); color:#fff; font-size:10px; font-weight:700; padding:2px 8px; border-radius:6px; white-space:nowrap; pointer-events:none; opacity:0; transition:opacity .15s; }
.drag-hint.on { opacity:1; }
.folder-dragging-src { opacity:.35; }
.folder-drag-ghost { position:fixed; pointer-events:none; z-index:500; opacity:.85; transform:scale(1.03); box-shadow:0 8px 32px rgba(0,0,0,.6); border-radius:var(--r); left:0; top:0; background:var(--sf); padding:10px 14px; display:flex; align-items:center; gap:8px; min-width:160px; }
.subfolder-indent { margin-left:12px; }
/* 階層ごとの左ライン＋背景で深さを表現 */
.folder-body { position:relative; }
.folder-body > .folder-block { border-left:2px solid rgba(124,92,252,.28); margin-left:10px; padding-left:10px; border-radius:0 0 0 6px; background:rgba(124,92,252,.04); border-radius:0 8px 8px 0; margin-bottom:6px; }
.folder-body > .folder-block > .folder-hdr { padding-left:0; }
.folder-body > .folder-block > .folder-body > .folder-block { border-left:2px solid rgba(92,248,252,.22); background:rgba(92,248,252,.03); }
/* 各階層のフォルダヘッダーに薄い背景 */
.folder-block[data-depth="0"] > .folder-hdr { background:rgba(255,255,255,.03); border-radius:10px; padding-left:8px; }
.folder-block[data-depth="1"] > .folder-hdr { background:rgba(124,92,252,.07); border-radius:8px; padding-left:6px; }
.folder-block[data-depth="2"] > .folder-hdr { background:rgba(92,248,252,.07); border-radius:7px; padding-left:6px; }
/* リストカードもインデント内では少し縮める */
.folder-body > .swipe-wrap { margin-left:2px; }
</style>
</head>
<body>
<script id="embedded-data" type="application/json">null</script>
<div id="app">

<div class="ld-bg" id="ld"><div class="spin"></div><div class="ld-tx" id="ld-tx">処理中...</div></div>
<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal-bg"><div class="modal-sh"><div class="modal-hd"></div><div id="modal-ct"></div></div></div>

<!-- HOME -->
<div class="scr on" id="s-home">
  <div class="home-top">
    <div class="logo">VocabMaster</div>
    <button class="btn btn-ic" id="B-go-settings">⚙️</button>
  </div>
  <div class="scroll">
    <div style="height:14px"></div>
    <div class="stats">
      <div class="stat"><div class="stat-n" id="H-total">0</div><div class="stat-l">総単語数</div></div>
      <div class="stat"><div class="stat-n" id="H-mastered">0</div><div class="stat-l">習得済み</div></div>
      <div class="stat"><div class="stat-n" id="H-streak">0</div><div class="stat-l">連続日数</div></div>
    </div>
    <button class="due-btn" id="B-quiz-due">
      <div class="due-txt"><h3>今日の復習</h3><p>忘却曲線に基づく最適タイミング</p></div>
      <div class="due-n" id="H-due">0</div>
    </button>
    <div class="act-grid">
      <button class="act-card" id="B-go-add"><span class="act-ic">➕</span><div class="act-title">単語を追加</div><div class="act-sub">テキスト・ファイル・AI</div></button>
      <button class="act-card" id="B-quiz-all"><span class="act-ic">⚡</span><div class="act-title">全単語クイズ</div><div class="act-sub">4択形式で練習</div></button>
      <button class="act-card" id="B-go-list"><span class="act-ic">📚</span><div class="act-title">単語一覧</div><div class="act-sub">管理・編集</div></button>
      <button class="act-card" id="B-quiz-weak"><span class="act-ic">🎯</span><div class="act-title">苦手単語</div><div class="act-sub">間違えた単語を特訓</div></button>
      <button class="act-card" id="B-study-list" style="border:1.5px solid rgba(124,92,252,.4)"><span class="act-ic">📖</span><div class="act-title">予習→クイズ</div><div class="act-sub">リストを選んで予習から</div></button>
      <button class="act-card" id="B-test-list" style="border:1.5px solid rgba(252,92,125,.4)"><span class="act-ic">📝</span><div class="act-title">テスト形式</div><div class="act-sub">予習なし・採点のみ</div></button>
    </div>
    <div class="sec-hdr">
      <div class="sec-title">単語リスト</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn-text" id="B-new-folder" style="color:var(--tx2)">📁 フォルダ</button>
        <button class="btn-text" id="B-new-list">＋ 新規</button>
      </div>
    </div>
    <div id="H-lists"></div>
    <div style="margin:18px 0 8px">
      <button id="B-report" style="width:100%;padding:13px;background:var(--sf);border:1.5px solid rgba(92,248,252,.3);border-radius:var(--r);color:var(--ac3);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px">
        <span>📊</span><span>学習報告書を作成</span>
      </button>
    </div>
    <div style="height:14px"></div>
  </div>
  <div class="tabbar">
    <button class="tab on" id="T-home"><div class="tab-ic">🏠</div><div class="tab-lb">ホーム</div></button>
    <button class="tab" id="T-add"><div class="tab-ic">➕</div><div class="tab-lb">追加</div></button>
    <button class="tab" id="T-list"><div class="tab-ic">📚</div><div class="tab-lb">単語帳</div></button>
    <button class="tab" id="T-settings"><div class="tab-ic">⚙️</div><div class="tab-lb">設定</div></button>
  </div>
</div>

<!-- ADD -->
<div class="scr" id="s-add">
  <div class="hdr">
    <button class="btn btn-back" id="B-add-back">←</button>
    <div class="hdr-title">単語を追加</div>
  </div>
  <div class="scroll">
    <div class="seg">
      <button class="seg-btn on" id="SG-paste">貼り付け</button>
      <button class="seg-btn" id="SG-file">ファイル</button>
      <button class="seg-btn" id="SG-ai">AI抽出<span class="ai-tag">AI</span></button>
    </div>

    <!-- 言語選択（共通） -->
    <div class="lang-sel-wrap">
      <div class="lang-sel-title">学習言語を選択</div>
      <div class="lang-sel-grid">
        <button class="lang-sel-btn on" data-lang="en" id="LS-en">🇬🇧<br>英語</button>
        <button class="lang-sel-btn" data-lang="de" id="LS-de">🇩🇪<br>独語</button>
        <button class="lang-sel-btn" data-lang="fr" id="LS-fr">🇫🇷<br>仏語</button>
        <button class="lang-sel-btn" data-lang="es" id="LS-es">🇪🇸<br>西語</button>
        <button class="lang-sel-btn" data-lang="it" id="LS-it">🇮🇹<br>伊語</button>
      </div>
    </div>

    <!-- PASTE -->
    <div id="TP-paste">
      <div class="lbl">リスト名</div>
      <input class="inp" id="IN-paste-name" type="text" placeholder="例: ドイツ語基礎単語">
      <div class="lbl">テキスト / JSON を貼り付け</div>
      <textarea class="inp ta" id="IN-paste-text" placeholder="例:&#10;Haus&#10;Schule,学校&#10;arbeiten&#10;schön,美しい"></textarea>
      <!-- JSON検出時に表示されるオプション -->
      <div id="PASTE-json-opts" style="display:none;margin-bottom:10px">
        <div style="background:rgba(92,248,252,.07);border:1px solid rgba(92,248,252,.2);border-radius:10px;padding:10px 12px;margin-bottom:10px;font-size:11px;color:var(--ac3);line-height:1.7">
          📗 <b>JSONテキストを検出しました</b><br>
          <span style="color:var(--tx2)">book_title・vocabulary・phrases などを自動認識します</span>
        </div>
        <div class="lbl">取り込みセクション</div>
        <div style="display:flex;gap:7px;margin-bottom:8px">
          <button class="opt-btn on" data-pjsec="all" id="PJSEC-all" style="flex:1;padding:7px;font-size:11px">📦<br>すべて</button>
          <button class="opt-btn" data-pjsec="vocabulary" id="PJSEC-vocab" style="flex:1;padding:7px;font-size:11px">📝<br>単語のみ</button>
          <button class="opt-btn" data-pjsec="phrases" id="PJSEC-phrase" style="flex:1;padding:7px;font-size:11px">💬<br>熟語のみ</button>
        </div>
      </div>
      <div class="hint" id="PASTE-hint">テキスト形式（1行1単語 / 「単語,訳」）または JSON テキストをそのまま貼り付けられます。訳なしの単語はAPIキー設定でAI自動翻訳できます。</div>

      <!-- JSON形式サンプル（折り畳み） -->
      <div id="JSON-sample-wrap" style="margin-bottom:12px">
        <button id="JSON-sample-toggle" style="width:100%;background:none;border:1px dashed rgba(92,248,252,.3);border-radius:10px;padding:9px 14px;color:var(--ac3);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none;display:flex;align-items:center;justify-content:space-between;gap:8px;text-align:left">
          <span>📋 AIへの依頼プロンプト・JSON形式の例</span>
          <span id="JSON-sample-arrow" style="font-size:10px;transition:transform .2s;flex-shrink:0">▼</span>
        </button>
        <div id="JSON-sample-body" style="display:none;margin-top:8px;background:rgba(92,248,252,.04);border:1px solid rgba(92,248,252,.15);border-radius:10px;padding:12px;font-size:11px;line-height:1.7">

          <div style="color:var(--tx2);margin-bottom:10px">
            下記のプロンプトをそのままAI（ChatGPT・Claude等）に送ると、このアプリに貼り付けられるJSONを作成してもらえます。
          </div>

          <!-- プロンプト例1：単語リスト -->
          <div style="margin-bottom:12px">
            <div style="color:var(--ac3);font-weight:700;margin-bottom:5px">① 単語リストを作る</div>
            <div style="background:rgba(0,0,0,.35);border-radius:8px;padding:10px;position:relative">
              <pre id="PROMPT-1" style="white-space:pre-wrap;color:var(--tx);font-family:-apple-system,Helvetica,Arial,sans-serif;font-size:11px;margin:0;line-height:1.6">英検準1級レベルの英単語を50語、以下のJSON形式で出力してください。日本語訳も必ず付けてください。

{
  "book_title": "英検準1級 単語リスト",
  "content": {
    "vocabulary": [
      {"word": "abolish", "meaning": "廃止する"},
      {"word": "ambiguous", "meaning": "曖昧な"}
    ],
    "phrases": [
      {"word": "carry out", "meaning": "実行する"},
      {"word": "come up with", "meaning": "思いつく"}
    ]
  }
}</pre>
              <button onclick="copyPrompt('PROMPT-1','BTN-CP-1')" id="BTN-CP-1" style="margin-top:8px;width:100%;background:rgba(92,248,252,.12);border:1px solid rgba(92,248,252,.25);border-radius:7px;padding:7px;color:var(--ac3);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none">📋 コピー</button>
            </div>
          </div>

          <!-- プロンプト例2：テーマ指定 -->
          <div style="margin-bottom:12px">
            <div style="color:var(--ac);font-weight:700;margin-bottom:5px">② テーマ・レベルを指定する</div>
            <div style="background:rgba(0,0,0,.35);border-radius:8px;padding:10px;position:relative">
              <pre id="PROMPT-2" style="white-space:pre-wrap;color:var(--tx);font-family:-apple-system,Helvetica,Arial,sans-serif;font-size:11px;margin:0;line-height:1.6">「ビジネス英語」に関する重要単語30語と頻出フレーズ10個を以下のJSON形式で出力してください。中上級レベルで、日本語訳も付けてください。

{
  "book_title": "ビジネス英語 必須表現",
  "content": {
    "vocabulary": [
      {"word": "negotiate", "meaning": "交渉する"},
      {"word": "facilitate", "meaning": "促進する、容易にする"}
    ],
    "phrases": [
      {"word": "reach a consensus", "meaning": "合意に達する"},
      {"word": "bottom line", "meaning": "最終的な結論、収益"}
    ]
  }
}</pre>
              <button onclick="copyPrompt('PROMPT-2','BTN-CP-2')" id="BTN-CP-2" style="margin-top:8px;width:100%;background:rgba(124,92,252,.12);border:1px solid rgba(124,92,252,.25);border-radius:7px;padding:7px;color:var(--ac);font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none">📋 コピー</button>
            </div>
          </div>

          <!-- 形式の説明 -->
          <div style="background:rgba(255,255,255,.04);border-radius:8px;padding:10px;color:var(--tx2);font-size:10px;line-height:1.8">
            <div style="color:var(--tx);font-weight:600;margin-bottom:4px">📌 JSONのルール</div>
            <div><span style="color:var(--ac3)">book_title</span> … リスト名として自動設定</div>
            <div><span style="color:var(--ac3)">vocabulary</span> … 単語リスト（単語 / 熟語どちらも可）</div>
            <div><span style="color:var(--ac3)">phrases</span> … 熟語・イディオム専用（省略可）</div>
            <div><span style="color:var(--ac3)">word</span> … 外国語の単語・フレーズ</div>
            <div><span style="color:var(--ac3)">meaning</span> … 日本語訳</div>
          </div>
        </div>
      </div>

      <button class="btn-primary" id="B-parse">🔍 解析する</button>
    </div>

    <!-- FILE -->
    <div id="TP-file" style="display:none">
      <div class="lbl">リスト名</div>
      <input class="inp" id="IN-file-name" type="text" placeholder="例: Deutsch A1">
      <div class="lbl">処理モード</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-fmode="vocab" id="FM-vocab" style="flex:1;padding:8px">📋<br>単語リスト<br><span style="font-size:9px;opacity:.7">CSV/Excel</span></button>
        <button class="opt-btn" data-fmode="json" id="FM-json" style="flex:1;padding:8px">📗<br>JSON読込<br><span style="font-size:9px;opacity:.7">外部JSON</span></button>
        <button class="opt-btn" data-fmode="extract" id="FM-extract" style="flex:1;padding:8px">✨<br>AIで抽出<br><span style="font-size:9px;opacity:.7">Word/PDF/TXT</span></button>
      </div>
      <div class="upload" id="B-upload">
        <div class="upload-ic" id="UP-ic">📁</div>
        <div class="upload-tx">タップしてファイルを選択</div>
        <div class="upload-sub" id="UP-sub">CSV / Excel (.xlsx)</div>
      </div>
      <input type="file" id="IN-file" accept=".csv,.xlsx,.xls,.txt,.json" style="display:none">
      <div class="hint" id="UP-hint">CSV: 1列目=単語、2列目=日本語訳（任意）</div>
      <!-- AI抽出モードのオプション（ファイル用） -->
      <div id="FILE-ai-opts" style="display:none">
        <div class="lbl">抽出レベル</div>
        <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
          <button class="opt-btn on" data-level="all" id="FLV-all">🔀<br>区別なし</button>
          <button class="opt-btn" data-level="beginner" id="FLV-beginner">🌱<br>初級</button>
          <button class="opt-btn" data-level="intermediate" id="FLV-intermediate">📘<br>中級</button>
          <button class="opt-btn" data-level="advanced" id="FLV-advanced">🔥<br>上級</button>
        </div>
        <div class="lbl" style="margin-top:8px">抽出タイプ</div>
        <div style="display:flex;gap:7px;margin-bottom:4px">
          <button class="opt-btn on" data-type="words" id="FTY-words" style="flex:1;padding:7px">📝<br>単語のみ</button>
          <button class="opt-btn" data-type="phrases" id="FTY-phrases" style="flex:1;padding:7px">💬<br>熟語のみ</button>
          <button class="opt-btn" data-type="both" id="FTY-both" style="flex:1;padding:7px">✨<br>単語＋熟語</button>
        </div>
      </div>
      <!-- JSONモードのオプション -->
      <div id="FILE-json-opts" style="display:none">
        <div style="background:var(--sf);border-radius:var(--r);padding:11px 13px;margin-bottom:10px;font-size:11px;color:var(--tx2);line-height:1.7">
          📗 対応形式：<br>
          <b style="color:var(--tx)">パターンC</b>（ネスト型）:<br>
          <code style="color:var(--ac3);font-size:10px">{"book_title":"...", "content":{"vocabulary":[...],"phrases":[...]}}</code><br>
          <b style="color:var(--tx)">シンプル型</b>:<br>
          <code style="color:var(--ac3);font-size:10px">{"words":[...]} / [{"word":"...","meaning":"..."}]</code><br>
          各要素のキー名は自動検出します（word/term/front + meaning/translation/back/definition）
        </div>
        <div class="lbl">取り込みセクション</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <button class="opt-btn on" data-jsec="all" id="JSEC-all" style="flex:1;padding:7px;font-size:11px">📦<br>すべて</button>
          <button class="opt-btn" data-jsec="vocabulary" id="JSEC-vocab" style="flex:1;padding:7px;font-size:11px">📝<br>単語のみ</button>
          <button class="opt-btn" data-jsec="phrases" id="JSEC-phrase" style="flex:1;padding:7px;font-size:11px">💬<br>熟語のみ</button>
        </div>
      </div>
    </div>

    <!-- AI -->
    <div id="TP-ai" style="display:none">
      <div class="lbl">リスト名</div>
      <input class="inp" id="IN-ai-name" type="text" placeholder="例: 小説から抽出">
      <div class="lbl">抽出レベル</div>
      <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
        <button class="opt-btn on" data-level="all" id="LV-all">🔀<br>区別<br>なし</button>
        <button class="opt-btn" data-level="beginner" id="LV-beginner">🌱<br>初級</button>
        <button class="opt-btn" data-level="intermediate" id="LV-intermediate">📘<br>中級</button>
        <button class="opt-btn" data-level="advanced" id="LV-advanced">🔥<br>上級</button>
      </div>
      <div id="LV-hint" style="font-size:10px;color:var(--tx2);margin-bottom:12px;line-height:1.6;padding:7px 10px;background:var(--sf);border-radius:9px"></div>
      <div class="lbl">抽出タイプ</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-type="words" id="TY-words" style="flex:1;padding:8px">📝<br>単語のみ</button>
        <button class="opt-btn" data-type="phrases" id="TY-phrases" style="flex:1;padding:8px">💬<br>熟語のみ</button>
        <button class="opt-btn" data-type="both" id="TY-both" style="flex:1;padding:8px">✨<br>単語＋熟語</button>
      </div>
      <div class="lbl">テキストを貼り付け</div>
      <textarea class="inp ta" id="IN-ai-text" style="height:140px" placeholder="テキストを貼り付けてください。AIが重要単語・熟語を自動抽出・翻訳します。&#10;&#10;例 (独): Das Haus ist sehr schön und die Schule liegt in der Nähe...&#10;例 (英): The enigmatic professor was known for his perspicacious observations..."></textarea>
      <div class="hint">✨ AIが重要単語・熟語を抽出し日本語訳を付与します。APIキーなしでもオフライン抽出が使えます。</div>
      <button class="btn-primary" id="B-ai-extract">✨ AI で単語・熟語を抽出</button>
    </div>

    <!-- PREVIEW -->
    <div id="PRV" style="display:none;margin-top:16px">
      <div class="prev-hdr">
        <div class="prev-title">プレビュー</div>
        <div class="prev-cnt" id="PRV-cnt">0 単語</div>
      </div>
      <div class="prev-list" id="PRV-list"></div>
      <button class="btn-primary" style="margin-top:13px" id="B-save">💾 単語帳に保存</button>
      <button class="btn-sec" id="B-clr-prv">✕ クリア</button>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<!-- LIST -->
<div class="scr" id="s-list">
  <div class="hdr">
    <button class="btn btn-back" id="B-list-back">←</button>
    <div class="hdr-title">単語一覧</div>
    <div style="display:flex;align-items:center;gap:4px">
      <button class="btn" id="B-dup-check" title="重複チェック" style="font-size:18px;padding:4px 6px">⊜</button>
      <button class="btn" id="B-sel-mode" title="選択モード" style="font-size:17px;padding:4px 6px;color:var(--tx2)">☑</button>
      <select class="sel" id="SEL-list"><option value="all">すべて</option></select>
    </div>
  </div>
  <div id="SEL-toolbar" style="display:none;padding:8px 14px;background:var(--sf);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn" id="SEL-all-btn" style="font-size:12px;color:var(--ac);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">全選択</button>
      <span id="SEL-count" style="font-size:12px;color:var(--tx2);flex:1;text-align:center">0件選択中</span>
      <button class="btn" id="SEL-move-btn" style="font-size:12px;color:var(--ac3);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">✦ 移動</button>
      <button class="btn" id="SEL-del-btn" style="font-size:12px;color:var(--rd);font-weight:600;padding:5px 10px;background:rgba(255,76,106,.1);border-radius:8px">🗑 削除</button>
    </div>
  </div>
  <div class="srch-wrap">
    <input class="srch" id="IN-search" type="search" placeholder="単語を検索...">
  </div>
  <div class="filter-bar" id="LANG-filter">
    <button class="flt-btn on" data-lang="all">すべて</button>
    <button class="flt-btn" data-lang="en">🇬🇧 英語</button>
    <button class="flt-btn" data-lang="de">🇩🇪 ドイツ語</button>
    <button class="flt-btn" data-lang="fr">🇫🇷 フランス語</button>
    <button class="flt-btn" data-lang="es">🇪🇸 スペイン語</button>
    <button class="flt-btn" data-lang="it">🇮🇹 イタリア語</button>
  </div>
  <div style="display:flex;gap:6px;padding:7px 16px 0;flex-shrink:0">
    <select id="SEL-status" style="flex:1;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:9px;color:var(--tx);font-family:inherit;font-size:12px;padding:6px 8px;outline:none;-webkit-appearance:none;text-align:center">
      <option value="all">すべて</option>
      <option value="new">🆕 未学習</option>
      <option value="ok">✅ 習得済み</option>
      <option value="ng">❌ 要復習</option>
      <option value="unknown">❓ 不明</option>
    </select>
    <select id="SEL-sort" style="flex:1;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:9px;color:var(--tx);font-family:inherit;font-size:12px;padding:6px 8px;outline:none;-webkit-appearance:none;text-align:center">
      <option value="default">追加順</option>
      <option value="alpha">A-Z順</option>
      <option value="level_asc">レベル↑</option>
      <option value="level_desc">レベル↓</option>
      <option value="miss">間違い順</option>
    </select>
  </div>
  <div class="scroll" style="padding-top:10px">
    <div id="L-words"></div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- FLASHCARD -->
<div class="scr" id="s-flash">
  <div class="fl-hdr">
    <button class="btn btn-back" id="B-flash-exit">✕</button>
    <div class="fl-prog"><div class="fl-fill" id="FL-fill" style="width:0%"></div></div>
    <div class="fl-cnt" id="FL-cnt">1/0</div>
  </div>
  <div class="fl-body">
    <div class="fl-card" id="FL-card">
      <div class="fl-lang" id="FL-lang">英語</div>
      <div class="fl-word" id="FL-word">word</div>
      <div class="fl-meaning" id="FL-meaning"></div>
      <button class="fl-spk" id="FL-spk">🔊 発音</button>
    </div>
  </div>
  <div class="fl-controls">
    <button class="fl-ctrl-btn" id="FL-prev">‹‹</button>
    <button class="fl-play-btn" id="FL-play">▶</button>
    <button class="fl-ctrl-btn" id="FL-next">››</button>
  </div>
  <div style="padding:0 16px calc(var(--sb) + 16px);flex-shrink:0;width:100%"><button class="btn-primary" id="FL-to-quiz" style="margin:0">⚡ このままクイズへ</button></div>
  <div id="FL-auto-quiz-overlay" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.75);z-index:100;flex-direction:column;align-items:center;justify-content:center;gap:16px">
    <div style="font-size:20px;font-weight:700;color:#fff">🎉 予習完了！</div>
    <div style="font-size:15px;color:rgba(255,255,255,.8)" id="FL-aq-msg">3秒後にクイズを開始します</div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button id="FL-aq-now" style="padding:11px 24px;background:linear-gradient(135deg,var(--ac),var(--ac2));border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">今すぐ開始</button>
      <button id="FL-aq-cancel" style="padding:11px 20px;background:var(--sf2);border:1px solid rgba(255,255,255,.15);border-radius:12px;color:var(--tx2);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">キャンセル</button>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="scr" id="s-quiz">
  <div class="qz-hdr">
    <button class="btn btn-back" id="B-quiz-exit">✕</button>
    <div class="qz-prog"><div class="qz-fill" id="QZ-fill" style="width:0%"></div></div>
    <div style="display:flex;align-items:center;gap:7px">
      <div id="QZ-mode-badge" style="display:none;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(252,92,125,.2);color:var(--ac2)">📝 テスト</div>
      <div class="qz-cnt" id="QZ-cnt">0/0</div>
    </div>
  </div>
  <div class="qz-body">
    <div class="qz-card">
      <div class="qz-badge" id="QZ-badge">日本語を選べ</div>
      <div class="qz-word" id="QZ-word">word</div>
      <button id="B-speak" style="margin-top:10px;background:rgba(124,92,252,.15);border:none;border-radius:20px;padding:6px 16px;color:var(--ac);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:none">🔊 発音</button>
    </div>
    <div class="choices" id="QZ-choices"></div>
  </div>
  <div class="fb" id="FB">
    <div><div class="fb-tx" id="FB-tx"></div><div class="fb-dt" id="FB-dt"></div></div>
    <button class="fb-next" id="B-next">次へ →</button>
  </div>
</div>

<!-- RESULT -->
<div class="scr" id="s-result">
  <div class="res-em" id="R-em">🎉</div>
  <div class="res-tl" id="R-tl">よくできました！</div>
  <div class="res-sub" id="R-sub">学習完了</div>
  <div class="res-stats">
    <div class="res-stat"><div class="rs-n" id="R-ok" style="color:var(--gn)">0</div><div class="rs-l">正解</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ng" style="color:var(--rd)">0</div><div class="rs-l">不正解</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ac" style="color:var(--ac)">0%</div><div class="rs-l">正解率</div></div>
  </div>
  <button class="btn-primary" id="B-res-home" style="width:260px">🏠 ホームに戻る</button>
  <button class="btn-sec" id="B-res-weak" style="width:260px">🎯 間違いを復習</button>
</div>

<!-- SETTINGS -->
<div class="scr" id="s-settings">
  <div class="hdr">
    <button class="btn btn-back" id="B-set-back">←</button>
    <div class="hdr-title">設定</div>
  </div>
  <div class="scroll">
    <div class="set-sec">AI 設定</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <span class="set-lbl">🔑 Anthropic APIキー</span>
        <input type="password" class="inp" id="IN-apikey" placeholder="sk-ant-..." style="margin-bottom:0;font-size:13px;padding:10px 12px">
        <button class="btn-primary" id="B-save-key" style="padding:10px;font-size:13px">💾 APIキーを保存</button>
        <div id="KEY-status" style="font-size:11px;text-align:center;padding:2px 0"></div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">APIキーを入力して「保存」を押すとAI翻訳・単語抽出が使えます。キーはデバイス内にのみ保存されます。</span>
      </div>
    </div>
    <div class="set-sec">学習設定</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">📊 1セッション問題数</span>
        <input type="number" id="SEL-size" min="1" max="200" value="20"
          style="width:64px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
        <span style="font-size:13px;color:var(--tx2)">問</span>
      </div>
      <div class="set-row" id="ROW-random">
        <span class="set-lbl">🔀 ランダム出題（未出題から）</span>
        <button class="toggle" id="TG-random"></button>
      </div>
      <div class="set-row" id="ROW-rev">
        <span class="set-lbl">🔄 逆クイズ（日→外国語）混在</span>
        <button class="toggle" id="TG-rev"></button>
      </div>
      <div class="set-row" id="ROW-speak">
        <span class="set-lbl">🔊 クイズ時に自動読み上げ</span>
        <button class="toggle" id="TG-speak"></button>
      </div>
      <div class="set-row" id="ROW-autonext">
        <span class="set-lbl">⏭️ クイズ正解時に自動で次へ</span>
        <button class="toggle" id="TG-autonext"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">🔁 不正解時の再出題回数</span>
        <div style="display:flex;gap:5px">
          <button class="opt-btn" data-rq="0" id="RQ-0" style="padding:5px 10px;font-size:12px">なし</button>
          <button class="opt-btn" data-rq="1" id="RQ-1" style="padding:5px 10px;font-size:12px">1回</button>
          <button class="opt-btn" data-rq="2" id="RQ-2" style="padding:5px 10px;font-size:12px">2回</button>
          <button class="opt-btn" data-rq="3" id="RQ-3" style="padding:5px 10px;font-size:12px">3回</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">⏱️ 自動進行の待機時間</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-autonext-sec" min="0.5" max="10" step="0.5" value="1.5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">秒</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">⚠️ 待機時間は予習カードの自動切り替えにも使われます（単語+訳の読み上げ後に次へ）</span>
      </div>
    </div>
    <div class="set-sec">🧠 エビングハウス忘却曲線</div>
    <div class="set-group">
      <div class="set-row" id="ROW-ebbing">
        <span class="set-lbl">📈 忘却曲線による追加復習</span>
        <button class="toggle" id="TG-ebbing"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">間違えた・わからなかった単語を1日後・3日後・7日後・14日後・30日後に通常クイズへ自動追加します。</span>
      </div>
      <div class="set-row" style="cursor:default" id="ROW-ebbing-max">
        <span class="set-lbl">📊 追加復習の上限単語数</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-ebbing-max" min="1" max="20" value="5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">単語</span>
        </div>
      </div>
    </div>
    <div class="set-sec">予習設定</div>
    <div class="set-group">
      <div class="set-row" id="ROW-flashauto">
        <span class="set-lbl">▶️ 予習カードを自動再生</span>
        <button class="toggle" id="TG-flashauto"></button>
      </div>
      <div class="set-row" id="ROW-autoQuiz">
        <span class="set-lbl">⚡ 予習完了後に自動でクイズへ</span>
        <button class="toggle" id="TG-autoQuiz"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">🔊 読み上げる言語</span>
        <div style="display:flex;gap:6px">
          <button class="opt-btn on" id="SPK-both" style="padding:5px 10px;font-size:12px">両方</button>
          <button class="opt-btn" id="SPK-foreign" style="padding:5px 10px;font-size:12px">外国語のみ</button>
          <button class="opt-btn" id="SPK-ja" style="padding:5px 10px;font-size:12px">日本語のみ</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">⏱️ カード切替間隔</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-flash-sec" min="1" max="15" step="0.5" value="2"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">秒</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">🎵 読み上げ中の音楽音量</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-duck-vol" min="0" max="80" step="5" value="15"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">%</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">読み上げ中の音楽ボリュームを下げます。0%で無音、100%で変化なし。</span>
      </div>
    </div>
    <div class="set-sec">データ</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;padding:10px 16px">
        <button class="btn-primary" id="B-save-file" style="width:100%;padding:12px;font-size:14px;font-weight:700">💾 ファイルに保存（iCloud用）</button>
      </div>
      <div class="set-row" style="cursor:default;padding:0 16px 10px">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">データを埋め込んだHTMLファイルをダウンロードします。iCloudに上書き保存してください。</span>
      </div>
      <div class="set-row" id="B-export"><span class="set-lbl">📤 全データをエクスポート (JSON)<br><span style="font-size:11px;color:var(--tx2);font-weight:400">単語・リスト・学習記録・統計を含む</span></span><span class="set-val">→</span></div>
      <div class="set-row" id="B-export-select"><span class="set-lbl">📋 リストを選んでエクスポート</span><span class="set-val">→</span></div>
      <div class="set-row" id="B-export-csv"><span class="set-lbl">📊 CSVでエクスポート</span><span class="set-val">→</span></div>
      <div class="set-row" id="B-qr"><span class="set-lbl">📱 QRコードで転送</span><span class="set-val">→</span></div>
      <div class="set-row" id="B-import-row"><span class="set-lbl">📥 インポート（追加統合）</span><span class="set-val">→</span></div>
      <div class="set-row" id="B-reset"><span class="set-lbl" style="color:var(--rd)">🗑️ すべて削除</span><span class="set-val">→</span></div>
    </div>
    <div style="text-align:center;padding:16px;color:var(--tx2);font-size:11px">VocabMaster v2.1 — 多言語対応版</div>
    <div style="height:20px"></div>
  </div>
</div>

</div>
<input type="file" id="IN-import" accept=".json" style="display:none">

<script>
var MEM=null, DBKEY='vm3';
function sGet(){
  /* まずHTMLに埋め込まれたデータを確認 */
  try{var ed=document.getElementById('embedded-data');if(ed&&ed.textContent&&ed.textContent!=='null'){var v=JSON.parse(ed.textContent);if(v)return v;}}catch(e){}
  /* 次にlocalStorageを確認 */
  try{var v=localStorage.getItem(DBKEY);return v?JSON.parse(v):null;}catch(e){return MEM;}
}
function sSet(v){
  try{localStorage.setItem(DBKEY,JSON.stringify(v));}catch(e){}
  MEM=v;
}


var EASE0=2.5, EMIN=1.3;

/* 言語定義 */
var LANGS={
  en:{name:'英語',flag:'🇬🇧',cls:'lang-en'},
  de:{name:'ドイツ語',flag:'🇩🇪',cls:'lang-de'},
  fr:{name:'フランス語',flag:'🇫🇷',cls:'lang-fr'},
  es:{name:'スペイン語',flag:'🇪🇸',cls:'lang-es'},
  it:{name:'イタリア語',flag:'🇮🇹',cls:'lang-it'}
};

function mkDB(){return{words:[],lists:[],folders:[],logs:[],cfg:{size:20,random:true,rev:false,speak:true,autonext:false,autonextSec:1.5,flashSec:2,flashAuto:false,spkMode:'both',duckVol:15,key:'',requeueMax:1,ebbing:true,ebbingMax:5},stats:{streak:0,lastDay:''}};}
var G=sGet()||mkDB();
if(!G.folders) G.folders=[];
function save(){sSet(G);}

/* ── ファイル保存（HTMLにデータ埋め込み） ── */
function saveAsFile(){
  var data=JSON.stringify(G);
  var current=document.documentElement.outerHTML;
  var marker='embedded-data" type="application/json">';
  var si=current.indexOf(marker);
  if(si<0){toast('保存エラー');return;}
  si+=marker.length;
  var ei=current.indexOf('</',si);
  var updated=current.slice(0,si)+data+current.slice(ei);
  var blob=new Blob([updated],{type:'text/html;charset=utf-8'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='vocab-master.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('💾 ファイルを保存しました');
}


/* SRS */
function lvl(w){var s=w.s;if(!s)return 0;if(s.i>=60)return 5;if(s.i>=30)return 4;if(s.i>=14)return 3;if(s.i>=7)return 2;if(s.i>=3)return 1;return 0;}
function due(w){if(!w.s||!w.s.d)return true;return new Date(w.s.d)<=new Date();}
function answer(w,ok){
  if(Q.testMode)return; /* テストモードはSRS更新しない */
  if(!w.s)w.s={i:1,e:EASE0,d:null,k:0,l:0};
  var s=w.s;
  if(ok){s.k=(s.k||0)+1;if(s.k<=1)s.i=1;else if(s.k===2)s.i=3;else s.i=Math.round(s.i*s.e);s.e=Math.min(3.0,s.e+0.1);
    if(G.cfg.ebbing) ebbingAdvance(w.id);}
  else{s.l=(s.l||0)+1;s.k=0;s.i=1;s.e=Math.max(EMIN,s.e-0.2);
    if(G.cfg.ebbing) ebbingMarkMiss(w.id, w.word, w.meaning||'', w.lang||'en');}
  s.i=Math.max(1,Math.min(s.i,365));
  var dt=new Date();dt.setDate(dt.getDate()+s.i);s.d=dt.toISOString();w.lr=new Date().toISOString();save();
}
function getDue(){return G.words.filter(due);}
/* ── エビングハウス忘却曲線 ── */
/* 間違い/わからなかった単語に復習スケジュールを設定する */
/* 復習インターバル (日数): 1, 3, 7, 14, 30 */
var EBBING_INTERVALS = [1, 3, 7, 14, 30];

function ebbingSchedule(wordId) {
  /* その単語のエビングハウス復習記録を返す */
  if (!G.ebbing) G.ebbing = {};
  return G.ebbing[wordId] || null;
}

function ebbingMarkMiss(wordId, word, meaning, lang) {
  /* 間違えた単語に復習スケジュールを追加 */
  if (!G.cfg.ebbing) return;
  if (!G.ebbing) G.ebbing = {};
  var now = new Date();
  var existing = G.ebbing[wordId];
  var nextIdx = 0;
  if (existing) {
    /* 既にスケジュール済みの場合: 現在のインデックスを維持 or リセット */
    nextIdx = existing.nextIdx || 0;
  }
  /* 次の復習日をインターバルから計算 */
  var nextDate = new Date(now);
  nextDate.setDate(nextDate.getDate() + EBBING_INTERVALS[nextIdx]);
  G.ebbing[wordId] = {
    wordId: wordId,
    word: word,
    meaning: meaning,
    lang: lang,
    nextIdx: nextIdx,
    nextDate: nextDate.toISOString(),
    createdAt: existing ? existing.createdAt : now.toISOString()
  };
  save();
}

function ebbingAdvance(wordId) {
  /* 正解後: 次のインターバルへ進む。全完了で削除 */
  if (!G.ebbing || !G.ebbing[wordId]) return;
  var rec = G.ebbing[wordId];
  var nextIdx = (rec.nextIdx || 0) + 1;
  if (nextIdx >= EBBING_INTERVALS.length) {
    /* 全インターバル完了 → 削除 */
    delete G.ebbing[wordId];
  } else {
    var nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + EBBING_INTERVALS[nextIdx]);
    rec.nextIdx = nextIdx;
    rec.nextDate = nextDate.toISOString();
  }
  save();
}

function getEbbingDue() {
  /* 今日以前の復習予定単語を返す */
  if (!G.cfg.ebbing || !G.ebbing) return [];
  var now = new Date();
  var max = G.cfg.ebbingMax || 5;
  var due = [];
  Object.values(G.ebbing).forEach(function(rec) {
    if (new Date(rec.nextDate) <= now) {
      var w = G.words.find(function(x) { return x.id === rec.wordId; });
      if (w) due.push(w);
    }
  });
  return due.slice(0, max);
}

function getEbbingForecast() {
  /* 今後30日の日別復習予定 {date, words:[]} の配列を返す */
  if (!G.ebbing) return [];
  var map = {};
  var now = new Date();
  now.setHours(0,0,0,0);
  Object.values(G.ebbing).forEach(function(rec) {
    var d = new Date(rec.nextDate);
    d.setHours(0,0,0,0);
    var diff = Math.round((d - now) / 86400000);
    if (diff < 0) diff = 0; /* 期限切れは今日に表示 */
    if (diff > 30) return;
    var key = diff;
    if (!map[key]) map[key] = {diff: diff, words: []};
    map[key].words.push({word: rec.word, meaning: rec.meaning, interval: EBBING_INTERVALS[rec.nextIdx]});
  });
  /* 0〜30日を埋める */
  var result = [];
  for (var i = 0; i <= 30; i++) {
    result.push(map[i] || {diff: i, words: []});
  }
  return result;
}

function getWeak(){return G.words.filter(function(w){return w.s&&(w.s.l||0)>0;}).sort(function(a,b){return(b.s.l||0)-(a.s.l||0);});}

/* NAV */
var SCREENS=['s-home','s-add','s-list','s-flash','s-quiz','s-result','s-settings'];
var TABMAP={'s-home':'T-home','s-add':'T-add','s-list':'T-list','s-settings':'T-settings'};
function go(id){
  /* 選択モードをリセット */
  if(selModeOn&&id!=='s-list'){selModeOn=false;selSet={};var tb=document.getElementById('SEL-toolbar');if(tb)tb.style.display='none';var sb=document.getElementById('B-sel-mode');if(sb)sb.style.color='var(--tx2)';}
  SCREENS.forEach(function(s){el(s).classList.remove('on');});
  el(id).classList.add('on');
  ['T-home','T-add','T-list','T-settings'].forEach(function(t){el(t).classList.remove('on');});
  if(TABMAP[id])el(TABMAP[id]).classList.add('on');
  if(id==='s-home')homeRefresh();
  if(id==='s-list'){if(selModeOn)toggleSelMode();listFilterRebuild();listRender();}
  if(id==='s-settings')settingsLoad();
}

/* HELPERS */
function el(id){return document.getElementById(id);}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
var _tt=null;
function toast(msg){var t=el('toast');t.textContent=msg;t.classList.add('on');if(_tt)clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('on');},2800);}
function loading(msg){el('ld-tx').textContent=msg||'処理中...';el('ld').classList.add('on');}
function loaded(){el('ld').classList.remove('on');}
function shuffle(a){var b=a.slice();for(var i=b.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=b[i];b[i]=b[j];b[j]=t;}return b;}
function uid(){return '_'+(Date.now()%1e9)+'_'+(Math.random()*1e6|0);}
function copyPrompt(preId, btnId){
  var pre=el(preId);if(!pre)return;
  var txt=pre.textContent||pre.innerText;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(function(){
      var btn=el(btnId);if(btn){var orig=btn.textContent;btn.textContent='✅ コピーしました';setTimeout(function(){btn.textContent=orig;},2000);}
    }).catch(function(){fallbackCopy(txt,btnId);});
  } else { fallbackCopy(txt,btnId); }
}
function fallbackCopy(txt,btnId){
  var ta=document.createElement('textarea');
  ta.value=txt;ta.style.position='fixed';ta.style.opacity='0';
  document.body.appendChild(ta);ta.focus();ta.select();
  try{document.execCommand('copy');var btn=el(btnId);if(btn){var orig=btn.textContent;btn.textContent='✅ コピーしました';setTimeout(function(){btn.textContent=orig;},2000);}}catch(e){toast('コピーに失敗しました');}
  document.body.removeChild(ta);
}
function langBadge(lang){var l=LANGS[lang||'en'];if(!l)return'';return'<span class="lang-badge '+l.cls+'">'+l.flag+' '+l.name+'</span>';}

/* HOME */
function homeRefresh(){
  el('H-total').textContent=G.words.length;
  el('H-mastered').textContent=G.words.filter(function(w){return w.s&&w.s.i>=14;}).length;
  el('H-streak').textContent=G.stats.streak||0;
  var dueCount=getDue().length;
  var ebDueCount=G.cfg.ebbing?getEbbingDue().filter(function(w){return !getDue().some(function(d){return d.id===w.id;});}).length:0;
  el('H-due').textContent=dueCount+ebDueCount;
  /* 忘却曲線バッジ */
  var ebBadge=el('H-eb-badge');
  if(ebBadge){ebBadge.style.display=ebDueCount>0?'inline':'none';ebBadge.textContent='🧠+'+ebDueCount;}
  homeListsRender();
}
function homeListsRender(){
  var c=el('H-lists');
  if(!G.lists.length&&!(G.folders&&G.folders.length)){c.innerHTML='<div class="empty"><div class="empty-ic">📖</div><div class="empty-tl">単語リストなし</div><div class="empty-sub">「単語を追加」から<br>新しい単語を登録しよう</div></div>';return;}

  /* フォルダが未初期化の場合に備える */
  if(!G.folders) G.folders=[];

  /* 各フォルダのリストカードHTMLを生成する共通関数 */
  function renderListCard(lst){
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var d=ws.filter(due).length;
    var l=LANGS[lst.lang||'en'];
    var cursor=lst.cursor||0;
    var total=ws.length;
    var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
    var progClr=pct>=100?'var(--gn)':pct>=60?'var(--ac3)':pct>=30?'var(--ac)':'var(--ac2)';
    var nextN=Math.min(parseInt(G.cfg.size)||20, total-cursor);
    var progLabel=pct>=100?'✅ 全単語完了！':'次回: '+cursor+'〜'+(cursor+nextN)+'番目 ('+pct+'%)';
    return '<div class="swipe-wrap" data-lid="'+esc(lst.id)+'">'+
      '<div class="swipe-del-bg"><span>🗑️</span>削除</div>'+
      '<div class="swipe-inner">'+
        '<button class="list-card" data-lid="'+esc(lst.id)+'" style="padding-bottom:8px">'+
          '<div class="list-ic" style="background:'+lst.clr+'20">'+(l?l.flag:'📗')+'</div>'+
          '<div class="list-inf">'+
            '<div class="list-name">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
            '<div class="list-meta">'+ws.length+'単語'+(d?' · 復習'+d+'件':'')+'</div>'+
            '<div style="margin-top:7px">'+
              '<div class="lc-prog-bar"><div class="lc-prog-fill" style="width:'+pct+'%;background:'+progClr+'"></div></div>'+
              '<div class="lc-prog-txt"><span>'+progLabel+'</span><span style="font-weight:600;color:'+progClr+'">'+pct+'%</span></div>'+
            '</div>'+
          '</div>'+
          (d?'<div class="list-badge" style="align-self:flex-start">'+d+'</div>':'')+'</button>'+
      '</div>'+
    '</div>';
  }

  /* フォルダブロックを再帰描画する関数 (depth: ネストの深さ) */
  function renderFolder(folder, depth){
    depth=depth||0;
    var folderLists=G.lists.filter(function(l){return l.fid===folder.id;});
    var subFolders=G.folders.filter(function(f){return f.parentId===folder.id;});
    var totalWords=folderLists.reduce(function(s,l){return s+G.words.filter(function(w){return w.lid===l.id;}).length;},0);
    var dueWords=folderLists.reduce(function(s,l){return s+G.words.filter(function(w){return w.lid===l.id&&due(w);}).length;},0);
    /* サブフォルダ内の集計も加える */
    function countInSubfolders(fid){
      var sf=G.folders.filter(function(f){return f.parentId===fid;});
      var sl=G.lists.filter(function(l){return l.fid===fid;});
      var tw=sl.reduce(function(s,l){return s+G.words.filter(function(w){return w.lid===l.id;}).length;},0);
      var dw=sl.reduce(function(s,l){return s+G.words.filter(function(w){return w.lid===l.id&&due(w);}).length;},0);
      sf.forEach(function(f){var r=countInSubfolders(f.id);tw+=r.tw;dw+=r.dw;});
      return{tw:tw,dw:dw};
    }
    var sub=countInSubfolders(folder.id);
    totalWords+=sub.tw; dueWords+=sub.dw;
    var isOpen=!folder.collapsed;
    var indent=depth>0?'class="subfolder-indent"':'';
    var fic=depth>0?'📂':'📁';
    var innerContent='';
    /* サブフォルダを先に描画 */
    subFolders.forEach(function(sf){ innerContent+=renderFolder(sf,depth+1); });
    /* リスト */
    folderLists.forEach(function(lst){ innerContent+=renderListCard(lst); });
    if(!subFolders.length&&!folderLists.length){
      innerContent='<div style="padding:10px 8px 6px;font-size:12px;color:var(--tx2)">リストなし</div>';
    }
    return '<div class="folder-block" data-fid="'+esc(folder.id)+'" data-depth="'+depth+'">'+
      '<div class="folder-hdr" data-fid="'+esc(folder.id)+'">'+
        '<span class="folder-arrow'+(isOpen?' open':'')+'">▶</span>'+
        '<span class="folder-ic">'+fic+'</span>'+
        '<span class="folder-name">'+esc(folder.name)+'</span>'+
        '<span class="folder-count">'+(subFolders.length?subFolders.length+'フォルダ・':'')+folderLists.length+'リスト'+(dueWords?' · 復習'+dueWords+'件':'')+'</span>'+
        '<button class="folder-edit-btn" data-fid="'+esc(folder.id)+'" title="フォルダを編集">···</button>'+
      '</div>'+
      '<div class="folder-body'+(isOpen?'':' collapsed')+'" data-fid="'+esc(folder.id)+'" style="max-height:'+(isOpen?'9999px':'0')+'">'+
        innerContent+
      '</div></div>';
  }

  var h='';

  /* ルートフォルダ（parentIdがない or undefinedのもの）を描画 */
  var rootFolders=G.folders.filter(function(f){return !f.parentId;});
  rootFolders.forEach(function(folder){ h+=renderFolder(folder,0); });

  /* フォルダなしのリスト */
  var noFolderLists=G.lists.filter(function(l){return !l.fid || !G.folders.some(function(f){return f.id===l.fid;});});
  if(noFolderLists.length>0){
    if(rootFolders.length>0){
      h+='<div class="no-folder-hdr">未分類</div>';
    }
    noFolderLists.forEach(function(lst){ h+=renderListCard(lst); });
  }

  c.innerHTML=h;

  /* フォルダヘッダークリックで折り畳み */
  c.querySelectorAll('.folder-hdr').forEach(function(hdr){
    hdr.addEventListener('click',function(e){
      /* 編集ボタンはスキップ */
      if(e.target.classList.contains('folder-edit-btn')) return;
      var fid=this.getAttribute('data-fid');
      var folder=G.folders.find(function(f){return f.id===fid;});
      if(!folder) return;
      folder.collapsed=!folder.collapsed;
      save();
      /* アニメーションで折り畳み */
      var arrow=this.querySelector('.folder-arrow');
      var body=c.querySelector('.folder-body[data-fid="'+fid+'"]');
      if(folder.collapsed){
        body.style.maxHeight=body.scrollHeight+'px';
        requestAnimationFrame(function(){
          body.style.transition='max-height .25s ease';
          body.style.maxHeight='0';
          body.classList.add('collapsed');
          if(arrow) arrow.classList.remove('open');
        });
      } else {
        body.classList.remove('collapsed');
        body.style.maxHeight='0';
        requestAnimationFrame(function(){
          body.style.transition='max-height .25s ease';
          body.style.maxHeight=body.scrollHeight+'px';
          setTimeout(function(){body.style.maxHeight='9999px';},260);
          if(arrow) arrow.classList.add('open');
        });
      }
    });
  });

  /* フォルダ編集ボタン */
  c.querySelectorAll('.folder-edit-btn').forEach(function(btn){
    btn.addEventListener('click',function(e){
      e.stopPropagation();
      editFolder(this.getAttribute('data-fid'));
    });
  });

  /* タップでlistMenu */
  c.querySelectorAll('.list-card').forEach(function(b){
    b.addEventListener('click',function(){
      var inner=this.closest('.swipe-inner');
      if(inner&&inner.classList.contains('swiped')){
        inner.classList.remove('swiped');return;
      }
      listMenu(this.getAttribute('data-lid'));
    });
  });

  /* スワイプ削除 */
  c.querySelectorAll('.swipe-wrap').forEach(function(wrap){
    var inner=wrap.querySelector('.swipe-inner');
    var startX,startY,dx,isDragging=false,isSwipe=false;
    inner.addEventListener('touchstart',function(e){
      startX=e.touches[0].clientX;startY=e.touches[0].clientY;
      dx=0;isDragging=true;isSwipe=false;inner.style.transition='none';
    },{passive:true});
    inner.addEventListener('touchmove',function(e){
      if(!isDragging)return;
      dx=e.touches[0].clientX-startX;
      var dy=e.touches[0].clientY-startY;
      if(!isSwipe&&Math.abs(dy)>Math.abs(dx)){isDragging=false;return;}
      if(Math.abs(dx)>8)isSwipe=true;
      if(!isSwipe)return;
      var already=inner.classList.contains('swiped')?-90:0;
      var tx=Math.min(0,Math.max(-90,already+dx));
      inner.style.transform='translateX('+tx+'px)';
    },{passive:true});
    inner.addEventListener('touchend',function(){
      if(!isDragging){inner.style.transition='';return;}
      isDragging=false;inner.style.transition='transform .2s ease';
      var already=inner.classList.contains('swiped')?-90:0;
      var total=already+dx;
      if(total<-40){
        inner.style.transform='translateX(-90px)';inner.classList.add('swiped');
      } else {
        inner.style.transform='';inner.classList.remove('swiped');
      }
    });
  });

  /* 削除ボタン */
  c.querySelectorAll('.swipe-del-bg').forEach(function(btn){
    btn.addEventListener('click',function(){
      deleteList(this.closest('.swipe-wrap').getAttribute('data-lid'));
    });
  });

  /* ---- タッチ ドラッグ & ドロップ ---- */
  initListDragDrop(c);
}

/* =========================================================
   タッチ ドラッグ & ドロップ（リスト → フォルダ移動 + フォルダ → フォルダ移動）
   ========================================================= */
function initListDragDrop(container){
  var LONG_PRESS_MS=480;
  var ghost=null, srcWrap=null, srcCard=null, srcLid=null;
  var srcFolderBlock=null, srcFid=null; /* フォルダドラッグ用 */
  var pressTimer=null, dragging=false, dragType=null; /* dragType: 'list' | 'folder' */
  var scrollEl=document.getElementById('s-home').querySelector('.scroll');

  /* ゴースト生成（リスト用） */
  function createGhost(wrap, touchX, touchY){
    var g=wrap.cloneNode(true);
    g.className='drag-ghost';
    var r=wrap.getBoundingClientRect();
    g.style.width=r.width+'px';
    g.style.left=(touchX-r.width/2)+'px';
    g.style.top=(touchY-r.height/2)+'px';
    document.body.appendChild(g);
    return g;
  }

  /* ゴースト生成（フォルダ用） */
  function createFolderGhost(folder, touchX, touchY){
    var g=document.createElement('div');
    g.className='folder-drag-ghost';
    g.innerHTML='<span style="font-size:18px">📂</span><span style="font-size:13px;font-weight:600">'+esc(folder.name)+'</span>';
    g.style.left=(touchX-80)+'px';
    g.style.top=(touchY-22)+'px';
    document.body.appendChild(g);
    return g;
  }

  /* ゴースト移動 */
  function moveGhost(touchX, touchY){
    if(!ghost)return;
    var r=ghost.getBoundingClientRect();
    ghost.style.left=(touchX-r.width/2)+'px';
    ghost.style.top=(touchY-r.height/2)+'px';
  }

  /* ドロップ対象のハイライト解除 */
  function clearHighlights(){
    container.querySelectorAll('.folder-drop-target').forEach(function(el){el.classList.remove('folder-drop-target');});
    container.querySelectorAll('.nofolder-drop-target').forEach(function(el){el.classList.remove('nofolder-drop-target');});
  }

  /* タッチ座標でフォルダヘッダーまたは未分類エリアを特定 */
  function findDropTarget(x, y, excludeFid){
    var els=document.elementsFromPoint(x,y);
    for(var i=0;i<els.length;i++){
      var e=els[i];
      /* フォルダヘッダー or フォルダボディ */
      if(e.classList.contains('folder-hdr')||e.classList.contains('folder-block')||e.classList.contains('folder-body')||e.classList.contains('folder-arrow')||e.classList.contains('folder-ic')||e.classList.contains('folder-name')||e.classList.contains('folder-count')){
        var fid=e.getAttribute('data-fid')||(e.closest('[data-fid]')&&e.closest('[data-fid]').getAttribute('data-fid'));
        if(fid&&fid!==excludeFid){
          /* 循環参照チェック: excludeFidの子孫にはドロップ不可 */
          if(excludeFid&&isDescendant(fid, excludeFid)) continue;
          var folder=G.folders.find(function(f){return f.id===fid;});
          if(folder) return {type:'folder',fid:fid,folder:folder,el:e.closest('.folder-block')||e};
        }
      }
      /* 未分類エリア */
      if(e.classList.contains('no-folder-hdr')){
        return {type:'nofolder',el:e};
      }
    }
    return null;
  }

  /* fid2がfid1の子孫かチェック */
  function isDescendant(fid2, fid1){
    var f=G.folders.find(function(x){return x.id===fid2;});
    if(!f) return false;
    if(f.parentId===fid1) return true;
    if(!f.parentId) return false;
    return isDescendant(f.parentId, fid1);
  }

  /* 長押し検出 — 各 swipe-wrap に付与（リストのD&D） */
  container.querySelectorAll('.swipe-wrap').forEach(function(wrap){
    var card=wrap.querySelector('.list-card');
    if(!card)return;
    var startX,startY,moved=false;

    function cancelPress(){
      clearTimeout(pressTimer);pressTimer=null;
    }

    wrap.addEventListener('touchstart',function(e){
      if(dragging)return;
      /* スワイプ済みなら長押し無効 */
      var inner=wrap.querySelector('.swipe-inner');
      if(inner&&inner.classList.contains('swiped'))return;
      startX=e.touches[0].clientX;startY=e.touches[0].clientY;moved=false;
      pressTimer=setTimeout(function(){
        if(moved)return;
        /* ドラッグ開始 */
        dragging=true; dragType='list';
        srcWrap=wrap;srcCard=card;
        srcLid=wrap.getAttribute('data-lid');
        card.classList.add('dragging-src');
        ghost=createGhost(wrap,startX,startY);
        if(navigator.vibrate)navigator.vibrate(40);
      },LONG_PRESS_MS);
    },{passive:true});

    wrap.addEventListener('touchmove',function(e){
      if(!dragging&&pressTimer){
        var dx=Math.abs(e.touches[0].clientX-startX);
        var dy=Math.abs(e.touches[0].clientY-startY);
        if(dx>8||dy>8){moved=true;cancelPress();}
        return;
      }
      if(!dragging||dragType!=='list')return;
      e.preventDefault();
      var tx=e.touches[0].clientX,ty=e.touches[0].clientY;
      moveGhost(tx,ty);
      clearHighlights();
      var target=findDropTarget(tx,ty,null);
      if(target){
        if(target.type==='folder'){
          var fb=container.querySelector('.folder-block[data-fid="'+target.fid+'"]');
          if(fb)fb.querySelector('.folder-hdr').classList.add('folder-drop-target');
        } else if(target.type==='nofolder'){
          target.el.classList.add('nofolder-drop-target');
        }
      }
      /* 自動スクロール */
      var margin=80,scrollSpeed=8;
      if(scrollEl){var sr=scrollEl.getBoundingClientRect();if(ty<sr.top+margin)scrollEl.scrollTop-=scrollSpeed;else if(ty>sr.bottom-margin)scrollEl.scrollTop+=scrollSpeed;}
    },{passive:false});

    function onTouchEnd(e){
      clearTimeout(pressTimer);pressTimer=null;
      if(!dragging||dragType!=='list')return;
      dragging=false; dragType=null;
      if(ghost){ghost.parentNode&&ghost.parentNode.removeChild(ghost);ghost=null;}
      clearHighlights();
      if(srcCard)srcCard.classList.remove('dragging-src');

      var tx=e.changedTouches[0].clientX,ty=e.changedTouches[0].clientY;
      var target=findDropTarget(tx,ty,null);
      var lst=G.lists.find(function(l){return l.id===srcLid;});
      if(lst&&target){
        var oldFid=lst.fid||null;
        var newFid=target.type==='folder'?target.fid:null;
        if(oldFid!==newFid){
          lst.fid=newFid;
          save();homeRefresh();
          var folderName=target.type==='folder'?'📁 '+target.folder.name:'未分類';
          toast('✅ 「'+lst.name+'」を '+folderName+' に移動しました');
          return;
        }
      }
      srcWrap=null;srcCard=null;srcLid=null;
    }
    wrap.addEventListener('touchend',onTouchEnd,{passive:true});
    wrap.addEventListener('touchcancel',onTouchEnd,{passive:true});
  });

  /* 長押し検出 — 各 folder-block に付与（フォルダのD&D） */
  container.querySelectorAll('.folder-block').forEach(function(block){
    var hdr=block.querySelector('.folder-block > .folder-hdr, .folder-hdr');
    if(!hdr)return;
    var fid=block.getAttribute('data-fid');
    var folder=G.folders.find(function(f){return f.id===fid;});
    if(!folder)return;
    var startX,startY,moved=false;

    function cancelFolderPress(){
      clearTimeout(pressTimer);pressTimer=null;
    }

    hdr.addEventListener('touchstart',function(e){
      if(dragging)return;
      if(e.target.classList.contains('folder-edit-btn'))return;
      startX=e.touches[0].clientX;startY=e.touches[0].clientY;moved=false;
      pressTimer=setTimeout(function(){
        if(moved)return;
        dragging=true; dragType='folder';
        srcFolderBlock=block; srcFid=fid;
        block.classList.add('folder-dragging-src');
        ghost=createFolderGhost(folder,startX,startY);
        if(navigator.vibrate)navigator.vibrate(60);
      },LONG_PRESS_MS);
    },{passive:true});

    hdr.addEventListener('touchmove',function(e){
      if(!dragging&&pressTimer){
        var dx=Math.abs(e.touches[0].clientX-startX);
        var dy=Math.abs(e.touches[0].clientY-startY);
        if(dx>8||dy>8){moved=true;cancelFolderPress();}
        return;
      }
      if(!dragging||dragType!=='folder')return;
      e.preventDefault();
      var tx=e.touches[0].clientX,ty=e.touches[0].clientY;
      /* フォルダゴーストを指に追従 */
      if(ghost){ghost.style.left=(tx-80)+'px';ghost.style.top=(ty-22)+'px';}
      clearHighlights();
      var target=findDropTarget(tx,ty,srcFid);
      if(target&&target.type==='folder'){
        var fb=container.querySelector('.folder-block[data-fid="'+target.fid+'"]');
        if(fb)fb.querySelector(':scope > .folder-hdr').classList.add('folder-drop-target');
      } else if(target&&target.type==='nofolder'){
        target.el.classList.add('nofolder-drop-target');
      }
      /* 自動スクロール */
      var margin=80,scrollSpeed=8;
      if(scrollEl){var sr=scrollEl.getBoundingClientRect();if(ty<sr.top+margin)scrollEl.scrollTop-=scrollSpeed;else if(ty>sr.bottom-margin)scrollEl.scrollTop+=scrollSpeed;}
    },{passive:false});

    function onFolderTouchEnd(e){
      clearTimeout(pressTimer);pressTimer=null;
      if(!dragging||dragType!=='folder')return;
      dragging=false; dragType=null;
      if(ghost){ghost.parentNode&&ghost.parentNode.removeChild(ghost);ghost=null;}
      clearHighlights();
      if(srcFolderBlock)srcFolderBlock.classList.remove('folder-dragging-src');

      var tx=e.changedTouches[0].clientX,ty=e.changedTouches[0].clientY;
      var target=findDropTarget(tx,ty,srcFid);
      var srcFolder=G.folders.find(function(f){return f.id===srcFid;});
      if(srcFolder&&target){
        var oldParent=srcFolder.parentId||null;
        var newParent=target.type==='folder'?target.fid:null;
        if(oldParent!==newParent){
          srcFolder.parentId=newParent;
          save();homeRefresh();
          var targetName=target.type==='folder'?'📁 '+target.folder.name:'ルート';
          toast('✅ フォルダ「'+srcFolder.name+'」を '+targetName+' に移動しました');
          return;
        }
      }
      srcFolderBlock=null; srcFid=null;
    }
    hdr.addEventListener('touchend',onFolderTouchEnd,{passive:true});
    hdr.addEventListener('touchcancel',onFolderTouchEnd,{passive:true});
  });
}

function deleteList(lid){
  var lst=G.lists.find(function(l){return l.id===lid;});
  if(!lst)return;
  var cnt=G.words.filter(function(w){return w.lid===lid;}).length;
  if(!confirm('「'+lst.name+'」（'+cnt+'単語）を削除しますか？\nこの操作は取り消せません。'))return;
  G.lists=G.lists.filter(function(l){return l.id!==lid;});
  G.words=G.words.filter(function(w){return w.lid!==lid;});
  save();homeRefresh();toast('🗑️ 削除しました');
}

/* ADD */
var addMode='paste', prevWords=[], selLang='en', selLevel='all', selType='words';

function segSwitch(mode){
  addMode=mode;
  ['paste','file','ai'].forEach(function(m){el('TP-'+m).style.display=m===mode?'block':'none';el('SG-'+m).classList.toggle('on',m===mode);});
  prvHide();
}

function setLang(lang){
  selLang=lang;
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-lang')===lang);});
  updateLevelHint();
  /* プレースホルダー更新 */
  var ph={en:'例:\nabandon\nabsolute,絶対的な',de:'例:\nHaus\nSchule,学校\narbeiten\nschön,美しい',fr:'例:\nmaison\nécole,学校\ntravail,仕事',es:'例:\ncasa\nescuela,学校\ntrabajo,仕事',it:'例:\ncasa\nscuola,学校\nlavoro,仕事'};
  var ta=el('IN-paste-text');if(ta)ta.placeholder=ph[lang]||ph.en;
}

/* JSON貼り付けモード用セクション */
var pasteJsonSection='all';
function setPasteJsonSection(sec){
  pasteJsonSection=sec;
  document.querySelectorAll('[data-pjsec]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-pjsec')===sec);});
}

/* テキストエリア入力でJSON検出してオプション表示 */
function pasteDetectJson(){
  var txt=(el('IN-paste-text').value||'').trim();
  var isJson=txt.charAt(0)==='{' || txt.charAt(0)==='[';
  var optsEl=el('PASTE-json-opts');
  var hintEl=el('PASTE-hint');
  if(optsEl) optsEl.style.display=isJson?'block':'none';
  if(hintEl){
    if(isJson){
      hintEl.textContent='📗 JSON を認識しました。リスト名は JSON 内の book_title / title から自動設定されます。';
    } else {
      hintEl.textContent='テキスト形式（1行1単語 / 「単語,訳」）または JSON テキストをそのまま貼り付けられます。訳なしの単語はAPIキー設定でAI自動翻訳できます。';
    }
  }
}

function parsePaste(){
  var txt=el('IN-paste-text').value.trim();
  if(!txt){toast('テキストを入力してください');return;}

  /* JSON自動認識 */
  var trimmed=txt.replace(/^\s+/,'');
  if(trimmed.charAt(0)==='{' || trimmed.charAt(0)==='['){
    try{
      var jd=JSON.parse(txt);

      /* 言語自動検出 */
      var LANG_KEY_MAP={german:'de',deutsch:'de',french:'fr',français:'fr',spanish:'es',italiano:'it',english:'en'};
      if(typeof jd==='object'&&!Array.isArray(jd)){
        Object.keys(jd).forEach(function(k){
          var lk=k.toLowerCase();
          Object.keys(LANG_KEY_MAP).forEach(function(lmk){
            if(lk===lmk){selLang=LANG_KEY_MAP[lmk];document.querySelectorAll('.lang-sel-btn').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-lang')===selLang);});}
          });
        });
      }

      /* リスト名の自動設定 */
      var ni=el('IN-paste-name');
      if(ni&&!ni.value){
        var autoName=jd.book_title||jd.title||jd.name||'';
        if(autoName) ni.value=autoName;
      }

      /* 単語配列を取り出す汎用関数 */
      function extractJW(arr){
        if(!Array.isArray(arr))return[];
        return arr.map(function(item){
          var w=item.word||item.term||item.front||item.expression||item.vocab||item.german||item.deutsch||item.french||item.spanish||item.english||'';
          var m=item.meaning||item.translation||item.back||item.definition||item.japanese||item.ja||'';
          return w?{word:String(w).trim(),meaning:String(m).trim()}:null;
        }).filter(Boolean);
      }

      var jwords=[];

      /* パターンC: {"content":{"vocabulary":[...],"phrases":[...]}} */
      if(jd.content&&typeof jd.content==='object'){
        var vocab=extractJW(jd.content.vocabulary||jd.content.words||[]);
        var phrases=extractJW(jd.content.phrases||jd.content.expressions||[]);
        if(pasteJsonSection==='vocabulary'){jwords=vocab;}
        else if(pasteJsonSection==='phrases'){jwords=phrases;}
        else{jwords=vocab.concat(phrases);}
        /* セクション別にリスト名サフィックスを付ける */
        if(ni&&ni.value&&(vocab.length>0||phrases.length>0)){
          if(pasteJsonSection==='vocabulary') ni.value=ni.value.replace(/ \[単語\]$/,'')+' [単語]';
          else if(pasteJsonSection==='phrases') ni.value=ni.value.replace(/ \[熟語\]$/,'')+' [熟語]';
        }
      }
      /* シンプル型 */
      else if(Array.isArray(jd.words)){jwords=extractJW(jd.words);}
      else if(Array.isArray(jd.vocabulary)){jwords=extractJW(jd.vocabulary);}
      else if(Array.isArray(jd.phrases)){jwords=extractJW(jd.phrases);}
      else if(Array.isArray(jd)){jwords=extractJW(jd);}
      /* フォールバック: オブジェクト内の配列を探す */
      if(!jwords.length&&typeof jd==='object'){
        Object.values(jd).forEach(function(v){if(Array.isArray(v)&&!jwords.length){var w=extractJW(v);if(w.length)jwords=w;}});
      }

      if(jwords.length){
        toast('📗 JSON形式を認識（'+jwords.length+'語）');
        needTranslate(jwords)?doTranslate(jwords,selLang):prvShow(jwords);
        return;
      } else {
        toast('⚠️ JSONを認識しましたが単語が見つかりません');return;
      }
    }catch(e){
      toast('⚠️ JSONの解析に失敗しました。形式を確認してください。');return;
    }
  }

  /* 通常テキスト（1行1単語 or 単語,訳） */
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim();var m=(p[1]||'').trim();
    if(w)words.push({word:w,meaning:m});
  });
  if(!words.length){toast('単語が見つかりません');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function needTranslate(words){return G.cfg.key&&words.some(function(w){return !w.meaning;});}

/* ---- FILE MODE ---- */
var fileMode='vocab'; /* vocab | extract */
var fileSelLevel='all', fileSelType='words';

function setFileMode(mode){
  fileMode=mode;
  document.querySelectorAll('[data-fmode]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-fmode')===mode);});
  var isExtract=(mode==='extract');
  var isJson=(mode==='json');
  el('FILE-ai-opts').style.display=isExtract?'block':'none';
  el('FILE-json-opts').style.display=isJson?'block':'none';
  if(isJson){
    el('UP-ic').textContent='📗';
    el('UP-sub').textContent='JSON ファイル (.json)';
    el('UP-hint').textContent='book_title / content / vocabulary / phrases などを自動認識します';
    el('IN-file').accept='.json';
  } else if(isExtract){
    el('UP-ic').textContent='📄';
    el('UP-sub').textContent='Word (.docx) / PDF / TXT / CSV';
    el('UP-hint').textContent='✨ AIがファイルの内容から単語・熟語を自動抽出し日本語訳を付与します';
    el('IN-file').accept='.txt,.csv,.docx,.pdf';
  } else {
    el('UP-ic').textContent='📁';
    el('UP-sub').textContent='CSV / Excel (.xlsx)';
    el('UP-hint').textContent='CSV: 1列目=単語、2列目=日本語訳（任意）';
    el('IN-file').accept='.csv,.xlsx,.xls,.txt';
  }
}

function setFileLevel(level){
  fileSelLevel=level;
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
}

function setFileType(type){
  fileSelType=type;
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function handleFile(evt){
  var f=evt.target.files[0];if(!f)return;evt.target.value='';
  var ext=f.name.split('.').pop().toLowerCase();
  var ni=el('IN-file-name');
  if(ni&&!ni.value)ni.value=f.name.replace(/\.[^.]+$/,'');

  if(fileMode==='json'||ext==='json'){
    var fr=new FileReader();
    fr.onload=function(e){jsonImport(e.target.result, f.name);};
    fr.readAsText(f,'UTF-8');
    return;
  }

  if(fileMode==='extract'){
    /* AI抽出モード: テキストを取り出してAIへ */
    if(ext==='txt'||ext==='csv'){
      var fr=new FileReader();
      fr.onload=function(e){fileAiExtract(e.target.result, f.name);};
      fr.readAsText(f,'UTF-8');
    } else if(ext==='docx'){
      extractDocx(f);
    } else if(ext==='pdf'){
      extractPdf(f);
    } else {
      toast('AI抽出対応: TXT / CSV / Word(.docx) / PDF');
    }
  } else {
    /* 単語リストモード（従来通り） */
    if(ext==='csv'||ext==='txt'){var fr=new FileReader();fr.onload=function(e){csvParse(e.target.result,f.name);};fr.readAsText(f,'UTF-8');}
    else if(ext==='xlsx'||ext==='xls'){xlsxRead(f);}
    else toast('対応形式: CSV, TXT, XLSX');
  }
}

function extractDocx(file){
  loading('Wordファイルを読み込み中...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      try{
        mammoth.extractRawText({arrayBuffer:e.target.result}).then(function(result){
          loaded();
          if(!result.value||result.value.trim().length<10){toast('テキストが取り出せませんでした');return;}
          fileAiExtract(result.value, file.name);
        }).catch(function(){loaded();toast('Wordファイルの読み込みに失敗しました');});
      }catch(e){loaded();toast('Wordファイルの読み込みに失敗しました');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof mammoth!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
  s.onload=function(){loaded();doExtract();};
  s.onerror=function(){loaded();toast('Wordライブラリの読み込みに失敗しました');};
  document.head.appendChild(s);
}

function extractPdf(file){
  loading('PDFを読み込み中...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      var typedArray=new Uint8Array(e.target.result);
      pdfjsLib.getDocument({data:typedArray}).promise.then(function(pdf){
        var totalPages=pdf.numPages, texts=[], done=0;
        for(var i=1;i<=totalPages;i++){
          (function(pageNum){
            pdf.getPage(pageNum).then(function(page){
              page.getTextContent().then(function(tc){
                texts[pageNum-1]=tc.items.map(function(s){return s.str;}).join(' ');
                done++;
                if(done===totalPages){
                  loaded();
                  var fullText=texts.join('\n');
                  if(!fullText.trim()){toast('PDFからテキストが取り出せませんでした（画像PDFは非対応）');return;}
                  fileAiExtract(fullText, file.name);
                }
              });
            });
          })(i);
        }
      }).catch(function(){loaded();toast('PDFの読み込みに失敗しました');});
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof pdfjsLib!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=function(){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    loaded();doExtract();
  };
  s.onerror=function(){loaded();toast('PDFライブラリの読み込みに失敗しました');};
  document.head.appendChild(s);
}

function fileAiExtract(text, fname){
  var savedLevel=selLevel, savedType=selType;
  selLevel=fileSelLevel; selType=fileSelType;
  if(!G.cfg.key){toast('AIでの抽出にはAPIキーが必要です（設定画面で入力）');selLevel=savedLevel;selType=savedType;return;}
  var ln=langName(selLang);
  var def=getLevelDef(selLang,fileSelLevel);
  var typeCond={words:'単語のみ（2語以上の熟語・イディオムは含めない）',phrases:'熟語・イディオム・慣用句のみ（2語以上のフレーズ）',both:'単語と熟語・イディオム・慣用句の両方'};
  var articleRule={en:'',de:'名詞には必ず定冠詞を付けてください（例: der Mann, die Frau, das Kind）。動詞は不定詞形、形容詞は原形で記載してください。',fr:'名詞には必ず定冠詞を付けてください（例: le livre, la maison）。動詞は不定詞形、形容詞は男性単数形で記載してください。',es:'名詞には必ず定冠詞を付けてください（例: el libro, la casa）。動詞は不定詞形、形容詞は男性単数形で記載してください。',it:'名詞には必ず定冠詞を付けてください（例: il libro, la casa）。動詞は不定詞形、形容詞は男性単数形で記載してください。'};
  var articleInstr=articleRule[selLang]||'';
  function makePrompt(chunk){
    return '以下の'+ln+'テキストから、「'+def.cond+'」に該当する'+typeCond[fileSelType]+'をできるだけ多く抽出し、それぞれ日本語訳をつけてください。\n'+
      (articleInstr?articleInstr+'\n':'')+
      '必ずすべての項目にmeaningを記入してください。訳がわからない場合でも推測して記入してください。\n'+
      '以下のJSON形式のみで返してください（前後に説明文や```は不要）:\n'+
      '{"words":[{"word":"primate","meaning":"霊長類"},{"word":"be put upon","meaning":"利用される"}]}\n\n'+
      'テキスト:\n'+chunk;
  }
  var chunks=splitChunks(text, 80000);
  loading('AIが抽出中... (1/'+chunks.length+'パート)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();selLevel=savedLevel;selType=savedType;
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false; seen[k]=true; return true;
      });
      if(!words.length){toast('❌ 単語が抽出できませんでした');return;}
      toast('✅ '+words.length+'語を抽出しました'+(chunks.length>1?' ('+chunks.length+'パート処理)':''));
      prvShow(words);
      var ni2=el('IN-file-name');var ni3=el('IN-ai-name');
      if(ni2&&ni2.value&&ni3&&!ni3.value)ni3.value=ni2.value;
    },
    function(e){
      loaded();selLevel=savedLevel;selType=savedType;
      var msg=e.message||'';
      toast(msg.indexOf('401')>=0?'❌ APIキーが無効です':'❌ エラー: '+msg.slice(0,50));
    }
  );
}

function csvParse(txt,fname){
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim().replace(/^["']|["']$/g,'');
    var m=(p[1]||'').trim().replace(/^["']|["']$/g,'');
    if(w)words.push({word:w,meaning:m});
  });
  var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=fname.replace(/\.[^.]+$/,'');
  if(!words.length){toast('単語が見つかりません');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function xlsxRead(file){
  loading('Excelを読み込み中...');
  function doRead(){
    var fr=new FileReader();
    fr.onload=function(e){
      loaded();
      try{
        var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        var rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
        var words=[];
        rows.forEach(function(r){var w=(r[0]||'').toString().trim(),m=(r[1]||'').toString().trim();if(w)words.push({word:w,meaning:m});});
        var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=file.name.replace(/\.[^.]+$/,'');
        if(!words.length){toast('単語が見つかりません');return;}
        needTranslate(words)?doTranslate(words,selLang):prvShow(words);
      }catch(e){toast('Excelの読み込みに失敗しました');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof XLSX!=='undefined'){loaded();doRead();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload=function(){loaded();doRead();};
  s.onerror=function(){loaded();toast('オフライン環境ではExcel非対応。CSVに変換してください。');};
  document.head.appendChild(s);
}

/* ---- JSON インポート ---- */
var jsonSection='all'; /* all | vocabulary | phrases */

function setJsonSection(sec){
  jsonSection=sec;
  document.querySelectorAll('[data-jsec]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-jsec')===sec);});
}

function jsonImport(text, fname){
  try{
    var d=JSON.parse(text);
  }catch(e){toast('❌ JSONの解析に失敗しました。形式を確認してください。');return;}

  /* book_title からリスト名を自動設定 */
  var ni=el('IN-file-name');
  if(ni){
    var autoName=d.book_title||d.title||d.name||fname.replace(/\.[^.]+$/,'');
    if(autoName&&!ni.value)ni.value=autoName;
  }

  /* 単語配列を取り出す汎用関数 */
  function extractWords(arr){
    if(!Array.isArray(arr))return[];
    return arr.map(function(item){
      var w=item.word||item.term||item.front||item.expression||item.vocab||'';
      var m=item.meaning||item.translation||item.back||item.definition||item.japanese||item.ja||'';
      return w?{word:String(w).trim(),meaning:String(m).trim()}:null;
    }).filter(Boolean);
  }

  var words=[];

  /* パターンC: {"content":{"vocabulary":[...],"phrases":[...]}} */
  if(d.content&&typeof d.content==='object'){
    var vocab=extractWords(d.content.vocabulary||d.content.words||[]);
    var phrases=extractWords(d.content.phrases||d.content.expressions||[]);
    if(jsonSection==='vocabulary'){words=vocab;}
    else if(jsonSection==='phrases'){words=phrases;}
    else{words=vocab.concat(phrases);}
  }
  /* {"words":[...]} または {"vocabulary":[...]} */
  else if(Array.isArray(d.words)){words=extractWords(d.words);}
  else if(Array.isArray(d.vocabulary)){words=extractWords(d.vocabulary);}
  else if(Array.isArray(d.phrases)){words=extractWords(d.phrases);}
  /* トップレベル配列 */
  else if(Array.isArray(d)){words=extractWords(d);}

  if(!words.length){toast('❌ 単語が見つかりません。JSONの形式を確認してください。');return;}

  /* セクション別にリスト名サフィックスを付ける */
  if(ni&&ni.value&&d.content){
    if(jsonSection==='vocabulary')ni.value=ni.value+' [単語]';
    else if(jsonSection==='phrases')ni.value=ni.value+' [熟語]';
  }

  toast('✅ '+words.length+'語を読み込みました');
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

/* 言語×レベル別の検定基準 */
var LEVEL_DEF={
  en:{
    all:  {hint:'レベル区別なし — 学習価値のある単語を幅広く抽出',cond:'基本的すぎる単語（冠詞・前置詞・be動詞など）は除き、学習価値のある単語'},
    beginner:{hint:'初級 — 英検5級・4級・3級レベルの単語',cond:'英検3〜5級レベル（中学英語相当）の基本的な単語。日常生活の簡単な表現'},
    intermediate:{hint:'中級 — 英検準2級・2級レベルの単語',cond:'英検準2級・2級レベル（高校英語相当）の単語。日常・社会的な話題に使われる語彙'},
    advanced:{hint:'上級 — 英検準1級・1級以上レベルの単語',cond:'英検準1級・1級以上レベルの高度な単語。学術・専門・難解な語彙'}
  },
  de:{
    all:  {hint:'レベル区別なし — 学習価値のある単語を幅広く抽出',cond:'基本的すぎる単語（冠詞・前置詞・助動詞など）は除き、学習価値のある単語'},
    beginner:{hint:'初級 — 独検5級・4級・3級レベルの単語',cond:'独検3〜5級レベルの基本的なドイツ語単語。日常生活の簡単な表現'},
    intermediate:{hint:'中級 — 独検2級レベルの単語',cond:'独検2級レベルのドイツ語単語。社会・文化・仕事などのテーマに使われる語彙'},
    advanced:{hint:'上級 — 独検1級以上レベルの単語',cond:'独検1級以上レベルの高度なドイツ語単語。学術・専門・文学的な語彙'}
  },
  fr:{
    all:  {hint:'レベル区別なし — 学習価値のある単語を幅広く抽出',cond:'基本的すぎる単語（冠詞・前置詞・être/avoirなど）は除き、学習価値のある単語'},
    beginner:{hint:'初級 — 仏検5級・4級・3級レベルの単語',cond:'仏検3〜5級レベルの基本的なフランス語単語。日常生活の簡単な表現'},
    intermediate:{hint:'中級 — 仏検2級レベルの単語',cond:'仏検2級レベルのフランス語単語。社会・文化・時事などに使われる語彙'},
    advanced:{hint:'上級 — 仏検1級以上レベルの単語',cond:'仏検1級以上レベルの高度なフランス語単語。学術・文学・専門的な語彙'}
  },
  es:{
    all:  {hint:'レベル区別なし — 学習価値のある単語を幅広く抽出',cond:'基本的すぎる単語（冠詞・前置詞・ser/estarなど）は除き、学習価値のある単語'},
    beginner:{hint:'初級 — スペイン語検定6級・5級・4級レベルの単語',cond:'スペイン語検定4〜6級レベルの基本的な単語。日常生活の簡単な表現'},
    intermediate:{hint:'中級 — スペイン語検定3級・2級レベルの単語',cond:'スペイン語検定2〜3級レベルの単語。社会・文化・仕事などに使われる語彙'},
    advanced:{hint:'上級 — スペイン語検定1級以上レベルの単語',cond:'スペイン語検定1級以上レベルの高度な単語。学術・専門・文学的な語彙'}
  },
  it:{
    all:  {hint:'レベル区別なし — 学習価値のある単語を幅広く抽出',cond:'基本的すぎる単語（冠詞・前置詞・essere/avereなど）は除き、学習価値のある単語'},
    beginner:{hint:'初級 — イタリア語検定（伊検）5級・4級・3級レベルの単語',cond:'イタリア語検定3〜5級レベルの基本的な単語。日常生活の簡単な表現'},
    intermediate:{hint:'中級 — イタリア語検定2級レベルの単語',cond:'イタリア語検定2級レベルの単語。社会・文化・仕事などに使われる語彙'},
    advanced:{hint:'上級 — イタリア語検定1級以上レベルの単語',cond:'イタリア語検定1級以上レベルの高度な単語。学術・専門・文学的な語彙'}
  }
};

function getLevelDef(lang,level){
  var ld=LEVEL_DEF[lang]||LEVEL_DEF.en;
  return ld[level]||ld.all;
}

function setLevel(level){
  selLevel=level;
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
  updateLevelHint();
}

function updateLevelHint(){
  var h=el('LV-hint');
  if(!h)return;
  var def=getLevelDef(selLang,selLevel);
  h.textContent=def.hint;
}

function setType(type){
  selType=type;
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function aiExtract(){
  var txt=el('IN-ai-text').value.trim();
  if(!txt||txt.length<20){toast('もう少し長いテキストを入力してください');return;}
  /* APIキーをその場で入力欄から直接取得（保存済みでなくても動く） */
  var keyFromInput=(el('IN-apikey')||{}).value||'';
  if(keyFromInput&&!G.cfg.key){G.cfg.key=keyFromInput;save();}
  if(G.cfg.key){
    aiExtractAPI(txt);
  } else {
    if(confirm('APIキーが設定されていません。\n設定画面でAPIキーを入力するとAI翻訳が使えます。\nオフライン抽出（訳なし）で続けますか？')){
      offlineExtract(txt);
    }
  }
}

function apiCall(body,ok,ng){
  var xhr=new XMLHttpRequest();
  xhr.open('POST','https://api.anthropic.com/v1/messages',true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.setRequestHeader('x-api-key',G.cfg.key);
  xhr.setRequestHeader('anthropic-version','2023-06-01');
  xhr.setRequestHeader('anthropic-dangerous-direct-browser-access','true');
  xhr.onload=function(){try{var d=JSON.parse(xhr.responseText);xhr.status===200?ok(d):ng(new Error((d.error&&d.error.message)||'APIエラー '+xhr.status));}catch(e){ng(e);}};
  xhr.onerror=function(){ng(new Error('通信エラー'));};
  xhr.send(JSON.stringify(body));
}

/* テキストを指定文字数でチャンク分割（単語区切りを尊重） */
function splitChunks(text, chunkSize){
  var chunks=[];
  var pos=0;
  while(pos<text.length){
    var end=Math.min(pos+chunkSize, text.length);
    /* 行末か空白で切る */
    if(end<text.length){
      var nl=text.lastIndexOf('\n',end);
      var sp=text.lastIndexOf(' ',end);
      var cut=nl>pos+chunkSize/2?nl:sp>pos+chunkSize/2?sp:end;
      end=cut>pos?cut:end;
    }
    chunks.push(text.slice(pos,end).trim());
    pos=end;
  }
  return chunks.filter(function(c){return c.length>0;});
}

/* 複数チャンクを順次APIに送り、結果をマージして返す */
function apiCallChunked(chunks, makePrompt, model, okAll, ngAll){
  var allWords=[];
  var idx=0;
  function next(){
    if(idx>=chunks.length){okAll(allWords);return;}
    var chunk=chunks[idx];
    idx++;
    loading('AIが抽出中... ('+idx+'/'+chunks.length+'パート)');
    var body={
      model:model,
      max_tokens:16000,
      messages:[{role:'user',content:makePrompt(chunk)}]
    };
    apiCall(body,function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var words=(JSON.parse(m[0]).words||[]).filter(function(w){return w.word&&w.word.trim();});
          allWords=allWords.concat(words);
        }
      }catch(e){/* パートのパース失敗は無視して続行 */}
      next();
    },function(e){ngAll(e);});
  }
  next();
}

function langName(lang){return LANGS[lang]?LANGS[lang].name:'英語';}

function aiExtractAPI(txt){
  /* ── スラッシュ区切りの単語リスト形式を検出 ── */
  var slashCount=(txt.match(/ \/ /g)||[]).length;
  var lineCount=txt.split('\n').filter(function(l){return l.trim();}).length;
  var isWordList= slashCount > 20 && slashCount > lineCount * 0.5;

  if(isWordList){
    loading('単語リストを解析中...');
    var rawWords=[];
    txt.split('\n').forEach(function(line){
      line=line.trim();
      if(!line) return;
      if(/[\u3000-\u9fff]/.test(line)) return;
      line.split('/').forEach(function(w){
        w=w.trim().replace(/^\(|\)$/g,'');
        if(w && w.length>0 && w.length<60) rawWords.push(w);
      });
    });
    var seen={};
    var words=rawWords.filter(function(w){
      var k=w.toLowerCase();
      if(seen[k])return false; seen[k]=true; return true;
    }).map(function(w){return{word:w, meaning:''};});

    if(!words.length){loaded();toast('\u274c 単語が見つかりません');return;}
    loaded();

    if(G.cfg.key){
      translateInChunks(words, selLang, function(translated){
        var ni=el('IN-ai-name');
        if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_AI抽出';
        toast('\u2705 '+translated.length+'語を読み込みました');
        prvShow(translated);
      });
    } else {
      var ni=el('IN-ai-name');
      if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_抽出';
      toast('\u2705 '+words.length+'語を読み込みました（翻訳はAPIキーが必要）');
      prvShow(words);
    }
    return;
  }

  /* ── 通常テキストからのAI抽出 ── */
  var ln=langName(selLang);
  var def=getLevelDef(selLang,selLevel);
  var levelLabel={all:'',beginner:'初級_',intermediate:'中級_',advanced:'上級_'};
  var typeLabel={words:'単語_',phrases:'熟語_',both:'単語熟語_'};
  var typeCond={
    words:'単語のみ（2語以上の熟語・イディオムは含めない）',
    phrases:'熟語・イディオム・慣用句のみ（2語以上のフレーズ）',
    both:'単語と熟語・イディオム・慣用句の両方'
  };
  var articleRule={
    en:'',
    de:'名詞には必ず定冠詞を付けてください（例: der Mann, die Frau, das Kind）。動詞は不定詞形（例: gehen, haben）、形容詞は原形で記載してください。',
    fr:"名詞には必ず定冠詞を付けてください（例: le livre, la maison, l\'école）。動詞は不定詞形（例: aller, avoir）、形容詞は男性単数形で記載してください。",
    es:'名詞には必ず定冠詞を付けてください（例: el libro, la casa）。動詞は不定詞形（例: ir, tener）、形容詞は男性単数形で記載してください。',
    it:'名詞には必ず定冠詞を付けてください（例: il libro, la casa, lo studente）。動詞は不定詞形（例: andare, avere）、形容詞は男性単数形で記載してください。'
  };
  var articleInstr=articleRule[selLang]||'';
  var ni=el('IN-ai-name');
  if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_'+(levelLabel[selLevel]||'')+(typeLabel[selType]||'')+'AI抽出';

  function makePrompt(chunk){
    return '以下の'+ln+'テキストから、'+
      '「'+def.cond+'」に該当する'+typeCond[selType]+'をできるだけ多く抽出し、それぞれ日本語訳をつけてください。\n'+
      (articleInstr?articleInstr+'\n':'')+
      '必ずすべての項目にmeaningを記入してください。訳がわからない場合でも推測して記入してください。\n'+
      '以下のJSON形式のみで返してください（前後に説明文や```は不要）:\n'+
      '{"words":[{"word":"primate","meaning":"霊長類"},{"word":"be put upon","meaning":"利用される、こき使われる"}]}\n\n'+
      'テキスト:\n'+chunk;
  }

  var chunks=splitChunks(txt, 80000);
  loading('AIが抽出中... (1/'+chunks.length+'パート)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false;
        seen[k]=true;return true;
      });
      if(!words.length){toast('\u274c 単語が抽出できませんでした');return;}
      toast('\u2705 '+words.length+'語を抽出しました'+(chunks.length>1?' ('+chunks.length+'パート処理)':''));
      prvShow(words);
    },
    function(e){
      loaded();
      var msg=e.message||'';
      if(msg.indexOf('401')>=0||msg.indexOf('authentication')>=0||msg.toLowerCase().indexOf('invalid')>=0){
        toast('\u274c APIキーが無効です。設定画面で確認してください');
      } else if(msg.indexOf('\u901a\u4fe1')>=0){
        toast('\u274c 通信エラー。ネットワークを確認してください');
      } else {
        toast('\u274c AIエラー: '+msg.slice(0,60));
      }
    }
  );
}

/* 単語リストを150語ずつ分割してAI翻訳 */
function translateInChunks(words, lang, callback){
  var ln=langName(lang);
  var chunkSize=150;
  var total=words.length;
  var idx=0;
  var result=words.slice();

  function nextChunk(){
    if(idx>=total){callback(result);return;}
    var chunk=result.slice(idx, idx+chunkSize);
    var noMeaning=chunk.filter(function(w){return !w.meaning;});
    if(!noMeaning.length){idx+=chunkSize;nextChunk();return;}

    loading('翻訳中... ('+Math.min(idx+chunkSize,total)+'/'+total+'語)');
    var wordList=noMeaning.map(function(w){return w.word;}).join(' / ');
    var prompt=
      '以下の'+ln+'の単語・熟語すべてに日本語訳をつけてください。\n'+
      '必ずすべての項目を含めてください。訳がわからない場合でも推測して記入してください。\n'+
      'JSONのみで返してください（```不要）: {"translations":{"abandon":"捨てる","be put upon":"こき使われる"}}\n\n'+
      '単語リスト: '+wordList;

    apiCall({
      model:'claude-haiku-4-5-20251001',
      max_tokens:16000,
      messages:[{role:'user',content:prompt}]
    },function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var tr=JSON.parse(m[0]).translations||{};
          for(var i=idx;i<Math.min(idx+chunkSize,total);i++){
            var w=result[i];
            if(!w.meaning){
              var meaning=tr[w.word]||tr[w.word.toLowerCase()]||'';
              if(!meaning){
                var wn=w.word.replace(/\s+/g,' ').trim();
                Object.keys(tr).forEach(function(k){
                  if(!meaning&&k.replace(/\s+/g,' ').trim().toLowerCase()===wn.toLowerCase())meaning=tr[k];
                });
              }
              if(meaning)w.meaning=meaning;
            }
          }
        }
      }catch(e){}
      idx+=chunkSize;
      nextChunk();
    },function(){
      idx+=chunkSize;
      nextChunk();
    });
  }
  nextChunk();
}
function offlineExtract(txt){
  var common={the:1,be:1,is:1,are:1,was:1,were:1,have:1,has:1,had:1,do:1,does:1,did:1,will:1,would:1,shall:1,should:1,may:1,might:1,must:1,can:1,could:1,a:1,an:1,in:1,on:1,at:1,to:1,for:1,of:1,and:1,or:1,but:1,not:1,this:1,that:1,with:1,from:1,by:1,as:1,up:1,out:1,if:1,about:1,who:1,what:1,which:1,all:1,when:1,so:1,no:1,just:1,into:1,over:1,after:1,also:1,than:1,only:1,they:1,their:1,you:1,we:1,he:1,she:1,me:1,my:1,us:1,him:1,it:1,i:1,
    der:1,die:1,das:1,ein:1,eine:1,und:1,oder:1,aber:1,nicht:1,ist:1,sind:1,war:1,hat:1,haben:1,mit:1,von:1,aus:1,bei:1,nach:1,zum:1,zur:1,dem:1,den:1,des:1,
    le:1,la:1,les:1,un:1,une:1,des:1,et:1,ou:1,est:1,sont:1,pas:1,que:1,qui:1,dans:1,sur:1,avec:1,par:1,
    el:1,los:1,las:1,es:1,son:1,una:1,con:1,por:1,para:1,
    il:1,lo:1,gli:1,del:1,della:1,nella:1,con:1,per:1,una:1,sono:1};
  var f={},m,re=/\b([\wÄäÖöÜüßàâäéèêëîïôùûüÿçæœÁáÉéÍíÓóÚúÑñÀàÈèÌìÒòÙù]{3,})\b/g;
  while((m=re.exec(txt))!==null){var w=m[1];if(!common[w.toLowerCase()]&&!common[w])f[w]=(f[w]||0)+1;}
  var s=Object.keys(f).sort(function(a,b){return f[b]-f[a];}).slice(0,30);
  toast('オフライン抽出完了（訳なし）APIキーを設定すると訳も付与できます');
  prvShow(s.map(function(w){return{word:w,meaning:''};}));
}

function doTranslate(words,lang){
  var nm=words.filter(function(w){return !w.meaning;});
  if(!nm.length){prvShow(words);return;}
  var ln=langName(lang);
  loading(nm.length+'単語を翻訳中...');
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:2048,
    messages:[{role:'user',content:'以下の'+ln+'の単語に日本語訳をつけてください。JSONのみで返してください: {"translations":{"Haus":"家",...}}\\n\\n単語: '+nm.map(function(w){return w.word;}).join(', ')}]
  },function(d){
    try{var m=d.content[0].text.match(/\{[\s\S]*\}/);if(m){var tr=JSON.parse(m[0]).translations||{};words.forEach(function(w){if(!w.meaning&&tr[w.word])w.meaning=tr[w.word];});}}catch(e){}
    loaded();prvShow(words);
  },function(){loaded();prvShow(words);});
}

function prvShow(words){
  prevWords=words.filter(function(w){return w.word&&w.word.trim();});
  el('PRV').style.display='block';
  el('PRV-cnt').textContent=prevWords.length+' 単語';
  var h='';
  prevWords.forEach(function(w,i){
    h+='<div class="prev-item"><div class="pi-n">'+(i+1)+'</div><div class="pi-en">'+esc(w.word)+'</div><div class="pi-ja">'+(w.meaning?esc(w.meaning):'<span style="color:var(--tx2);font-size:11px">訳なし</span>')+'</div></div>';
  });
  el('PRV-list').innerHTML=h;
  var sc=el('s-add').querySelector('.scroll');if(sc)sc.scrollTop=9999;
}
function prvHide(){prevWords=[];el('PRV').style.display='none';el('PRV-list').innerHTML='';}

function saveList(){
  if(!prevWords.length)return;
  var nameMap={paste:'IN-paste-name',file:'IN-file-name',ai:'IN-ai-name'};
  var ni=el(nameMap[addMode]||'IN-paste-name');
  var listName=(ni&&ni.value.trim())||((LANGS[selLang]?LANGS[selLang].name:'')+'リスト '+(G.lists.length+1));
  var lst=null;
  for(var i=0;i<G.lists.length;i++){if(G.lists[i].name===listName){lst=G.lists[i];break;}}
  if(!lst){
    var clrs=['#7c5cfc','#fc5c7d','#5cf8fc','#ffd700','#4cff91','#ff9c4c'];
    var langClr={en:'#4cff91',de:'#ffd700',fr:'#5cf8fc',es:'#ff9c4c',it:'#fc5c7d'};
    lst={id:uid(),name:listName,ic:LANGS[selLang]?LANGS[selLang].flag:'📗',clr:langClr[selLang]||clrs[G.lists.length%clrs.length],lang:selLang,cr:new Date().toISOString()};
    G.lists.push(lst);
  }
  var added=0;
  prevWords.forEach(function(pw){
    var ex=G.words.some(function(w){return w.word===pw.word&&w.lid===lst.id;});
    if(!ex){G.words.push({id:uid(),word:pw.word,meaning:pw.meaning||'',lid:lst.id,lang:selLang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});added++;}
  });
  save();prvHide();
  if(ni)ni.value='';
  var ta=el(addMode==='paste'?'IN-paste-text':addMode==='ai'?'IN-ai-text':'IN-paste-text');if(ta)ta.value='';
  toast('✅ '+added+'単語を「'+listName+'」に追加しました');
  setTimeout(function(){go('s-home');},500);
}

/* WORD LIST */
var listLangFilter='all';
function listFilterRebuild(){
  var sel=el('SEL-list'),cur=sel.value;
  sel.innerHTML='<option value="all">すべて</option>';
  G.lists.forEach(function(l){var o=document.createElement('option');o.value=l.id;o.textContent=(LANGS[l.lang]?LANGS[l.lang].flag+' ':'')+l.name;sel.appendChild(o);});
  sel.value=cur||'all';
}
function wordStatus(w){
  /* ステータスを返す: new/ok/ng/unknown */
  if(!w.s||w.s.k===undefined)return 'new';
  if((w.s.l||0)>0&&(w.s.k||0)<2)return 'ng';
  if(w.s.k>=1&&w.s.i>=3)return 'ok';
  if(!w.s.d)return 'new';
  return 'unknown';
}
function statusMark(w){
  var st=wordStatus(w);
  if(st==='ok')return'<span title="習得済み" style="font-size:13px;margin-left:4px">✅</span>';
  if(st==='ng')return'<span title="要復習" style="font-size:13px;margin-left:4px">❌</span>';
  if(st==='new')return'<span title="未学習" style="font-size:13px;margin-left:4px">🆕</span>';
  return'<span title="不明" style="font-size:13px;margin-left:4px">❓</span>';
}
function listRender(){
  /* 選択モードのツールバー表示を同期 */
  var _tb=document.getElementById('SEL-toolbar');
  if(_tb)_tb.style.display=selModeOn?'block':'none';
  var flt=(el('SEL-list')||{}).value||'all';
  var srch=((el('IN-search')||{}).value||'').toLowerCase();
  var statusFlt=((el('SEL-status')||{}).value)||'all';
  var sortMode=((el('SEL-sort')||{}).value)||'default';
  var c=el('L-words');
  var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
  if(listLangFilter!=='all')words=words.filter(function(w){return(w.lang||'en')===listLangFilter;});
  if(srch)words=words.filter(function(w){return w.word.toLowerCase().indexOf(srch)>=0||(w.meaning||'').toLowerCase().indexOf(srch)>=0;});
  /* ステータスフィルタ */
  if(statusFlt!=='all')words=words.filter(function(w){return wordStatus(w)===statusFlt;});
  /* ソート */
  if(sortMode==='alpha'){words=words.slice().sort(function(a,b){return a.word.localeCompare(b.word);});}
  else if(sortMode==='level_asc'){words=words.slice().sort(function(a,b){return lvl(a)-lvl(b);});}
  else if(sortMode==='level_desc'){words=words.slice().sort(function(a,b){return lvl(b)-lvl(a);});}
  else if(sortMode==='miss'){words=words.slice().sort(function(a,b){return((b.s&&b.s.l)||0)-((a.s&&a.s.l)||0);});}
  if(!words.length){c.innerHTML='<div class="empty"><div class="empty-ic">🔍</div><div class="empty-tl">単語なし</div></div>';return;}
  var lb=['初','入','中','中上','上','習得'],h='';
  words.forEach(function(w){
    var v=lvl(w);
    var l=LANGS[w.lang||'en'];
    var chk=selModeOn?'<input type="checkbox" class="word-sel-chk" data-wid="'+esc(w.id)+'"'+(selSet[w.id]?' checked':'')+' style="width:18px;height:18px;flex-shrink:0;margin-right:4px;accent-color:var(--ac)">':'';
    h+='<button class="word-item" data-wid="'+esc(w.id)+'" style="'+(selModeOn&&selSet[w.id]?'background:rgba(124,92,252,.18);border-color:var(--ac);':'')+'">'+
      chk+
      '<div class="wi-inf"><div class="wi-en">'+(l?'<span style="font-size:11px;margin-right:4px">'+l.flag+'</span>':'')+esc(w.word)+statusMark(w)+'</div>'+
      '<div class="wi-ja">'+(w.meaning?esc(w.meaning):'訳なし')+'</div></div>'+
      '<div class="wi-lvl l'+v+'">'+lb[v]+'</div></button>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.word-item').forEach(function(b){
    b.addEventListener('click',function(e){
      var wid=this.getAttribute('data-wid');
      if(selModeOn){selWordToggle(wid);this.style.background=selSet[wid]?'rgba(124,92,252,.18)':'';this.style.borderColor=selSet[wid]?'var(--ac)':'';}
      else{wordDetail(wid);}
    });
  });
  c.querySelectorAll('.word-sel-chk').forEach(function(chk){
    chk.addEventListener('click',function(e){e.stopPropagation();selWordToggle(this.getAttribute('data-wid'));var btn=this.closest('.word-item');if(btn){btn.style.background=selSet[this.getAttribute('data-wid')]?'rgba(124,92,252,.18)':'';btn.style.borderColor=selSet[this.getAttribute('data-wid')]?'var(--ac)':'';}});
  });
}

function listMenu(lid){
  var lst=G.lists.find(function(x){return x.id===lid;}); if(!lst)return;
  var ws=G.words.filter(function(w){return w.lid===lid;});
  var d=ws.filter(due).length;
  var l=LANGS[lst.lang||'en'];
  var cursor=lst.cursor||0;
  var total=ws.length;
  if(cursor>=total)cursor=0; /* 全完了していたらリセット済み扱い */
  var size=Math.min(parseInt(G.cfg.size)||20, total);
  var nextEnd=Math.min(cursor+size, total);
  var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
  var progressInfo=total>0?'進捗 '+pct+'% ('+cursor+'/'+total+'単語完了)':'';
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(lst.name)+'</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:8px">'+ws.length+'単語'+(d?' · 復習'+d+'件':'')+'</div>'+
    (total>0?'<div style="margin-bottom:14px"><div style="height:5px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-bottom:5px"><div style="height:100%;width:'+pct+'%;background:'+(pct>=100?'var(--gn)':pct>=60?'var(--ac3)':'var(--ac)')+';border-radius:3px;transition:width .3s"></div></div><div style="font-size:11px;color:var(--tx2)">'+progressInfo+(cursor<total?' · 次回: '+cursor+'〜'+nextEnd+'番目':' · 全単語完了！')+'</div></div>':'')+
    '<button class="btn-primary" id="LM-flash" style="margin-bottom:8px">📖 予習してからクイズ</button>'+
    '<button class="btn-sec" id="LM-quiz" style="margin-top:0;margin-bottom:8px">⚡ すぐクイズ（続きから）</button>'+
    '<button class="btn-sec" id="LM-quiz-reset" style="margin-top:0;margin-bottom:8px">🔁 最初からクイズ</button>'+
    '<button class="btn-sec" id="LM-due" style="margin-top:0;margin-bottom:8px'+(d?'':';opacity:.4;pointer-events:none')+'">📅 復習単語のみ（'+d+'件）</button>'+
    '<button class="btn-sec" id="LM-list" style="margin-top:0;margin-bottom:8px">📚 単語一覧を見る</button>'+
    '<button class="btn-sec" id="LM-edit" style="margin-top:0">✏️ リストを編集</button>';
  el('modal-bg').classList.add('on');

  /* カーソル位置以降の全未習単語からランダム抽出する共通関数 */
  function makePool(fromStart){
    var cur=fromStart?0:(lst.cursor||0);
    if(cur>=total)cur=0;
    /* cursor以降の全単語を対象にシャッフルしてsize件取る */
    var remaining=ws.slice(cur);
    var pool=G.cfg.random ? shuffle(remaining).slice(0,size) : remaining.slice(0,size);
    if(pool.length<2&&total>=2){
      /* 残りが少なすぎる場合は先頭から */
      cur=0;
      var all=G.cfg.random ? shuffle(ws.slice()) : ws.slice();
      pool=all.slice(0,size);
    }
    /* nextCursorは「取り出した件数分」だけ進める（登録順での位置） */
    var nextCursor=Math.min(cur+size, total);
    return {pool:pool, nextCursor:nextCursor};
  }

  el('LM-flash').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    /* カーソルをflashStartに渡し、クイズ完了時に進める */
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    flashStart(r.pool,'list',lid);
  });
  el('LM-quiz').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    if(r.pool.length<2){toast('クイズには最低2単語必要です');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-quiz-reset').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(true);
    if(r.pool.length<2){toast('クイズには最低2単語必要です');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-due').addEventListener('click',function(){
    if(!d)return;
    el('modal-bg').classList.remove('on');
    var pool=ws.filter(due);
    if(pool.length<2){toast('復習単語が少なすぎます（最低2単語）');return;}
    var qs=(G.cfg.random ? shuffle(pool) : pool).slice(0,size);
    Q={words:qs,q:qs.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'due',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    go('s-quiz');qRender();
  });
  el('LM-list').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    go('s-list');
    var sel=el('SEL-list');
    listFilterRebuild();
    sel.value=lid;
    listRender();
  });
  el('LM-edit').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editList(lid);
  });
}

function wordDetail(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var lst=G.lists.find(function(x){return x.id===w.lid;});
  var dStr=w.s&&w.s.d?new Date(w.s.d).toLocaleDateString('ja-JP'):'すぐ';
  var lbn=['初級','入門','中級','中上級','上級','習得済み'],v=lvl(w);
  var l=LANGS[w.lang||'en'];
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(w.word)+'</div>'+
    '<div style="font-size:20px;color:var(--ac3);margin-bottom:13px">'+esc(w.meaning||'訳なし')+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px">'+
    mkCard('SRSレベル',lbn[v])+mkCard('次回復習',dStr)+
    mkCard('連続正解',(w.s&&w.s.k||0))+mkCard('間違い回数','<span style="color:var(--rd)">'+(w.s&&w.s.l||0)+'</span>')+
    '</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">言語: '+(l?l.flag+' '+l.name:'不明')+' ／ リスト: '+esc(lst?lst.name:'不明')+'</div>'+
    '<button class="btn-sec" id="EDIT-word-btn" style="margin-bottom:8px">✏️ 単語を編集</button>'+
    '<button class="del-btn" id="DEL-btn">🗑️ この単語を削除</button>';
  el('modal-bg').classList.add('on');
  el('EDIT-word-btn').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editWord(wid);
  });
  el('DEL-btn').addEventListener('click',function(){
    if(!confirm('「'+w.word+'」を削除しますか？'))return;
    G.words=G.words.filter(function(x){return x.id!==wid;});
    save();el('modal-bg').classList.remove('on');listRender();toast('削除しました');
  });
}
function mkCard(l,v){return'<div style="background:var(--sf2);border-radius:9px;padding:10px"><div style="font-size:10px;color:var(--tx2);margin-bottom:3px">'+l+'</div><div style="font-size:14px;font-weight:600">'+v+'</div></div>';}
/* ========== EDIT FUNCTIONS ========== */

/* ── リスト編集モーダル ── */
function editList(lid){
  var lst=G.lists.find(function(x){return x.id===lid;});if(!lst)return;
  if(!G.folders) G.folders=[];
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+(lst.lang===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  var folderOpts='<option value=""'+((!lst.fid||!G.folders.some(function(f){return f.id===lst.fid;}))?' selected':'')+'>（未分類）</option>';
  folderOpts+=G.folders.map(function(f){
    return '<option value="'+f.id+'"'+(lst.fid===f.id?' selected':'')+'>📁 '+escHtml(f.name)+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">✏️ リストを編集</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">リスト名</div>'+
    '<input class="inp" id="EL-name" type="text" value="'+escHtml(lst.name)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">言語</div>'+
    '<select class="inp" id="EL-lang" style="margin-bottom:12px">'+langOpts+'</select>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">フォルダ</div>'+
    '<select class="inp" id="EL-folder" style="margin-bottom:16px">'+folderOpts+'</select>'+
    '<button class="btn-primary" id="EL-save" style="margin-bottom:8px">💾 保存</button>'+
    '<button class="btn-sec" id="EL-cancel" style="margin-top:0">キャンセル</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EL-name');if(n){n.focus();n.select();}},100);
  el('EL-save').addEventListener('click',function(){
    var name=(el('EL-name').value||'').trim();
    if(!name){toast('リスト名を入力してください');return;}
    lst.name=name;
    lst.lang=el('EL-lang').value;
    lst.fid=el('EL-folder').value||null;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listFilterRebuild();listRender();
    toast('✅ リストを更新しました');
  });
  el('EL-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* ── フォルダ作成 ── */
function createFolder(parentId){
  if(!G.folders) G.folders=[];
  var parentFolder=parentId?G.folders.find(function(f){return f.id===parentId;}):null;
  var title=parentFolder?'📂 サブフォルダを作成':'📁 新規フォルダ';
  var hint=parentFolder?'<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">親フォルダ: 📁 '+esc(parentFolder.name)+'</div>':'';
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+title+'</div>'+
    hint+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">フォルダ名</div>'+
    '<input class="inp" id="CF-name" type="text" placeholder="例: 英検準1級、仕事用" style="margin-bottom:16px">'+
    '<button class="btn-primary" id="CF-save" style="margin-bottom:8px">📁 作成</button>'+
    '<button class="btn-sec" id="CF-cancel" style="margin-top:0">キャンセル</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('CF-name');if(n){n.focus();}},100);
  el('CF-save').addEventListener('click',function(){
    var name=(el('CF-name').value||'').trim();
    if(!name){toast('フォルダ名を入力してください');return;}
    var newFolder={id:uid(),name:name,collapsed:false};
    if(parentId) newFolder.parentId=parentId;
    G.folders.push(newFolder);
    save();el('modal-bg').classList.remove('on');
    homeRefresh();toast('📁 フォルダ「'+name+'」を作成しました');
  });
  el('CF-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* ── フォルダ編集 ── */
function editFolder(fid){
  if(!G.folders) G.folders=[];
  var folder=G.folders.find(function(f){return f.id===fid;});if(!folder)return;
  var listsInFolder=G.lists.filter(function(l){return l.fid===fid;});
  var subFolders=G.folders.filter(function(f){return f.parentId===fid;});
  var parentFolder=folder.parentId?G.folders.find(function(f){return f.id===folder.parentId;}):null;

  /* 移動先フォルダ選択肢（自分自身と子孫を除く） */
  function isDescOf(f2id, f1id){
    var f=G.folders.find(function(x){return x.id===f2id;});
    if(!f) return false;
    if(f.parentId===f1id) return true;
    if(!f.parentId) return false;
    return isDescOf(f.parentId, f1id);
  }
  var moveOpts='<option value="">ルート（トップレベル）</option>';
  G.folders.forEach(function(f){
    if(f.id===fid||isDescOf(f.id,fid)) return; /* 自分・子孫は除外 */
    moveOpts+='<option value="'+esc(f.id)+'"'+(folder.parentId===f.id?' selected':'')+'>📁 '+esc(f.name)+'</option>';
  });

  el('modal-ct').innerHTML=
    '<div class="modal-tl">📁 フォルダを編集</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">フォルダ名</div>'+
    '<input class="inp" id="EF-name" type="text" value="'+escHtml(folder.name)+'" style="margin-bottom:10px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">📂 親フォルダ</div>'+
    '<select class="inp" id="EF-parent" style="margin-bottom:16px">'+moveOpts+'</select>'+
    '<button class="btn-primary" id="EF-save" style="margin-bottom:8px">💾 保存</button>'+
    '<button class="btn-sec" id="EF-subfolder" style="margin-top:0;margin-bottom:8px">📂 サブフォルダを作成</button>'+
    '<button class="btn-sec" id="EF-cancel" style="margin-top:0;margin-bottom:8px">キャンセル</button>'+
    '<button class="del-btn" id="EF-del">🗑️ フォルダを削除（リストは残す）</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EF-name');if(n){n.focus();n.select();}},100);
  el('EF-save').addEventListener('click',function(){
    var name=(el('EF-name').value||'').trim();
    if(!name){toast('フォルダ名を入力してください');return;}
    folder.name=name;
    var newParent=el('EF-parent').value||null;
    folder.parentId=newParent||undefined;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();toast('✅ フォルダを更新しました');
  });
  el('EF-subfolder').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    setTimeout(function(){createFolder(fid);},150);
  });
  el('EF-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
  el('EF-del').addEventListener('click',function(){
    var totalSub=subFolders.length;
    var msg='フォルダ「'+folder.name+'」を削除しますか？\n（フォルダ内の'+listsInFolder.length+'件のリストは未分類に移動します）';
    if(totalSub>0) msg+='\n※ サブフォルダ '+totalSub+'件 もすべて削除されます';
    if(!confirm(msg))return;
    /* 再帰的にサブフォルダを削除し、リストのfidを解除 */
    function removeFolder(rfid){
      G.lists.forEach(function(l){if(l.fid===rfid)l.fid=null;});
      var subs=G.folders.filter(function(f){return f.parentId===rfid;});
      subs.forEach(function(sf){removeFolder(sf.id);});
      G.folders=G.folders.filter(function(f){return f.id!==rfid;});
    }
    removeFolder(fid);
    save();el('modal-bg').classList.remove('on');
    homeRefresh();toast('🗑️ フォルダを削除しました');
  });
}

/* ── 単語編集モーダル ── */
function editWord(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+((w.lang||'en')===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  var listOpts=G.lists.map(function(l){
    return '<option value="'+l.id+'"'+(w.lid===l.id?' selected':'')+'>'+escHtml(l.name)+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">✏️ 単語を編集</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">単語（外国語）</div>'+
    '<input class="inp" id="EW-word" type="text" value="'+escHtml(w.word)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">意味（日本語）</div>'+
    '<input class="inp" id="EW-meaning" type="text" value="'+escHtml(w.meaning||'')+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">言語</div>'+
    '<select class="inp" id="EW-lang" style="margin-bottom:12px">'+langOpts+'</select>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">所属リスト</div>'+
    '<select class="inp" id="EW-list" style="margin-bottom:16px">'+listOpts+'</select>'+
    '<button class="btn-primary" id="EW-save" style="margin-bottom:8px">💾 保存</button>'+
    '<button class="btn-sec" id="EW-cancel" style="margin-top:0">キャンセル</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EW-word');if(n){n.focus();n.select();}},100);
  el('EW-save').addEventListener('click',function(){
    var word=(el('EW-word').value||'').trim();
    var meaning=(el('EW-meaning').value||'').trim();
    if(!word){toast('単語を入力してください');return;}
    w.word=word; w.meaning=meaning;
    w.lang=el('EW-lang').value;
    w.lid=el('EW-list').value;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('✅ 単語を更新しました');
  });
  el('EW-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* ── 重複チェック ── */
function checkDuplicates(){
  var seen={}, dups=[];
  G.words.forEach(function(w){
    var key=(w.word||'').toLowerCase().trim()+'|'+(w.lang||'en');
    if(seen[key]){
      /* 同一グループに追加 */
      var grp=dups.find(function(g){return g.key===key;});
      if(grp)grp.words.push(w);
      else dups.push({key:key,words:[seen[key],w]});
    } else {
      seen[key]=w;
    }
  });
  if(!dups.length){toast('重複単語はありません ✅');return;}

  var rows=dups.map(function(g){
    var wds=g.words;
    var lists=wds.map(function(w){var l=G.lists.find(function(x){return x.id===w.lid;});return l?l.name:'不明';});
    return '<div style="background:var(--sf2);border-radius:9px;padding:10px;margin-bottom:8px">'+
      '<div style="font-weight:700;margin-bottom:5px;color:var(--ac3)">'+escHtml(wds[0].word)+'</div>'+
      wds.map(function(w,i){
        return '<div style="display:flex;align-items:center;gap:7px;margin-bottom:4px">'+
          '<input type="checkbox" class="dup-chk" data-wid="'+w.id+'" style="width:16px;height:16px;flex-shrink:0">'+
          '<span style="font-size:11px;color:var(--tx2);flex:1">'+escHtml(w.meaning||'訳なし')+' <span style="opacity:.6">／ '+escHtml(lists[i])+'</span></span>'+
        '</div>';
      }).join('')+
    '</div>';
  }).join('');

  el('modal-ct').innerHTML=
    '<div class="modal-tl">⊜ 重複チェック（'+dups.length+'件）</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">削除する単語にチェックを入れてください</div>'+
    '<div id="DUP-list">'+rows+'</div>'+
    '<button class="del-btn" id="DUP-del" style="margin-top:8px">🗑️ チェックした単語を削除</button>'+
    '<button class="btn-sec" id="DUP-cancel" style="margin-top:8px">閉じる</button>';
  el('modal-bg').classList.add('on');

  el('DUP-del').addEventListener('click',function(){
    var checked=Array.from(el('DUP-list').querySelectorAll('.dup-chk:checked')).map(function(c){return c.getAttribute('data-wid');});
    if(!checked.length){toast('削除する単語を選択してください');return;}
    G.words=G.words.filter(function(w){return checked.indexOf(w.id)<0;});
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('🗑️ '+checked.length+'件削除しました');
  });
  el('DUP-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* ── 選択モード ── */
var selModeOn=false, selSet={};
function toggleSelMode(){
  selModeOn=!selModeOn; selSet={};
  el('SEL-toolbar').style.display=selModeOn?'block':'none';
  el('B-sel-mode').style.color=selModeOn?'var(--ac)':'var(--tx2)';
  listRender();
  updateSelCount();
}
function updateSelCount(){
  var n=Object.keys(selSet).length;
  el('SEL-count').textContent=n+'件選択中';
}
function selWordToggle(wid){
  if(selSet[wid])delete selSet[wid]; else selSet[wid]=true;
  var chk=document.querySelector('.word-sel-chk[data-wid="'+wid+'"]');
  if(chk)chk.checked=!!selSet[wid];
  updateSelCount();
}
function selDeleteAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('単語を選択してください');return;}
  if(!confirm(ids.length+'件の単語を削除しますか？'))return;
  G.words=G.words.filter(function(w){return!selSet[w.id];});
  selSet={};save();homeRefresh();listRender();updateSelCount();toast('🗑️ '+ids.length+'件削除しました');
}
function selMoveAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('単語を選択してください');return;}
  if(G.lists.length<2){toast('移動先リストがありません');return;}
  var opts=G.lists.map(function(l){return '<button class="btn-sec sel-mv-btn" data-lid="'+l.id+'" style="margin-bottom:6px;margin-top:0">'+escHtml(l.name)+'</button>';}).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">✦ 移動先リストを選択</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">'+ids.length+'件を移動します</div>'+
    opts+
    '<button class="btn-sec" id="MV-cancel" style="margin-top:8px">キャンセル</button>';
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.sel-mv-btn').forEach(function(b){
    b.addEventListener('click',function(){
      var toLid=this.getAttribute('data-lid');
      G.words.forEach(function(w){if(selSet[w.id])w.lid=toLid;});
      selSet={};save();el('modal-bg').classList.remove('on');
      listRender();updateSelCount();toast('✅ 移動しました');
    });
  });
  el('MV-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}
/* ========== END EDIT FUNCTIONS ========== */


/* ---------- SPEECH ---------- */
var LANG_VOICE={en:'en-US',de:'de-DE',fr:'fr-FR',es:'es-ES',it:'it-IT'};

/* ---- 音楽ダッキング ---- */
var DUCK_VOL=0.15; /* 読み上げ中の音楽音量 */
var _duckActive=0; /* ネスト対応カウンター */
function duckStart(){
  _duckActive++;
  if(_duckActive>1)return;
  document.querySelectorAll('audio,video').forEach(function(m){
    if(!m.paused&&!m._preVol){m._preVol=m.volume;m.volume=Math.min(m.volume,DUCK_VOL);}
  });
}
function duckEnd(){
  _duckActive=Math.max(0,_duckActive-1);
  if(_duckActive>0)return;
  setTimeout(function(){ /* 少し待ってから戻す（次の読み上げが来た場合対策） */
    if(_duckActive>0)return;
    document.querySelectorAll('audio,video').forEach(function(m){
      if(m._preVol!=null){m.volume=m._preVol;delete m._preVol;}
    });
  },300);
}

function speak(text, lang){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);
  u.lang=LANG_VOICE[lang||'en']||'en-US';
  u.rate=0.9;
  u.pitch=1.0;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();};
  u.onerror=function(){duckEnd();};
  setTimeout(function(){window.speechSynthesis.speak(u);},100);
}

/* ---------- FLASHCARD ---------- */
var FL={words:[],i:0,playing:false,timer:null,quizPool:null,quizMode:null,quizLid:null,token:0};

/* ---- 読み上げキュー（iOS対応） ---- */
var SQ={queue:[],busy:false};
function sqClear(){
  SQ.queue=[];SQ.busy=false;
  try{window.speechSynthesis.cancel();}catch(e){}
}
function sqSpeak(text,lang,cb){
  cb=cb||function(){};
  if(!text||!text.trim()){cb();return;} /* 空文字はスキップしてcbだけ呼ぶ */
  SQ.queue.push({text:text,lang:lang,cb:cb});
  if(!SQ.busy)sqNext();
}
function sqNext(){
  if(!SQ.queue.length){SQ.busy=false;return;}
  SQ.busy=true;
  var item=SQ.queue.shift();
  if(!window.speechSynthesis){item.cb();SQ.busy=false;sqNext();return;}
  var u=new SpeechSynthesisUtterance(item.text);
  u.lang=LANG_VOICE[item.lang||'en']||'en-US';
  u.rate=0.9;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  u.onerror=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  setTimeout(function(){
    window.speechSynthesis.speak(u);
    setTimeout(function(){if(window.speechSynthesis.paused)window.speechSynthesis.resume();},200);
  },80);
}

function speakWithCb(text,lang,cb){sqSpeak(text,lang,cb);}
function speakJa(text){sqSpeak(text,'ja',function(){});}

function flRender(){
  var token=++FL.token;
  var w=FL.words[FL.i];
  if(!w)return;
  var tot=FL.words.length,cur=FL.i+1;
  el('FL-fill').style.width=(cur/tot*100)+'%';
  el('FL-cnt').textContent=cur+'/'+tot;
  var l=LANGS[w.lang||'en'];
  el('FL-lang').textContent=l?l.flag+' '+l.name:'';
  var card=el('FL-card');
  card.classList.add('flip');

  setTimeout(function(){
    if(FL.token!==token)return;
    el('FL-word').textContent=w.word;
    el('FL-meaning').textContent='';
    card.classList.remove('flip');

    var mode=G.cfg.spkMode||'both';
    var doForeign=(mode==='both'||mode==='foreign');
    var doJa=(mode==='both'||mode==='ja');

    /* 読み上げ完了後に次フェーズへ進む汎用関数 */
    function sayThen(text, lang, next){
      if(!text||!text.trim()||!window.speechSynthesis){
        setTimeout(next,50);return;
      }
      var u=new SpeechSynthesisUtterance(text);
      u.lang=lang; u.rate=0.9;
      u.onstart=function(){duckStart();};
      u.onend=function(){duckEnd();if(FL.token===token)next();};
      u.onerror=function(){duckEnd();if(FL.token===token)next();};
      window.speechSynthesis.speak(u);
    }

    /* ③ 両方完了後に設定秒数待って次へ */
    function afterAll(){
      if(!FL.playing||FL.token!==token)return;
      FL.timer=setTimeout(function(){
        if(!FL.playing||FL.token!==token)return;
        if(FL.i<FL.words.length-1){FL.i++;flRender();}
        else{
          flStopAuto();
          if(G.cfg.autoQuiz){flStartAutoQuizCountdown();}
          else{toast('予習完了！クイズで確認しよう');}
        }
      },(G.cfg.flashSec||2)*1000);
    }

    /* ② 和訳を表示して日本語読み上げ → afterAll */
    function showMeaning(){
      if(FL.token!==token)return;
      el('FL-meaning').textContent=w.meaning||'';
      if(doJa&&w.meaning&&w.meaning.trim()){
        sayThen(w.meaning,'ja-JP',afterAll);
      } else {
        afterAll();
      }
    }

    /* ① 外国語読み上げ → 800ms後にshowMeaning */
    if(doForeign&&w.word){
      sayThen(w.word, LANG_VOICE[w.lang||'en']||'en-US', function(){
        setTimeout(showMeaning, 800);
      });
    } else {
      setTimeout(showMeaning, 300);
    }

  },200);
}

function flNext(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i<FL.words.length-1){FL.i++;flRender();}
  else{toast('最後の単語です');}
}
function flPrev(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i>0){FL.i--;flRender();}
  else{toast('最初の単語です');}
}
function flToggleAuto(){
  if(FL.playing){flStopAuto();}
  else{
    FL.playing=true;
    el('FL-play').textContent='⏸';
    if(!SQ.busy&&!FL.timer){flRender();}
  }
}
function flStopAuto(){
  FL.playing=false;
  el('FL-play').textContent='▶';
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
}

/* 予習完了後の自動クイズ移行カウントダウン */
var FL_AQ_timer=null;
function flStartAutoQuizCountdown(){
  var overlay=el('FL-auto-quiz-overlay');
  overlay.style.display='flex';
  var sec=3;
  function tick(){
    el('FL-aq-msg').textContent=sec+'秒後にクイズを開始します';
    if(sec<=0){flLaunchAutoQuiz();return;}
    sec--;
    FL_AQ_timer=setTimeout(tick,1000);
  }
  tick();
}
function flCancelAutoQuiz(){
  if(FL_AQ_timer){clearTimeout(FL_AQ_timer);FL_AQ_timer=null;}
  el('FL-auto-quiz-overlay').style.display='none';
  toast('予習完了！クイズで確認しよう');
}
function flLaunchAutoQuiz(){
  if(FL_AQ_timer){clearTimeout(FL_AQ_timer);FL_AQ_timer=null;}
  el('FL-auto-quiz-overlay').style.display='none';
  if(window.speechSynthesis)window.speechSynthesis.cancel();
  var pool=FL.words.slice();
  if(pool.length<2){toast('クイズには最低2単語必要です');return;}
  var qpool=G.cfg.random ? shuffle(pool) : pool;
  var pending=Q._pendingCursor;
  Q={words:qpool,q:qpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
  if(pending)Q._pendingCursor=pending;
  go('s-quiz');qRender();
}

function flashStart(words, quizMode, quizLid){
  if(!words||!words.length){toast('単語がありません');return;}
  sqClear();
  FL.words=words; FL.i=0; FL.playing=false; FL.timer=null; FL.token=0;
  FL.quizMode=quizMode; FL.quizLid=quizLid;
  go('s-flash');
  if(G.cfg.flashAuto){
    FL.playing=true;
    el('FL-play').textContent='⏸';
  }
  flRender();
}

function flBindButtons(){
  el('B-flash-exit').addEventListener('click',function(){
    flCancelAutoQuiz();
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    go('s-home');
  });
  el('FL-prev').addEventListener('click',flPrev);
  el('FL-next').addEventListener('click',flNext);
  el('FL-play').addEventListener('click',flToggleAuto);
  el('FL-spk').addEventListener('click',function(){
    var w=FL.words[FL.i];if(!w)return;
    speak(w.word,w.lang||'en');
    if(w.meaning)setTimeout(function(){speakJa(w.meaning);},1800);
  });
  el('FL-to-quiz').addEventListener('click',function(){
    flCancelAutoQuiz();
    flStopAuto();
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    var pool=FL.words.slice();
    if(pool.length<2){toast('クイズには最低2単語必要です');return;}
    var qpool=G.cfg.random ? shuffle(pool) : pool;
    var pending=Q._pendingCursor;
    Q={words:qpool,q:qpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    if(pending)Q._pendingCursor=pending;
    go('s-quiz');qRender();
  });
  el('FL-aq-now').addEventListener('click',function(){flLaunchAutoQuiz();});
  el('FL-aq-cancel').addEventListener('click',function(){flCancelAutoQuiz();});
}

/* QUIZ */
var Q={words:[],q:[],i:0,ok:0,ng:0,done:false,miss:[],ci:0,ca:'',testMode:false,startMs:Date.now()};
/* ============================================================
   学習報告書
   ============================================================ */
function showReportModal(){
  showReportStep1();
}

function showReportStep1(){
  var periods=[
    {id:'day',  label:'📅 日次報告書', sub:'本日の学習記録'},
    {id:'week', label:'📆 週次報告書', sub:'過去7日間の記録'},
    {id:'month',label:'🗓️ 月次報告書', sub:'過去30日間の記録'}
  ];
  var html='<div class="modal-tl">📊 学習報告書を作成</div>';
  html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">① 期間を選択</div>';
  periods.forEach(function(p){
    html+='<button class="rpt-btn" data-period="'+p.id+'" style="display:flex;align-items:center;gap:12px;width:100%;background:var(--sf2);border:none;border-radius:12px;padding:14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;">'+
      '<div style="flex:1"><div style="font-size:14px;font-weight:600;color:var(--tx)">'+p.label+'</div>'+
      '<div style="font-size:11px;color:var(--tx2);margin-top:3px">'+p.sub+'</div></div>'+
      '<div style="font-size:18px;color:var(--tx2)">›</div></button>';
  });
  el('modal-ct').innerHTML=html;
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.rpt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      showReportStep2(this.getAttribute('data-period'));
    });
  });
}

function showReportStep2(period){
  var periodLabels={day:'日次報告書',week:'週次報告書',month:'月次報告書'};
  /* 選択状態をJSオブジェクトで管理（チェックボックス不使用） */
  var selLids={all:true}; /* デフォルト：全て選択 */

  function renderStep2(){
    var html='<div class="modal-tl">📊 '+periodLabels[period]+'</div>';
    html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">② 単語集を選択（複数可）</div>';

    function btnStyle(lid){
      var on=selLids[lid];
      return 'display:flex;align-items:center;gap:12px;width:100%;background:'+(on?'rgba(124,92,252,.15)':'var(--sf2)')+
        ';border:2px solid '+(on?'var(--ac)':'rgba(255,255,255,.1)')+
        ';border-radius:12px;padding:13px 14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;';
    }
    function chkMark(lid){
      return '<div style="width:22px;height:22px;border-radius:6px;border:2px solid '+(selLids[lid]?'var(--ac)':'rgba(255,255,255,.2)')+
        ';background:'+(selLids[lid]?'var(--ac)':'transparent')+
        ';display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:#fff">'+
        (selLids[lid]?'✓':'')+
        '</div>';
    }

    html+='<button class="rpt-sel-btn" data-lid="all" style="'+btnStyle('all')+'">'+
      chkMark('all')+
      '<div style="flex:1"><div style="font-size:14px;font-weight:600;color:var(--tx)">📚 すべての単語集</div>'+
      '<div style="font-size:11px;color:var(--tx2);margin-top:2px">全リストを対象にする</div></div></button>';

    G.lists.forEach(function(lst){
      var l=LANGS[lst.lang||'en'];
      var ws=G.words.filter(function(w){return w.lid===lst.id;});
      html+='<button class="rpt-sel-btn" data-lid="'+lst.id+'" style="'+btnStyle(lst.id)+'">'+
        chkMark(lst.id)+
        '<div style="font-size:22px;flex-shrink:0">'+(l?l.flag:'📗')+'</div>'+
        '<div style="flex:1;min-width:0">'+
          '<div style="font-size:14px;font-weight:600;color:var(--tx);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(lst.name)+'</div>'+
          '<div style="font-size:11px;color:var(--tx2);margin-top:2px">'+ws.length+'単語</div>'+
        '</div></button>';
    });

    html+='<button class="btn-primary" id="RPT-go" style="margin-top:4px">📄 報告書を作成</button>';
    html+='<button class="btn-sec" id="RPT-back" style="margin-top:0;margin-top:8px">← 戻る</button>';
    el('modal-ct').innerHTML=html;

    el('modal-ct').querySelectorAll('.rpt-sel-btn').forEach(function(btn){
      btn.addEventListener('click',function(){
        var lid=this.getAttribute('data-lid');
        if(lid==='all'){
          /* 「全て」をタップ → 全てON・個別OFF */
          selLids={all:true};
        } else {
          /* 個別をタップ → 「全て」をOFF、個別トグル */
          delete selLids.all;
          if(selLids[lid]) delete selLids[lid];
          else selLids[lid]=true;
          /* 何も選ばれなければ「全て」に戻す */
          if(!Object.keys(selLids).length) selLids={all:true};
        }
        renderStep2(); /* 再描画 */
      });
    });

    el('RPT-go').addEventListener('click',function(){
      var lids=Object.keys(selLids);
      el('modal-bg').classList.remove('on');
      generateReport(period, lids);
    });
    el('RPT-back').addEventListener('click',function(){showReportStep1();});
  }

  renderStep2();
}

function generateReport(period, lids){
  if(!G.logs)G.logs=[];
  lids=lids||['all'];
  var now=new Date();
  var cutoff=new Date(now);
  var periodLabel='';
  if(period==='day'){cutoff.setHours(0,0,0,0);periodLabel='日次報告書（'+fmtDate(now)+'）';}
  else if(period==='week'){cutoff.setDate(now.getDate()-6);cutoff.setHours(0,0,0,0);periodLabel='週次報告書（'+fmtDate(cutoff)+'〜'+fmtDate(now)+'）';}
  else{cutoff.setDate(now.getDate()-29);cutoff.setHours(0,0,0,0);periodLabel='月次報告書（'+fmtDate(cutoff)+'〜'+fmtDate(now)+'）';}

  /* 単語集フィルタ */
  var filterAll=(lids.indexOf('all')>=0||!lids.length);
  var listNames=[];
  if(!filterAll){
    lids.forEach(function(lid){
      var lst=G.lists.find(function(x){return x.id===lid;});
      if(lst)listNames.push(lst.name);
    });
  }

  /* ログを期間＋単語集でフィルタ */
  var logs=G.logs.filter(function(l){
    if(new Date(l.ts)<cutoff)return false;
    if(filterAll)return true;
    /* lidsとログのlidsが重なるか確認 */
    var logLids=l.lids||[];
    /* 古いログはwordsから推定 */
    if(!logLids.length&&l.words&&l.words.length){
      var lidSet={};
      l.words.forEach(function(wid){var w=G.words.find(function(x){return x.id===wid;});if(w&&w.lid)lidSet[w.lid]=true;});
      logLids=Object.keys(lidSet);
    }
    return lids.some(function(lid){return logLids.indexOf(lid)>=0;});
  });

  /* 集計 */
  var totalSessions=logs.length;
  var totalQ=logs.reduce(function(s,l){return s+l.total;},0);
  var totalOk=logs.reduce(function(s,l){return s+l.ok;},0);
  var totalNg=logs.reduce(function(s,l){return s+l.ng;},0);
  var avgAcc=totalQ?Math.round(totalOk/totalQ*100):0;
  /* dur(秒)とdurationMs(ミリ秒)を両対応で統一 */
  var totalDurMs=logs.reduce(function(s,l){return s+(l.durationMs||((l.dur||0)*1000));},0);

  /* 日別集計 */
  var dayMap={};
  logs.forEach(function(l){
    var d=l.ts.slice(0,10);
    if(!dayMap[d])dayMap[d]={ok:0,ng:0,total:0,sessions:0,durMs:0};
    dayMap[d].ok+=l.ok; dayMap[d].ng+=l.ng; dayMap[d].total+=l.total; dayMap[d].sessions++;
    dayMap[d].durMs+=(l.durationMs||((l.dur||0)*1000));
  });

  /* 間違えた単語の集計（回数順） */
  var missMap={};
  logs.forEach(function(l){
    (l.miss||[]).forEach(function(w){
      if(!missMap[w.id])missMap[w.id]={word:w.word,meaning:w.meaning,lang:w.lang,count:0};
      missMap[w.id].count++;
    });
  });
  var missArr=Object.values(missMap).sort(function(a,b){return b.count-a.count;});

  /* 準苦手：正解したが5秒以上かかった単語 */
  var slowMap={};
  logs.forEach(function(l){
    (l.slow||[]).forEach(function(w){
      if(!slowMap[w.id])slowMap[w.id]={word:w.word,meaning:w.meaning||'',lang:w.lang||'en',count:0,totalMs:0};
      slowMap[w.id].count++;
      slowMap[w.id].totalMs+=(w.answerMs||0);
    });
  });
  var slowArr=Object.values(slowMap).map(function(w){w.avgMs=w.count?Math.round(w.totalMs/w.count):0;return w;})
    .sort(function(a,b){return b.count!==a.count?b.count-a.count:b.avgMs-a.avgMs;});

  /* 正答率推移（日別） */
  var dayKeys=Object.keys(dayMap).sort();

  /* モード別学習時間集計 */
  var MODES=['due','study','all','weak','test'];
  var modeLabels={due:'今日の復習',all:'全単語クイズ',weak:'苦手単語',study:'予習→クイズ',test:'テスト形式'};
  var modeColors={due:'#7c5cfc',all:'#4cff91',weak:'#fc5c7d',study:'#ffd700',test:'#5cf8fc'};
  var modeMs={due:0,all:0,weak:0,study:0,test:0};
  logs.forEach(function(l){
    var m=l.quizMode||(l.testMode?'test':'all');
    if(modeMs[m]===undefined)modeMs[m]=0;
    modeMs[m]+=(l.durationMs||((l.dur||0)*1000));
  });
  var modeData=MODES.filter(function(k){return modeMs[k]>0;}).map(function(k){
    return {key:k, label:modeLabels[k], ms:modeMs[k], color:modeColors[k]};
  });

  /* リスト別集計 */
  var listMap={};
  logs.forEach(function(l){
    (l.lids||[]).forEach(function(lid){
      if(!listMap[lid])listMap[lid]={sessions:0,total:0,ok:0,durMs:0};
      listMap[lid].sessions++;
      listMap[lid].total+=l.total;
      listMap[lid].ok+=l.ok;
      listMap[lid].durMs+=(l.durationMs||((l.dur||0)*1000));
    });
    /* lidsがない古いログはwordsから推定 */
    if(!l.lids&&l.words&&l.words.length){
      var lidSet={};
      l.words.forEach(function(wid){
        var w=G.words.find(function(x){return x.id===wid;});
        if(w&&w.lid)lidSet[w.lid]=true;
      });
      Object.keys(lidSet).forEach(function(lid){
        if(!listMap[lid])listMap[lid]={sessions:0,total:0,ok:0,durMs:0};
        listMap[lid].sessions++;
        listMap[lid].total+=l.total;
        listMap[lid].ok+=l.ok;
        listMap[lid].durMs+=(l.durationMs||((l.dur||0)*1000));
      });
    }
  });
  var listData=Object.keys(listMap).map(function(lid){
    var lst=G.lists.find(function(x){return x.id===lid;});
    var r=listMap[lid];
    var acc2=r.total?Math.round(r.ok/r.total*100):0;
    return {lid:lid, name:lst?lst.name:'（削除済みリスト）', lang:lst?lst.lang:'', sessions:r.sessions, total:r.total, ok:r.ok, acc:acc2, durMs:r.durMs};
  }).sort(function(a,b){return b.durMs-a.durMs;});

  /* エビングハウス今後30日予測 */
  var ebbingForecast = getEbbingForecast();

  /* HTML生成（1ウィンドウ・タブ切り替え） */
  var h=buildCombinedReportHTML(periodLabel, now,
    totalSessions, totalQ, totalOk, totalNg, avgAcc, totalDurMs,
    dayKeys, dayMap, logs, modeData, listData, period,
    filterAll?[]:listNames,
    missArr, slowArr, ebbingForecast);

  /* 別ウィンドウを1つだけ開く */
  var w=window.open('','_blank','width=900,height=700');
  if(!w){toast('ポップアップをブロックされました。ブラウザの設定を確認してください');return;}
  w.document.write(h);
  w.document.close();
}

function fmtDate(d){
  return d.getFullYear()+'年'+(d.getMonth()+1)+'月'+d.getDate()+'日';
}
function fmtDateShort(s){
  var d=new Date(s);return (d.getMonth()+1)+'/'+d.getDate();
}

function buildCombinedReportHTML(title, now, sessions, totalQ, ok, ng, acc, totalDurMs, dayKeys, dayMap, logs, modeData, listData, period, targetListNames, missArr, slowArr, ebbingForecast){

  ebbingForecast = ebbingForecast || [];

  function makeEbbingHTML(forecast){
    if(!forecast||!forecast.length)forecast=[];
    var hasDue=forecast.some(function(d){return d.words.length>0;});
    var maxN=Math.max.apply(null,forecast.map(function(d){return d.words.length;}).concat([1]));
    var GW=580, GH=130, PL=30, PR=10, PB=28, PT=14;
    var IW=GW-PL-PR, IH=GH-PT-PB;
    var step=IW/31;
    /* グリッド */
    var grid='';
    [0,0.5,1].forEach(function(r){
      var y=PT+IH-Math.round(r*IH);
      grid+='<line x1="'+PL+'" y1="'+y+'" x2="'+(GW-PR)+'" y2="'+y+'" stroke="#dde" stroke-width="'+(r===0||r===1?'1':'0.5')+'" stroke-dasharray="'+(r>0&&r<1?'3,3':'0')+'"/>';
      if(r>0||r===0) grid+='<text x="'+(PL-3)+'" y="'+(y+3)+'" text-anchor="end" font-size="7" fill="#888">'+Math.round(maxN*r)+'</text>';
    });
    /* 折れ線と点 */
    var pts=[];
    forecast.forEach(function(d,i){
      var cx=PL+i*step+step/2;
      var cy=PT+IH-(d.words.length/maxN*IH);
      pts.push({cx:cx,cy:cy,n:d.words.length,diff:d.diff,words:d.words});
    });
    var line='';
    for(var i=1;i<pts.length;i++){
      var p=pts[i-1],q=pts[i];
      if(p.n>0||q.n>0){
        line+='<line x1="'+p.cx.toFixed(1)+'" y1="'+p.cy.toFixed(1)+'" x2="'+q.cx.toFixed(1)+'" y2="'+q.cy.toFixed(1)+'" stroke="#7c5cfc" stroke-width="2" opacity="0.8"/>';
      }
    }
    var dots='';
    pts.forEach(function(p){
      if(p.n>0){
        dots+='<circle cx="'+p.cx.toFixed(1)+'" cy="'+p.cy.toFixed(1)+'" r="4" fill="'+(p.diff===0?'#fc5c7d':'#7c5cfc')+'" stroke="#fff" stroke-width="1.5" class="eb-dot" data-diff="'+p.diff+'" style="cursor:pointer"/>';
      }
    });
    /* X軸ラベル (週ごと) */
    var xlbls='';
    [0,7,14,21,28,30].forEach(function(d){
      var cx=PL+d*step+step/2;
      var dt=new Date(); dt.setDate(dt.getDate()+d);
      var label=d===0?'今日':(dt.getMonth()+1)+'/'+(dt.getDate());
      xlbls+='<text x="'+cx.toFixed(1)+'" y="'+(GH-4)+'" text-anchor="middle" font-size="7.5" fill="'+(d===0?'#fc5c7d':'#555')+'">'+label+'</text>';
    });
    /* データなしのとき空グラフ + メッセージ */
    if(!hasDue){
      return '<div style="overflow-x:auto">'+
        '<svg viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:160px;display:block">'+grid+xlbls+'</svg>'+
        '</div><p style="color:#888;font-size:9pt;margin-top:4px">📭 現在、忘却曲線の復習予定はありません。クイズで間違えた単語が登録されると表示されます。</p>';
    }
    var svgHtml='<svg id="ebbing-svg" viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:160px;display:block;cursor:default">'+grid+line+dots+xlbls+'</svg>';

    /* ツールチップ用データをJSON埋め込み */
    var tooltipData=JSON.stringify(pts.map(function(p){return{diff:p.diff,n:p.n,words:p.words};}));

    var html='<div style="overflow-x:auto;position:relative" id="ebbing-chart-wrap">'+svgHtml+
      '<div id="eb-tooltip" style="display:none;position:absolute;background:#1a1a2e;border:1px solid #7c5cfc;border-radius:10px;padding:10px 14px;font-size:9.5pt;min-width:180px;max-width:280px;z-index:100;pointer-events:none;box-shadow:0 4px 16px rgba(0,0,0,.3)">'+
        '<div id="eb-tip-title" style="font-weight:700;color:#7c5cfc;margin-bottom:6px"></div>'+
        '<div id="eb-tip-list" style="color:#dde;line-height:1.8"></div>'+
      '</div>'+
    '</div>'+
    '<script>(function(){'+
      'var data='+tooltipData+';'+
      'var svg=document.getElementById("ebbing-svg");'+
      'var wrap=document.getElementById("ebbing-chart-wrap");'+
      'var tip=document.getElementById("eb-tooltip");'+
      'if(!svg||!tip)return;'+
      'svg.querySelectorAll(".eb-dot").forEach(function(dot){'+
        'dot.addEventListener("mouseover",function(e){'+
          'var diff=parseInt(this.getAttribute("data-diff"));'+
          'var d=data.find(function(x){return x.diff===diff;});'+
          'if(!d||!d.n)return;'+
          'var dt=new Date(); dt.setDate(dt.getDate()+diff);'+
          'var label=diff===0?"今日（期限切れ含む）":(dt.getMonth()+1)+"月"+(dt.getDate())+"日（"+diff+"日後）";'+
          'document.getElementById("eb-tip-title").textContent=label+" — "+d.n+"単語";'+
          'document.getElementById("eb-tip-list").innerHTML=d.words.map(function(w){'+
            'return "<span style=\"color:#ffd700;font-weight:600\">"+w.word+"</span> <span style=\"color:#aac;font-size:8.5pt\">"+w.meaning+"</span>";'+
          '}).join("<br>");'+
          'tip.style.display="block";'+
          'var rect=wrap.getBoundingClientRect();'+
          'var dotRect=this.getBoundingClientRect();'+
          'var tx=dotRect.left-rect.left+8;'+
          'var ty=dotRect.top-rect.top-10;'+
          'if(tx+280>rect.width)tx=tx-290;'+
          'tip.style.left=tx+"px"; tip.style.top=ty+"px";'+
        '});'+
        'dot.addEventListener("mouseleave",function(){tip.style.display="none";});'+
      '});'+
    '})();<\/script>';
    return html;
  }
  var ebbingHTML = makeEbbingHTML(ebbingForecast);

  function fmtDur(ms){
    if(!ms||ms<1000)return '0分';
    var s=Math.round(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60);
    if(h>0)return h+'時間'+(m%60)+'分';
    if(m>0)return m+'分'+(s%60>0?s%60+'秒':'');
    return s+'秒';
  }

  /* ── SVG：複合グラフ ── */
  function makeComboSVG(labels,durMins,accPcts){
    var n=labels.length;
    if(!n)return '<p style="color:#888;font-size:9pt;margin:8px 0">データがありません</p>';
    var GW=560,GH=120,PAD_L=36,PAD_R=36,PAD_B=22,PAD_T=14;
    var IW=GW-PAD_L-PAD_R,IH=GH-PAD_T-PAD_B;
    var bw=Math.min(36,Math.floor(IW/n)-3),step=IW/n;
    var maxDur=Math.max.apply(null,durMins.concat([1]));
    var grid='',yLbls='';
    [0,0.25,0.5,0.75,1].forEach(function(r){
      var y=PAD_T+IH-Math.round(r*IH);
      grid+='<line x1="'+PAD_L+'" y1="'+y+'" x2="'+(GW-PAD_R)+'" y2="'+y+'" stroke="'+(r===0||r===1?'#ccc':'#eee')+'" stroke-width="'+(r===0||r===1?'1':'0.5')+'" stroke-dasharray="'+(r>0&&r<1?'3,3':'0')+'"/>';
      yLbls+='<text x="'+(PAD_L-4)+'" y="'+(y+3)+'" text-anchor="end" font-size="7" fill="#888">'+Math.round(maxDur*r)+'</text>';
      yLbls+='<text x="'+(GW-PAD_R+4)+'" y="'+(y+3)+'" text-anchor="start" font-size="7" fill="#5c9cf8">'+(100*r|0)+'%</text>';
    });
    var bars='',barLbls='',xlbls='',lineP='',lineDots='';
    durMins.forEach(function(v,i){
      var bh=maxDur?Math.max(v>0?2:0,Math.round(v/maxDur*IH)):0;
      var cx=PAD_L+i*step+step/2,bx=cx-bw/2,by=PAD_T+IH-bh;
      bars+='<rect x="'+bx.toFixed(1)+'" y="'+by+'" width="'+bw+'" height="'+bh+'" fill="#7c5cfc" rx="2" opacity="0.75"/>';
      if(bh>13)barLbls+='<text x="'+cx.toFixed(1)+'" y="'+(by-2)+'" text-anchor="middle" font-size="6.5" fill="#7c5cfc">'+v+'分</text>';
      var show=(n<=14)||(i%Math.ceil(n/14)===0)||(i===n-1);
      if(show)xlbls+='<text x="'+cx.toFixed(1)+'" y="'+(GH-4)+'" text-anchor="middle" font-size="7" fill="#888">'+labels[i]+'</text>';
      var ap=accPcts[i],ly=PAD_T+IH-Math.round(ap/100*IH);
      lineDots+='<circle cx="'+cx.toFixed(1)+'" cy="'+ly+'" r="2.5" fill="'+(ap>=80?'#4cff91':ap>=60?'#ffd700':'#fc5c7d')+'" stroke="#fff" stroke-width="1"/>';
      if(i>0){var px=PAD_L+(i-1)*step+step/2,py=PAD_T+IH-Math.round(accPcts[i-1]/100*IH);lineP+='<line x1="'+px.toFixed(1)+'" y1="'+py+'" x2="'+cx.toFixed(1)+'" y2="'+ly+'" stroke="#5c9cf8" stroke-width="1.5" opacity="0.8"/>';}
    });
    var legend='<text x="'+(PAD_L+4)+'" y="'+(PAD_T-4)+'" font-size="7" fill="#7c5cfc">■ 学習時間（分）</text><text x="'+(PAD_L+80)+'" y="'+(PAD_T-4)+'" font-size="7" fill="#5c9cf8">— 正答率</text>';
    return '<div style="overflow-x:auto"><svg viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:160px;display:block">'+grid+bars+barLbls+lineP+lineDots+xlbls+yLbls+legend+'</svg></div>';
  }

  function makeModeSVG(modeData){
    if(!modeData||!modeData.length)return '';
    var n=modeData.length,GW=560,GH=100,PAD_L=10,PAD_R=10,PAD_B=22,PAD_T=10;
    var IW=GW-PAD_L-PAD_R,IH=GH-PAD_T-PAD_B;
    var step=IW/n,bw=Math.min(60,step-12);
    var maxMs=Math.max.apply(null,modeData.map(function(m){return m.ms;}).concat([1]));
    var grid='',yLbls='';
    [0,0.5,1].forEach(function(r){
      var y=PAD_T+IH-Math.round(r*IH);
      grid+='<line x1="'+PAD_L+'" y1="'+y+'" x2="'+(GW-PAD_R)+'" y2="'+y+'" stroke="'+(r===0||r===1?'#ccc':'#eee')+'" stroke-width="1"/>';
      if(r>0)yLbls+='<text x="'+(PAD_L-2)+'" y="'+(y+3)+'" text-anchor="end" font-size="7" fill="#888">'+fmtDur(maxMs*r)+'</text>';
    });
    var bars='',barLbls='',xlbls='';
    modeData.forEach(function(m,i){
      var bh=maxMs?Math.max(m.ms>0?2:0,Math.round(m.ms/maxMs*IH)):0;
      var cx=PAD_L+i*step+step/2,bx=cx-bw/2,by=PAD_T+IH-bh;
      bars+='<rect x="'+bx.toFixed(1)+'" y="'+by+'" width="'+bw+'" height="'+bh+'" fill="'+m.color+'" rx="3" opacity="0.85"/>';
      if(bh>13)barLbls+='<text x="'+cx.toFixed(1)+'" y="'+(by-2)+'" text-anchor="middle" font-size="7" fill="'+m.color+'">'+fmtDur(m.ms)+'</text>';
      xlbls+='<text x="'+cx.toFixed(1)+'" y="'+(GH-4)+'" text-anchor="middle" font-size="7.5" fill="#555">'+m.label+'</text>';
    });
    return '<div style="overflow-x:auto"><svg viewBox="0 0 '+GW+' '+GH+'" style="width:100%;max-height:130px;display:block">'+grid+bars+barLbls+xlbls+yLbls+'</svg></div>';
  }

  /* グラフデータ */
  var comboLabels=[],comboDurMins=[],comboAccPcts=[];
  if(period==='day'||period==='week'){
    comboLabels=dayKeys.map(function(d){return fmtDateShort(d);});
    comboDurMins=dayKeys.map(function(d){return Math.round((dayMap[d].durMs||0)/60000);});
    comboAccPcts=dayKeys.map(function(d){var r=dayMap[d];return r.total?Math.round(r.ok/r.total*100):0;});
  } else {
    var weekMap={};
    dayKeys.forEach(function(d){
      var dt=new Date(d),dow=dt.getDay()||7,mon=new Date(dt);
      mon.setDate(dt.getDate()-(dow-1));
      var wk=mon.toISOString().slice(0,10);
      if(!weekMap[wk])weekMap[wk]={durMs:0,ok:0,total:0};
      weekMap[wk].durMs+=(dayMap[d].durMs||0);
      weekMap[wk].ok+=dayMap[d].ok; weekMap[wk].total+=dayMap[d].total;
    });
    var wkKeys=Object.keys(weekMap).sort();
    comboLabels=wkKeys.map(function(k){var d=new Date(k);return(d.getMonth()+1)+'/'+(d.getDate())+'〜';});
    comboDurMins=wkKeys.map(function(k){return Math.round(weekMap[k].durMs/60000);});
    comboAccPcts=wkKeys.map(function(k){var r=weekMap[k];return r.total?Math.round(r.ok/r.total*100):0;});
  }
  var comboSVG=makeComboSVG(comboLabels,comboDurMins,comboAccPcts);
  var modeSVG=makeModeSVG(modeData);
  var graphSection='';
  if(dayKeys.length>0){
    graphSection=
      '<h2>📊 学習状況グラフ</h2>'+
      '<div style="background:#f8f8ff;border:1px solid #e8e8f8;border-radius:8px;padding:12px;margin-bottom:14px">'+
        '<div style="font-size:9pt;font-weight:600;color:#555;margin-bottom:6px">⏱️ 学習時間（棒）＋ 📈 正答率（折れ線）</div>'+comboSVG+
      '</div>'+
      (modeSVG?'<div style="background:#f8f8ff;border:1px solid #e8e8f8;border-radius:8px;padding:12px;margin-bottom:14px"><div style="font-size:9pt;font-weight:600;color:#555;margin-bottom:6px">🎯 モード別学習時間</div>'+modeSVG+'</div>':'');
  }

  /* 日別テーブル */
  var langNames={en:'英語',de:'ドイツ語',fr:'フランス語',es:'スペイン語',it:'イタリア語'};
  var dayRows='';
  dayKeys.forEach(function(d){
    var r=dayMap[d],a=r.total?Math.round(r.ok/r.total*100):0;
    var clr=a>=80?'#2e7d32':a>=60?'#f57c00':'#c62828';
    dayRows+='<tr><td>'+d.replace(/-/g,'/')+'</td><td>'+r.sessions+'</td><td>'+r.total+'</td><td>'+r.ok+'</td><td>'+r.ng+'</td>'+
      '<td><span style="color:'+clr+';font-weight:700">'+a+'%</span></td><td>'+fmtDur(r.durMs||0)+'</td></tr>';
  });
  if(!dayRows)dayRows='<tr><td colspan="7" style="text-align:center;color:#888;padding:14px">この期間の記録はありません</td></tr>';

  /* 単語集テーブル */
  var listRows='';
  if(listData&&listData.length){
    listData.forEach(function(d){
      var l=LANGS[d.lang||'en'];
      var clr=d.acc>=80?'#2e7d32':d.acc>=60?'#f57c00':'#c62828';
      listRows+='<tr><td><strong>'+escHtml(d.name)+'</strong></td><td>'+(l?l.flag+' '+l.name:'—')+'</td>'+
        '<td style="text-align:center">'+d.sessions+'</td><td style="text-align:center">'+d.total+'</td>'+
        '<td style="text-align:center;color:'+clr+';font-weight:700">'+d.acc+'%</td><td>'+fmtDur(d.durMs)+'</td></tr>';
    });
  } else {
    listRows='<tr><td colspan="6" style="text-align:center;color:#888;padding:14px">データがありません</td></tr>';
  }

  /* 苦手単語テーブル */
  var missRows='';
  if(missArr&&missArr.length){
    missArr.forEach(function(w,i){
      missRows+='<tr><td style="text-align:center">'+(i+1)+'</td><td><strong>'+escHtml(w.word)+'</strong></td>'+
        '<td>'+escHtml(w.meaning)+'</td><td>'+(langNames[w.lang]||w.lang)+'</td>'+
        '<td style="color:#c62828;font-weight:700;text-align:center">'+w.count+'回</td></tr>';
    });
  } else {
    missRows='<tr><td colspan="5" style="text-align:center;color:#888;padding:14px">間違いはありませんでした 🎉</td></tr>';
  }

  /* 準苦手テーブル */
  var slowRows='';
  if(slowArr&&slowArr.length){
    slowArr.forEach(function(w,i){
      var avgSec=(w.avgMs/1000).toFixed(1);
      var secClr=w.avgMs>=15000?'#c62828':w.avgMs>=10000?'#f57c00':'#e65100';
      var medal=i===0?'🥇':i===1?'🥈':i===2?'🥉':'';
      slowRows+='<tr><td style="text-align:center">'+(medal||'<span style="color:#aaa">'+(i+1)+'</span>')+'</td>'+
        '<td><strong>'+escHtml(w.word)+'</strong></td><td>'+escHtml(w.meaning)+'</td>'+
        '<td>'+(langNames[w.lang]||w.lang)+'</td>'+
        '<td style="color:'+secClr+';font-weight:700;text-align:center">'+avgSec+'秒</td>'+
        '<td style="text-align:center;color:#888">'+w.count+'回</td></tr>';
    });
  } else {
    slowRows='<tr><td colspan="6" style="text-align:center;color:#888;padding:14px">5秒以上かかった単語はありません 👍</td></tr>';
  }

  var badges=(targetListNames&&targetListNames.length)?
    '<div style="margin-bottom:12px">'+targetListNames.map(function(n){return'<span style="display:inline-block;background:#7c5cfc22;color:#7c5cfc;border:1px solid #7c5cfc44;border-radius:6px;padding:2px 10px;font-size:9pt;font-weight:600;margin:0 3px 3px 0">'+escHtml(n)+'</span>';}).join('')+'</div>':'';

  /* ── 学習報告書ページ ── */
  var page1=
    '<div id="tab-summary" class="tab-content" style="display:block">'+
    '<h1>📊 VocabMaster 学習報告書</h1>'+
    '<div class="subtitle">'+escHtml(title)+' ｜ 作成：'+fmtDate(now)+' '+now.getHours()+'時'+String(now.getMinutes()).padStart(2,'0')+'分</div>'+
    badges+
    '<div class="summary-grid">'+
      '<div class="summary-box"><div class="summary-n">'+sessions+'</div><div class="summary-l">セッション数</div></div>'+
      '<div class="summary-box"><div class="summary-n">'+totalQ+'</div><div class="summary-l">総出題数</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#2e7d32">'+ok+'</div><div class="summary-l">正解数</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#'+(acc>=80?'2e7d32':acc>=60?'f57c00':'c62828')+'">'+acc+'%</div><div class="summary-l">平均正答率</div></div>'+
      '<div class="summary-box"><div class="summary-n" style="color:#7c5cfc;font-size:14pt">'+fmtDur(totalDurMs)+'</div><div class="summary-l">総学習時間</div></div>'+
    '</div>'+
    graphSection+
    '<h2>🧠 エビングハウス忘却曲線 — 今後30日の復習予定</h2>'+
    '<div style="background:#f0f0ff;border:1px solid #d0d0f0;border-radius:8px;padding:12px;margin-bottom:14px">'+
      '<div style="font-size:9pt;color:#555;margin-bottom:8px">📍 横軸: 今後の日付 ／ 縦軸: 復習すべき単語数 ／ 点にカーソルを合わせると単語一覧が表示されます</div>'+
      ebbingHTML+
    '</div>'+
    '<h2>📋 日別学習記録</h2>'+
    '<table><tr><th>日付</th><th>セッション</th><th>出題数</th><th>正解</th><th>不正解</th><th>正答率</th><th>学習時間</th></tr>'+dayRows+'</table>'+
    '</div>';

  /* ── 単語レポートページ ── */
  var page2=
    '<div id="tab-words" class="tab-content" style="display:none">'+
    '<h1>📝 単語レポート</h1>'+
    '<div class="subtitle">'+escHtml(title)+' ｜ 作成：'+fmtDate(now)+' '+now.getHours()+'時'+String(now.getMinutes()).padStart(2,'0')+'分</div>'+
    badges+
    '<h2 style="border-left-color:#7c5cfc">📚 使用した単語集</h2>'+
    '<table><tr><th style="background:#7c5cfc">単語集名</th><th style="background:#7c5cfc">言語</th><th style="background:#7c5cfc">セッション</th><th style="background:#7c5cfc">出題数</th><th style="background:#7c5cfc">正答率</th><th style="background:#7c5cfc">学習時間</th></tr>'+listRows+'</table>'+
    '<h2 style="border-left-color:#c62828">❌ 苦手単語（不正解が多い順）</h2>'+
    '<table><tr><th style="background:#c62828">#</th><th style="background:#c62828">単語</th><th style="background:#c62828">意味</th><th style="background:#c62828">言語</th><th style="background:#c62828">間違い回数</th></tr>'+missRows+'</table>'+
    '<h2 style="border-left-color:#e65100">⏱️ 準苦手ランキング（回答に時間がかかった単語）</h2>'+
    '<div style="font-size:9pt;color:#888;margin:-8px 0 10px">正解したが5秒以上かかった単語 ／ 平均回答時間の長い順</div>'+
    '<table><tr><th style="background:#e65100">#</th><th style="background:#e65100">単語</th><th style="background:#e65100">意味</th><th style="background:#e65100">言語</th><th style="background:#e65100">平均回答時間</th><th style="background:#e65100">計測回数</th></tr>'+slowRows+'</table>'+
    '</div>';

  return '<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">'+
    '<title>'+escHtml(title)+'</title>'+
    '<style>'+
    '@page{size:A4;margin:12mm 12mm 18mm 12mm}'+
    'body{font-family:"Hiragino Sans","Yu Gothic","Meiryo",Arial,sans-serif;font-size:10.5pt;color:#1a1a2e;background:#fff;margin:0;padding:0}'+
    '.topbar{display:flex;gap:8px;align-items:center;padding:12px 20px;background:#1a1a2e;position:sticky;top:0;z-index:10}'+
    '.tab-btn{padding:8px 20px;border:none;border-radius:8px;font-size:11pt;font-weight:600;cursor:pointer;font-family:inherit;background:rgba(255,255,255,.15);color:#fff}'+
    '.tab-btn.active{background:#7c5cfc;color:#fff}'+
    '.btn-print{padding:8px 18px;background:#4caf50;color:#fff;border:none;border-radius:8px;font-size:11pt;font-weight:600;cursor:pointer;font-family:inherit;margin-left:auto}'+
    '.btn-close{padding:8px 14px;background:#888;color:#fff;border:none;border-radius:8px;font-size:11pt;cursor:pointer;font-family:inherit}'+
    '.tab-content{max-width:800px;margin:0 auto;padding:20px 20px 40px}'+
    'h1{font-size:18pt;color:#1a1a2e;border-bottom:3px solid #7c5cfc;padding-bottom:8px;margin-bottom:6px}'+
    'h2{font-size:12pt;color:#1a1a2e;border-left:4px solid #7c5cfc;padding-left:10px;margin:22px 0 10px}'+
    '.subtitle{color:#666;font-size:9.5pt;margin-bottom:14px}'+
    '.summary-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:20px}'+
    '.summary-box{background:#f8f8ff;border:1px solid #e0e0f0;border-radius:8px;padding:10px;text-align:center}'+
    '.summary-n{font-size:17pt;font-weight:700;color:#7c5cfc}'+
    '.summary-l{font-size:8pt;color:#666;margin-top:4px}'+
    'table{width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:8px}'+
    'th{background:#1a1a2e;color:#fff;padding:7px 8px;text-align:left;font-weight:600}'+
    'td{padding:6px 8px;border-bottom:1px solid #eee}'+
    'tr:nth-child(even) td{background:#f8f8ff}'+
    '.footer{margin-top:20px;padding-top:10px;border-top:1px solid #ddd;font-size:8pt;color:#aaa;text-align:center}'+
    '@media print{.topbar{display:none!important}.tab-content{display:block!important}h1{page-break-before:always}h1:first-child{page-break-before:avoid}th{-webkit-print-color-adjust:exact;print-color-adjust:exact}}'+
    '</style>'+
    '<script>'+
    'function showTab(id){'+
      'document.querySelectorAll(".tab-content").forEach(function(el){el.style.display="none";});'+
      'document.getElementById(id).style.display="block";'+
      'document.querySelectorAll(".tab-btn").forEach(function(b){b.classList.remove("active");});'+
      'document.querySelector("[data-tab="+id+"]").classList.add("active");'+
    '}'+
    '<\/script>'+
    '</head><body>'+
    '<div class="topbar no-print">'+
      '<button class="tab-btn active" data-tab="tab-summary" onclick="showTab(\'tab-summary\')">📊 学習報告書</button>'+
      '<button class="tab-btn" data-tab="tab-words" onclick="showTab(\'tab-words\')">📝 単語レポート</button>'+
      '<button class="btn-print" onclick="window.print()">🖨️ 印刷</button>'+
      '<button class="btn-close" onclick="window.close()">✕</button>'+
    '</div>'+
    page1+page2+
    '</body></html>';
}


function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* リスト選択モーダル（予習→クイズ / テスト形式） */
function showListSelectModal(mode){
  if(!G.lists.length){toast('単語リストがありません');return;}
  var isStudy=(mode==='study');
  var title=isStudy?'📖 予習→クイズ：リストを選択':'📝 テスト形式：リストを選択';
  var sub=isStudy?'予習（フラッシュカード）の後に同じ単語でクイズ':'予習なし・SRS更新なし・採点のみ';
  var html='<div class="modal-tl">'+title+'</div>';
  html+='<div style="font-size:11px;color:var(--tx2);margin-bottom:12px">'+sub+'</div>';
  G.lists.forEach(function(lst){
    var l=LANGS[lst.lang||'en'];
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var cnt=ws.length;
    var cursor=lst.cursor||0; if(cursor>=cnt)cursor=0;
    var pct=cnt>0?Math.min(100,Math.round(cursor/cnt*100)):0;
    var progClr=pct>=100?'#4cff91':pct>=60?'#5cf8fc':'#7c5cfc';
    html+='<button class="list-sel-btn" data-lid="'+esc(lst.id)+'" style="display:flex;align-items:center;gap:10px;width:100%;background:var(--sf2);border:none;border-radius:12px;padding:12px 14px;margin-bottom:8px;cursor:pointer;font-family:inherit;text-align:left;-webkit-appearance:none;">'+
      '<div style="width:36px;height:36px;border-radius:9px;background:'+lst.clr+'20;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">'+(l?l.flag:'📗')+'</div>'+
      '<div style="flex:1;min-width:0">'+
        '<div style="font-size:14px;font-weight:600;color:var(--tx)">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
        '<div style="font-size:11px;color:var(--tx2);margin-top:2px">'+cnt+'単語 · 進捗 '+pct+'%</div>'+
        '<div style="height:3px;background:rgba(255,255,255,.1);border-radius:2px;margin-top:5px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+progClr+';border-radius:2px"></div></div>'+
      '</div>'+
      '<div style="font-size:18px;color:var(--tx2)">›</div></button>';
  });
  el('modal-ct').innerHTML=html;
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.list-sel-btn').forEach(function(b){
    b.addEventListener('click',function(){
      var lid=this.getAttribute('data-lid');
      var lst=G.lists.find(function(l){return l.id===lid;});
      var ws=G.words.filter(function(w){return w.lid===lid;});
      if(ws.length<2){toast('クイズには最低2単語必要です');return;}
      el('modal-bg').classList.remove('on');
      var size=Math.min(parseInt(G.cfg.size)||20, ws.length);
      var cursor=lst.cursor||0; if(cursor>=ws.length)cursor=0;
      var remaining=ws.slice(cursor);
      var pool;
      if(G.cfg.random){
        pool=shuffle(remaining).slice(0,size);
      } else {
        pool=remaining.slice(0,size);
      }
      if(pool.length<2){
        pool=G.cfg.random ? shuffle(ws.slice()).slice(0,size) : ws.slice(0,size);
      }
      var nextCursor=Math.min(cursor+size, ws.length);
      if(isStudy){
        Q._pendingCursor={lid:lid, next:nextCursor};
        flashStart((G.cfg.random ? shuffle(pool.slice()) : pool.slice()),'list',lid);
      } else {
        var tpool=G.cfg.random ? shuffle(pool.slice()) : pool.slice();
        Q={words:tpool,q:tpool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:true,quizMode:'test',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
        go('s-quiz');qRender();
      }
    });
  });
}

function quizStart(mode,lid){
  var pool=[];
  if(mode==='due'){
    pool=getDue();
    if(G.cfg.ebbing){
      var ebDue=getEbbingDue();
      var poolIds=pool.map(function(w){return w.id;});
      ebDue.forEach(function(w){if(poolIds.indexOf(w.id)<0){pool.push(w);}});
    }
  }
  else if(mode==='all')pool=G.words.slice();
  else if(mode==='weak'){pool=getWeak();if(!pool.length){toast('間違えた単語がありません');return;}}
  else if(mode==='list')pool=G.words.filter(function(w){return w.lid===lid;});
  if(pool.length<2){toast('クイズには最低2単語必要です');return;}
  var size=Math.min(pool.length,parseInt(G.cfg.size)||20);
  var ws=(G.cfg.random ? shuffle(pool) : pool).slice(0,size);
  Q={words:ws,q:ws.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:mode,sessionStart:Date.now(),
     consec:{},mastered:0,masteredIds:{}}; /* consec: wordId→連続正解数 */
  go('s-quiz');qRender();
}

function isPhrase(word){
  /* スペースを含む場合は熟語とみなす */
  return word && word.trim().indexOf(' ')>=0;
}

function qRender(){
  var q=Q.q[Q.i];if(!q){qResult();return;}
  if(Q.i===0&&!Q.sessionStart)Q.sessionStart=Date.now();

  var totalWords=Q.words.length;
  var mastered=Q.mastered||0;
  el('QZ-fill').style.width=(mastered/totalWords*100)+'%';
  el('QZ-cnt').textContent=mastered+'/'+totalWords;
  el('QZ-mode-badge').style.display=Q.testMode?'inline-block':'none';
  var rev=G.cfg.rev&&Math.random()<0.3;Q.rev=rev;
  var l=LANGS[q.lang||'en'];
  el('QZ-badge').textContent=rev?(l?l.name:'外国語')+'を選べ':'日本語を選べ';
  var displayWord=rev?(q.meaning||q.word):q.word;
  el('QZ-word').textContent=displayWord;
  Q.done=false;

  /* 発音ボタン — 外国語が表示されているときだけ表示 */
  var spk=el('B-speak');
  var isForLang=!rev;
  if(isForLang&&window.speechSynthesis){
    spk.style.display='inline-block';
    spk.onclick=function(){speak(q.word, q.lang||'en');};
    /* 自動読み上げがオンのとき */
    if(G.cfg.speak!==false){speak(q.word, q.lang||'en');}
  } else {
    spk.style.display='none';
    if(window.speechSynthesis)window.speechSynthesis.cancel();
  }

  var ca=rev?q.word:(q.meaning||'（訳なし）');
  /* 熟語/単語を区別してダミー選択肢を選ぶ */
  var qIsPhrase=isPhrase(q.word);
  var sameLang=G.words.filter(function(w){
    return w.id!==q.id&&(w.lang||'en')===(q.lang||'en')&&isPhrase(w.word)===qIsPhrase;
  });
  /* 同種類が3件未満なら言語・タイプを緩和 */
  if(sameLang.length<3){
    sameLang=G.words.filter(function(w){return w.id!==q.id&&(w.lang||'en')===(q.lang||'en');});
  }
  var others=sameLang.length>=3?sameLang:G.words.filter(function(w){return w.id!==q.id;});
  var dist=shuffle(others).slice(0,3).map(function(w){return rev?w.word:(w.meaning||w.word);});
  var choices=shuffle([ca].concat(dist).slice(0,4));
  while(choices.length<4)choices.push('---');
  Q.ca=ca;Q.ci=choices.indexOf(ca);
  var L=['A','B','C','D'],h='';
  choices.forEach(function(c,i){
    h+='<button class="ch-btn" data-i="'+i+'"><div class="ch-lt">'+L[i]+'</div><div class="ch-tx">'+esc(c)+'</div><div class="ch-ic"></div></button>';
  });
  h+='<button class="ch-dk" id="QZ-dontknow">❓ 分からない</button>';
  el('QZ-choices').innerHTML=h;
  el('QZ-choices').querySelectorAll('.ch-btn').forEach(function(b){b.addEventListener('click',function(){qSelect(parseInt(this.getAttribute('data-i')));});});
  el('QZ-choices').querySelector('#QZ-dontknow').addEventListener('click',function(){qDontKnow();});
  el('FB').classList.remove('on');
  Q.qStartTime=Date.now();
}

function qDontKnow(){
  if(Q.done)return;Q.done=true;
  var answerMs=Q.qStartTime?Date.now()-Q.qStartTime:0;
  /* 全ボタン無効化 */
  el('QZ-choices').querySelectorAll('.ch-btn,.ch-dk').forEach(function(b){b.classList.add('done');});
  /* 正解を緑でハイライト */
  var btns=el('QZ-choices').querySelectorAll('.ch-btn');
  btns[Q.ci].classList.add('ok');
  btns[Q.ci].querySelector('.ch-ic').textContent='✓';
  var q=Q.q[Q.i];
  q._answerMs=answerMs;
  /* 不正解と同じ扱い（SRS更新・miss追加） */
  answer(q,false);
  Q.ng++;
  Q.miss.push(q);
  /* hadMissフラグ → 2回連続正解が必要になる */
  if(!Q.consec)Q.consec={};
  q._hadMiss=true;
  Q.consec[q.id]=0;
  /* 習得カウントは増やさない */
  el('FB-tx').innerHTML='<span style="color:var(--ac3)">❓ 分からない</span> → <span style="color:var(--gn)">'+esc(Q.ca)+'</span>';
  el('FB-dt').textContent=Q.testMode?'':'1日後に再復習';
  el('FB').classList.add('on');
}

function qSelect(i){
  if(Q.done)return;Q.done=true;
  var answerMs=Q.qStartTime?Date.now()-Q.qStartTime:0;
  var btns=el('QZ-choices').querySelectorAll('.ch-btn');
  btns.forEach(function(b){b.classList.add('done');});
  var ok=(i===Q.ci);
  btns[i].classList.add(ok?'ok':'ng');
  btns[i].querySelector('.ch-ic').textContent=ok?'✓':'✗';
  if(!ok){btns[Q.ci].classList.add('ok');btns[Q.ci].querySelector('.ch-ic').textContent='✓';}
  var q=Q.q[Q.i];
  q._answerMs=answerMs;
  answer(q,ok);
  ok?Q.ok++:(Q.ng++,Q.miss.push(q));
  if(ok&&answerMs>=5000){
    if(!Q.slow)Q.slow=[];
    Q.slow.push({id:q.id,word:q.word,meaning:q.meaning||'',lang:q.lang||'en',lid:q.lid,answerMs:answerMs});
  }
  /* 習得判定：初回正解で即習得。不正解後は2回連続正解で習得 */
  if(!Q.consec)Q.consec={};
  if(!Q.masteredIds)Q.masteredIds={};
  var hadMiss=!!q._hadMiss;
  if(!ok){ q._hadMiss=true; Q.consec[q.id]=0; }
  else { Q.consec[q.id]=(Q.consec[q.id]||0)+1; }
  var justMastered=ok&&(!hadMiss||Q.consec[q.id]>=2)&&!Q.masteredIds[q.id];
  if(justMastered){Q.masteredIds[q.id]=true;Q.mastered=(Q.mastered||0)+1;}

  el('FB-tx').innerHTML=ok
    ?(justMastered?'<span style="color:var(--gn)">✓ 正解！</span>':'<span style="color:var(--gn)">✓ 正解！ もう1回！</span>')
    :'<span style="color:var(--rd)">✗ 不正解</span> → '+esc(Q.ca);
  el('FB-dt').textContent=Q.testMode?'':(ok?'次回: '+(q.s&&q.s.i||1)+'日後':'1日後に再復習');
  el('FB').classList.add('on');
  /* 自動進行 — 正解時のみ（不正解は手動で確認させる） */
  if(ok&&G.cfg.autonext){
    var delay=Math.round((G.cfg.autonextSec||1.5)*1000);
    var remaining=Math.ceil(G.cfg.autonextSec||1.5);
    el('B-next').textContent='次へ ('+remaining+'秒)';
    var countdown=setInterval(function(){
      remaining--;
      if(remaining>0){el('B-next').textContent='次へ ('+remaining+'秒)';}
      else{clearInterval(countdown);}
    },1000);
    Q._autoTimer=setTimeout(function(){
      clearInterval(countdown);
      el('B-next').textContent='次へ →';
      if(Q.done)qNext();
    },delay);
  }
}

function qNext(){
  if(Q._autoTimer){clearTimeout(Q._autoTimer);Q._autoTimer=null;}
  el('B-next').textContent='次へ →';

  var q=Q.q[Q.i];
  /* 不正解経験あり かつ 再出題回数が上限未満の場合のみ再出題 */
  var requeueMax=G.cfg.requeueMax!=null?G.cfg.requeueMax:1;
  if(!Q.requeued)Q.requeued={};
  var remaining=Q.q.length-(Q.i+1);
  /* masteredIds にある（2回連続正解済み）場合は再出題しない */
  var alreadyMastered=Q.masteredIds&&Q.masteredIds[q&&q.id];
  if(q && q._hadMiss && !alreadyMastered && (Q.requeued[q.id]||0)<requeueMax && remaining>0){
    Q.requeued[q.id]=(Q.requeued[q.id]||0)+1;
    /* 残り問題のうち1〜3問後のランダムな位置に挿入 */
    var insertOffset=1+Math.floor(Math.random()*Math.min(remaining,3));
    Q.q.splice(Q.i+1+insertOffset,0,q);
  }

  Q.i++;
  Q.i>=Q.q.length?qResult():qRender();
}

function qResult(){
  el('FB').classList.remove('on');
  var tot=Q.ok+Q.ng,acc=tot?Math.round(Q.ok/tot*100):0;
  el('R-ok').textContent=Q.ok;el('R-ng').textContent=Q.ng;el('R-ac').textContent=acc+'%';
  var em='📚',tl='もう少しです！';
  if(acc>=90){em='🏆';tl='完璧です！';}else if(acc>=70){em='🎉';tl='よくできました！';}else if(acc>=50){em='📚';tl='もう少しです！';}else{em='💪';tl='練習あるのみ！';}
  el('R-em').textContent=em;el('R-tl').textContent=tl;
  el('R-sub').textContent=tot+'問中'+Q.ok+'問正解 · 正解率'+acc+'%';

  /* カーソルを進める（リストクイズのみ） */
  if(Q._pendingCursor&&!Q.testMode){
    var pc=Q._pendingCursor;
    var lst=G.lists.find(function(l){return l.id===pc.lid;});
    if(lst){
      var wsLen=G.words.filter(function(w){return w.lid===pc.lid;}).length;
      lst.cursor=pc.next>=wsLen?0:pc.next; /* 最後まで行ったらリセット */
      var completed=(pc.next>=wsLen);
      if(completed){
        em='🎊';tl='このリスト完了！';
        el('R-em').textContent=em;el('R-tl').textContent=tl;
        el('R-sub').textContent='全単語を学習しました！次回は最初からスタートします';
      }
    }
  }

  /* セッションログを保存 */
  var _durMs=Q.sessionStart?Date.now()-Q.sessionStart:(Q.startMs?Date.now()-Q.startMs:0);
  if(!G.logs)G.logs=[];
  /* 使用リストIDを収集（重複排除） */
  var _lidSet={};
  Q.words.forEach(function(w){if(w.lid)_lidSet[w.lid]=true;});
  var _lids=Object.keys(_lidSet);
  G.logs.push({
    ts: new Date().toISOString(),
    ok: Q.ok, ng: Q.ng, acc: acc, total: tot,
    durationMs: _durMs,
    quizMode: Q.quizMode||'all',
    testMode: !!Q.testMode,
    lids: _lids,
    miss: Q.miss.map(function(w){return{id:w.id,word:w.word,meaning:w.meaning||'',lang:w.lang||'en',lid:w.lid};}),
    slow: (Q.slow||[]).map(function(w){return{id:w.id,word:w.word,meaning:w.meaning||'',lang:w.lang||'en',lid:w.lid,answerMs:w.answerMs};}),
    words: Q.words.map(function(w){return w.id;})
  });
  if(G.logs.length>365)G.logs=G.logs.slice(-365);
  var today=new Date().toDateString();
  if(G.stats.lastDay!==today){var yest=new Date(Date.now()-86400000).toDateString();G.stats.streak=(G.stats.lastDay===yest)?(G.stats.streak||0)+1:1;G.stats.lastDay=today;}
  save();
  go('s-result');
}

/* SETTINGS */
function updateKeyStatus(){
  var s=el('KEY-status');if(!s)return;
  if(G.cfg.key){
    s.innerHTML='<span style="color:var(--gn)">✅ APIキー設定済み（sk-ant-...'+G.cfg.key.slice(-4)+'）</span>';
  } else {
    s.innerHTML='<span style="color:var(--or)">⚠️ APIキー未設定</span>';
  }
}
function settingsLoad(){
  el('IN-apikey').value=G.cfg.key||'';
  el('SEL-size').value=G.cfg.size||20;
  el('TG-rev').classList.toggle('on',!!G.cfg.rev);
  el('TG-random').classList.toggle('on',!!G.cfg.random);
  el('TG-speak').classList.toggle('on',G.cfg.speak!==false);
  el('TG-autonext').classList.toggle('on',!!G.cfg.autonext);
  el('IN-autonext-sec').value=G.cfg.autonextSec||1.5;
  el('TG-flashauto').classList.toggle('on',!!G.cfg.flashAuto);
  el('TG-autoQuiz').classList.toggle('on',!!G.cfg.autoQuiz);
  el('IN-flash-sec').value=G.cfg.flashSec||2;
  var sm=G.cfg.spkMode||'both';
  ['both','foreign','ja'].forEach(function(m){el('SPK-'+m).classList.toggle('on',sm===m);});
  el('IN-duck-vol').value=G.cfg.duckVol!=null?G.cfg.duckVol:15;
  var rq=G.cfg.requeueMax!=null?G.cfg.requeueMax:1;
  [0,1,2,3].forEach(function(n){el('RQ-'+n).classList.toggle('on',rq===n);});
  if(el('TG-ebbing'))el('TG-ebbing').classList.toggle('on', G.cfg.ebbing!==false);
  if(el('IN-ebbing-max'))el('IN-ebbing-max').value = G.cfg.ebbingMax || 5;
  updateKeyStatus();
}

/* BIND */
function bind(){
  flBindButtons();
  el('T-home').addEventListener('click',function(){go('s-home');});
  el('T-add').addEventListener('click',function(){go('s-add');});
  el('T-list').addEventListener('click',function(){go('s-list');});
  el('T-settings').addEventListener('click',function(){go('s-settings');});
  el('B-go-settings').addEventListener('click',function(){go('s-settings');});

  el('B-quiz-due').addEventListener('click',function(){quizStart('due');});
  el('B-go-add').addEventListener('click',function(){go('s-add');});
  el('B-quiz-all').addEventListener('click',function(){quizStart('all');});
  el('B-go-list').addEventListener('click',function(){go('s-list');});
  el('B-quiz-weak').addEventListener('click',function(){quizStart('weak');});
  el('B-study-list').addEventListener('click',function(){showListSelectModal('study');});
  el('B-test-list').addEventListener('click',function(){showListSelectModal('test');});
  el('B-report').addEventListener('click',function(){showReportModal();});
  el('B-new-list').addEventListener('click',function(){go('s-add');});
  el('B-new-folder').addEventListener('click',function(){createFolder();});

  el('B-add-back').addEventListener('click',function(){go('s-home');});
  el('SG-paste').addEventListener('click',function(){segSwitch('paste');});
  el('SG-file').addEventListener('click',function(){segSwitch('file');});
  el('SG-ai').addEventListener('click',function(){segSwitch('ai');});

  /* 抽出タイプボタン */
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){
    b.addEventListener('click',function(){setType(this.getAttribute('data-type'));});
  });

  /* レベル選択ボタン */
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){
    b.addEventListener('click',function(){setLevel(this.getAttribute('data-level'));});
  });

  /* 言語選択ボタン */
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){
    b.addEventListener('click',function(){setLang(this.getAttribute('data-lang'));});
  });

  /* 言語フィルター */
  el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(b){
    b.addEventListener('click',function(){
      listLangFilter=this.getAttribute('data-lang');
      el('LANG-filter').querySelectorAll('.flt-btn').forEach(function(x){x.classList.remove('on');});
      this.classList.add('on');
      listRender();
    });
  });

  el('B-parse').addEventListener('click',parsePaste);
  el('B-upload').addEventListener('click',function(){el('IN-file').click();});
  el('IN-file').addEventListener('change',handleFile);

  /* JSON形式サンプル 折り畳みトグル */
  el('JSON-sample-toggle').addEventListener('click',function(){
    var body=el('JSON-sample-body');
    var arrow=el('JSON-sample-arrow');
    var isOpen=body.style.display!=='none';
    body.style.display=isOpen?'none':'block';
    arrow.style.transform=isOpen?'':'rotate(180deg)';
  });

  /* 貼り付けタブ: JSON自動検出 */
  el('IN-paste-text').addEventListener('input',pasteDetectJson);
  el('IN-paste-text').addEventListener('paste',function(){setTimeout(pasteDetectJson,50);});
  /* 貼り付けタブ: JSONセクション選択 */
  document.querySelectorAll('[data-pjsec]').forEach(function(b){
    b.addEventListener('click',function(){setPasteJsonSection(this.getAttribute('data-pjsec'));});
  });

  /* ファイルタブのモード/レベル/タイプ切替 */
  document.querySelectorAll('[data-fmode]').forEach(function(b){
    b.addEventListener('click',function(){setFileMode(this.getAttribute('data-fmode'));});
  });
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileLevel(this.getAttribute('data-level'));});
  });
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){
    b.addEventListener('click',function(){setFileType(this.getAttribute('data-type'));});
  });
  document.querySelectorAll('[data-jsec]').forEach(function(b){
    b.addEventListener('click',function(){setJsonSection(this.getAttribute('data-jsec'));});
  });
  el('B-ai-extract').addEventListener('click',aiExtract);
  el('B-save').addEventListener('click',saveList);
  el('B-clr-prv').addEventListener('click',prvHide);

  el('B-list-back').addEventListener('click',function(){
    if(selModeOn){toggleSelMode();}else{go('s-home');}
  });
  el('B-dup-check').addEventListener('click',function(){checkDuplicates();});
  el('B-sel-mode').addEventListener('click',function(){toggleSelMode();});
  el('SEL-all-btn').addEventListener('click',function(){
    var flt=el('SEL-list').value;
    var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
    var allSel=words.every(function(w){return selSet[w.id];});
    if(allSel){selSet={};}else{words.forEach(function(w){selSet[w.id]=true;});}
    listRender();updateSelCount();
  });
  el('SEL-del-btn').addEventListener('click',function(){selDeleteAll();});
  el('SEL-move-btn').addEventListener('click',function(){selMoveAll();});
  el('SEL-list').addEventListener('change',listRender);
  el('IN-search').addEventListener('input',listRender);
  /* 状態・ソートドロップダウン */
  if(el('SEL-status'))el('SEL-status').addEventListener('change',listRender);
  if(el('SEL-sort'))el('SEL-sort').addEventListener('change',listRender);

  el('B-quiz-exit').addEventListener('click',function(){
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    el('FB').classList.remove('on');go('s-home');
  });
  el('B-next').addEventListener('click',qNext);
  el('B-res-home').addEventListener('click',function(){go('s-home');});
  el('B-res-weak').addEventListener('click',function(){quizStart('weak');});

  el('B-set-back').addEventListener('click',function(){go('s-home');});
  el('B-save-file').addEventListener('click',function(){saveAsFile();});
  el('B-save-key').addEventListener('click',function(){
    var key=(el('IN-apikey').value||'').trim();
    if(!key){toast('❌ APIキーを入力してください');return;}
    if(!key.startsWith('sk-ant-')){toast('❌ APIキーの形式が正しくありません（sk-ant-で始まるキー）');return;}
    G.cfg.key=key;save();
    updateKeyStatus();
    toast('✅ APIキーを保存しました');
  });
  el('SEL-size').addEventListener('input',function(){
    var v=parseInt(this.value)||20;
    if(v<1)v=1;
    if(v>200)v=200;
    G.cfg.size=v;save();
  });
  el('TG-random').addEventListener('click',function(){G.cfg.random=!this.classList.contains('on');this.classList.toggle('on',G.cfg.random);save();});
  el('ROW-random').addEventListener('click',function(e){if(e.target!==el('TG-random'))el('TG-random').click();});
  el('TG-rev').addEventListener('click',function(){G.cfg.rev=!G.cfg.rev;this.classList.toggle('on',G.cfg.rev);save();});
  el('ROW-rev').addEventListener('click',function(e){if(e.target!==el('TG-rev'))el('TG-rev').click();});
  el('TG-speak').addEventListener('click',function(){G.cfg.speak=!this.classList.contains('on');this.classList.toggle('on',G.cfg.speak);save();});
  el('ROW-speak').addEventListener('click',function(e){if(e.target!==el('TG-speak'))el('TG-speak').click();});
  el('TG-autonext').addEventListener('click',function(){G.cfg.autonext=!this.classList.contains('on');this.classList.toggle('on',G.cfg.autonext);save();});
  el('ROW-autonext').addEventListener('click',function(e){if(e.target!==el('TG-autonext'))el('TG-autonext').click();});
  el('IN-autonext-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||1.5;
    if(v<0.5)v=0.5; if(v>10)v=10;
    G.cfg.autonextSec=v; save();
  });
  el('IN-flash-sec').addEventListener('input',function(){
    var v=parseFloat(this.value)||4;
    if(v<2)v=2; if(v>15)v=15;
    G.cfg.flashSec=v; save();
  });
  el('IN-duck-vol').addEventListener('input',function(){
    var v=parseInt(this.value);
    if(isNaN(v))v=15;
    if(v<0)v=0; if(v>100)v=100;
    G.cfg.duckVol=v; save();
    DUCK_VOL=v/100;
  });
  DUCK_VOL=(G.cfg.duckVol!=null?G.cfg.duckVol:15)/100;
  el('TG-flashauto').addEventListener('click',function(){G.cfg.flashAuto=!this.classList.contains('on');this.classList.toggle('on',G.cfg.flashAuto);save();});
  el('ROW-flashauto').addEventListener('click',function(e){if(e.target!==el('TG-flashauto'))el('TG-flashauto').click();});
  el('TG-autoQuiz').addEventListener('click',function(){G.cfg.autoQuiz=!this.classList.contains('on');this.classList.toggle('on',G.cfg.autoQuiz);save();});
  el('ROW-autoQuiz').addEventListener('click',function(e){if(e.target!==el('TG-autoQuiz'))el('TG-autoQuiz').click();});
  [0,1,2,3].forEach(function(n){
    el('RQ-'+n).addEventListener('click',function(){
      G.cfg.requeueMax=n; save();
      [0,1,2,3].forEach(function(x){el('RQ-'+x).classList.toggle('on',x===n);});
    });
  });
  ['both','foreign','ja'].forEach(function(m){
    el('SPK-'+m).addEventListener('click',function(){
      G.cfg.spkMode=m;save();
      ['both','foreign','ja'].forEach(function(x){el('SPK-'+x).classList.toggle('on',x===m);});
    });
  });

  /* ---- エクスポート/インポート ---- */

  /* 全データJSON */
  el('B-export').addEventListener('click',function(){
    dlJson(G,'vocabmaster_backup.json');
    toast('✅ エクスポート完了');
  });

  /* リスト選択エクスポート */
  el('B-export-select').addEventListener('click',function(){
    if(!G.lists.length){toast('リストがありません');return;}
    var html='<div class="modal-tl">📋 エクスポートするリストを選択</div>';
    html+='<div style="max-height:220px;overflow-y:auto;margin-bottom:12px">';
    G.lists.forEach(function(lst){
      var l=LANGS[lst.lang||'en'];
      var cnt=G.words.filter(function(w){return w.lid===lst.id;}).length;
      html+='<label style="display:flex;align-items:center;gap:10px;padding:10px 4px;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer">'+
        '<input type="checkbox" data-lid="'+lst.id+'" style="width:18px;height:18px;accent-color:var(--ac)">'+
        '<span>'+(l?l.flag+' ':'')+esc(lst.name)+'</span>'+
        '<span style="margin-left:auto;font-size:12px;color:var(--tx2)">'+cnt+'単語</span></label>';
    });
    html+='</div>';
    html+='<button class="btn-primary" id="EXP-json-sel" style="margin-bottom:8px">📤 JSON</button>';
    html+='<button class="btn-sec" id="EXP-csv-sel" style="margin-top:0">📊 CSV</button>';
    el('modal-ct').innerHTML=html;
    el('modal-bg').classList.add('on');

    function getSelected(){
      return Array.from(el('modal-ct').querySelectorAll('input[data-lid]:checked')).map(function(c){return c.getAttribute('data-lid');});
    }
    el('EXP-json-sel').addEventListener('click',function(){
      var ids=getSelected();if(!ids.length){toast('リストを選択してください');return;}
      var lists=G.lists.filter(function(l){return ids.indexOf(l.id)>=0;});
      var words=G.words.filter(function(w){return ids.indexOf(w.lid)>=0;});
      /* 選択リストに関連する学習ログも含める */
      var selLogs=(G.logs||[]).filter(function(lg){
        var lgLids=lg.lids||[];
        return lgLids.some(function(lid){return ids.indexOf(lid)>=0;});
      });
      dlJson({words:words,lists:lists,logs:selLogs,cfg:G.cfg,stats:G.stats}, 'vocabmaster_lists.json');
      el('modal-bg').classList.remove('on');toast('✅ エクスポート完了');
    });
    el('EXP-csv-sel').addEventListener('click',function(){
      var ids=getSelected();if(!ids.length){toast('リストを選択してください');return;}
      var words=G.words.filter(function(w){return ids.indexOf(w.lid)>=0;});
      exportCsv(words,'vocabmaster_lists.csv');
      el('modal-bg').classList.remove('on');toast('✅ CSVエクスポート完了');
    });
  });

  /* 全データCSV */
  el('B-export-csv').addEventListener('click',function(){
    exportCsv(G.words,'vocabmaster_all.csv');
    toast('✅ CSVエクスポート完了');
  });

  /* QRコード転送 */
  el('B-qr').addEventListener('click',function(){
    if(!G.lists.length){toast('リストがありません');return;}
    var html='<div class="modal-tl">📱 QRコードで転送</div>';
    html+='<div style="font-size:12px;color:var(--tx2);margin-bottom:10px">転送するリストを1つ選んでください（QRコードのサイズ制限のため1リストずつ）</div>';
    html+='<select id="QR-sel" class="sel" style="width:100%;margin-bottom:12px">';
    G.lists.forEach(function(lst){
      var cnt=G.words.filter(function(w){return w.lid===lst.id;}).length;
      html+='<option value="'+lst.id+'">'+esc(lst.name)+' ('+cnt+'単語)</option>';
    });
    html+='</select>';
    html+='<button class="btn-primary" id="QR-gen">QRコードを生成</button>';
    html+='<div id="QR-area" style="margin-top:14px;text-align:center"></div>';
    el('modal-ct').innerHTML=html;
    el('modal-bg').classList.add('on');

    el('QR-gen').addEventListener('click',function(){
      var lid=el('QR-sel').value;
      var lst=G.lists.find(function(l){return l.id===lid;});
      var words=G.words.filter(function(w){return w.lid===lid;});
      if(!words.length){toast('単語がありません');return;}
      /* データをBase64に圧縮してURLに埋め込む */
      var payload=JSON.stringify({lists:[lst],words:words});
      if(payload.length>2953){
        toast('単語数が多すぎます（目安：単語20個以下）。リストを分けてください');return;
      }
      var b64=btoa(unescape(encodeURIComponent(payload)));
      /* GitHub PagesのURLにハッシュとしてデータを埋め込む */
      var baseUrl=location.href.split('#')[0];
      var qrUrl=baseUrl+'#import='+b64;
      genQr(qrUrl, 'QR-area');
    });
  });

  /* インポート（追加統合） */
  el('B-import-row').addEventListener('click',function(){el('IN-import').click();});
  el('IN-import').addEventListener('change',function(e){
    var f=e.target.files[0];if(!f)return;
    var fr=new FileReader();
    fr.onload=function(ev){
      try{
        var d=JSON.parse(ev.target.result);
        if(!d.words||!d.lists)throw 0;
        /* 追加統合: 既存IDと重複しないものだけ追加 */
        var existListIds=G.lists.map(function(l){return l.id;});
        var existWordIds=G.words.map(function(w){return w.id;});
        var addedLists=0,addedWords=0;
        d.lists.forEach(function(lst){
          if(existListIds.indexOf(lst.id)<0){G.lists.push(lst);addedLists++;}
        });
        d.words.forEach(function(w){
          if(existWordIds.indexOf(w.id)<0){G.words.push(w);addedWords++;}
        });
        /* 学習ログのマージ（重複はtsで判定） */
        var addedLogs=0;
        if(d.logs&&d.logs.length){
          if(!G.logs)G.logs=[];
          var existTs=G.logs.map(function(l){return l.ts;});
          d.logs.forEach(function(lg){
            if(existTs.indexOf(lg.ts)<0){G.logs.push(lg);addedLogs++;}
          });
          /* 日付順に並べ直す */
          G.logs.sort(function(a,b){return a.ts<b.ts?-1:a.ts>b.ts?1:0;});
          /* 上限365件 */
          if(G.logs.length>365)G.logs=G.logs.slice(-365);
        }
        /* stats（streak・lastDay）は、インポート元の方が進んでいる場合のみ上書き */
        if(d.stats){
          var localStreak=G.stats.streak||0;
          var remoteStreak=d.stats.streak||0;
          if(remoteStreak>localStreak){
            G.stats.streak=remoteStreak;
            G.stats.lastDay=d.stats.lastDay||G.stats.lastDay;
          }
        }
        save();homeRefresh();
        var msg='✅ '+addedLists+'リスト・'+addedWords+'単語を追加しました';
        if(addedLogs>0)msg+='（学習記録+'+addedLogs+'件）';
        toast(msg);
      }
      catch(err){toast('インポートに失敗しました');}
    };
    fr.readAsText(f);e.target.value='';
  });

  el('B-reset').addEventListener('click',function(){
    if(confirm('すべてのデータを削除しますか？\nこの操作は取り消せません。')){G=mkDB();save();toast('データを削除しました');homeRefresh();}
  });
  /* ── エビングハウス忘却曲線設定 ── */
  if(el('TG-ebbing'))el('TG-ebbing').addEventListener('click',function(){
    G.cfg.ebbing=!this.classList.contains('on');
    this.classList.toggle('on',G.cfg.ebbing);
    save();
    toast(G.cfg.ebbing?'🧠 忘却曲線による追加復習をONにしました':'忘却曲線による追加復習をOFFにしました');
  });
  if(el('ROW-ebbing'))el('ROW-ebbing').addEventListener('click',function(e){if(el('TG-ebbing')&&e.target!==el('TG-ebbing'))el('TG-ebbing').click();});
  if(el('IN-ebbing-max'))el('IN-ebbing-max').addEventListener('input',function(){
    var v=parseInt(this.value)||5;
    if(v<1)v=1; if(v>20)v=20;
    G.cfg.ebbingMax=v; save();
  });
  el('modal-bg').addEventListener('click',function(e){if(e.target===this)this.classList.remove('on');});
}

/* ---- データ転送ヘルパー ---- */
function dlJson(data, fname){
  var b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=fname;document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u);},1000);
}

function exportCsv(words, fname){
  var bom='\uFEFF'; /* BOM: ExcelでUTF-8が文字化けしないように */
  var rows=[['word','meaning','lang','list']];
  words.forEach(function(w){
    var lst=G.lists.find(function(l){return l.id===w.lid;});
    rows.push([w.word, w.meaning||'', w.lang||'en', lst?lst.name:'']);
  });
  var csv=bom+rows.map(function(r){
    return r.map(function(c){return '"'+String(c).replace(/"/g,'""')+'"';}).join(',');
  }).join('\r\n');
  var b=new Blob([csv],{type:'text/csv;charset=utf-8'});
  var u=URL.createObjectURL(b),a=document.createElement('a');
  a.href=u;a.download=fname;document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(u);},1000);
}

function genQr(text, targetId){
  var area=el(targetId);
  area.innerHTML='<div style="color:var(--tx2);font-size:12px;margin-bottom:8px">生成中...</div>';
  /* QRコードライブラリを動的ロード */
  function doGen(){
    area.innerHTML='';
    var div=document.createElement('div');
    area.appendChild(div);
    new QRCode(div,{text:text,width:200,height:200,colorDark:'#ffffff',colorLight:'#12121a',correctLevel:QRCode.CorrectLevel.M});
    area.insertAdjacentHTML('beforeend','<div style="font-size:11px;color:var(--tx2);margin-top:8px">別のデバイスでスキャンしてインポートURLを開いてください</div>');
  }
  if(typeof QRCode!=='undefined'){doGen();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
  s.onload=doGen;
  s.onerror=function(){area.innerHTML='<span style="color:var(--rd)">QRライブラリの読み込みに失敗しました</span>';};
  document.head.appendChild(s);
}

/* SAMPLE */
function loadSample(){
  if(G.words.length>0)return;
  var samples=[
    {lang:'en',name:'英語サンプル',ic:'🇬🇧',clr:'#4cff91',words:[['abandon','捨てる、放棄する'],['accomplish','達成する'],['acquire','取得する'],['advocate','提唱する'],['ambiguous','あいまいな']]},
    {lang:'de',name:'ドイツ語サンプル',ic:'🇩🇪',clr:'#ffd700',words:[['Haus','家'],['Schule','学校'],['Arbeit','仕事'],['schön','美しい'],['lernen','学ぶ']]},
    {lang:'fr',name:'フランス語サンプル',ic:'🇫🇷',clr:'#5cf8fc',words:[['maison','家'],['école','学校'],['travail','仕事'],['beau','美しい'],['apprendre','学ぶ']]},
  ];
  samples.forEach(function(s){
    var lst={id:uid(),name:s.name,ic:s.ic,clr:s.clr,lang:s.lang,cr:new Date().toISOString()};
    G.lists.push(lst);
    s.words.forEach(function(w){G.words.push({id:uid(),word:w[0],meaning:w[1],lid:lst.id,lang:s.lang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});});
  });
  save();
}

window.onload=function(){
  /* QRコードからのインポート処理 */
  var hash=location.hash;
  if(hash&&hash.indexOf('#import=')===0){
    try{
      var b64=hash.slice(8);
      var json=decodeURIComponent(escape(atob(b64)));
      var d=JSON.parse(json);
      if(d.words&&d.lists){
        var existListIds=G.lists.map(function(l){return l.id;});
        var existWordIds=G.words.map(function(w){return w.id;});
        var addedLists=0,addedWords=0;
        d.lists.forEach(function(lst){if(existListIds.indexOf(lst.id)<0){G.lists.push(lst);addedLists++;}});
        d.words.forEach(function(w){if(existWordIds.indexOf(w.id)<0){G.words.push(w);addedWords++;}});
        /* 学習ログのマージ */
        if(d.logs&&d.logs.length){
          if(!G.logs)G.logs=[];
          var existTs=G.logs.map(function(l){return l.ts;});
          d.logs.forEach(function(lg){if(existTs.indexOf(lg.ts)<0)G.logs.push(lg);});
          G.logs.sort(function(a,b){return a.ts<b.ts?-1:a.ts>b.ts?1:0;});
          if(G.logs.length>365)G.logs=G.logs.slice(-365);
        }
        save();
        history.replaceState(null,'',location.pathname); /* ハッシュを消す */
        setTimeout(function(){toast('📱 QRから '+addedLists+'リスト・'+addedWords+'単語をインポートしました！');},500);
      }
    }catch(e){/* 無効なハッシュは無視 */}
  }
  bind();loadSample();homeRefresh();updateLevelHint();
};
</script>
</body>
</html>
