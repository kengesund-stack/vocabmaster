<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<title>VocabMaster</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
:root {
  --bg:#0a0a0f; --sf:#12121a; --sf2:#1a1a26; --sf3:#22222f;
  --ac:#7c5cfc; --ac2:#fc5c7d; --ac3:#5cf8fc;
  --tx:#f0f0f8; --tx2:#9090aa;
  --gn:#4cff91; --rd:#ff4c6a; --or:#ff9c4c; --gd:#ffd700;
  --r:14px;
  --st:env(safe-area-inset-top,0px); --sb:env(safe-area-inset-bottom,0px);
}
html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--tx); font-family:-apple-system,Helvetica,Arial,sans-serif; -webkit-user-select:none; user-select:none; }
#app { width:100%; height:100%; overflow:hidden; position:relative; }

.scr { display:none; position:absolute; top:0; left:0; width:100%; height:100%; flex-direction:column; background:var(--bg); }
.scr.on { display:flex; }

.scroll { flex:1; overflow-y:scroll; overflow-x:hidden; -webkit-overflow-scrolling:touch; padding:14px 18px; }

.tabbar { display:flex; background:var(--sf); border-top:1px solid rgba(255,255,255,.07); padding-bottom:var(--sb); flex-shrink:0; }
.tab { flex:1; display:flex; flex-direction:column; align-items:center; padding:8px 0; background:none; border:none; color:var(--tx2); cursor:pointer; font-family:inherit; }
.tab.on { color:var(--ac); }
.tab-ic { font-size:20px; }
.tab-lb { font-size:10px; margin-top:2px; }

.hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:10px; background:var(--bg); border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0; }
.hdr-title { font-size:16px; font-weight:600; flex:1; }

#s-home { background:radial-gradient(ellipse at 20% 10%,rgba(124,92,252,.15) 0%,transparent 55%),radial-gradient(ellipse at 80% 90%,rgba(252,92,125,.1) 0%,transparent 55%),var(--bg); }
.home-top { display:flex; justify-content:space-between; align-items:center; padding:12px 18px 0; padding-top:calc(var(--st) + 12px); flex-shrink:0; }
.logo { font-size:24px; font-weight:900; letter-spacing:-1px; background:linear-gradient(135deg,var(--ac),var(--ac2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

.btn { display:flex; align-items:center; justify-content:center; background:none; border:none; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.btn-ic { width:38px; height:38px; border-radius:10px; background:var(--sf2); font-size:17px; color:var(--tx2); }
.btn-back { width:34px; height:34px; border-radius:9px; background:var(--sf2); font-size:17px; color:var(--tx); flex-shrink:0; }
.btn-primary { width:100%; padding:14px; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); color:#fff; font-size:15px; font-weight:600; -webkit-appearance:none; border:none; cursor:pointer; font-family:inherit; }
.btn-primary:active { opacity:.8; }
.btn-sec { width:100%; padding:13px; background:var(--sf2); border:1px solid rgba(255,255,255,.1); border-radius:var(--r); color:var(--tx); font-size:14px; font-weight:500; margin-top:8px; -webkit-appearance:none; border-radius:var(--r); cursor:pointer; font-family:inherit; }
.btn-sec:active { background:var(--sf3); }
.btn-text { background:none; border:none; color:var(--ac); font-size:13px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }

.stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:14px; }
.stat { background:var(--sf); border-radius:var(--r); padding:11px; text-align:center; }
.stat-n { font-size:22px; font-weight:700; }
.stat-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.due-btn { width:100%; background:linear-gradient(135deg,var(--ac),var(--ac2)); border-radius:var(--r); padding:15px 17px; margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; border:none; cursor:pointer; -webkit-appearance:none; text-align:left; font-family:inherit; }
.due-btn:active { opacity:.85; }
.due-txt h3 { font-size:16px; font-weight:600; color:#fff; }
.due-txt p { font-size:11px; color:rgba(255,255,255,.75); margin-top:2px; }
.due-n { font-size:36px; font-weight:700; color:#fff; line-height:1; }

.act-grid { display:grid; grid-template-columns:1fr 1fr; gap:9px; margin-bottom:18px; }
.act-card { background:var(--sf); border-radius:var(--r); padding:14px; border:none; cursor:pointer; text-align:left; width:100%; -webkit-appearance:none; font-family:inherit; }
.act-card:active { background:var(--sf2); }
.act-ic { font-size:24px; margin-bottom:5px; display:block; }
.act-title { font-size:13px; font-weight:600; color:var(--tx); }
.act-sub { font-size:11px; color:var(--tx2); margin-top:2px; }

.sec-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.sec-title { font-size:12px; font-weight:600; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }

.list-card { background:var(--sf); border-radius:var(--r); padding:13px; margin-bottom:7px; display:flex; align-items:center; gap:11px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.list-card:active { background:var(--sf2); }
.lc-prog-wrap { padding:0 13px 10px; }
.lc-prog-bar { height:4px; background:rgba(255,255,255,.1); border-radius:2px; overflow:hidden; }
.lc-prog-fill { height:100%; border-radius:2px; transition:width .4s ease; }
.lc-prog-txt { font-size:10px; color:var(--tx2); margin-top:4px; display:flex; justify-content:space-between; }

/* ã‚¹ãƒ¯ã‚¤ãƒ—å‰Šé™¤ */
.swipe-wrap { position:relative; overflow:hidden; border-radius:var(--r); margin-bottom:7px; }
.swipe-del-bg { position:absolute; right:0; top:0; bottom:0; width:90px; background:var(--rd); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:2px; color:#fff; font-size:11px; font-weight:700; border-radius:var(--r); }
.swipe-del-bg span { font-size:20px; }
.swipe-inner { position:relative; transition:transform .2s ease; touch-action:pan-y; will-change:transform; }
.swipe-inner.swiped { transform:translateX(-90px); }
.swipe-inner .list-card { margin-bottom:0; border-radius:var(--r); }
.list-ic { width:40px; height:40px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0; }
.list-inf { flex:1; min-width:0; }
.list-name { font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.list-meta { font-size:11px; color:var(--tx2); margin-top:2px; }
.list-badge { background:var(--ac); color:#fff; font-size:11px; font-weight:600; padding:2px 8px; border-radius:20px; }

/* è¨€èªãƒãƒƒã‚¸ */
.lang-badge { display:inline-block; font-size:10px; font-weight:700; padding:1px 6px; border-radius:5px; margin-left:5px; vertical-align:middle; }
.lang-en { background:rgba(76,255,145,.15); color:var(--gn); }
.lang-de { background:rgba(255,215,0,.15); color:var(--gd); }
.lang-fr { background:rgba(92,248,252,.15); color:var(--ac3); }
.lang-es { background:rgba(255,156,76,.15); color:var(--or); }
.lang-it { background:rgba(252,92,125,.15); color:var(--ac2); }

.seg { display:flex; background:var(--sf); border-radius:11px; padding:3px; margin-bottom:16px; }
.seg-btn { flex:1; padding:8px 3px; border:none; border-radius:8px; background:transparent; color:var(--tx2); font-size:12px; font-weight:500; cursor:pointer; -webkit-appearance:none; font-family:inherit; }
.seg-btn.on { background:var(--sf3); color:var(--tx); }

.lbl { font-size:12px; color:var(--tx2); margin-bottom:5px; font-weight:500; }
.inp { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:var(--r); color:var(--tx); font-family:inherit; font-size:15px; padding:12px 14px; outline:none; -webkit-appearance:none; margin-bottom:12px; -webkit-user-select:text; user-select:text; }
.inp:focus { border-color:var(--ac); }
.ta { height:140px; resize:none; line-height:1.6; }
.hint { font-size:11px; color:var(--tx2); margin-bottom:12px; line-height:1.5; }

/* è¨€èªé¸æŠ */
.lang-sel-wrap { margin-bottom:14px; }
.lang-sel-title { font-size:12px; color:var(--tx2); margin-bottom:7px; font-weight:500; }
.lang-sel-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.lang-sel-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.lang-sel-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }
.opt-btn { padding:8px 4px; border:2px solid rgba(255,255,255,.08); border-radius:10px; background:var(--sf); color:var(--tx2); font-size:11px; font-weight:600; cursor:pointer; text-align:center; -webkit-appearance:none; font-family:inherit; line-height:1.4; }
.opt-btn.on { border-color:var(--ac); background:rgba(124,92,252,.12); color:var(--tx); }

.upload { border:2px dashed rgba(124,92,252,.3); border-radius:var(--r); padding:26px; text-align:center; cursor:pointer; margin-bottom:12px; background:rgba(124,92,252,.03); }
.upload:active { border-color:var(--ac); background:rgba(124,92,252,.08); }
.upload-ic { font-size:30px; margin-bottom:5px; }
.upload-tx { font-size:14px; font-weight:500; }
.upload-sub { font-size:11px; color:var(--tx2); margin-top:3px; }

.prev-hdr { display:flex; justify-content:space-between; align-items:center; margin-bottom:9px; }
.prev-title { font-size:13px; font-weight:600; color:var(--tx2); }
.prev-cnt { background:var(--ac); color:#fff; font-size:11px; padding:2px 8px; border-radius:10px; }
.prev-list { display:flex; flex-direction:column; gap:5px; max-height:220px; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.prev-item { background:var(--sf); border-radius:9px; padding:9px 11px; display:flex; align-items:center; gap:9px; }
.pi-n { font-size:11px; color:var(--tx2); width:20px; flex-shrink:0; }
.pi-en { font-size:14px; font-weight:500; flex:1; }
.pi-ja { font-size:12px; color:var(--ac3); }

.srch-wrap { padding:9px 16px 0; flex-shrink:0; }
.srch { width:100%; background:var(--sf); border:1px solid rgba(255,255,255,.08); border-radius:11px; padding:9px 13px; color:var(--tx); font-family:inherit; font-size:14px; outline:none; -webkit-appearance:none; -webkit-user-select:text; user-select:text; }

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ */
.filter-bar { display:flex; gap:7px; padding:9px 16px 0; overflow-x:scroll; -webkit-overflow-scrolling:touch; flex-shrink:0; }
.filter-bar::-webkit-scrollbar { display:none; }
.flt-btn { padding:5px 12px; border-radius:20px; border:1px solid rgba(255,255,255,.1); background:var(--sf); color:var(--tx2); font-size:12px; font-weight:500; white-space:nowrap; cursor:pointer; -webkit-appearance:none; font-family:inherit; flex-shrink:0; }
.flt-btn.on { background:var(--ac); border-color:var(--ac); color:#fff; }

.word-item { background:var(--sf); border-radius:var(--r); padding:11px 13px; margin-bottom:6px; display:flex; align-items:center; gap:9px; border:none; cursor:pointer; width:100%; text-align:left; -webkit-appearance:none; font-family:inherit; }
.word-item:active { background:var(--sf2); }
.wi-inf { flex:1; min-width:0; }
.wi-en { font-size:14px; font-weight:500; }
.wi-ja { font-size:11px; color:var(--tx2); margin-top:2px; }
.wi-lvl { width:28px; height:28px; border-radius:7px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; flex-shrink:0; }
.l0{background:rgba(255,76,106,.15);color:var(--rd);} .l1{background:rgba(255,156,76,.15);color:var(--or);} .l2{background:rgba(255,215,0,.15);color:var(--gd);} .l3{background:rgba(76,255,145,.15);color:var(--gn);} .l4{background:rgba(124,92,252,.15);color:var(--ac);} .l5{background:rgba(92,248,252,.15);color:var(--ac3);}

#s-quiz { background:radial-gradient(ellipse at 50% 0%,rgba(124,92,252,.12) 0%,transparent 55%),var(--bg); }
.qz-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.qz-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.qz-fill { height:100%; background:linear-gradient(90deg,var(--ac),var(--ac2)); border-radius:3px; transition:width .35s ease; }
.qz-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.qz-body { flex:1; display:flex; flex-direction:column; padding:13px 16px; overflow:hidden; gap:10px; }
.qz-card { background:var(--sf); border-radius:18px; padding:22px 18px; text-align:center; flex-shrink:0; }
.qz-badge { display:inline-block; background:rgba(124,92,252,.15); color:var(--ac); font-size:10px; font-weight:700; padding:3px 9px; border-radius:20px; margin-bottom:12px; text-transform:uppercase; letter-spacing:.06em; }
.qz-word { font-size:28px; font-weight:700; line-height:1.2; word-break:break-word; }
.choices { display:flex; flex-direction:column; gap:7px; flex:1; justify-content:center; }
.ch-btn { width:100%; padding:13px 14px; background:var(--sf); border:2px solid rgba(255,255,255,.08); border-radius:13px; color:var(--tx); font-size:14px; font-weight:500; cursor:pointer; font-family:inherit; text-align:left; display:flex; align-items:center; gap:9px; -webkit-appearance:none; min-height:50px; }
.ch-btn:active:not(.done) { border-color:var(--ac); background:rgba(124,92,252,.08); }
.ch-btn.ok { border-color:var(--gn)!important; background:rgba(76,255,145,.08)!important; }
.ch-btn.ok .ch-lt { background:rgba(76,255,145,.2); color:var(--gn); }
.ch-btn.ok .ch-tx { color:var(--gn); }
.ch-btn.ng { border-color:var(--rd)!important; background:rgba(255,76,106,.08)!important; }
.ch-btn.ng .ch-lt { background:rgba(255,76,106,.2); color:var(--rd); }
.ch-btn.ng .ch-tx { color:var(--rd); }
.ch-lt { width:25px; height:25px; border-radius:6px; background:rgba(255,255,255,.06); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--tx2); flex-shrink:0; }
.ch-tx { flex:1; line-height:1.3; }
.ch-ic { font-size:15px; margin-left:auto; flex-shrink:0; min-width:18px; text-align:center; }
.ch-dk { width:100%; padding:11px 14px; background:transparent; border:2px dashed rgba(255,255,255,.15); border-radius:13px; color:var(--tx2); font-size:13px; font-weight:500; cursor:pointer; font-family:inherit; text-align:center; margin-top:2px; -webkit-appearance:none; }
.ch-dk:active:not(.done) { border-color:rgba(255,255,255,.35); color:var(--tx); }
.ch-dk.done { opacity:.5; pointer-events:none; }

.fb { position:absolute; bottom:calc(var(--sb) + 7px); left:14px; right:14px; background:var(--sf2); border:1px solid rgba(255,255,255,.08); border-radius:13px; padding:11px 14px; display:flex; align-items:center; justify-content:space-between; gap:9px; opacity:0; transform:translateY(28px); transition:opacity .25s ease,transform .25s ease; pointer-events:none; z-index:10; }
.fb.on { opacity:1; transform:translateY(0); pointer-events:auto; }
.fb-tx { font-size:13px; font-weight:600; }
.fb-dt { font-size:11px; color:var(--tx2); margin-top:2px; }
.fb-next { background:var(--ac); color:#fff; border:none; border-radius:9px; padding:8px 14px; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; flex-shrink:0; font-family:inherit; -webkit-appearance:none; }
.fb-next:active { opacity:.8; }

#s-result { background:radial-gradient(ellipse at 50% 30%,rgba(124,92,252,.2) 0%,transparent 55%),var(--bg); align-items:center; justify-content:center; padding:36px 22px; }
.res-em { font-size:64px; margin-bottom:12px; }
.res-tl { font-size:26px; font-weight:700; margin-bottom:5px; text-align:center; }
.res-sub { font-size:13px; color:var(--tx2); margin-bottom:24px; text-align:center; }
.res-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:9px; width:100%; margin-bottom:24px; }
.res-stat { background:var(--sf); border-radius:13px; padding:13px; text-align:center; }
.rs-n { font-size:24px; font-weight:700; }
.rs-l { font-size:10px; color:var(--tx2); margin-top:2px; }

.set-group { background:var(--sf); border-radius:var(--r); margin-bottom:16px; overflow:hidden; }
.set-row { display:flex; align-items:center; padding:13px 14px; gap:9px; border-bottom:1px solid rgba(255,255,255,.05); cursor:pointer; }
.set-row:last-child { border-bottom:none; }
.set-lbl { flex:1; font-size:14px; }
.set-val { font-size:13px; color:var(--tx2); }
.set-sec { font-size:11px; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; font-weight:600; margin-bottom:6px; padding-left:2px; }
.set-inp { background:transparent; border:none; color:var(--tx); font-family:inherit; font-size:13px; outline:none; flex:1; text-align:right; -webkit-user-select:text; user-select:text; -webkit-appearance:none; }
.toggle { width:40px; height:24px; border-radius:12px; background:var(--sf3); position:relative; cursor:pointer; transition:background .3s; flex-shrink:0; border:none; -webkit-appearance:none; }
.toggle.on { background:var(--ac); }
.toggle::after { content:''; position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:50%; background:#fff; transition:transform .3s; box-shadow:0 1px 3px rgba(0,0,0,.4); }
.toggle.on::after { transform:translateX(16px); }
.sel { background:transparent; border:none; color:var(--tx2); font-size:13px; outline:none; font-family:inherit; -webkit-appearance:none; padding:4px 0; }

.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:50; display:none; align-items:flex-end; }
.modal-bg.on { display:flex; }
.modal-sh { background:var(--sf); border-radius:20px 20px 0 0; padding:18px 16px calc(var(--sb) + 16px); width:100%; max-height:80%; overflow-y:scroll; -webkit-overflow-scrolling:touch; }
.modal-hd { width:32px; height:4px; background:rgba(255,255,255,.15); border-radius:2px; margin:0 auto 16px; }
.modal-tl { font-size:17px; font-weight:700; margin-bottom:13px; }
.del-btn { background:rgba(255,76,106,.1); color:var(--rd); border:1px solid rgba(255,76,106,.2); border-radius:11px; padding:12px; font-size:14px; font-weight:600; cursor:pointer; width:100%; font-family:inherit; margin-top:5px; -webkit-appearance:none; }
.del-btn:active { background:rgba(255,76,106,.2); }

.empty { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:44px 20px; text-align:center; gap:9px; }
.empty-ic { font-size:42px; }
.empty-tl { font-size:16px; font-weight:600; }
.empty-sub { font-size:12px; color:var(--tx2); line-height:1.5; }

.ai-tag { display:inline-block; background:linear-gradient(135deg,var(--ac),var(--ac2)); color:#fff; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; vertical-align:middle; margin-left:3px; }

.ld-bg { position:fixed; inset:0; background:rgba(10,10,15,.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; }
.ld-bg.on { display:flex; }
.spin { width:42px; height:42px; border:3px solid rgba(124,92,252,.2); border-top-color:var(--ac); border-radius:50%; animation:sp .8s linear infinite; margin-bottom:12px; }
@keyframes sp { to { transform:rotate(360deg); } }
.ld-tx { font-size:13px; color:var(--tx2); }

.toast { position:fixed; top:calc(var(--st) + 12px); left:16px; right:16px; background:var(--sf3); border:1px solid rgba(255,255,255,.1); border-radius:11px; padding:10px 14px; font-size:13px; font-weight:500; text-align:center; z-index:200; transform:translateY(-70px); opacity:0; transition:all .25s ease; pointer-events:none; }
.toast.on { transform:translateY(0); opacity:1; }

/* ---- FLASHCARD ---- */
#s-flash { background:radial-gradient(ellipse at 50% 0%,rgba(92,248,252,.08) 0%,transparent 55%),var(--bg); }
.fl-hdr { display:flex; align-items:center; padding:12px 16px; padding-top:calc(var(--st) + 12px); gap:11px; flex-shrink:0; }
.fl-prog { flex:1; height:5px; background:var(--sf2); border-radius:3px; overflow:hidden; }
.fl-fill { height:100%; background:linear-gradient(90deg,var(--ac3),var(--ac)); border-radius:3px; transition:width .35s ease; }
.fl-cnt { font-size:12px; color:var(--tx2); font-weight:500; white-space:nowrap; }
.fl-body { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:16px; gap:16px; }
.fl-card { width:100%; max-width:360px; background:var(--sf); border-radius:22px; padding:36px 24px; text-align:center; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; box-shadow:0 4px 32px rgba(0,0,0,.4); transition:transform .2s ease,opacity .2s ease; }
.fl-card.flip { transform:scale(.93); opacity:.4; }
.fl-lang { font-size:11px; font-weight:700; color:var(--tx2); text-transform:uppercase; letter-spacing:.08em; }
.fl-word { font-size:32px; font-weight:700; line-height:1.2; word-break:break-word; }
.fl-meaning { font-size:22px; color:var(--ac3); font-weight:600; }
.fl-spk { background:rgba(92,248,252,.12); border:none; border-radius:20px; padding:6px 18px; color:var(--ac3); font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; -webkit-appearance:none; }
.fl-controls { display:flex; align-items:center; gap:18px; flex-shrink:0; padding-bottom:calc(var(--sb) + 16px); }
.fl-ctrl-btn { width:52px; height:52px; border-radius:50%; background:var(--sf2); border:none; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--tx); -webkit-appearance:none; }
.fl-ctrl-btn:active { background:var(--sf3); }
.fl-play-btn { width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg,var(--ac3),var(--ac)); border:none; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#fff; -webkit-appearance:none; box-shadow:0 4px 16px rgba(124,92,252,.4); }
.fl-play-btn:active { opacity:.85; }

/* JSONè²¼ã‚Šä»˜ã‘å°‚ç”¨UI */
.json-detect-banner {
  display:none;
  background:rgba(92,248,252,.1);
  border:1px solid rgba(92,248,252,.3);
  border-radius:10px;
  padding:10px 12px;
  margin-bottom:12px;
  font-size:12px;
  color:var(--ac3);
  line-height:1.5;
}
.json-detect-banner.on { display:block; }
.json-sec-wrap { margin-bottom:12px; display:none; }
.json-sec-wrap.on { display:block; }

::-webkit-scrollbar { display:none; }
</style>
</head>
<body>
<script id="embedded-data" type="application/json">null</script>
<div id="app">

<div class="ld-bg" id="ld"><div class="spin"></div><div class="ld-tx" id="ld-tx">å‡¦ç†ä¸­...</div></div>
<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal-bg"><div class="modal-sh"><div class="modal-hd"></div><div id="modal-ct"></div></div></div>

<!-- HOME -->
<div class="scr on" id="s-home">
  <div class="home-top">
    <div class="logo">VocabMaster</div>
    <button class="btn btn-ic" id="B-go-settings">âš™ï¸</button>
  </div>
  <div class="scroll">
    <div style="height:14px"></div>
    <div class="stats">
      <div class="stat"><div class="stat-n" id="H-total">0</div><div class="stat-l">ç·å˜èªæ•°</div></div>
      <div class="stat"><div class="stat-n" id="H-mastered">0</div><div class="stat-l">ç¿’å¾—æ¸ˆã¿</div></div>
      <div class="stat"><div class="stat-n" id="H-streak">0</div><div class="stat-l">é€£ç¶šæ—¥æ•°</div></div>
    </div>
    <button class="due-btn" id="B-quiz-due">
      <div class="due-txt"><h3>ä»Šæ—¥ã®å¾©ç¿’</h3><p>å¿˜å´æ›²ç·šã«åŸºã¥ãæœ€é©ã‚¿ã‚¤ãƒŸãƒ³ã‚°</p></div>
      <div class="due-n" id="H-due">0</div>
    </button>
    <div class="act-grid">
      <button class="act-card" id="B-go-add"><span class="act-ic">â•</span><div class="act-title">å˜èªã‚’è¿½åŠ </div><div class="act-sub">ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»AI</div></button>
      <button class="act-card" id="B-quiz-all"><span class="act-ic">âš¡</span><div class="act-title">å…¨å˜èªã‚¯ã‚¤ã‚º</div><div class="act-sub">4æŠå½¢å¼ã§ç·´ç¿’</div></button>
      <button class="act-card" id="B-go-list"><span class="act-ic">ğŸ“š</span><div class="act-title">å˜èªä¸€è¦§</div><div class="act-sub">ç®¡ç†ãƒ»ç·¨é›†</div></button>
      <button class="act-card" id="B-quiz-weak"><span class="act-ic">ğŸ¯</span><div class="act-title">è‹¦æ‰‹å˜èª</div><div class="act-sub">é–“é•ãˆãŸå˜èªã‚’ç‰¹è¨“</div></button>
      <button class="act-card" id="B-study-list" style="border:1.5px solid rgba(124,92,252,.4)"><span class="act-ic">ğŸ“–</span><div class="act-title">äºˆç¿’â†’ã‚¯ã‚¤ã‚º</div><div class="act-sub">ãƒªã‚¹ãƒˆã‚’é¸ã‚“ã§äºˆç¿’ã‹ã‚‰</div></button>
      <button class="act-card" id="B-test-list" style="border:1.5px solid rgba(252,92,125,.4)"><span class="act-ic">ğŸ“</span><div class="act-title">ãƒ†ã‚¹ãƒˆå½¢å¼</div><div class="act-sub">äºˆç¿’ãªã—ãƒ»æ¡ç‚¹ã®ã¿</div></button>
    </div>
    <div class="sec-hdr">
      <div class="sec-title">å˜èªãƒªã‚¹ãƒˆ</div>
      <button class="btn-text" id="B-new-list">ï¼‹ æ–°è¦</button>
    </div>
    <div id="H-lists"></div>
    <div style="margin:18px 0 8px">
      <button id="B-report" style="width:100%;padding:13px;background:var(--sf);border:1.5px solid rgba(92,248,252,.3);border-radius:var(--r);color:var(--ac3);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;-webkit-appearance:none;display:flex;align-items:center;justify-content:center;gap:8px">
        <span>ğŸ“Š</span><span>å­¦ç¿’å ±å‘Šæ›¸ã‚’ä½œæˆ</span>
      </button>
    </div>
    <div style="height:14px"></div>
  </div>
  <div class="tabbar">
    <button class="tab on" id="T-home"><div class="tab-ic">ğŸ </div><div class="tab-lb">ãƒ›ãƒ¼ãƒ </div></button>
    <button class="tab" id="T-add"><div class="tab-ic">â•</div><div class="tab-lb">è¿½åŠ </div></button>
    <button class="tab" id="T-list"><div class="tab-ic">ğŸ“š</div><div class="tab-lb">å˜èªå¸³</div></button>
    <button class="tab" id="T-settings"><div class="tab-ic">âš™ï¸</div><div class="tab-lb">è¨­å®š</div></button>
  </div>
</div>

<!-- ADD -->
<div class="scr" id="s-add">
  <div class="hdr">
    <button class="btn btn-back" id="B-add-back">â†</button>
    <div class="hdr-title">å˜èªã‚’è¿½åŠ </div>
  </div>
  <div class="scroll">
    <div class="seg">
      <button class="seg-btn on" id="SG-paste">è²¼ã‚Šä»˜ã‘</button>
      <button class="seg-btn" id="SG-file">ãƒ•ã‚¡ã‚¤ãƒ«</button>
      <button class="seg-btn" id="SG-ai">AIæŠ½å‡º<span class="ai-tag">AI</span></button>
    </div>

    <!-- è¨€èªé¸æŠï¼ˆå…±é€šï¼‰ -->
    <div class="lang-sel-wrap">
      <div class="lang-sel-title">å­¦ç¿’è¨€èªã‚’é¸æŠ</div>
      <div class="lang-sel-grid">
        <button class="lang-sel-btn on" data-lang="en" id="LS-en">ğŸ‡¬ğŸ‡§<br>è‹±èª</button>
        <button class="lang-sel-btn" data-lang="de" id="LS-de">ğŸ‡©ğŸ‡ª<br>ç‹¬èª</button>
        <button class="lang-sel-btn" data-lang="fr" id="LS-fr">ğŸ‡«ğŸ‡·<br>ä»èª</button>
        <button class="lang-sel-btn" data-lang="es" id="LS-es">ğŸ‡ªğŸ‡¸<br>è¥¿èª</button>
        <button class="lang-sel-btn" data-lang="it" id="LS-it">ğŸ‡®ğŸ‡¹<br>ä¼Šèª</button>
      </div>
    </div>

    <!-- PASTE -->
    <div id="TP-paste">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-paste-name" type="text" placeholder="ä¾‹: ãƒ‰ã‚¤ãƒ„èªåŸºç¤å˜èª">

      <!-- JSONæ¤œå‡ºãƒãƒŠãƒ¼ -->
      <div class="json-detect-banner" id="JSON-banner">
        ğŸ“— <strong>JSONå½¢å¼ã‚’æ¤œå‡ºã—ã¾ã—ãŸ</strong><br>
        å–ã‚Šè¾¼ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ã€Œè§£æã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„
      </div>

      <!-- JSONã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠï¼ˆJSONè²¼ã‚Šä»˜ã‘æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="json-sec-wrap" id="PASTE-json-sec">
        <div class="lbl">å–ã‚Šè¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <button class="opt-btn on" data-pjsec="all" id="PJSEC-all" style="flex:1;padding:7px;font-size:11px">ğŸ“¦<br>ã™ã¹ã¦</button>
          <button class="opt-btn" data-pjsec="vocabulary" id="PJSEC-vocab" style="flex:1;padding:7px;font-size:11px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-pjsec="phrases" id="PJSEC-phrase" style="flex:1;padding:7px;font-size:11px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        </div>
      </div>

      <div class="lbl">å˜èªãƒªã‚¹ãƒˆ ã¾ãŸã¯ JSONãƒ†ã‚­ã‚¹ãƒˆ</div>
      <textarea class="inp ta" id="IN-paste-text" placeholder="â–  é€šå¸¸å½¢å¼ï¼ˆ1è¡Œ1å˜èª ã¾ãŸã¯ã€Œå˜èª,è¨³ã€ï¼‰&#10;ä¾‹:&#10;Haus&#10;Schule,å­¦æ ¡&#10;&#10;â–  JSONå½¢å¼ï¼ˆè²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•èªè­˜ï¼‰&#10;ä¾‹:&#10;{&quot;words&quot;:[{&quot;word&quot;:&quot;Haus&quot;,&quot;meaning&quot;:&quot;å®¶&quot;}]}"></textarea>
      <div class="hint">è¨³ãªã—ã®å˜èªã¯APIã‚­ãƒ¼è¨­å®šã§AIè‡ªå‹•ç¿»è¨³ã§ãã¾ã™ã€‚JSONå½¢å¼ã‚‚è‡ªå‹•èªè­˜ã—ã¾ã™ã€‚</div>
      <button class="btn-primary" id="B-parse">ğŸ” è§£æã™ã‚‹</button>
    </div>

    <!-- FILE -->
    <div id="TP-file" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-file-name" type="text" placeholder="ä¾‹: Deutsch A1">
      <div class="lbl">å‡¦ç†ãƒ¢ãƒ¼ãƒ‰</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-fmode="vocab" id="FM-vocab" style="flex:1;padding:8px">ğŸ“‹<br>å˜èªãƒªã‚¹ãƒˆ<br><span style="font-size:9px;opacity:.7">CSV/Excel</span></button>
        <button class="opt-btn" data-fmode="json" id="FM-json" style="flex:1;padding:8px">ğŸ“—<br>JSONèª­è¾¼<br><span style="font-size:9px;opacity:.7">å¤–éƒ¨JSON</span></button>
        <button class="opt-btn" data-fmode="extract" id="FM-extract" style="flex:1;padding:8px">âœ¨<br>AIã§æŠ½å‡º<br><span style="font-size:9px;opacity:.7">Word/PDF/TXT</span></button>
      </div>
      <div class="upload" id="B-upload">
        <div class="upload-ic" id="UP-ic">ğŸ“</div>
        <div class="upload-tx">ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
        <div class="upload-sub" id="UP-sub">CSV / Excel (.xlsx)</div>
      </div>
      <input type="file" id="IN-file" accept=".csv,.xlsx,.xls,.txt,.json" style="display:none">
      <div class="hint" id="UP-hint">CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰</div>
      <!-- AIæŠ½å‡ºãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ï¼‰ -->
      <div id="FILE-ai-opts" style="display:none">
        <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
        <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
          <button class="opt-btn on" data-level="all" id="FLV-all">ğŸ”€<br>åŒºåˆ¥ãªã—</button>
          <button class="opt-btn" data-level="beginner" id="FLV-beginner">ğŸŒ±<br>åˆç´š</button>
          <button class="opt-btn" data-level="intermediate" id="FLV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
          <button class="opt-btn" data-level="advanced" id="FLV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
        </div>
        <div class="lbl" style="margin-top:8px">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
        <div style="display:flex;gap:7px;margin-bottom:4px">
          <button class="opt-btn on" data-type="words" id="FTY-words" style="flex:1;padding:7px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-type="phrases" id="FTY-phrases" style="flex:1;padding:7px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
          <button class="opt-btn" data-type="both" id="FTY-both" style="flex:1;padding:7px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
        </div>
      </div>
      <!-- JSONãƒ¢ãƒ¼ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
      <div id="FILE-json-opts" style="display:none">
        <div style="background:var(--sf);border-radius:var(--r);padding:11px 13px;margin-bottom:10px;font-size:11px;color:var(--tx2);line-height:1.7">
          ğŸ“— å¯¾å¿œå½¢å¼ï¼š<br>
          <b style="color:var(--tx)">ãƒ‘ã‚¿ãƒ¼ãƒ³C</b>ï¼ˆãƒã‚¹ãƒˆå‹ï¼‰:<br>
          <code style="color:var(--ac3);font-size:10px">{"book_title":"...", "content":{"vocabulary":[...],"phrases":[...]}}</code><br>
          <b style="color:var(--tx)">ã‚·ãƒ³ãƒ—ãƒ«å‹</b>:<br>
          <code style="color:var(--ac3);font-size:10px">{"words":[...]} / [{"word":"...","meaning":"..."}]</code><br>
          å„è¦ç´ ã®ã‚­ãƒ¼åã¯è‡ªå‹•æ¤œå‡ºã—ã¾ã™ï¼ˆword/term/front + meaning/translation/back/definitionï¼‰
        </div>
        <div class="lbl">å–ã‚Šè¾¼ã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
        <div style="display:flex;gap:7px;margin-bottom:10px">
          <button class="opt-btn on" data-jsec="all" id="JSEC-all" style="flex:1;padding:7px;font-size:11px">ğŸ“¦<br>ã™ã¹ã¦</button>
          <button class="opt-btn" data-jsec="vocabulary" id="JSEC-vocab" style="flex:1;padding:7px;font-size:11px">ğŸ“<br>å˜èªã®ã¿</button>
          <button class="opt-btn" data-jsec="phrases" id="JSEC-phrase" style="flex:1;padding:7px;font-size:11px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        </div>
      </div>
    </div>

    <!-- AI -->
    <div id="TP-ai" style="display:none">
      <div class="lbl">ãƒªã‚¹ãƒˆå</div>
      <input class="inp" id="IN-ai-name" type="text" placeholder="ä¾‹: å°èª¬ã‹ã‚‰æŠ½å‡º">
      <div class="lbl">æŠ½å‡ºãƒ¬ãƒ™ãƒ«</div>
      <div class="lang-sel-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:4px">
        <button class="opt-btn on" data-level="all" id="LV-all">ğŸ”€<br>åŒºåˆ¥<br>ãªã—</button>
        <button class="opt-btn" data-level="beginner" id="LV-beginner">ğŸŒ±<br>åˆç´š</button>
        <button class="opt-btn" data-level="intermediate" id="LV-intermediate">ğŸ“˜<br>ä¸­ç´š</button>
        <button class="opt-btn" data-level="advanced" id="LV-advanced">ğŸ”¥<br>ä¸Šç´š</button>
      </div>
      <div id="LV-hint" style="font-size:10px;color:var(--tx2);margin-bottom:12px;line-height:1.6;padding:7px 10px;background:var(--sf);border-radius:9px"></div>
      <div class="lbl">æŠ½å‡ºã‚¿ã‚¤ãƒ—</div>
      <div style="display:flex;gap:7px;margin-bottom:12px">
        <button class="opt-btn on" data-type="words" id="TY-words" style="flex:1;padding:8px">ğŸ“<br>å˜èªã®ã¿</button>
        <button class="opt-btn" data-type="phrases" id="TY-phrases" style="flex:1;padding:8px">ğŸ’¬<br>ç†Ÿèªã®ã¿</button>
        <button class="opt-btn" data-type="both" id="TY-both" style="flex:1;padding:8px">âœ¨<br>å˜èªï¼‹ç†Ÿèª</button>
      </div>
      <div class="lbl">ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘</div>
      <textarea class="inp ta" id="IN-ai-text" style="height:140px" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºãƒ»ç¿»è¨³ã—ã¾ã™ã€‚&#10;&#10;ä¾‹ (ç‹¬): Das Haus ist sehr schÃ¶n und die Schule liegt in der NÃ¤he...&#10;ä¾‹ (è‹±): The enigmatic professor was known for his perspicacious observations..."></textarea>
      <div class="hint">âœ¨ AIãŒé‡è¦å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™ã€‚APIã‚­ãƒ¼ãªã—ã§ã‚‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚</div>
      <button class="btn-primary" id="B-ai-extract">âœ¨ AI ã§å˜èªãƒ»ç†Ÿèªã‚’æŠ½å‡º</button>
    </div>

    <!-- PREVIEW -->
    <div id="PRV" style="display:none;margin-top:16px">
      <div class="prev-hdr">
        <div class="prev-title">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        <div class="prev-cnt" id="PRV-cnt">0 å˜èª</div>
      </div>
      <div class="prev-list" id="PRV-list"></div>
      <button class="btn-primary" style="margin-top:13px" id="B-save">ğŸ’¾ å˜èªå¸³ã«ä¿å­˜</button>
      <button class="btn-sec" id="B-clr-prv">âœ• ã‚¯ãƒªã‚¢</button>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<!-- LIST -->
<div class="scr" id="s-list">
  <div class="hdr">
    <button class="btn btn-back" id="B-list-back">â†</button>
    <div class="hdr-title">å˜èªä¸€è¦§</div>
    <div style="display:flex;align-items:center;gap:4px">
      <button class="btn" id="B-dup-check" title="é‡è¤‡ãƒã‚§ãƒƒã‚¯" style="font-size:18px;padding:4px 6px">âŠœ</button>
      <button class="btn" id="B-sel-mode" title="é¸æŠãƒ¢ãƒ¼ãƒ‰" style="font-size:17px;padding:4px 6px;color:var(--tx2)">â˜‘</button>
      <select class="sel" id="SEL-list"><option value="all">ã™ã¹ã¦</option></select>
    </div>
  </div>
  <div id="SEL-toolbar" style="display:none;padding:8px 14px;background:var(--sf);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0">
    <div style="display:flex;align-items:center;gap:8px">
      <button class="btn" id="SEL-all-btn" style="font-size:12px;color:var(--ac);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">å…¨é¸æŠ</button>
      <span id="SEL-count" style="font-size:12px;color:var(--tx2);flex:1;text-align:center">0ä»¶é¸æŠä¸­</span>
      <button class="btn" id="SEL-move-btn" style="font-size:12px;color:var(--ac3);font-weight:600;padding:5px 10px;background:var(--sf2);border-radius:8px">âœ¦ ç§»å‹•</button>
      <button class="btn" id="SEL-del-btn" style="font-size:12px;color:var(--rd);font-weight:600;padding:5px 10px;background:rgba(255,76,106,.1);border-radius:8px">ğŸ—‘ å‰Šé™¤</button>
    </div>
  </div>
  <div class="srch-wrap">
    <input class="srch" id="IN-search" type="search" placeholder="å˜èªã‚’æ¤œç´¢...">
  </div>
  <div class="filter-bar" id="LANG-filter">
    <button class="flt-btn on" data-lang="all">ã™ã¹ã¦</button>
    <button class="flt-btn" data-lang="en">ğŸ‡¬ğŸ‡§ è‹±èª</button>
    <button class="flt-btn" data-lang="de">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª</button>
    <button class="flt-btn" data-lang="fr">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª</button>
    <button class="flt-btn" data-lang="es">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª</button>
    <button class="flt-btn" data-lang="it">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª</button>
  </div>
  <div style="display:flex;gap:6px;padding:7px 16px 0;flex-shrink:0">
    <select id="SEL-status" style="flex:1;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:9px;color:var(--tx);font-family:inherit;font-size:12px;padding:6px 8px;outline:none;-webkit-appearance:none;text-align:center">
      <option value="all">ã™ã¹ã¦</option>
      <option value="new">ğŸ†• æœªå­¦ç¿’</option>
      <option value="ok">âœ… ç¿’å¾—æ¸ˆã¿</option>
      <option value="ng">âŒ è¦å¾©ç¿’</option>
      <option value="unknown">â“ ä¸æ˜</option>
    </select>
    <select id="SEL-sort" style="flex:1;background:var(--sf);border:1px solid rgba(255,255,255,.1);border-radius:9px;color:var(--tx);font-family:inherit;font-size:12px;padding:6px 8px;outline:none;-webkit-appearance:none;text-align:center">
      <option value="default">è¿½åŠ é †</option>
      <option value="alpha">A-Zé †</option>
      <option value="level_asc">ãƒ¬ãƒ™ãƒ«â†‘</option>
      <option value="level_desc">ãƒ¬ãƒ™ãƒ«â†“</option>
      <option value="miss">é–“é•ã„é †</option>
    </select>
  </div>
  <div class="scroll" style="padding-top:10px">
    <div id="L-words"></div>
    <div style="height:14px"></div>
  </div>
</div>

<!-- FLASHCARD -->
<div class="scr" id="s-flash">
  <div class="fl-hdr">
    <button class="btn btn-back" id="B-flash-exit">âœ•</button>
    <div class="fl-prog"><div class="fl-fill" id="FL-fill" style="width:0%"></div></div>
    <div class="fl-cnt" id="FL-cnt">1/0</div>
  </div>
  <div class="fl-body">
    <div class="fl-card" id="FL-card">
      <div class="fl-lang" id="FL-lang">è‹±èª</div>
      <div class="fl-word" id="FL-word">word</div>
      <div class="fl-meaning" id="FL-meaning"></div>
      <button class="fl-spk" id="FL-spk">ğŸ”Š ç™ºéŸ³</button>
    </div>
  </div>
  <div class="fl-controls">
    <button class="fl-ctrl-btn" id="FL-prev">â€¹â€¹</button>
    <button class="fl-play-btn" id="FL-play">â–¶</button>
    <button class="fl-ctrl-btn" id="FL-next">â€ºâ€º</button>
  </div>
  <div style="padding:0 16px calc(var(--sb) + 16px);flex-shrink:0;width:100%"><button class="btn-primary" id="FL-to-quiz" style="margin:0">âš¡ ã“ã®ã¾ã¾ã‚¯ã‚¤ã‚ºã¸</button></div>
  <div id="FL-auto-quiz-overlay" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.75);z-index:100;flex-direction:column;align-items:center;justify-content:center;gap:16px">
    <div style="font-size:20px;font-weight:700;color:#fff">ğŸ‰ äºˆç¿’å®Œäº†ï¼</div>
    <div style="font-size:15px;color:rgba(255,255,255,.8)" id="FL-aq-msg">3ç§’å¾Œã«ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã—ã¾ã™</div>
    <div style="display:flex;gap:10px;margin-top:4px">
      <button id="FL-aq-now" style="padding:11px 24px;background:linear-gradient(135deg,var(--ac),var(--ac2));border:none;border-radius:12px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">ä»Šã™ãé–‹å§‹</button>
      <button id="FL-aq-cancel" style="padding:11px 20px;background:var(--sf2);border:1px solid rgba(255,255,255,.15);border-radius:12px;color:var(--tx2);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="scr" id="s-quiz">
  <div class="qz-hdr">
    <button class="btn btn-back" id="B-quiz-exit">âœ•</button>
    <div class="qz-prog"><div class="qz-fill" id="QZ-fill" style="width:0%"></div></div>
    <div style="display:flex;align-items:center;gap:7px">
      <div id="QZ-mode-badge" style="display:none;font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:rgba(252,92,125,.2);color:var(--ac2)">ğŸ“ ãƒ†ã‚¹ãƒˆ</div>
      <div class="qz-cnt" id="QZ-cnt">0/0</div>
    </div>
  </div>
  <div class="qz-body">
    <div class="qz-card">
      <div class="qz-badge" id="QZ-badge">æ—¥æœ¬èªã‚’é¸ã¹</div>
      <div class="qz-word" id="QZ-word">word</div>
      <button id="B-speak" style="margin-top:10px;background:rgba(124,92,252,.15);border:none;border-radius:20px;padding:6px 16px;color:var(--ac);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;display:none">ğŸ”Š ç™ºéŸ³</button>
    </div>
    <div class="choices" id="QZ-choices"></div>
  </div>
  <div class="fb" id="FB">
    <div><div class="fb-tx" id="FB-tx"></div><div class="fb-dt" id="FB-dt"></div></div>
    <button class="fb-next" id="B-next">æ¬¡ã¸ â†’</button>
  </div>
</div>

<!-- RESULT -->
<div class="scr" id="s-result">
  <div class="res-em" id="R-em">ğŸ‰</div>
  <div class="res-tl" id="R-tl">ã‚ˆãã§ãã¾ã—ãŸï¼</div>
  <div class="res-sub" id="R-sub">å­¦ç¿’å®Œäº†</div>
  <div class="res-stats">
    <div class="res-stat"><div class="rs-n" id="R-ok" style="color:var(--gn)">0</div><div class="rs-l">æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ng" style="color:var(--rd)">0</div><div class="rs-l">ä¸æ­£è§£</div></div>
    <div class="res-stat"><div class="rs-n" id="R-ac" style="color:var(--ac)">0%</div><div class="rs-l">æ­£è§£ç‡</div></div>
  </div>
  <button class="btn-primary" id="B-res-home" style="width:260px">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <button class="btn-sec" id="B-res-weak" style="width:260px">ğŸ¯ é–“é•ã„ã‚’å¾©ç¿’</button>
</div>

<!-- SETTINGS -->
<div class="scr" id="s-settings">
  <div class="hdr">
    <button class="btn btn-back" id="B-set-back">â†</button>
    <div class="hdr-title">è¨­å®š</div>
  </div>
  <div class="scroll">
    <div class="set-sec">AI è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <span class="set-lbl">ğŸ”‘ Anthropic APIã‚­ãƒ¼</span>
        <input type="password" class="inp" id="IN-apikey" placeholder="sk-ant-..." style="margin-bottom:0;font-size:13px;padding:10px 12px">
        <button class="btn-primary" id="B-save-key" style="padding:10px;font-size:13px">ğŸ’¾ APIã‚­ãƒ¼ã‚’ä¿å­˜</button>
        <div id="KEY-status" style="font-size:11px;text-align:center;padding:2px 0"></div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨AIç¿»è¨³ãƒ»å˜èªæŠ½å‡ºãŒä½¿ãˆã¾ã™ã€‚ã‚­ãƒ¼ã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚</span>
      </div>
    </div>
    <div class="set-sec">å­¦ç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ“Š 1ã‚»ãƒƒã‚·ãƒ§ãƒ³å•é¡Œæ•°</span>
        <input type="number" id="SEL-size" min="1" max="200" value="20"
          style="width:64px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
        <span style="font-size:13px;color:var(--tx2)">å•</span>
      </div>
      <div class="set-row" id="ROW-random">
        <span class="set-lbl">ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œï¼ˆæœªå‡ºé¡Œã‹ã‚‰ï¼‰</span>
        <button class="toggle" id="TG-random"></button>
      </div>
      <div class="set-row" id="ROW-rev">
        <span class="set-lbl">ğŸ”„ é€†ã‚¯ã‚¤ã‚ºï¼ˆæ—¥â†’å¤–å›½èªï¼‰æ··åœ¨</span>
        <button class="toggle" id="TG-rev"></button>
      </div>
      <div class="set-row" id="ROW-speak">
        <span class="set-lbl">ğŸ”Š ã‚¯ã‚¤ã‚ºæ™‚ã«è‡ªå‹•èª­ã¿ä¸Šã’</span>
        <button class="toggle" id="TG-speak"></button>
      </div>
      <div class="set-row" id="ROW-autonext">
        <span class="set-lbl">â­ï¸ ã‚¯ã‚¤ã‚ºæ­£è§£æ™‚ã«è‡ªå‹•ã§æ¬¡ã¸</span>
        <button class="toggle" id="TG-autonext"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ” ä¸æ­£è§£æ™‚ã®å†å‡ºé¡Œå›æ•°</span>
        <div style="display:flex;gap:5px">
          <button class="opt-btn" data-rq="0" id="RQ-0" style="padding:5px 10px;font-size:12px">ãªã—</button>
          <button class="opt-btn" data-rq="1" id="RQ-1" style="padding:5px 10px;font-size:12px">1å›</button>
          <button class="opt-btn" data-rq="2" id="RQ-2" style="padding:5px 10px;font-size:12px">2å›</button>
          <button class="opt-btn" data-rq="3" id="RQ-3" style="padding:5px 10px;font-size:12px">3å›</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">â±ï¸ è‡ªå‹•é€²è¡Œã®å¾…æ©Ÿæ™‚é–“</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-autonext-sec" min="0.5" max="10" step="0.5" value="1.5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.5">âš ï¸ å¾…æ©Ÿæ™‚é–“ã¯äºˆç¿’ã‚«ãƒ¼ãƒ‰ã®è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆã«ã‚‚ä½¿ã‚ã‚Œã¾ã™ï¼ˆå˜èª+è¨³ã®èª­ã¿ä¸Šã’å¾Œã«æ¬¡ã¸ï¼‰</span>
      </div>
    </div>
    <div class="set-sec">ğŸ§  ã‚¨ãƒ“ãƒ³ã‚°ãƒã‚¦ã‚¹å¿˜å´æ›²ç·š</div>
    <div class="set-group">
      <div class="set-row" id="ROW-ebbing">
        <span class="set-lbl">ğŸ“ˆ å¿˜å´æ›²ç·šã«ã‚ˆã‚‹è¿½åŠ å¾©ç¿’</span>
        <button class="toggle" id="TG-ebbing"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">é–“é•ãˆãŸãƒ»ã‚ã‹ã‚‰ãªã‹ã£ãŸå˜èªã‚’1æ—¥å¾Œãƒ»3æ—¥å¾Œãƒ»7æ—¥å¾Œãƒ»14æ—¥å¾Œãƒ»30æ—¥å¾Œã«é€šå¸¸ã‚¯ã‚¤ã‚ºã¸è‡ªå‹•è¿½åŠ ã—ã¾ã™ã€‚</span>
      </div>
      <div class="set-row" style="cursor:default" id="ROW-ebbing-max">
        <span class="set-lbl">ğŸ“Š è¿½åŠ å¾©ç¿’ã®ä¸Šé™å˜èªæ•°</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-ebbing-max" min="1" max="20" value="5"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">å˜èª</span>
        </div>
      </div>
    </div>
    <div class="set-sec">äºˆç¿’è¨­å®š</div>
    <div class="set-group">
      <div class="set-row" id="ROW-flashauto">
        <span class="set-lbl">â–¶ï¸ äºˆç¿’ã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•å†ç”Ÿ</span>
        <button class="toggle" id="TG-flashauto"></button>
      </div>
      <div class="set-row" id="ROW-autoQuiz">
        <span class="set-lbl">âš¡ äºˆç¿’å®Œäº†å¾Œã«è‡ªå‹•ã§ã‚¯ã‚¤ã‚ºã¸</span>
        <button class="toggle" id="TG-autoQuiz"></button>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸ”Š èª­ã¿ä¸Šã’ã‚‹è¨€èª</span>
        <div style="display:flex;gap:6px">
          <button class="opt-btn on" id="SPK-both" style="padding:5px 10px;font-size:12px">ä¸¡æ–¹</button>
          <button class="opt-btn" id="SPK-foreign" style="padding:5px 10px;font-size:12px">å¤–å›½èªã®ã¿</button>
          <button class="opt-btn" id="SPK-ja" style="padding:5px 10px;font-size:12px">æ—¥æœ¬èªã®ã¿</button>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">â±ï¸ ã‚«ãƒ¼ãƒ‰åˆ‡æ›¿é–“éš”</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-flash-sec" min="1" max="15" step="0.5" value="2"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">ç§’</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span class="set-lbl">ğŸµ èª­ã¿ä¸Šã’ä¸­ã®éŸ³æ¥½éŸ³é‡</span>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="number" id="IN-duck-vol" min="0" max="80" step="5" value="15"
            style="width:58px;background:var(--sf2);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--tx);font-family:inherit;font-size:14px;font-weight:600;padding:5px 8px;text-align:center;outline:none;-webkit-appearance:none;-webkit-user-select:text;user-select:text;">
          <span style="font-size:13px;color:var(--tx2)">%</span>
        </div>
      </div>
      <div class="set-row" style="cursor:default">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">èª­ã¿ä¸Šã’ä¸­ã®éŸ³æ¥½ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚’ä¸‹ã’ã¾ã™ã€‚0%ã§ç„¡éŸ³ã€100%ã§å¤‰åŒ–ãªã—ã€‚</span>
      </div>
    </div>
    <div class="set-sec">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</div>
    <div class="set-group">
      <div class="set-row" id="ROW-cloudauto">
        <span class="set-lbl">ğŸ”„ ã‚¯ãƒ©ã‚¦ãƒ‰è‡ªå‹•ä¿å­˜ï¼ˆ5åˆ†ã”ã¨ï¼‰</span>
        <button class="toggle" id="TG-cloudauto"></button>
      </div>
      <div class="set-row" style="cursor:default;flex-direction:column;align-items:stretch;gap:8px">
        <div style="font-size:11px;color:var(--tx2);line-height:1.6;padding:2px 0">åŒã˜Claudeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸåˆ¥ãƒ‡ãƒã‚¤ã‚¹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•åŒæœŸã§ãã¾ã™ã€‚</div>
        <button class="btn-primary" id="B-cloud-save" style="padding:10px;font-size:13px">â˜ï¸ ä»Šã™ãä¿å­˜</button>
        <button class="btn-sec" id="B-cloud-load" style="padding:10px;font-size:13px;margin-top:0">ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
        <div id="CLOUD-status" style="font-size:11px;text-align:center;color:var(--tx2);padding:2px 0;min-height:16px"></div>
      </div>
    </div>
    <div class="set-sec">ãƒ‡ãƒ¼ã‚¿</div>
    <div class="set-group">
      <div class="set-row" style="cursor:default;padding:10px 16px">
        <button class="btn-primary" id="B-save-file" style="width:100%;padding:12px;font-size:14px;font-weight:700">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆiCloudç”¨ï¼‰</button>
      </div>
      <div class="set-row" style="cursor:default;padding:0 16px 10px">
        <span style="font-size:11px;color:var(--tx2);line-height:1.6">ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚“ã HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚iCloudã«ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„ã€‚</span>
      </div>
      <div class="set-row" id="B-export"><span class="set-lbl">ğŸ“¤ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-export-select"><span class="set-lbl">ğŸ“‹ ãƒªã‚¹ãƒˆã‚’é¸ã‚“ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-export-csv"><span class="set-lbl">ğŸ“Š CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-qr"><span class="set-lbl">ğŸ“± QRã‚³ãƒ¼ãƒ‰ã§è»¢é€</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-import-row"><span class="set-lbl">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆè¿½åŠ çµ±åˆï¼‰</span><span class="set-val">â†’</span></div>
      <div class="set-row" id="B-reset"><span class="set-lbl" style="color:var(--rd)">ğŸ—‘ï¸ ã™ã¹ã¦å‰Šé™¤</span><span class="set-val">â†’</span></div>
    </div>
    <div style="text-align:center;padding:16px;color:var(--tx2);font-size:11px">VocabMaster v2.0 â€” å¤šè¨€èªå¯¾å¿œç‰ˆ</div>
    <div style="height:20px"></div>
  </div>
</div>

</div>
<input type="file" id="IN-import" accept=".json" style="display:none">

<script>
var MEM=null, DBKEY='vm3';
function sGet(){
  try{var ed=document.getElementById('embedded-data');if(ed&&ed.textContent&&ed.textContent!=='null'){var v=JSON.parse(ed.textContent);if(v)return v;}}catch(e){}
  try{var v=localStorage.getItem(DBKEY);return v?JSON.parse(v):null;}catch(e){return MEM;}
}
function sSet(v){
  try{localStorage.setItem(DBKEY,JSON.stringify(v));}catch(e){}
  MEM=v;
}

/* â”€â”€ Claudeã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŒæœŸ â”€â”€ */
var CLOUD_KEY='vocabmaster-sync-v1';
function cloudStatus(msg,clr){var el=document.getElementById('CLOUD-status');if(el){el.textContent=msg;el.style.color=clr||'var(--tx2)';}}

var _autoSaveTimer=null;
var AUTO_SAVE_DELAY=5*60*1000;

function scheduleAutoCloudSave(){
  if(!G.cfg.cloudAuto) return;
  if(!window.storage) return;
  if(_autoSaveTimer) clearTimeout(_autoSaveTimer);
  _autoSaveTimer=setTimeout(function(){
    _autoSaveTimer=null;
    cloudSaveAuto();
  }, AUTO_SAVE_DELAY);
}

async function cloudSaveAuto(){
  if(!window.storage||!G.cfg.cloudAuto) return;
  try{
    var payload=JSON.stringify(G);
    if(payload.length>4*1024*1024) return;
    var result=await window.storage.set(CLOUD_KEY, payload);
    if(result){
      var now=new Date();
      var ts=now.getFullYear()+'/'+(now.getMonth()+1)+'/'+now.getDate()+' '+now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
      cloudStatus('ğŸ”„ è‡ªå‹•ä¿å­˜å®Œäº† â€” '+ts,'var(--gn)');
      if(document.getElementById('s-home').classList.contains('on')){
        toast('â˜ï¸ è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
      }
    }
  }catch(e){}
}

async function cloudSave(){
  if(!window.storage){cloudStatus('âš ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“','var(--rd)');return;}
  var btn=document.getElementById('B-cloud-save');
  if(btn){btn.disabled=true;btn.textContent='ä¿å­˜ä¸­...';}
  cloudStatus('','');
  try{
    var payload=JSON.stringify(G);
    if(payload.length>4*1024*1024){cloudStatus('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã¾ã™ï¼ˆ4MBè¶…ï¼‰','var(--rd)');return;}
    var result=await window.storage.set(CLOUD_KEY, payload);
    if(result){
      var now=new Date();
      var ts=now.getFullYear()+'/'+(now.getMonth()+1)+'/'+now.getDate()+' '+now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
      cloudStatus('âœ… ä¿å­˜å®Œäº† â€” '+ts,'var(--gn)');
      toast('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸ');
    }else{
      cloudStatus('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ','var(--rd)');
    }
  }catch(e){
    cloudStatus('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+e.message,'var(--rd)');
  }finally{
    if(btn){btn.disabled=false;btn.textContent='â˜ï¸ ä»Šã™ãä¿å­˜';}
  }
}

async function cloudCheckOnStartup(){
  if(!window.storage) return;
  try{
    var result=await window.storage.get(CLOUD_KEY);
    if(!result||!result.value) return;
    var remote=JSON.parse(result.value);
    var remoteWords=(remote.words||[]).length;
    var localWords=G.words.length;
    if(remoteWords>localWords){
      setTimeout(function(){
        var msg='â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™\n\nã‚¯ãƒ©ã‚¦ãƒ‰: '+remoteWords+'å˜èª / ãƒ­ãƒ¼ã‚«ãƒ«: '+localWords+'å˜èª\n\nã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰';
        if(confirm(msg)){
          var savedKey=(G.cfg&&G.cfg.key)||'';
          G=remote;
          if(savedKey&&(!G.cfg||!G.cfg.key)){if(!G.cfg)G.cfg={};G.cfg.key=savedKey;}
          sSet(G);
          homeRefresh();
          toast('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ'+remoteWords+'å˜èªï¼‰');
        }
      }, 800);
    }
  }catch(e){}
}

async function cloudLoad(){
  if(!window.storage){cloudStatus('âš ï¸ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“','var(--rd)');return;}
  var btn=document.getElementById('B-cloud-load');
  if(btn){btn.disabled=true;btn.textContent='èª­ã¿è¾¼ã¿ä¸­...';}
  cloudStatus('','');
  try{
    var result=await window.storage.get(CLOUD_KEY);
    if(!result||!result.value){cloudStatus('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“','var(--tx2)');toast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');return;}
    var remote=JSON.parse(result.value);
    var lists=(remote.lists||[]).length;
    var words=(remote.words||[]).length;
    var msg='ã‚¯ãƒ©ã‚¦ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿:\nãƒªã‚¹ãƒˆ '+lists+' ä»¶ / å˜èª '+words+' ä»¶\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¨ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ\nï¼ˆç½®ãæ›ãˆå‰ã«ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ï¼‰';
    if(!confirm(msg))return;
    var savedKey=(G.cfg&&G.cfg.key)||'';
    G=remote;
    if(savedKey&&!G.cfg.key){if(!G.cfg)G.cfg={};G.cfg.key=savedKey;}
    sSet(G);
    homeRefresh();listFilterRebuild();listRender();
    cloudStatus('âœ… èª­ã¿è¾¼ã¿å®Œäº† â€” ãƒªã‚¹ãƒˆ'+lists+'ä»¶ / å˜èª'+words+'ä»¶','var(--gn)');
    toast('ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  }catch(e){
    cloudStatus('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+e.message,'var(--rd)');
  }finally{
    if(btn){btn.disabled=false;btn.textContent='ğŸ“¥ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã‚€';}
  }
}

var EASE0=2.5, EMIN=1.3;

var LANGS={
  en:{name:'è‹±èª',flag:'ğŸ‡¬ğŸ‡§',cls:'lang-en'},
  de:{name:'ãƒ‰ã‚¤ãƒ„èª',flag:'ğŸ‡©ğŸ‡ª',cls:'lang-de'},
  fr:{name:'ãƒ•ãƒ©ãƒ³ã‚¹èª',flag:'ğŸ‡«ğŸ‡·',cls:'lang-fr'},
  es:{name:'ã‚¹ãƒšã‚¤ãƒ³èª',flag:'ğŸ‡ªğŸ‡¸',cls:'lang-es'},
  it:{name:'ã‚¤ã‚¿ãƒªã‚¢èª',flag:'ğŸ‡®ğŸ‡¹',cls:'lang-it'}
};

function mkDB(){return{words:[],lists:[],logs:[],cfg:{size:20,random:true,rev:false,speak:true,autonext:false,autonextSec:1.5,flashSec:2,flashAuto:false,spkMode:'both',duckVol:15,key:'',requeueMax:1,ebbing:true,ebbingMax:5},stats:{streak:0,lastDay:''}};}
var G=sGet()||mkDB();
function save(){sSet(G);scheduleAutoCloudSave();}

function saveAsFile(){
  var data=JSON.stringify(G);
  var current=document.documentElement.outerHTML;
  var marker='embedded-data" type="application/json">';
  var si=current.indexOf(marker);
  if(si<0){toast('ä¿å­˜ã‚¨ãƒ©ãƒ¼');return;}
  si+=marker.length;
  var ei=current.indexOf('</',si);
  var updated=current.slice(0,si)+data+current.slice(ei);
  var blob=new Blob([updated],{type:'text/html;charset=utf-8'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='vocab-master.html';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

/* SRS */
function lvl(w){var s=w.s;if(!s)return 0;if(s.i>=60)return 5;if(s.i>=30)return 4;if(s.i>=14)return 3;if(s.i>=7)return 2;if(s.i>=3)return 1;return 0;}
function due(w){if(!w.s||!w.s.d)return true;return new Date(w.s.d)<=new Date();}
function answer(w,ok){
  if(Q.testMode)return;
  if(!w.s)w.s={i:1,e:EASE0,d:null,k:0,l:0};
  var s=w.s;
  if(ok){s.k=(s.k||0)+1;if(s.k<=1)s.i=1;else if(s.k===2)s.i=3;else s.i=Math.round(s.i*s.e);s.e=Math.min(3.0,s.e+0.1);
    if(G.cfg.ebbing) ebbingAdvance(w.id);}
  else{s.l=(s.l||0)+1;s.k=0;s.i=1;s.e=Math.max(EMIN,s.e-0.2);
    if(G.cfg.ebbing) ebbingMarkMiss(w.id, w.word, w.meaning||'', w.lang||'en');}
  s.i=Math.max(1,Math.min(s.i,365));
  var dt=new Date();dt.setDate(dt.getDate()+s.i);s.d=dt.toISOString();w.lr=new Date().toISOString();save();
}
function getDue(){return G.words.filter(due);}

var EBBING_INTERVALS = [1, 3, 7, 14, 30];

function ebbingSchedule(wordId) {
  if (!G.ebbing) G.ebbing = {};
  return G.ebbing[wordId] || null;
}

function ebbingMarkMiss(wordId, word, meaning, lang) {
  if (!G.cfg.ebbing) return;
  if (!G.ebbing) G.ebbing = {};
  var now = new Date();
  var existing = G.ebbing[wordId];
  var nextIdx = 0;
  if (existing) {
    nextIdx = existing.nextIdx || 0;
  }
  var nextDate = new Date(now);
  nextDate.setDate(nextDate.getDate() + EBBING_INTERVALS[nextIdx]);
  G.ebbing[wordId] = {
    wordId: wordId,
    word: word,
    meaning: meaning,
    lang: lang,
    nextIdx: nextIdx,
    nextDate: nextDate.toISOString(),
    createdAt: existing ? existing.createdAt : now.toISOString()
  };
  save();
}

function ebbingAdvance(wordId) {
  if (!G.ebbing || !G.ebbing[wordId]) return;
  var rec = G.ebbing[wordId];
  var nextIdx = (rec.nextIdx || 0) + 1;
  if (nextIdx >= EBBING_INTERVALS.length) {
    delete G.ebbing[wordId];
  } else {
    var nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + EBBING_INTERVALS[nextIdx]);
    rec.nextIdx = nextIdx;
    rec.nextDate = nextDate.toISOString();
  }
  save();
}

function getEbbingDue() {
  if (!G.cfg.ebbing || !G.ebbing) return [];
  var now = new Date();
  var max = G.cfg.ebbingMax || 5;
  var due = [];
  Object.values(G.ebbing).forEach(function(rec) {
    if (new Date(rec.nextDate) <= now) {
      var w = G.words.find(function(x) { return x.id === rec.wordId; });
      if (w) due.push(w);
    }
  });
  return due.slice(0, max);
}

function getEbbingForecast() {
  if (!G.ebbing) return [];
  var map = {};
  var now = new Date();
  now.setHours(0,0,0,0);
  Object.values(G.ebbing).forEach(function(rec) {
    var d = new Date(rec.nextDate);
    d.setHours(0,0,0,0);
    var diff = Math.round((d - now) / 86400000);
    if (diff < 0) diff = 0;
    if (diff > 30) return;
    var key = diff;
    if (!map[key]) map[key] = {diff: diff, words: []};
    map[key].words.push({word: rec.word, meaning: rec.meaning, interval: EBBING_INTERVALS[rec.nextIdx]});
  });
  var result = [];
  for (var i = 0; i <= 30; i++) {
    result.push(map[i] || {diff: i, words: []});
  }
  return result;
}

function getWeak(){return G.words.filter(function(w){return w.s&&(w.s.l||0)>0;}).sort(function(a,b){return(b.s.l||0)-(a.s.l||0);});}

/* NAV */
var SCREENS=['s-home','s-add','s-list','s-flash','s-quiz','s-result','s-settings'];
var TABMAP={'s-home':'T-home','s-add':'T-add','s-list':'T-list','s-settings':'T-settings'};
function go(id){
  if(selModeOn&&id!=='s-list'){selModeOn=false;selSet={};var tb=document.getElementById('SEL-toolbar');if(tb)tb.style.display='none';var sb=document.getElementById('B-sel-mode');if(sb)sb.style.color='var(--tx2)';}
  SCREENS.forEach(function(s){el(s).classList.remove('on');});
  el(id).classList.add('on');
  ['T-home','T-add','T-list','T-settings'].forEach(function(t){el(t).classList.remove('on');});
  if(TABMAP[id])el(TABMAP[id]).classList.add('on');
  if(id==='s-home')homeRefresh();
  if(id==='s-list'){if(selModeOn)toggleSelMode();listFilterRebuild();listRender();}
  if(id==='s-settings')settingsLoad();
  /* è¿½åŠ ã‚¿ãƒ–ã«æ¥ãŸã‚‰JSONæ¤œå‡ºUIã‚’ãƒªã‚»ãƒƒãƒˆ */
  if(id==='s-add'){pasteJsonDetectReset();}
}

/* HELPERS */
function el(id){return document.getElementById(id);}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
var _tt=null;
function toast(msg){var t=el('toast');t.textContent=msg;t.classList.add('on');if(_tt)clearTimeout(_tt);_tt=setTimeout(function(){t.classList.remove('on');},2800);}
function loading(msg){el('ld-tx').textContent=msg||'å‡¦ç†ä¸­...';el('ld').classList.add('on');}
function loaded(){el('ld').classList.remove('on');}
function shuffle(a){var b=a.slice();for(var i=b.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=b[i];b[i]=b[j];b[j]=t;}return b;}
function uid(){return '_'+(Date.now()%1e9)+'_'+(Math.random()*1e6|0);}
function langBadge(lang){var l=LANGS[lang||'en'];if(!l)return'';return'<span class="lang-badge '+l.cls+'">'+l.flag+' '+l.name+'</span>';}

/* HOME */
function homeRefresh(){
  el('H-total').textContent=G.words.length;
  el('H-mastered').textContent=G.words.filter(function(w){return w.s&&w.s.i>=14;}).length;
  el('H-streak').textContent=G.stats.streak||0;
  var dueCount=getDue().length;
  var ebDueCount=G.cfg.ebbing?getEbbingDue().filter(function(w){return !getDue().some(function(d){return d.id===w.id;});}).length:0;
  el('H-due').textContent=dueCount+ebDueCount;
  var ebBadge=el('H-eb-badge');
  if(ebBadge){ebBadge.style.display=ebDueCount>0?'inline':'none';ebBadge.textContent='ğŸ§ +'+ebDueCount;}
  homeListsRender();
}
function homeListsRender(){
  var c=el('H-lists');
  if(!G.lists.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ“–</div><div class="empty-tl">å˜èªãƒªã‚¹ãƒˆãªã—</div><div class="empty-sub">ã€Œå˜èªã‚’è¿½åŠ ã€ã‹ã‚‰<br>æ–°ã—ã„å˜èªã‚’ç™»éŒ²ã—ã‚ˆã†</div></div>';return;}
  var h='';
  G.lists.forEach(function(lst){
    var ws=G.words.filter(function(w){return w.lid===lst.id;});
    var d=ws.filter(due).length;
    var l=LANGS[lst.lang||'en'];
    var cursor=lst.cursor||0;
    var total=ws.length;
    var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
    var progClr=pct>=100?'var(--gn)':pct>=60?'var(--ac3)':pct>=30?'var(--ac)':'var(--ac2)';
    var nextN=Math.min(parseInt(G.cfg.size)||20, total-cursor);
    var progLabel=pct>=100?'âœ… å…¨å˜èªå®Œäº†ï¼':'æ¬¡å›: '+cursor+'ã€œ'+(cursor+nextN)+'ç•ªç›® ('+pct+'%)';
    h+='<div class="swipe-wrap" data-lid="'+esc(lst.id)+'">'+
      '<div class="swipe-del-bg"><span>ğŸ—‘ï¸</span>å‰Šé™¤</div>'+
      '<div class="swipe-inner">'+
        '<button class="list-card" data-lid="'+esc(lst.id)+'" style="padding-bottom:8px">'+
          '<div class="list-ic" style="background:'+lst.clr+'20">'+(l?l.flag:'ğŸ“—')+'</div>'+
          '<div class="list-inf">'+
            '<div class="list-name">'+esc(lst.name)+langBadge(lst.lang)+'</div>'+
            '<div class="list-meta">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div>'+
            '<div style="margin-top:7px">'+
              '<div class="lc-prog-bar"><div class="lc-prog-fill" style="width:'+pct+'%;background:'+progClr+'"></div></div>'+
              '<div class="lc-prog-txt"><span>'+progLabel+'</span><span style="font-weight:600;color:'+progClr+'">'+pct+'%</span></div>'+
            '</div>'+
          '</div>'+
          (d?'<div class="list-badge" style="align-self:flex-start">'+d+'</div>':'')+'</button>'+
      '</div>'+
    '</div>';
  });
  c.innerHTML=h;

  c.querySelectorAll('.list-card').forEach(function(b){
    b.addEventListener('click',function(){
      var inner=this.closest('.swipe-inner');
      if(inner&&inner.classList.contains('swiped')){
        inner.classList.remove('swiped');return;
      }
      listMenu(this.getAttribute('data-lid'));
    });
  });

  c.querySelectorAll('.swipe-wrap').forEach(function(wrap){
    var inner=wrap.querySelector('.swipe-inner');
    var startX,startY,dx,isDragging=false,isSwipe=false;

    inner.addEventListener('touchstart',function(e){
      startX=e.touches[0].clientX;
      startY=e.touches[0].clientY;
      dx=0; isDragging=true; isSwipe=false;
      inner.style.transition='none';
    },{passive:true});

    inner.addEventListener('touchmove',function(e){
      if(!isDragging)return;
      dx=e.touches[0].clientX-startX;
      var dy=e.touches[0].clientY-startY;
      if(!isSwipe&&Math.abs(dy)>Math.abs(dx)){isDragging=false;return;}
      if(Math.abs(dx)>8)isSwipe=true;
      if(!isSwipe)return;
      var already=inner.classList.contains('swiped')?-90:0;
      var tx=Math.min(0,Math.max(-90,already+dx));
      inner.style.transform='translateX('+tx+'px)';
    },{passive:true});

    inner.addEventListener('touchend',function(){
      if(!isDragging){inner.style.transition='';return;}
      isDragging=false;
      inner.style.transition='transform .2s ease';
      var already=inner.classList.contains('swiped')?-90:0;
      var total=already+dx;
      if(total<-40){
        inner.style.transform='translateX(-90px)';
        inner.classList.add('swiped');
      } else {
        inner.style.transform='';
        inner.classList.remove('swiped');
      }
    });
  });

  c.querySelectorAll('.swipe-del-bg').forEach(function(btn){
    btn.addEventListener('click',function(){
      var lid=this.closest('.swipe-wrap').getAttribute('data-lid');
      deleteList(lid);
    });
  });
}

function deleteList(lid){
  var lst=G.lists.find(function(l){return l.id===lid;});
  if(!lst)return;
  var cnt=G.words.filter(function(w){return w.lid===lid;}).length;
  if(!confirm('ã€Œ'+lst.name+'ã€ï¼ˆ'+cnt+'å˜èªï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;
  G.lists=G.lists.filter(function(l){return l.id!==lid;});
  G.words=G.words.filter(function(w){return w.lid!==lid;});
  save();homeRefresh();toast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* ======================================================
   ADD â€” JSONè²¼ã‚Šä»˜ã‘å¯¾å¿œ
   ====================================================== */
var addMode='paste', prevWords=[], selLang='en', selLevel='all', selType='words';
var pasteJsonSection='all'; /* è²¼ã‚Šä»˜ã‘ã‚¿ãƒ–ç”¨ã®JSONã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠ */

/* JSONæ¤œå‡º UIã®è¡¨ç¤º/éè¡¨ç¤º */
function pasteJsonDetect(txt){
  var trimmed=(txt||'').replace(/^\s+/,'');
  var isJson=(trimmed.charAt(0)==='{' || trimmed.charAt(0)==='[');
  el('JSON-banner').classList.toggle('on', isJson);
  el('PASTE-json-sec').classList.toggle('on', isJson);
}

function pasteJsonDetectReset(){
  el('JSON-banner').classList.remove('on');
  el('PASTE-json-sec').classList.remove('on');
}

function setPasteJsonSection(sec){
  pasteJsonSection=sec;
  document.querySelectorAll('[data-pjsec]').forEach(function(b){
    b.classList.toggle('on', b.getAttribute('data-pjsec')===sec);
  });
}

/* ---- JSON å˜èªæŠ½å‡ºï¼ˆè²¼ã‚Šä»˜ã‘ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å…±é€šï¼‰ ---- */
function extractWordsFromJson(d, section){
  /* æ±ç”¨ã‚­ãƒ¼æ¤œç´¢ */
  function extractArr(arr){
    if(!Array.isArray(arr))return[];
    return arr.map(function(item){
      var w=item.word||item.term||item.front||item.expression||item.vocab||item.german||item.deutsch||item.french||item.spanish||item.english||'';
      var m=item.meaning||item.translation||item.back||item.definition||item.japanese||item.ja||'';
      return w?{word:String(w).trim(),meaning:String(m).trim()}:null;
    }).filter(Boolean);
  }

  var words=[];

  /* ãƒ‘ã‚¿ãƒ¼ãƒ³C: content.vocabulary / content.phrases */
  if(d.content&&typeof d.content==='object'){
    var vocab=extractArr(d.content.vocabulary||d.content.words||[]);
    var phrases=extractArr(d.content.phrases||d.content.expressions||[]);
    if(section==='vocabulary'){words=vocab;}
    else if(section==='phrases'){words=phrases;}
    else{words=vocab.concat(phrases);}
  }
  /* {"words":[...]} */
  else if(Array.isArray(d.words)){words=extractArr(d.words);}
  else if(Array.isArray(d.vocabulary)){words=extractArr(d.vocabulary);}
  else if(Array.isArray(d.phrases)){words=extractArr(d.phrases);}
  /* ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«é…åˆ— */
  else if(Array.isArray(d)){words=extractArr(d);}
  /* ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…¨å€¤ã‚’èµ°æŸ» */
  if(!words.length&&typeof d==='object'){
    Object.values(d).forEach(function(v){
      if(Array.isArray(v)&&!words.length){var w=extractArr(v);if(w.length)words=w;}
    });
  }
  return words;
}

/* ---- è¨€èªè‡ªå‹•æ¤œå‡ºï¼ˆJSONã‚­ãƒ¼ã‹ã‚‰ï¼‰ ---- */
function detectLangFromJson(d){
  var LANG_KEY_MAP={german:'de',deutsch:'de',french:'fr',franÃ§ais:'fr',spanish:'es',italiano:'it',english:'en'};
  if(typeof d==='object'&&!Array.isArray(d)){
    Object.keys(d).forEach(function(k){
      var lk=k.toLowerCase();
      Object.keys(LANG_KEY_MAP).forEach(function(lmk){
        if(lk===lmk){
          selLang=LANG_KEY_MAP[lmk];
          document.querySelectorAll('.lang-sel-btn').forEach(function(b){
            b.classList.toggle('on',b.getAttribute('data-lang')===selLang);
          });
        }
      });
    });
  }
}

function segSwitch(mode){
  addMode=mode;
  ['paste','file','ai'].forEach(function(m){el('TP-'+m).style.display=m===mode?'block':'none';el('SG-'+m).classList.toggle('on',m===mode);});
  prvHide();
  if(mode==='paste') pasteJsonDetectReset();
}

function setLang(lang){
  selLang=lang;
  document.querySelectorAll('.lang-sel-btn').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-lang')===lang);});
  updateLevelHint();
  var ph={en:'ä¾‹:\nabandon\nabsolute,çµ¶å¯¾çš„ãª',de:'ä¾‹:\nHaus\nSchule,å­¦æ ¡\narbeiten\nschÃ¶n,ç¾ã—ã„',fr:'ä¾‹:\nmaison\nÃ©cole,å­¦æ ¡\ntravail,ä»•äº‹',es:'ä¾‹:\ncasa\nescuela,å­¦æ ¡\ntrabajo,ä»•äº‹',it:'ä¾‹:\ncasa\nscuola,å­¦æ ¡\nlavoro,ä»•äº‹'};
  var ta=el('IN-paste-text');if(ta)ta.placeholder=ph[lang]||ph.en;
}

/* ---- è²¼ã‚Šä»˜ã‘ã‚¿ãƒ–ã®ã€Œè§£æã™ã‚‹ã€ ---- */
function parsePaste(){
  var txt=el('IN-paste-text').value.trim();
  if(!txt){toast('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}

  var trimmed=txt.replace(/^\s+/,'');
  if(trimmed.charAt(0)==='{' || trimmed.charAt(0)==='['){
    /* JSONå½¢å¼ */
    try{
      var jd=JSON.parse(txt);
      /* è¨€èªè‡ªå‹•æ¤œå‡º */
      detectLangFromJson(jd);

      /* ãƒªã‚¹ãƒˆåè‡ªå‹•è¨­å®š */
      var ni=el('IN-paste-name');
      if(ni&&!ni.value){
        var autoName=jd.book_title||jd.title||jd.name||'';
        if(autoName)ni.value=autoName;
      }

      /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é¸æŠä»˜ãã§å˜èªæŠ½å‡º */
      var words=extractWordsFromJson(jd, pasteJsonSection);

      /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ */
      if(ni&&ni.value&&jd.content){
        if(pasteJsonSection==='vocabulary'&&ni.value.indexOf('[å˜èª]')<0)ni.value=ni.value+' [å˜èª]';
        else if(pasteJsonSection==='phrases'&&ni.value.indexOf('[ç†Ÿèª]')<0)ni.value=ni.value+' [ç†Ÿèª]';
      }

      if(!words.length){toast('JSONã‚’èªè­˜ã—ã¾ã—ãŸãŒå˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}

      var secLabel={all:'',vocabulary:' (å˜èªã®ã¿)',phrases:' (ç†Ÿèªã®ã¿)'};
      toast('ğŸ“— JSON '+words.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'+secLabel[pasteJsonSection]);
      needTranslate(words)?doTranslate(words,selLang):prvShow(words);
      return;
    }catch(e){
      toast('âš ï¸ JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      return;
    }
  }

  /* é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ */
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim();var m=(p[1]||'').trim();
    if(w)words.push({word:w,meaning:m});
  });
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function needTranslate(words){return G.cfg.key&&words.some(function(w){return !w.meaning;});}

/* ---- FILE MODE ---- */
var fileMode='vocab';
var fileSelLevel='all', fileSelType='words';

function setFileMode(mode){
  fileMode=mode;
  document.querySelectorAll('[data-fmode]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-fmode')===mode);});
  var isExtract=(mode==='extract');
  var isJson=(mode==='json');
  el('FILE-ai-opts').style.display=isExtract?'block':'none';
  el('FILE-json-opts').style.display=isJson?'block':'none';
  if(isJson){
    el('UP-ic').textContent='ğŸ“—';
    el('UP-sub').textContent='JSON ãƒ•ã‚¡ã‚¤ãƒ« (.json)';
    el('UP-hint').textContent='book_title / content / vocabulary / phrases ãªã©ã‚’è‡ªå‹•èªè­˜ã—ã¾ã™';
    el('IN-file').accept='.json';
  } else if(isExtract){
    el('UP-ic').textContent='ğŸ“„';
    el('UP-sub').textContent='Word (.docx) / PDF / TXT / CSV';
    el('UP-hint').textContent='âœ¨ AIãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‹ã‚‰å˜èªãƒ»ç†Ÿèªã‚’è‡ªå‹•æŠ½å‡ºã—æ—¥æœ¬èªè¨³ã‚’ä»˜ä¸ã—ã¾ã™';
    el('IN-file').accept='.txt,.csv,.docx,.pdf';
  } else {
    el('UP-ic').textContent='ğŸ“';
    el('UP-sub').textContent='CSV / Excel (.xlsx)';
    el('UP-hint').textContent='CSV: 1åˆ—ç›®=å˜èªã€2åˆ—ç›®=æ—¥æœ¬èªè¨³ï¼ˆä»»æ„ï¼‰';
    el('IN-file').accept='.csv,.xlsx,.xls,.txt';
  }
}

function setFileLevel(level){
  fileSelLevel=level;
  document.querySelectorAll('[data-level][id^="FLV-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
}

function setFileType(type){
  fileSelType=type;
  document.querySelectorAll('[data-type][id^="FTY-"]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function handleFile(evt){
  var f=evt.target.files[0];if(!f)return;evt.target.value='';
  var ext=f.name.split('.').pop().toLowerCase();
  var ni=el('IN-file-name');
  if(ni&&!ni.value)ni.value=f.name.replace(/\.[^.]+$/,'');

  if(fileMode==='json'||ext==='json'){
    var fr=new FileReader();
    fr.onload=function(e){jsonImport(e.target.result, f.name);};
    fr.readAsText(f,'UTF-8');
    return;
  }

  if(fileMode==='extract'){
    if(ext==='txt'||ext==='csv'){
      var fr=new FileReader();
      fr.onload=function(e){fileAiExtract(e.target.result, f.name);};
      fr.readAsText(f,'UTF-8');
    } else if(ext==='docx'){
      extractDocx(f);
    } else if(ext==='pdf'){
      extractPdf(f);
    } else {
      toast('AIæŠ½å‡ºå¯¾å¿œ: TXT / CSV / Word(.docx) / PDF');
    }
  } else {
    if(ext==='csv'||ext==='txt'){var fr=new FileReader();fr.onload=function(e){csvParse(e.target.result,f.name);};fr.readAsText(f,'UTF-8');}
    else if(ext==='xlsx'||ext==='xls'){xlsxRead(f);}
    else toast('å¯¾å¿œå½¢å¼: CSV, TXT, XLSX');
  }
}

function extractDocx(file){
  loading('Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      try{
        mammoth.extractRawText({arrayBuffer:e.target.result}).then(function(result){
          loaded();
          if(!result.value||result.value.trim().length<10){toast('ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸ');return;}
          fileAiExtract(result.value, file.name);
        }).catch(function(){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
      }catch(e){loaded();toast('Wordãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof mammoth!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
  s.onload=function(){loaded();doExtract();};
  s.onerror=function(){loaded();toast('Wordãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function extractPdf(file){
  loading('PDFã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doExtract(){
    var fr=new FileReader();
    fr.onload=function(e){
      var typedArray=new Uint8Array(e.target.result);
      pdfjsLib.getDocument({data:typedArray}).promise.then(function(pdf){
        var totalPages=pdf.numPages, texts=[], done=0;
        for(var i=1;i<=totalPages;i++){
          (function(pageNum){
            pdf.getPage(pageNum).then(function(page){
              page.getTextContent().then(function(tc){
                texts[pageNum-1]=tc.items.map(function(s){return s.str;}).join(' ');
                done++;
                if(done===totalPages){
                  loaded();
                  var fullText=texts.join('\n');
                  if(!fullText.trim()){toast('PDFã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆãŒå–ã‚Šå‡ºã›ã¾ã›ã‚“ã§ã—ãŸï¼ˆç”»åƒPDFã¯éå¯¾å¿œï¼‰');return;}
                  fileAiExtract(fullText, file.name);
                }
              });
            });
          })(i);
        }
      }).catch(function(){loaded();toast('PDFã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');});
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof pdfjsLib!=='undefined'){loaded();doExtract();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload=function(){
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    loaded();doExtract();
  };
  s.onerror=function(){loaded();toast('PDFãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');};
  document.head.appendChild(s);
}

function fileAiExtract(text, fname){
  var savedLevel=selLevel, savedType=selType;
  selLevel=fileSelLevel; selType=fileSelType;
  if(!G.cfg.key){toast('AIã§ã®æŠ½å‡ºã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ï¼ˆè¨­å®šç”»é¢ã§å…¥åŠ›ï¼‰');selLevel=savedLevel;selType=savedType;return;}
  var ln=langName(selLang);
  var def=getLevelDef(selLang,fileSelLevel);
  var typeCond={words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'};
  var articleRule={en:'',de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',fr:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maisonï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'};
  var articleInstr=articleRule[selLang]||'';
  function makePrompt(chunk){
    return 'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[fileSelType]+'ã‚’ã§ãã‚‹ã ã‘å¤šãæŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      (articleInstr?articleInstr+'\n':'')+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
      '{"words":[{"word":"primate","meaning":"éœŠé•·é¡"},{"word":"be put upon","meaning":"åˆ©ç”¨ã•ã‚Œã‚‹"}]}\n\n'+
      'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+chunk;
  }
  var chunks=splitChunks(text, 80000);
  loading('AIãŒæŠ½å‡ºä¸­... (1/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();selLevel=savedLevel;selType=savedType;
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false; seen[k]=true; return true;
      });
      if(!words.length){toast('âŒ å˜èªãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');return;}
      toast('âœ… '+words.length+'èªã‚’æŠ½å‡ºã—ã¾ã—ãŸ'+(chunks.length>1?' ('+chunks.length+'ãƒ‘ãƒ¼ãƒˆå‡¦ç†)':''));
      prvShow(words);
      var ni2=el('IN-file-name');var ni3=el('IN-ai-name');
      if(ni2&&ni2.value&&ni3&&!ni3.value)ni3.value=ni2.value;
    },
    function(e){
      loaded();selLevel=savedLevel;selType=savedType;
      var msg=e.message||'';
      toast(msg.indexOf('401')>=0?'âŒ APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™':'âŒ ã‚¨ãƒ©ãƒ¼: '+msg.slice(0,50));
    }
  );
}

function csvParse(txt,fname){
  var words=[];
  txt.split('\n').forEach(function(line){
    line=line.trim();if(!line)return;
    var p=line.split(/[,\t]/);
    var w=(p[0]||'').trim().replace(/^["']|["']$/g,'');
    var m=(p[1]||'').trim().replace(/^["']|["']$/g,'');
    if(w)words.push({word:w,meaning:m});
  });
  var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=fname.replace(/\.[^.]+$/,'');
  if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

function xlsxRead(file){
  loading('Excelã‚’èª­ã¿è¾¼ã¿ä¸­...');
  function doRead(){
    var fr=new FileReader();
    fr.onload=function(e){
      loaded();
      try{
        var wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
        var rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
        var words=[];
        rows.forEach(function(r){var w=(r[0]||'').toString().trim(),m=(r[1]||'').toString().trim();if(w)words.push({word:w,meaning:m});});
        var ni=el('IN-file-name');if(ni&&!ni.value)ni.value=file.name.replace(/\.[^.]+$/,'');
        if(!words.length){toast('å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
        needTranslate(words)?doTranslate(words,selLang):prvShow(words);
      }catch(e){toast('Excelã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');}
    };
    fr.readAsArrayBuffer(file);
  }
  if(typeof XLSX!=='undefined'){loaded();doRead();return;}
  var s=document.createElement('script');
  s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onload=function(){loaded();doRead();};
  s.onerror=function(){loaded();toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã¯Exceléå¯¾å¿œã€‚CSVã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚');};
  document.head.appendChild(s);
}

/* ---- JSON ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ãƒ–ç”¨ï¼‰ ---- */
var jsonSection='all';

function setJsonSection(sec){
  jsonSection=sec;
  document.querySelectorAll('[data-jsec]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-jsec')===sec);});
}

function jsonImport(text, fname){
  try{
    var d=JSON.parse(text);
  }catch(e){toast('âŒ JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');return;}

  var ni=el('IN-file-name');
  if(ni){
    var autoName=d.book_title||d.title||d.name||fname.replace(/\.[^.]+$/,'');
    if(autoName&&!ni.value)ni.value=autoName;
  }

  var words=extractWordsFromJson(d, jsonSection);

  if(ni&&ni.value&&d.content){
    if(jsonSection==='vocabulary')ni.value=ni.value+' [å˜èª]';
    else if(jsonSection==='phrases')ni.value=ni.value+' [ç†Ÿèª]';
  }

  if(!words.length){toast('âŒ å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚JSONã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');return;}

  toast('âœ… '+words.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  needTranslate(words)?doTranslate(words,selLang):prvShow(words);
}

/* è¨€èªÃ—ãƒ¬ãƒ™ãƒ«åˆ¥ã®æ¤œå®šåŸºæº– */
var LEVEL_DEF={
  en:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»beå‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” è‹±æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ï¼ˆä¸­å­¦è‹±èªç›¸å½“ï¼‰ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–2ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ï¼ˆé«˜æ ¡è‹±èªç›¸å½“ï¼‰ã®å˜èªã€‚æ—¥å¸¸ãƒ»ç¤¾ä¼šçš„ãªè©±é¡Œã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'è‹±æ¤œæº–1ç´šãƒ»1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»é›£è§£ãªèªå½™'}
  },
  de:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»åŠ©å‹•è©ãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ç‹¬æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ‰ã‚¤ãƒ„èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã®ãƒ†ãƒ¼ãƒã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ç‹¬æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ‰ã‚¤ãƒ„èªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  fr:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»Ãªtre/avoirãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ä»æ¤œ5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ2ç´šãƒ¬ãƒ™ãƒ«ã®ãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»æ™‚äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ä»æ¤œ1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªãƒ•ãƒ©ãƒ³ã‚¹èªå˜èªã€‚å­¦è¡“ãƒ»æ–‡å­¦ãƒ»å°‚é–€çš„ãªèªå½™'}
  },
  es:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»ser/estarãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š6ç´šãƒ»5ç´šãƒ»4ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š4ã€œ6ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š3ç´šãƒ»2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š2ã€œ3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¹ãƒšã‚¤ãƒ³èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  },
  it:{
    all:  {hint:'ãƒ¬ãƒ™ãƒ«åŒºåˆ¥ãªã— â€” å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èªã‚’å¹…åºƒãæŠ½å‡º',cond:'åŸºæœ¬çš„ã™ãã‚‹å˜èªï¼ˆå† è©ãƒ»å‰ç½®è©ãƒ»essere/avereãªã©ï¼‰ã¯é™¤ãã€å­¦ç¿’ä¾¡å€¤ã®ã‚ã‚‹å˜èª'},
    beginner:{hint:'åˆç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®šï¼ˆä¼Šæ¤œï¼‰5ç´šãƒ»4ç´šãƒ»3ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š3ã€œ5ç´šãƒ¬ãƒ™ãƒ«ã®åŸºæœ¬çš„ãªå˜èªã€‚æ—¥å¸¸ç”Ÿæ´»ã®ç°¡å˜ãªè¡¨ç¾'},
    intermediate:{hint:'ä¸­ç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š2ç´šãƒ¬ãƒ™ãƒ«ã®å˜èªã€‚ç¤¾ä¼šãƒ»æ–‡åŒ–ãƒ»ä»•äº‹ãªã©ã«ä½¿ã‚ã‚Œã‚‹èªå½™'},
    advanced:{hint:'ä¸Šç´š â€” ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®å˜èª',cond:'ã‚¤ã‚¿ãƒªã‚¢èªæ¤œå®š1ç´šä»¥ä¸Šãƒ¬ãƒ™ãƒ«ã®é«˜åº¦ãªå˜èªã€‚å­¦è¡“ãƒ»å°‚é–€ãƒ»æ–‡å­¦çš„ãªèªå½™'}
  }
};

function getLevelDef(lang,level){
  var ld=LEVEL_DEF[lang]||LEVEL_DEF.en;
  return ld[level]||ld.all;
}

function setLevel(level){
  selLevel=level;
  document.querySelectorAll('.opt-btn[data-level]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-level')===level);});
  updateLevelHint();
}

function updateLevelHint(){
  var h=el('LV-hint');
  if(!h)return;
  var def=getLevelDef(selLang,selLevel);
  h.textContent=def.hint;
}

function setType(type){
  selType=type;
  document.querySelectorAll('.opt-btn[data-type]').forEach(function(b){b.classList.toggle('on',b.getAttribute('data-type')===type);});
}

function aiExtract(){
  var txt=el('IN-ai-text').value.trim();
  if(!txt||txt.length<20){toast('ã‚‚ã†å°‘ã—é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var keyFromInput=(el('IN-apikey')||{}).value||'';
  if(keyFromInput&&!G.cfg.key){G.cfg.key=keyFromInput;save();}
  if(G.cfg.key){
    aiExtractAPI(txt);
  } else {
    if(confirm('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nè¨­å®šç”»é¢ã§APIã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚‹ã¨AIç¿»è¨³ãŒä½¿ãˆã¾ã™ã€‚\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºï¼ˆè¨³ãªã—ï¼‰ã§ç¶šã‘ã¾ã™ã‹ï¼Ÿ')){
      offlineExtract(txt);
    }
  }
}

function apiCall(body,ok,ng){
  var xhr=new XMLHttpRequest();
  xhr.open('POST','https://api.anthropic.com/v1/messages',true);
  xhr.setRequestHeader('Content-Type','application/json');
  xhr.setRequestHeader('x-api-key',G.cfg.key);
  xhr.setRequestHeader('anthropic-version','2023-06-01');
  xhr.setRequestHeader('anthropic-dangerous-direct-browser-access','true');
  xhr.onload=function(){try{var d=JSON.parse(xhr.responseText);xhr.status===200?ok(d):ng(new Error((d.error&&d.error.message)||'APIã‚¨ãƒ©ãƒ¼ '+xhr.status));}catch(e){ng(e);}};
  xhr.onerror=function(){ng(new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼'));};
  xhr.send(JSON.stringify(body));
}

function splitChunks(text, chunkSize){
  var chunks=[];
  var pos=0;
  while(pos<text.length){
    var end=Math.min(pos+chunkSize, text.length);
    if(end<text.length){
      var nl=text.lastIndexOf('\n',end);
      var sp=text.lastIndexOf(' ',end);
      var cut=nl>pos+chunkSize/2?nl:sp>pos+chunkSize/2?sp:end;
      end=cut>pos?cut:end;
    }
    chunks.push(text.slice(pos,end).trim());
    pos=end;
  }
  return chunks.filter(function(c){return c.length>0;});
}

function apiCallChunked(chunks, makePrompt, model, okAll, ngAll){
  var allWords=[];
  var idx=0;
  function next(){
    if(idx>=chunks.length){okAll(allWords);return;}
    var chunk=chunks[idx];
    idx++;
    loading('AIãŒæŠ½å‡ºä¸­... ('+idx+'/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
    var body={
      model:model,
      max_tokens:16000,
      messages:[{role:'user',content:makePrompt(chunk)}]
    };
    apiCall(body,function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var words=(JSON.parse(m[0]).words||[]).filter(function(w){return w.word&&w.word.trim();});
          allWords=allWords.concat(words);
        }
      }catch(e){}
      next();
    },function(e){ngAll(e);});
  }
  next();
}

function langName(lang){return LANGS[lang]?LANGS[lang].name:'è‹±èª';}

function aiExtractAPI(txt){
  var slashCount=(txt.match(/ \/ /g)||[]).length;
  var lineCount=txt.split('\n').filter(function(l){return l.trim();}).length;
  var isWordList= slashCount > 20 && slashCount > lineCount * 0.5;

  if(isWordList){
    loading('å˜èªãƒªã‚¹ãƒˆã‚’è§£æä¸­...');
    var rawWords=[];
    txt.split('\n').forEach(function(line){
      line=line.trim();
      if(!line) return;
      if(/[\u3000-\u9fff]/.test(line)) return;
      line.split('/').forEach(function(w){
        w=w.trim().replace(/^\(|\)$/g,'');
        if(w && w.length>0 && w.length<60) rawWords.push(w);
      });
    });
    var seen={};
    var words=rawWords.filter(function(w){
      var k=w.toLowerCase();
      if(seen[k])return false; seen[k]=true; return true;
    }).map(function(w){return{word:w, meaning:''};});

    if(!words.length){loaded();toast('\u274c å˜èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
    loaded();

    if(G.cfg.key){
      translateInChunks(words, selLang, function(translated){
        var ni=el('IN-ai-name');
        if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_AIæŠ½å‡º';
        toast('\u2705 '+translated.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        prvShow(translated);
      });
    } else {
      var ni=el('IN-ai-name');
      if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_æŠ½å‡º';
      toast('\u2705 '+words.length+'èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆç¿»è¨³ã¯APIã‚­ãƒ¼ãŒå¿…è¦ï¼‰');
      prvShow(words);
    }
    return;
  }

  var ln=langName(selLang);
  var def=getLevelDef(selLang,selLevel);
  var levelLabel={all:'',beginner:'åˆç´š_',intermediate:'ä¸­ç´š_',advanced:'ä¸Šç´š_'};
  var typeLabel={words:'å˜èª_',phrases:'ç†Ÿèª_',both:'å˜èªç†Ÿèª_'};
  var typeCond={
    words:'å˜èªã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ã¯å«ã‚ãªã„ï¼‰',
    phrases:'ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ã¿ï¼ˆ2èªä»¥ä¸Šã®ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰',
    both:'å˜èªã¨ç†Ÿèªãƒ»ã‚¤ãƒ‡ã‚£ã‚ªãƒ ãƒ»æ…£ç”¨å¥ã®ä¸¡æ–¹'
  };
  var articleRule={
    en:'',
    de:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: der Mann, die Frau, das Kindï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: gehen, habenï¼‰ã€å½¢å®¹è©ã¯åŸå½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    fr:"åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: le livre, la maison, l\'Ã©coleï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: aller, avoirï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚",
    es:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: el libro, la casaï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: ir, tenerï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚',
    it:'åè©ã«ã¯å¿…ãšå®šå† è©ã‚’ä»˜ã‘ã¦ãã ã•ã„ï¼ˆä¾‹: il libro, la casa, lo studenteï¼‰ã€‚å‹•è©ã¯ä¸å®šè©å½¢ï¼ˆä¾‹: andare, avereï¼‰ã€å½¢å®¹è©ã¯ç”·æ€§å˜æ•°å½¢ã§è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚'
  };
  var articleInstr=articleRule[selLang]||'';
  var ni=el('IN-ai-name');
  if(ni&&!ni.value)ni.value=(LANGS[selLang]?LANGS[selLang].name:'')+'_'+(levelLabel[selLevel]||'')+(typeLabel[selType]||'')+'AIæŠ½å‡º';

  function makePrompt(chunk){
    return 'ä»¥ä¸‹ã®'+ln+'ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€'+
      'ã€Œ'+def.cond+'ã€ã«è©²å½“ã™ã‚‹'+typeCond[selType]+'ã‚’ã§ãã‚‹ã ã‘å¤šãæŠ½å‡ºã—ã€ãã‚Œãã‚Œæ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      (articleInstr?articleInstr+'\n':'')+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã«meaningã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆå‰å¾Œã«èª¬æ˜æ–‡ã‚„```ã¯ä¸è¦ï¼‰:\n'+
      '{"words":[{"word":"primate","meaning":"éœŠé•·é¡"},{"word":"be put upon","meaning":"åˆ©ç”¨ã•ã‚Œã‚‹ã€ã“ãä½¿ã‚ã‚Œã‚‹"}]}\n\n'+
      'ãƒ†ã‚­ã‚¹ãƒˆ:\n'+chunk;
  }

  var chunks=splitChunks(txt, 80000);
  loading('AIãŒæŠ½å‡ºä¸­... (1/'+chunks.length+'ãƒ‘ãƒ¼ãƒˆ)');
  apiCallChunked(chunks, makePrompt, 'claude-haiku-4-5-20251001',
    function(allWords){
      loaded();
      var seen={};
      var words=allWords.filter(function(w){
        var k=w.word.toLowerCase().trim();
        if(seen[k])return false;
        seen[k]=true;return true;
      });
      if(!words.length){toast('\u274c å˜èªãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');return;}
      toast('\u2705 '+words.length+'èªã‚’æŠ½å‡ºã—ã¾ã—ãŸ'+(chunks.length>1?' ('+chunks.length+'ãƒ‘ãƒ¼ãƒˆå‡¦ç†)':''));
      prvShow(words);
    },
    function(e){
      loaded();
      var msg=e.message||'';
      if(msg.indexOf('401')>=0||msg.indexOf('authentication')>=0||msg.toLowerCase().indexOf('invalid')>=0){
        toast('\u274c APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šç”»é¢ã§ç¢ºèªã—ã¦ãã ã•ã„');
      } else if(msg.indexOf('\u901a\u4fe1')>=0){
        toast('\u274c é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
      } else {
        toast('\u274c AIã‚¨ãƒ©ãƒ¼: '+msg.slice(0,60));
      }
    }
  );
}

function translateInChunks(words, lang, callback){
  var ln=langName(lang);
  var chunkSize=150;
  var total=words.length;
  var idx=0;
  var result=words.slice();

  function nextChunk(){
    if(idx>=total){callback(result);return;}
    var chunk=result.slice(idx, idx+chunkSize);
    var noMeaning=chunk.filter(function(w){return !w.meaning;});
    if(!noMeaning.length){idx+=chunkSize;nextChunk();return;}

    loading('ç¿»è¨³ä¸­... ('+Math.min(idx+chunkSize,total)+'/'+total+'èª)');
    var wordList=noMeaning.map(function(w){return w.word;}).join(' / ');
    var prompt=
      'ä»¥ä¸‹ã®'+ln+'ã®å˜èªãƒ»ç†Ÿèªã™ã¹ã¦ã«æ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚\n'+
      'å¿…ãšã™ã¹ã¦ã®é …ç›®ã‚’å«ã‚ã¦ãã ã•ã„ã€‚è¨³ãŒã‚ã‹ã‚‰ãªã„å ´åˆã§ã‚‚æ¨æ¸¬ã—ã¦è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚\n'+
      'JSONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„ï¼ˆ```ä¸è¦ï¼‰: {"translations":{"abandon":"æ¨ã¦ã‚‹","be put upon":"ã“ãä½¿ã‚ã‚Œã‚‹"}}\n\n'+
      'å˜èªãƒªã‚¹ãƒˆ: '+wordList;

    apiCall({
      model:'claude-haiku-4-5-20251001',
      max_tokens:16000,
      messages:[{role:'user',content:prompt}]
    },function(d){
      try{
        var raw=(d.content[0].text||'').replace(/```json|```/g,'').trim();
        var m=raw.match(/\{[\s\S]*\}/);
        if(m){
          var tr=JSON.parse(m[0]).translations||{};
          for(var i=idx;i<Math.min(idx+chunkSize,total);i++){
            var w=result[i];
            if(!w.meaning){
              var meaning=tr[w.word]||tr[w.word.toLowerCase()]||'';
              if(!meaning){
                var wn=w.word.replace(/\s+/g,' ').trim();
                Object.keys(tr).forEach(function(k){
                  if(!meaning&&k.replace(/\s+/g,' ').trim().toLowerCase()===wn.toLowerCase())meaning=tr[k];
                });
              }
              if(meaning)w.meaning=meaning;
            }
          }
        }
      }catch(e){}
      idx+=chunkSize;
      nextChunk();
    },function(){
      idx+=chunkSize;
      nextChunk();
    });
  }
  nextChunk();
}

function offlineExtract(txt){
  var common={the:1,be:1,is:1,are:1,was:1,were:1,have:1,has:1,had:1,do:1,does:1,did:1,will:1,would:1,shall:1,should:1,may:1,might:1,must:1,can:1,could:1,a:1,an:1,in:1,on:1,at:1,to:1,for:1,of:1,and:1,or:1,but:1,not:1,this:1,that:1,with:1,from:1,by:1,as:1,up:1,out:1,if:1,about:1,who:1,what:1,which:1,all:1,when:1,so:1,no:1,just:1,into:1,over:1,after:1,also:1,than:1,only:1,they:1,their:1,you:1,we:1,he:1,she:1,me:1,my:1,us:1,him:1,it:1,i:1,
    der:1,die:1,das:1,ein:1,eine:1,und:1,oder:1,aber:1,nicht:1,ist:1,sind:1,war:1,hat:1,haben:1,mit:1,von:1,aus:1,bei:1,nach:1,zum:1,zur:1,dem:1,den:1,des:1,
    le:1,la:1,les:1,un:1,une:1,des:1,et:1,ou:1,est:1,sont:1,pas:1,que:1,qui:1,dans:1,sur:1,avec:1,par:1,
    el:1,los:1,las:1,es:1,son:1,una:1,con:1,por:1,para:1,
    il:1,lo:1,gli:1,del:1,della:1,nella:1,con:1,per:1,una:1,sono:1};
  var f={},m,re=/\b([\wÃ„Ã¤Ã–Ã¶ÃœÃ¼ÃŸÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Ã¼Ã¿Ã§Ã¦Å“ÃÃ¡Ã‰Ã©ÃÃ­Ã“Ã³ÃšÃºÃ‘Ã±Ã€Ã ÃˆÃ¨ÃŒÃ¬Ã’Ã²Ã™Ã¹]{3,})\b/g;
  while((m=re.exec(txt))!==null){var w=m[1];if(!common[w.toLowerCase()]&&!common[w])f[w]=(f[w]||0)+1;}
  var s=Object.keys(f).sort(function(a,b){return f[b]-f[a];}).slice(0,30);
  toast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æŠ½å‡ºå®Œäº†ï¼ˆè¨³ãªã—ï¼‰APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨è¨³ã‚‚ä»˜ä¸ã§ãã¾ã™');
  prvShow(s.map(function(w){return{word:w,meaning:''};}));
}

function doTranslate(words,lang){
  var nm=words.filter(function(w){return !w.meaning;});
  if(!nm.length){prvShow(words);return;}
  var ln=langName(lang);
  loading(nm.length+'å˜èªã‚’ç¿»è¨³ä¸­...');
  apiCall({
    model:'claude-haiku-4-5-20251001',max_tokens:2048,
    messages:[{role:'user',content:'ä»¥ä¸‹ã®'+ln+'ã®å˜èªã«æ—¥æœ¬èªè¨³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚JSONã®ã¿ã§è¿”ã—ã¦ãã ã•ã„: {"translations":{"Haus":"å®¶",...}}\\n\\nå˜èª: '+nm.map(function(w){return w.word;}).join(', ')}]
  },function(d){
    try{var m=d.content[0].text.match(/\{[\s\S]*\}/);if(m){var tr=JSON.parse(m[0]).translations||{};words.forEach(function(w){if(!w.meaning&&tr[w.word])w.meaning=tr[w.word];});}}catch(e){}
    loaded();prvShow(words);
  },function(){loaded();prvShow(words);});
}

function prvShow(words){
  prevWords=words.filter(function(w){return w.word&&w.word.trim();});
  el('PRV').style.display='block';
  el('PRV-cnt').textContent=prevWords.length+' å˜èª';
  var h='';
  prevWords.forEach(function(w,i){
    h+='<div class="prev-item"><div class="pi-n">'+(i+1)+'</div><div class="pi-en">'+esc(w.word)+'</div><div class="pi-ja">'+(w.meaning?esc(w.meaning):'<span style="color:var(--tx2);font-size:11px">è¨³ãªã—</span>')+'</div></div>';
  });
  el('PRV-list').innerHTML=h;
  var sc=el('s-add').querySelector('.scroll');if(sc)sc.scrollTop=9999;
}
function prvHide(){prevWords=[];el('PRV').style.display='none';el('PRV-list').innerHTML='';}

function saveList(){
  if(!prevWords.length)return;
  var nameMap={paste:'IN-paste-name',file:'IN-file-name',ai:'IN-ai-name'};
  var ni=el(nameMap[addMode]||'IN-paste-name');
  var listName=(ni&&ni.value.trim())||((LANGS[selLang]?LANGS[selLang].name:'')+'ãƒªã‚¹ãƒˆ '+(G.lists.length+1));
  var lst=null;
  for(var i=0;i<G.lists.length;i++){if(G.lists[i].name===listName){lst=G.lists[i];break;}}
  if(!lst){
    var clrs=['#7c5cfc','#fc5c7d','#5cf8fc','#ffd700','#4cff91','#ff9c4c'];
    var langClr={en:'#4cff91',de:'#ffd700',fr:'#5cf8fc',es:'#ff9c4c',it:'#fc5c7d'};
    lst={id:uid(),name:listName,ic:LANGS[selLang]?LANGS[selLang].flag:'ğŸ“—',clr:langClr[selLang]||clrs[G.lists.length%clrs.length],lang:selLang,cr:new Date().toISOString()};
    G.lists.push(lst);
  }
  var added=0;
  prevWords.forEach(function(pw){
    var ex=G.words.some(function(w){return w.word===pw.word&&w.lid===lst.id;});
    if(!ex){G.words.push({id:uid(),word:pw.word,meaning:pw.meaning||'',lid:lst.id,lang:selLang,s:{i:1,e:EASE0,d:null,k:0,l:0},cr:new Date().toISOString(),lr:null});added++;}
  });
  save();prvHide();
  if(ni)ni.value='';
  var ta=el(addMode==='paste'?'IN-paste-text':addMode==='ai'?'IN-ai-text':'IN-paste-text');if(ta)ta.value='';
  /* JSONæ¤œå‡ºUIã‚‚ãƒªã‚»ãƒƒãƒˆ */
  pasteJsonDetectReset();
  toast('âœ… '+added+'å˜èªã‚’ã€Œ'+listName+'ã€ã«è¿½åŠ ã—ã¾ã—ãŸ');
  setTimeout(function(){go('s-home');},500);
}

/* WORD LIST */
var listLangFilter='all';
function listFilterRebuild(){
  var sel=el('SEL-list'),cur=sel.value;
  sel.innerHTML='<option value="all">ã™ã¹ã¦</option>';
  G.lists.forEach(function(l){var o=document.createElement('option');o.value=l.id;o.textContent=(LANGS[l.lang]?LANGS[l.lang].flag+' ':'')+l.name;sel.appendChild(o);});
  sel.value=cur||'all';
}
function wordStatus(w){
  if(!w.s||w.s.k===undefined)return 'new';
  if((w.s.l||0)>0&&(w.s.k||0)<2)return 'ng';
  if(w.s.k>=1&&w.s.i>=3)return 'ok';
  if(!w.s.d)return 'new';
  return 'unknown';
}
function statusMark(w){
  var st=wordStatus(w);
  if(st==='ok')return'<span title="ç¿’å¾—æ¸ˆã¿" style="font-size:13px;margin-left:4px">âœ…</span>';
  if(st==='ng')return'<span title="è¦å¾©ç¿’" style="font-size:13px;margin-left:4px">âŒ</span>';
  if(st==='new')return'<span title="æœªå­¦ç¿’" style="font-size:13px;margin-left:4px">ğŸ†•</span>';
  return'<span title="ä¸æ˜" style="font-size:13px;margin-left:4px">â“</span>';
}
function listRender(){
  var _tb=document.getElementById('SEL-toolbar');
  if(_tb)_tb.style.display=selModeOn?'block':'none';
  var flt=(el('SEL-list')||{}).value||'all';
  var srch=((el('IN-search')||{}).value||'').toLowerCase();
  var statusFlt=((el('SEL-status')||{}).value)||'all';
  var sortMode=((el('SEL-sort')||{}).value)||'default';
  var c=el('L-words');
  var words=flt==='all'?G.words.slice():G.words.filter(function(w){return w.lid===flt;});
  if(listLangFilter!=='all')words=words.filter(function(w){return(w.lang||'en')===listLangFilter;});
  if(srch)words=words.filter(function(w){return w.word.toLowerCase().indexOf(srch)>=0||(w.meaning||'').toLowerCase().indexOf(srch)>=0;});
  if(statusFlt!=='all')words=words.filter(function(w){return wordStatus(w)===statusFlt;});
  if(sortMode==='alpha'){words=words.slice().sort(function(a,b){return a.word.localeCompare(b.word);});}
  else if(sortMode==='level_asc'){words=words.slice().sort(function(a,b){return lvl(a)-lvl(b);});}
  else if(sortMode==='level_desc'){words=words.slice().sort(function(a,b){return lvl(b)-lvl(a);});}
  else if(sortMode==='miss'){words=words.slice().sort(function(a,b){return((b.s&&b.s.l)||0)-((a.s&&a.s.l)||0);});}
  if(!words.length){c.innerHTML='<div class="empty"><div class="empty-ic">ğŸ”</div><div class="empty-tl">å˜èªãªã—</div></div>';return;}
  var lb=['åˆ','å…¥','ä¸­','ä¸­ä¸Š','ä¸Š','ç¿’å¾—'],h='';
  words.forEach(function(w){
    var v=lvl(w);
    var l=LANGS[w.lang||'en'];
    var chk=selModeOn?'<input type="checkbox" class="word-sel-chk" data-wid="'+esc(w.id)+'"'+(selSet[w.id]?' checked':'')+' style="width:18px;height:18px;flex-shrink:0;margin-right:4px;accent-color:var(--ac)">':'';
    h+='<button class="word-item" data-wid="'+esc(w.id)+'" style="'+(selModeOn&&selSet[w.id]?'background:rgba(124,92,252,.18);border-color:var(--ac);':'')+'">'+
      chk+
      '<div class="wi-inf"><div class="wi-en">'+(l?'<span style="font-size:11px;margin-right:4px">'+l.flag+'</span>':'')+esc(w.word)+statusMark(w)+'</div>'+
      '<div class="wi-ja">'+(w.meaning?esc(w.meaning):'è¨³ãªã—')+'</div></div>'+
      '<div class="wi-lvl l'+v+'">'+lb[v]+'</div></button>';
  });
  c.innerHTML=h;
  c.querySelectorAll('.word-item').forEach(function(b){
    b.addEventListener('click',function(e){
      var wid=this.getAttribute('data-wid');
      if(selModeOn){selWordToggle(wid);this.style.background=selSet[wid]?'rgba(124,92,252,.18)':'';this.style.borderColor=selSet[wid]?'var(--ac)':'';}
      else{wordDetail(wid);}
    });
  });
  c.querySelectorAll('.word-sel-chk').forEach(function(chk){
    chk.addEventListener('click',function(e){e.stopPropagation();selWordToggle(this.getAttribute('data-wid'));var btn=this.closest('.word-item');if(btn){btn.style.background=selSet[this.getAttribute('data-wid')]?'rgba(124,92,252,.18)':'';btn.style.borderColor=selSet[this.getAttribute('data-wid')]?'var(--ac)':'';}});
  });
}

function listMenu(lid){
  var lst=G.lists.find(function(x){return x.id===lid;}); if(!lst)return;
  var ws=G.words.filter(function(w){return w.lid===lid;});
  var d=ws.filter(due).length;
  var l=LANGS[lst.lang||'en'];
  var cursor=lst.cursor||0;
  var total=ws.length;
  if(cursor>=total)cursor=0;
  var size=Math.min(parseInt(G.cfg.size)||20, total);
  var nextEnd=Math.min(cursor+size, total);
  var pct=total>0?Math.min(100,Math.round(cursor/total*100)):0;
  var progressInfo=total>0?'é€²æ— '+pct+'% ('+cursor+'/'+total+'å˜èªå®Œäº†)':'';
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(lst.name)+'</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:8px">'+ws.length+'å˜èª'+(d?' Â· å¾©ç¿’'+d+'ä»¶':'')+'</div>'+
    (total>0?'<div style="margin-bottom:14px"><div style="height:5px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-bottom:5px"><div style="height:100%;width:'+pct+'%;background:'+(pct>=100?'var(--gn)':pct>=60?'var(--ac3)':'var(--ac)')+';border-radius:3px;transition:width .3s"></div></div><div style="font-size:11px;color:var(--tx2)">'+progressInfo+(cursor<total?' Â· æ¬¡å›: '+cursor+'ã€œ'+nextEnd+'ç•ªç›®':' Â· å…¨å˜èªå®Œäº†ï¼')+'</div></div>':'')+
    '<button class="btn-primary" id="LM-flash" style="margin-bottom:8px">ğŸ“– äºˆç¿’ã—ã¦ã‹ã‚‰ã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-quiz" style="margin-top:0;margin-bottom:8px">âš¡ ã™ãã‚¯ã‚¤ã‚ºï¼ˆç¶šãã‹ã‚‰ï¼‰</button>'+
    '<button class="btn-sec" id="LM-quiz-reset" style="margin-top:0;margin-bottom:8px">ğŸ” æœ€åˆã‹ã‚‰ã‚¯ã‚¤ã‚º</button>'+
    '<button class="btn-sec" id="LM-due" style="margin-top:0;margin-bottom:8px'+(d?'':';opacity:.4;pointer-events:none')+'">ğŸ“… å¾©ç¿’å˜èªã®ã¿ï¼ˆ'+d+'ä»¶ï¼‰</button>'+
    '<button class="btn-sec" id="LM-list" style="margin-top:0;margin-bottom:8px">ğŸ“š å˜èªä¸€è¦§ã‚’è¦‹ã‚‹</button>'+
    '<button class="btn-sec" id="LM-edit" style="margin-top:0">âœï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†</button>';
  el('modal-bg').classList.add('on');

  function makePool(fromStart){
    var cur=fromStart?0:(lst.cursor||0);
    if(cur>=total)cur=0;
    var remaining=ws.slice(cur);
    var pool=G.cfg.random ? shuffle(remaining).slice(0,size) : remaining.slice(0,size);
    if(pool.length<2&&total>=2){
      cur=0;
      var all=G.cfg.random ? shuffle(ws.slice()) : ws.slice();
      pool=all.slice(0,size);
    }
    var nextCursor=Math.min(cur+size, total);
    return {pool:pool, nextCursor:nextCursor};
  }

  el('LM-flash').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    flashStart(r.pool,'list',lid);
  });
  el('LM-quiz').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(false);
    if(r.pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-quiz-reset').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    var r=makePool(true);
    if(r.pool.length<2){toast('ã‚¯ã‚¤ã‚ºã«ã¯æœ€ä½2å˜èªå¿…è¦ã§ã™');return;}
    Q={words:r.pool,q:r.pool.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'study',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    Q._pendingCursor={lid:lid, next:r.nextCursor};
    go('s-quiz');qRender();
  });
  el('LM-due').addEventListener('click',function(){
    if(!d)return;
    el('modal-bg').classList.remove('on');
    var pool=ws.filter(due);
    if(pool.length<2){toast('å¾©ç¿’å˜èªãŒå°‘ãªã™ãã¾ã™ï¼ˆæœ€ä½2å˜èªï¼‰');return;}
    var qs=(G.cfg.random ? shuffle(pool) : pool).slice(0,size);
    Q={words:qs,q:qs.slice(),i:0,ok:0,ng:0,done:false,miss:[],slow:[],ci:0,ca:'',testMode:false,quizMode:'due',sessionStart:Date.now(),consec:{},mastered:0,masteredIds:{}};
    go('s-quiz');qRender();
  });
  el('LM-list').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    go('s-list');
    var sel=el('SEL-list');
    listFilterRebuild();
    sel.value=lid;
    listRender();
  });
  el('LM-edit').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editList(lid);
  });
}

function wordDetail(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var lst=G.lists.find(function(x){return x.id===w.lid;});
  var dStr=w.s&&w.s.d?new Date(w.s.d).toLocaleDateString('ja-JP'):'ã™ã';
  var lbn=['åˆç´š','å…¥é–€','ä¸­ç´š','ä¸­ä¸Šç´š','ä¸Šç´š','ç¿’å¾—æ¸ˆã¿'],v=lvl(w);
  var l=LANGS[w.lang||'en'];
  el('modal-ct').innerHTML=
    '<div class="modal-tl">'+(l?l.flag+' ':'')+esc(w.word)+'</div>'+
    '<div style="font-size:20px;color:var(--ac3);margin-bottom:13px">'+esc(w.meaning||'è¨³ãªã—')+'</div>'+
    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px">'+
    mkCard('SRSãƒ¬ãƒ™ãƒ«',lbn[v])+mkCard('æ¬¡å›å¾©ç¿’',dStr)+
    mkCard('é€£ç¶šæ­£è§£',(w.s&&w.s.k||0))+mkCard('é–“é•ã„å›æ•°','<span style="color:var(--rd)">'+(w.s&&w.s.l||0)+'</span>')+
    '</div>'+
    '<div style="font-size:12px;color:var(--tx2);margin-bottom:14px">è¨€èª: '+(l?l.flag+' '+l.name:'ä¸æ˜')+' ï¼ ãƒªã‚¹ãƒˆ: '+esc(lst?lst.name:'ä¸æ˜')+'</div>'+
    '<button class="btn-sec" id="EDIT-word-btn" style="margin-bottom:8px">âœï¸ å˜èªã‚’ç·¨é›†</button>'+
    '<button class="del-btn" id="DEL-btn">ğŸ—‘ï¸ ã“ã®å˜èªã‚’å‰Šé™¤</button>';
  el('modal-bg').classList.add('on');
  el('EDIT-word-btn').addEventListener('click',function(){
    el('modal-bg').classList.remove('on');
    editWord(wid);
  });
  el('DEL-btn').addEventListener('click',function(){
    if(!confirm('ã€Œ'+w.word+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
    G.words=G.words.filter(function(x){return x.id!==wid;});
    save();el('modal-bg').classList.remove('on');listRender();toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  });
}
function mkCard(l,v){return'<div style="background:var(--sf2);border-radius:9px;padding:10px"><div style="font-size:10px;color:var(--tx2);margin-bottom:3px">'+l+'</div><div style="font-size:14px;font-weight:600">'+v+'</div></div>';}

function editList(lid){
  var lst=G.lists.find(function(x){return x.id===lid;});if(!lst)return;
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+(lst.lang===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœï¸ ãƒªã‚¹ãƒˆã‚’ç·¨é›†</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">ãƒªã‚¹ãƒˆå</div>'+
    '<input class="inp" id="EL-name" type="text" value="'+escHtml(lst.name)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">è¨€èª</div>'+
    '<select class="inp" id="EL-lang" style="margin-bottom:16px">'+langOpts+'</select>'+
    '<button class="btn-primary" id="EL-save" style="margin-bottom:8px">ğŸ’¾ ä¿å­˜</button>'+
    '<button class="btn-sec" id="EL-cancel" style="margin-top:0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EL-name');if(n){n.focus();n.select();}},100);
  el('EL-save').addEventListener('click',function(){
    var name=(el('EL-name').value||'').trim();
    if(!name){toast('ãƒªã‚¹ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    lst.name=name;
    lst.lang=el('EL-lang').value;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listFilterRebuild();listRender();
    toast('âœ… ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });
  el('EL-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

function editWord(wid){
  var w=G.words.find(function(x){return x.id===wid;});if(!w)return;
  var langOpts=Object.entries(LANGS).map(function(kv){
    return '<option value="'+kv[0]+'"'+((w.lang||'en')===kv[0]?' selected':'')+'>'+kv[1].flag+' '+kv[1].name+'</option>';
  }).join('');
  var listOpts=G.lists.map(function(l){
    return '<option value="'+l.id+'"'+(w.lid===l.id?' selected':'')+'>'+escHtml(l.name)+'</option>';
  }).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœï¸ å˜èªã‚’ç·¨é›†</div>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">å˜èªï¼ˆå¤–å›½èªï¼‰</div>'+
    '<input class="inp" id="EW-word" type="text" value="'+escHtml(w.word)+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">æ„å‘³ï¼ˆæ—¥æœ¬èªï¼‰</div>'+
    '<input class="inp" id="EW-meaning" type="text" value="'+escHtml(w.meaning||'')+'" style="margin-bottom:12px">'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">è¨€èª</div>'+
    '<select class="inp" id="EW-lang" style="margin-bottom:12px">'+langOpts+'</select>'+
    '<div class="lbl" style="font-size:11px;color:var(--tx2);margin-bottom:6px">æ‰€å±ãƒªã‚¹ãƒˆ</div>'+
    '<select class="inp" id="EW-list" style="margin-bottom:16px">'+listOpts+'</select>'+
    '<button class="btn-primary" id="EW-save" style="margin-bottom:8px">ğŸ’¾ ä¿å­˜</button>'+
    '<button class="btn-sec" id="EW-cancel" style="margin-top:0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  setTimeout(function(){var n=el('EW-word');if(n){n.focus();n.select();}},100);
  el('EW-save').addEventListener('click',function(){
    var word=(el('EW-word').value||'').trim();
    var meaning=(el('EW-meaning').value||'').trim();
    if(!word){toast('å˜èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
    w.word=word; w.meaning=meaning;
    w.lang=el('EW-lang').value;
    w.lid=el('EW-list').value;
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('âœ… å˜èªã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });
  el('EW-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

function checkDuplicates(){
  var seen={}, dups=[];
  G.words.forEach(function(w){
    var key=(w.word||'').toLowerCase().trim()+'|'+(w.lang||'en');
    if(seen[key]){
      var grp=dups.find(function(g){return g.key===key;});
      if(grp)grp.words.push(w);
      else dups.push({key:key,words:[seen[key],w]});
    } else {
      seen[key]=w;
    }
  });
  if(!dups.length){toast('é‡è¤‡å˜èªã¯ã‚ã‚Šã¾ã›ã‚“ âœ…');return;}

  var rows=dups.map(function(g){
    var wds=g.words;
    var lists=wds.map(function(w){var l=G.lists.find(function(x){return x.id===w.lid;});return l?l.name:'ä¸æ˜';});
    return '<div style="background:var(--sf2);border-radius:9px;padding:10px;margin-bottom:8px">'+
      '<div style="font-weight:700;margin-bottom:5px;color:var(--ac3)">'+escHtml(wds[0].word)+'</div>'+
      wds.map(function(w,i){
        return '<div style="display:flex;align-items:center;gap:7px;margin-bottom:4px">'+
          '<input type="checkbox" class="dup-chk" data-wid="'+w.id+'" style="width:16px;height:16px;flex-shrink:0">'+
          '<span style="font-size:11px;color:var(--tx2);flex:1">'+escHtml(w.meaning||'è¨³ãªã—')+' <span style="opacity:.6">ï¼ '+escHtml(lists[i])+'</span></span>'+
        '</div>';
      }).join('')+
    '</div>';
  }).join('');

  el('modal-ct').innerHTML=
    '<div class="modal-tl">âŠœ é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆ'+dups.length+'ä»¶ï¼‰</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">å‰Šé™¤ã™ã‚‹å˜èªã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</div>'+
    '<div id="DUP-list">'+rows+'</div>'+
    '<button class="del-btn" id="DUP-del" style="margin-top:8px">ğŸ—‘ï¸ ãƒã‚§ãƒƒã‚¯ã—ãŸå˜èªã‚’å‰Šé™¤</button>'+
    '<button class="btn-sec" id="DUP-cancel" style="margin-top:8px">é–‰ã˜ã‚‹</button>';
  el('modal-bg').classList.add('on');

  el('DUP-del').addEventListener('click',function(){
    var checked=Array.from(el('DUP-list').querySelectorAll('.dup-chk:checked')).map(function(c){return c.getAttribute('data-wid');});
    if(!checked.length){toast('å‰Šé™¤ã™ã‚‹å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
    G.words=G.words.filter(function(w){return checked.indexOf(w.id)<0;});
    save();el('modal-bg').classList.remove('on');
    homeRefresh();listRender();toast('ğŸ—‘ï¸ '+checked.length+'ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
  });
  el('DUP-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

var selModeOn=false, selSet={};
function toggleSelMode(){
  selModeOn=!selModeOn; selSet={};
  el('SEL-toolbar').style.display=selModeOn?'block':'none';
  el('B-sel-mode').style.color=selModeOn?'var(--ac)':'var(--tx2)';
  listRender();
  updateSelCount();
}
function updateSelCount(){
  var n=Object.keys(selSet).length;
  el('SEL-count').textContent=n+'ä»¶é¸æŠä¸­';
}
function selWordToggle(wid){
  if(selSet[wid])delete selSet[wid]; else selSet[wid]=true;
  var chk=document.querySelector('.word-sel-chk[data-wid="'+wid+'"]');
  if(chk)chk.checked=!!selSet[wid];
  updateSelCount();
}
function selDeleteAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(!confirm(ids.length+'ä»¶ã®å˜èªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  G.words=G.words.filter(function(w){return!selSet[w.id];});
  selSet={};save();homeRefresh();listRender();updateSelCount();toast('ğŸ—‘ï¸ '+ids.length+'ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
}
function selMoveAll(){
  var ids=Object.keys(selSet);
  if(!ids.length){toast('å˜èªã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(G.lists.length<2){toast('ç§»å‹•å…ˆãƒªã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var opts=G.lists.map(function(l){return '<button class="btn-sec sel-mv-btn" data-lid="'+l.id+'" style="margin-bottom:6px;margin-top:0">'+escHtml(l.name)+'</button>';}).join('');
  el('modal-ct').innerHTML=
    '<div class="modal-tl">âœ¦ ç§»å‹•å…ˆãƒªã‚¹ãƒˆã‚’é¸æŠ</div>'+
    '<div style="font-size:11px;color:var(--tx2);margin-bottom:10px">'+ids.length+'ä»¶ã‚’ç§»å‹•ã—ã¾ã™</div>'+
    opts+
    '<button class="btn-sec" id="MV-cancel" style="margin-top:8px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>';
  el('modal-bg').classList.add('on');
  el('modal-ct').querySelectorAll('.sel-mv-btn').forEach(function(b){
    b.addEventListener('click',function(){
      var toLid=this.getAttribute('data-lid');
      G.words.forEach(function(w){if(selSet[w.id])w.lid=toLid;});
      selSet={};save();el('modal-bg').classList.remove('on');
      listRender();updateSelCount();toast('âœ… ç§»å‹•ã—ã¾ã—ãŸ');
    });
  });
  el('MV-cancel').addEventListener('click',function(){el('modal-bg').classList.remove('on');});
}

/* ---------- SPEECH ---------- */
var LANG_VOICE={en:'en-US',de:'de-DE',fr:'fr-FR',es:'es-ES',it:'it-IT'};
var DUCK_VOL=0.15;
var _duckActive=0;
function duckStart(){
  _duckActive++;
  if(_duckActive>1)return;
  document.querySelectorAll('audio,video').forEach(function(m){
    if(!m.paused&&!m._preVol){m._preVol=m.volume;m.volume=Math.min(m.volume,DUCK_VOL);}
  });
}
function duckEnd(){
  _duckActive=Math.max(0,_duckActive-1);
  if(_duckActive>0)return;
  setTimeout(function(){
    if(_duckActive>0)return;
    document.querySelectorAll('audio,video').forEach(function(m){
      if(m._preVol!=null){m.volume=m._preVol;delete m._preVol;}
    });
  },300);
}

function speak(text, lang){
  if(!window.speechSynthesis)return;
  window.speechSynthesis.cancel();
  var u=new SpeechSynthesisUtterance(text);
  u.lang=LANG_VOICE[lang||'en']||'en-US';
  u.rate=0.9;
  u.pitch=1.0;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();};
  u.onerror=function(){duckEnd();};
  setTimeout(function(){window.speechSynthesis.speak(u);},100);
}

var SQ={queue:[],busy:false};
function sqClear(){
  SQ.queue=[];SQ.busy=false;
  try{window.speechSynthesis.cancel();}catch(e){}
}
function sqSpeak(text,lang,cb){
  cb=cb||function(){};
  if(!text||!text.trim()){cb();return;}
  SQ.queue.push({text:text,lang:lang,cb:cb});
  if(!SQ.busy)sqNext();
}
function sqNext(){
  if(!SQ.queue.length){SQ.busy=false;return;}
  SQ.busy=true;
  var item=SQ.queue.shift();
  if(!window.speechSynthesis){item.cb();SQ.busy=false;sqNext();return;}
  var u=new SpeechSynthesisUtterance(item.text);
  u.lang=LANG_VOICE[item.lang||'en']||'en-US';
  u.rate=0.9;
  u.onstart=function(){duckStart();};
  u.onend=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  u.onerror=function(){duckEnd();SQ.busy=false;item.cb();sqNext();};
  setTimeout(function(){
    window.speechSynthesis.speak(u);
    setTimeout(function(){if(window.speechSynthesis.paused)window.speechSynthesis.resume();},200);
  },80);
}

function speakWithCb(text,lang,cb){sqSpeak(text,lang,cb);}
function speakJa(text){sqSpeak(text,'ja',function(){});}

/* ---------- FLASHCARD ---------- */
var FL={words:[],i:0,playing:false,timer:null,quizPool:null,quizMode:null,quizLid:null,token:0};

function flRender(){
  var token=++FL.token;
  var w=FL.words[FL.i];
  if(!w)return;
  var tot=FL.words.length,cur=FL.i+1;
  el('FL-fill').style.width=(cur/tot*100)+'%';
  el('FL-cnt').textContent=cur+'/'+tot;
  var l=LANGS[w.lang||'en'];
  el('FL-lang').textContent=l?l.flag+' '+l.name:'';
  var card=el('FL-card');
  card.classList.add('flip');

  setTimeout(function(){
    if(FL.token!==token)return;
    el('FL-word').textContent=w.word;
    el('FL-meaning').textContent='';
    card.classList.remove('flip');

    var mode=G.cfg.spkMode||'both';
    var doForeign=(mode==='both'||mode==='foreign');
    var doJa=(mode==='both'||mode==='ja');

    function sayThen(text, lang, next){
      if(!text||!text.trim()||!window.speechSynthesis){
        setTimeout(next,50);return;
      }
      var u=new SpeechSynthesisUtterance(text);
      u.lang=lang; u.rate=0.9;
      u.onstart=function(){duckStart();};
      u.onend=function(){duckEnd();if(FL.token===token)next();};
      u.onerror=function(){duckEnd();if(FL.token===token)next();};
      window.speechSynthesis.speak(u);
    }

    function afterAll(){
      if(!FL.playing||FL.token!==token)return;
      FL.timer=setTimeout(function(){
        if(!FL.playing||FL.token!==token)return;
        if(FL.i<FL.words.length-1){FL.i++;flRender();}
        else{
          flStopAuto();
          if(G.cfg.autoQuiz){flStartAutoQuizCountdown();}
          else{toast('äºˆç¿’å®Œäº†ï¼ã‚¯ã‚¤ã‚ºã§ç¢ºèªã—ã‚ˆã†');}
        }
      },(G.cfg.flashSec||2)*1000);
    }

    function showMeaning(){
      if(FL.token!==token)return;
      el('FL-meaning').textContent=w.meaning||'';
      if(doJa&&w.meaning&&w.meaning.trim()){
        sayThen(w.meaning,'ja-JP',afterAll);
      } else {
        afterAll();
      }
    }

    if(doForeign&&w.word){
      sayThen(w.word, LANG_VOICE[w.lang||'en']||'en-US', function(){
        setTimeout(showMeaning, 800);
      });
    } else {
      setTimeout(showMeaning, 300);
    }

  },200);
}

function flNext(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i<FL.words.length-1){FL.i++;flRender();}
  else{toast('æœ€å¾Œã®å˜èªã§ã™');}
}
function flPrev(){
  FL.token++;sqClear();
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
  if(FL.i>0){FL.i--;flRender();}
  else{toast('æœ€åˆã®å˜èªã§ã™');}
}
function flToggleAuto(){
  if(FL.playing){flStopAuto();}
  else{
    FL.playing=true;
    el('FL-play').textContent='â¸';
    if(!SQ.busy&&!FL.timer){flRender();}
  }
}
function flStopAuto(){
  FL.playing=false;
  el('FL-play').textContent='â–¶';
  if(FL.timer){clearTimeout(FL.timer);FL.timer=null;}
}

var FL_AQ_timer=null;
function flStartAutoQuizCountdown(){
  var overlay=el('FL-auto-quiz-overlay');
  overlay.style.display='flex';
  var sec=3;
  function tick(){
    el('FL-aq-msg').textContent=sec+'ç§’å¾Œã«